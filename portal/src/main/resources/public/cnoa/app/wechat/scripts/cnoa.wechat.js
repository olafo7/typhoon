var CNOA_wechat_setting_setting,CNOA_wechat_setting_settingClass;CNOA_wechat_setting_settingClass=new CNOA.Class.create();CNOA_wechat_setting_settingClass.prototype={init:function(){this.baseUrl="index.php?app=wechat&func=setting&action=setting";var g=this.getAgentPanel(),d=this.getWeChatDeptPanel(),b=this.getWeChatUserPanel(),a=this.getWeChatConfigPanel(),e=this.getWeChatChatPanel(),c=this.getWeChatLogPanel(),f=this.getWeChatCallBackPanel();this.mainPanel=new Ext.ux.VerticalTabPanel({region:"center",border:false,tabPosition:"left",tabWidth:100,activeItem:0,deferredRender:true,layoutOnTabChange:true,items:[a,d,b,e,g,c,f]})},getAgentPanel:function(){var f=this;var c=[{name:"id"},{name:"agentId"},{name:"name"}];var b=new Ext.grid.ColumnModel({defaults:{align:"center",menuDisabled:true},columns:[new Ext.grid.RowNumberer(),{header:"id",dataIndex:"id",hidden:true},{header:"应用名称",dataIndex:"name",width:100,align:"left"},{header:"应用ID",dataIndex:"agentId",width:50,editor:new Ext.form.NumberField({nanText:"只能是数字",allowNegative:false,allowDecimals:false,allowBlank:false})},{header:lang("opt"),dataIndex:"",width:250,renderer:f.makeOperate}]});var a=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:f.baseUrl+"&task=getAgentList",disableCaching:true}),reader:new Ext.data.JsonReader({root:"data",fields:c})});var e=new Ext.grid.EditorGridPanel({name:"企业号应用",region:"center",store:a,cm:b,tbar:new Ext.Toolbar({items:[{text:"一键生成企业号应用菜单",iconCls:"icon-utils-s-add",cls:"btn-blue4",handler:function(){var g=new Ext.LoadMask(Ext.getBody(),{msg:"正在生成企业号应用菜单，请稍后...",removeMask:true});g.show();Ext.Ajax.request({url:f.baseUrl+"&task=createAllMenu",success:function(h){g.hide();var i=Ext.decode(h.responseText);CNOA.msg.notice2(i.msg)}})}},"-",("【注：生成前请设置好应用ID！】")]}),listeners:{afteredit:function(i){var h=i.field,j=i.record.get("id"),g=i.value;f.updateAgent(j,h,g,a)}}});var d=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,region:"center",title:"企业号应用",items:[e]});return d},getWeChatDeptPanel:function(){var e=this;var b=[{name:"id"},{name:"name"},{name:"log"},{name:"posttime"}];var g=new Ext.grid.CheckboxSelectionModel({singleSelect:false});var a=new Ext.grid.ColumnModel({defaults:{menuDisabled:true},columns:[new Ext.grid.RowNumberer(),g,{header:"id",dataIndex:"id",hidden:true},{header:"部门名称",dataIndex:"name",width:200},{header:"日志信息",dataIndex:"log",width:500},{header:"操作时间",dataIndex:"posttime",width:110}]});var f=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:e.baseUrl+"&task=getWeChatLog&type=dept",disableCaching:true}),reader:new Ext.data.JsonReader({root:"data",fields:b})});var d=new Ext.grid.GridPanel({title:"微信企业号部门操作日志",region:"center",store:f,cm:a,sm:g,tbar:new Ext.Toolbar({items:[{text:"一键生成企业号部门",iconCls:"icon-utils-s-add",cls:"btn-blue4",handler:function(){var h=new Ext.LoadMask(Ext.getBody(),{msg:"正在生成企业号部门，请稍后...",removeMask:true});h.show();Ext.Ajax.request({url:e.baseUrl+"&task=createAllDept",success:function(j){h.hide();f.reload();var i=Ext.decode(j.responseText);if(i.failure===true){CNOA.msg.alert(i.msg)}else{CNOA.msg.notice2(i.msg)}}})}},"-",("【注：请不要重复生成！】")]})});var c=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,region:"center",title:"企业号部门",items:[d]});return c},getWeChatUserPanel:function(){var f=this;var b=[{name:"id"},{name:"name"},{name:"log"},{name:"posttime"}];var h=new Ext.grid.CheckboxSelectionModel({singleSelect:false});var a=new Ext.grid.ColumnModel({defaults:{menuDisabled:true},columns:[new Ext.grid.RowNumberer(),h,{header:"id",dataIndex:"id",hidden:true},{header:"成员名称",dataIndex:"name",width:200},{header:"日志信息",dataIndex:"log",width:500},{header:"操作时间",dataIndex:"posttime",width:110}]});var g=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:f.baseUrl+"&task=getWeChatLog&type=user",disableCaching:true}),reader:new Ext.data.JsonReader({root:"data",fields:b})});var e=function(m,l){var j=20;if(m>=l){g.reload();return}var k=(m+20)>l?l:(m+20);var i=new Ext.LoadMask(Ext.getBody(),{msg:"正在生成"+(m+1)+"号到"+k+"号成员，请稍后...",removeMask:true});i.show();Ext.Ajax.request({url:f.baseUrl+"&task=createAllUser",params:{start:m,limit:j},success:function(n){i.hide();e(m+j,l)}})};var d=new Ext.grid.GridPanel({title:"微信企业号成员操作日志",region:"center",store:g,cm:a,sm:h,tbar:new Ext.Toolbar({items:[{text:"一键生成企业号成员",iconCls:"icon-utils-s-add",cls:"btn-blue4",handler:function(){Ext.Ajax.request({url:f.baseUrl+"&task=getUserCount",success:function(j){var i=Ext.decode(j.responseText);if(i.failure===true){CNOA.msg.alert(i.msg);g.reload()}else{e(0,i.msg)}}})}},"-",("【注：请不要重复生成！】")]})});var c=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,region:"center",title:"企业号成员",items:[d]});return c},getWeChatConfigPanel:function(){var a=this;return new Ext.Panel({title:"企业号配置",items:[{xtype:"form",width:465,bodyBorder:false,labelWidth:100,labelAlign:"left",id:"wechatConfig",style:"margin: 5px;",items:[{xtype:"textfield",fieldLabel:"企业号CorpID",name:"corpid",allowBlank:false,width:350},{xtype:"textfield",fieldLabel:"管理组凭证密钥",name:"corpsecret",allowBlank:false,width:350},{xtype:"textfield",fieldLabel:"公司OA外网",name:"oaUrl",allowBlank:false,width:350},{xtype:"radiogroup",fieldLabel:"微信通讯录账号",items:[{boxLabel:"OA用户ID",name:"accountType",inputValue:0,checked:true},{boxLabel:"手机号",name:"accountType",inputValue:1},{boxLabel:"自定义",name:"accountType",inputValue:2}]},{xtype:"checkbox",fieldLabel:"开启微信企业号",name:"isOpen"}],buttons:[{text:"保存",handler:function(){var b=Ext.getCmp("wechatConfig");if(b.getForm().isValid()){b.getForm().submit({url:a.baseUrl+"&task=submitToSave",method:"POST",waitMsg:lang("notice"),success:function(c,d){CNOA.msg.notice2(d.result.msg)},failure:function(c,d){CNOA.msg.alert(d.result.msg)}})}}}],listeners:{afterRender:function(){Ext.Ajax.request({url:a.baseUrl+"&task=getWeChatConfig",success:function(b){var c=Ext.decode(b.responseText);Ext.getCmp("wechatConfig").getForm().setValues(c)}})}}}]})},getWeChatCallBackPanel:function(){var a=this;return new Ext.Panel({title:"企业号回调",items:[{xtype:"form",width:465,bodyBorder:false,labelWidth:100,labelAlign:"left",id:"wechatCallBack",style:"margin: 5px;",items:[{xtype:"textfield",fieldLabel:"Token",name:"token",width:350},{xtype:"textfield",fieldLabel:"EncodingAESKey",name:"encodingAESKey",width:350}],buttons:[{text:"保存",handler:function(){var b=Ext.getCmp("wechatCallBack");if(b.getForm().isValid()){b.getForm().submit({url:a.baseUrl+"&task=saveWechatCallBack",method:"POST",waitMsg:lang("notice"),success:function(c,d){CNOA.msg.notice2(d.result.msg)},failure:function(c,d){CNOA.msg.alert(d.result.msg)}})}}}],listeners:{afterRender:function(){Ext.Ajax.request({url:a.baseUrl+"&task=getWeChatCallBackConfig",success:function(b){var c=Ext.decode(b.responseText);Ext.getCmp("wechatCallBack").getForm().setValues(c)}})}}}]})},getWeChatChatPanel:function(){var a=this;return new Ext.Panel({title:"企业号会话",items:[{xtype:"form",width:465,bodyBorder:false,labelWidth:100,labelAlign:"left",id:"wechatChatConfig",style:"margin: 5px;",items:[{xtype:"textfield",fieldLabel:"企业号CorpID",name:"corpid",allowBlank:false,width:350},{xtype:"textfield",fieldLabel:"会话凭证密钥",name:"corpsecret",allowBlank:false,width:350},{xtype:"checkbox",fieldLabel:"开启企会话",name:"isOpen"}],buttons:[{text:"保存",handler:function(){var b=Ext.getCmp("wechatChatConfig");if(b.getForm().isValid()){b.getForm().submit({url:a.baseUrl+"&task=submitToSaveChat",method:"POST",waitMsg:lang("notice"),success:function(c,d){CNOA.msg.notice2(d.result.msg)},failure:function(c,d){CNOA.msg.alert(d.result.msg)}})}}}],listeners:{afterRender:function(){Ext.Ajax.request({url:a.baseUrl+"&task=getWeChatChatConfig",success:function(b){var c=Ext.decode(b.responseText);Ext.getCmp("wechatChatConfig").getForm().setValues(c)}})}}}],tbar:new Ext.Toolbar({items:[{text:"一键同步小秘书会话",iconCls:"icon-utils-s-add",cls:"btn-blue4",handler:function(){var b=new Ext.LoadMask(Ext.getBody(),{msg:"正在同步小秘书会话，请稍后...",removeMask:true});b.show();Ext.Ajax.request({url:a.baseUrl+"&task=createAllChat",success:function(c){b.hide();var d=Ext.decode(c.responseText);CNOA.msg.notice2(d.msg)}})}},"-",("【注：请不要重复生成！】")]})})},getWeChatLogPanel:function(){var e=this;var b=[{name:"id"},{name:"name"},{name:"log"},{name:"type"},{name:"posttime"}];var h=new Ext.grid.CheckboxSelectionModel({singleSelect:false});var a=new Ext.grid.ColumnModel({defaults:{menuDisabled:true},columns:[new Ext.grid.RowNumberer(),h,{header:"id",dataIndex:"id",hidden:true},{header:"日志名称",dataIndex:"name",width:200},{header:"日志类型",dataIndex:"type",width:100},{header:"日志信息",dataIndex:"log",width:500},{header:"操作时间",dataIndex:"posttime",width:110}]});var f=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:e.baseUrl+"&task=getWeChatLog",disableCaching:true}),reader:new Ext.data.JsonReader({root:"data",fields:b})});var g=new Ext.form.ComboBox({width:80,displayField:"name",valueField:"id",triggerAction:"all",editable:false,allowBlank:false,hiddenName:"type",id:"logType",mode:"local",store:new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:e.baseUrl+"&task=getTypeCombo"}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:["id","name"]}),listeners:{load:function(){var j=Ext.getCmp("logType");var i=j.store.reader.jsonData.data[0].id;j.setValue(i)}}}),listeners:{select:function(i){f.load({params:{type:i.value}})}}});var d=new Ext.grid.GridPanel({title:"企业号日志",region:"center",store:f,cm:a,sm:h,tbar:new Ext.Toolbar({items:["选择日志类型：",g,{text:"刷新",handler:function(){f.reload()}},{text:lang("clear"),handler:function(){Ext.Ajax.request({url:e.baseUrl+"&task=clearLog",success:function(j){var i=Ext.decode(j.responseText);if(i.failure===true){CNOA.msg.alert(i.msg);f.reload()}else{CNOA.msg.notice2(i.msg);f.reload()}}})}}]})});var c=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,region:"center",title:"企业号成员",items:[d]});return d},updateAgent:function(e,d,c,a){var b=this;Ext.Ajax.request({url:b.baseUrl+"&task=updateAgent",params:{id:e,field:d,value:c},success:function(g){var f=Ext.decode(g.responseText);if(f.failure===true){CNOA.msg.alert(f.msg);a.reload()}else{CNOA.msg.notice2(f.msg);a.reload()}}})},makeOperate:function(e,b,a,g,d,c){var f=a.json.id;e="<a href='javascript:void(0);'  class='gridview' onclick='CNOA_wechat_setting_setting.createMenu("+f+");'>生成应用菜单</a>";e+="　<a href='javascript:void(0);'  class='gridview4' onclick='CNOA_wechat_setting_setting.deleteMenu("+f+");'>删除应用菜单</a>";return e},createMenu:function(b){var a=this;Ext.Ajax.request({url:a.baseUrl+"&task=createMenu&id="+b,success:function(c){var d=Ext.decode(c.responseText);CNOA.msg.notice2(d.msg)}})},deleteMenu:function(b){var a=this;Ext.Ajax.request({url:a.baseUrl+"&task=deleteMenu&id="+b,success:function(c){var d=Ext.decode(c.responseText);CNOA.msg.notice2(d.msg)}})}};var sm_wechat_wechat=1;