var CNOA_project_proj_viewprojClass,CNOA_project_proj_viewproj;CNOA_project_proj_viewprojClass=CNOA.Class.create();CNOA_project_proj_viewprojClass.prototype={init:function(){var g=this;this.edit_id=0;this.content_start=1;this.baseUrl="index.php?app=project&func=proj&action=main&module=viewproj";this.ID_btn_edit=Ext.id();this.ID_btn_delete=Ext.id();this.ID_plan_content=Ext.id();var d=Ext.id();var e=Ext.id();var a=Ext.id();var b=Ext.id();var c=Ext.id();this.status=2;this.storeBar={title:"",s_standard:0,e_standard:0,s_time:0,e_time:0,status:""};this.fields=[{name:"pid"},{name:"name"},{name:"number"},{name:"type"},{name:"ttime"},{name:"ptime"},{name:"pday"},{name:"tday"},{name:"posttime"},{name:"updatetime"},{name:"uidname"},{name:"setname"},{name:"viewer"},{name:"status"},{name:"description"},{name:"checknum"},{name:"upgradetitle"},{name:"upgradewidth"},{name:"upgradecolor"},{name:"editable"},{name:"upgradable"},{name:"deleteable"},{name:"changeable"},{name:"startable"},{name:"finishable"}];this.store=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getJsonData",disableCaching:true}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields}),listeners:{exception:function(n,m,o,l,k,j){var i=Ext.decode(k.responseText);if(i.failure){CNOA.msg.alert(i.msg)}}}});this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.colModel=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"pid",dataIndex:"pid",hidden:true},{header:lang("opt"),dataIndex:"",width:120,sortable:false,menuDisabled:true,renderer:this.makeOperate.createDelegate(this)},{header:"项目名称",dataIndex:"name",width:255,sortable:true,menuDisabled:true},{header:"项目进度",dataIndex:"pid",width:90,sortable:false,menuDisabled:true,renderer:this.makeStatus.createDelegate(this)},{header:"立项人",dataIndex:"uidname",width:80,sortable:false,menuDisabled:true},{header:"计划时间",dataIndex:"ptime",width:120,sortable:false,menuDisabled:true},{header:"计划工时(天)",dataIndex:"pday",width:80,sortable:false,menuDisabled:true},{header:"实际时间",dataIndex:"ttime",width:120,sortable:false,menuDisabled:true},{header:"实际工时(天)",dataIndex:"tday",width:80,sortable:false,menuDisabled:true,renderer:this.formatday.createDelegate(this)},{header:"状态",dataIndex:"status",width:60,sortable:false,menuDisabled:true},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.pagingBar=new Ext.PagingToolbar({displayInfo:true,store:this.store,pageSize:15,listeners:{beforechange:function(i,j){j.status=g.storeBar.status;j.title=g.storeBar.title;j.s_standard=g.storeBar.s_standard;j.e_standard=g.storeBar.e_standard;j.s_time=g.storeBar.s_time;j.e_time=g.storeBar.e_time}}});this.searchBar=new Ext.Toolbar({items:["项目名称:",{xtype:"textfield",id:d,width:128},"&nbsp;项目进度从:",{xtype:"textfield",id:e,width:50,regex:/^(?:\d?\d|100)$/i,regexText:"必须设置为0到100的整数数字"},"~",{xtype:"textfield",id:a,width:50,regex:/^(?:\d?\d|100)$/i,regexText:"必须设置为0到100的整数数字"},"&nbsp;实际开始时间:",{xtype:"datefield",format:"Y-m-d",id:b,width:100},"&nbsp;实际结束时间:",{xtype:"datefield",format:"Y-m-d",id:c,width:100},{xtype:"button",text:lang("search"),style:"margin-left:5px",handler:function(){g.storeBar.title=Ext.getCmp(d).getValue();g.storeBar.s_standard=Ext.getCmp(e).getValue();g.storeBar.e_standard=Ext.getCmp(a).getValue();g.storeBar.s_time=Ext.getCmp(b).getRawValue();g.storeBar.e_time=Ext.getCmp(c).getRawValue();g.store.load({params:g.storeBar})}},{xtype:"button",text:lang("clear"),style:"margin-left:5px",handler:function(){Ext.getCmp(d).setValue("");Ext.getCmp(e).setValue("");Ext.getCmp(a).setValue("");Ext.getCmp(b).setValue("");Ext.getCmp(c).setValue("");g.storeBar.title=0;g.storeBar.s_standard=0;g.storeBar.e_standard=0;g.storeBar.s_time=0;g.storeBar.e_time=0;g.store.load({params:g.storeBar})}}]});this.grid=new Ext.grid.GridPanel({store:this.store,loadMask:{msg:lang("waiting")},cm:this.colModel,sm:this.sm,stripeRows:true,hideBorders:true,border:false,viewConfig:{},listeners:{render:function(){g.searchBar.render(this.tbar)}},tbar:new Ext.Toolbar({items:[{handler:function(i,j){g.store.reload()}.createDelegate(this),iconCls:"icon-system-refresh",text:lang("refresh")},{handler:function(i,j){g.storeBar.status="waiting";g.store.load({params:g.storeBar})}.createDelegate(this),iconCls:"icon-waiting",enableToggle:true,pressed:true,allowDepress:false,toggleGroup:"project_proj_myproj_type",tooltip:"显示正在进行中和审批通过的所有项目列表",cls:"btn-yellow1",text:"进行中/审批通过的项目"},{handler:function(i,j){g.storeBar.status="finish";g.store.load({params:g.storeBar})}.createDelegate(this),enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_type",iconCls:"icon-pass",cls:"btn-blue4",tooltip:"显示立项中的所有项目列表",text:"已结束的项目"},"->",{xtype:"cnoa_helpBtn",helpid:2014}]}),bbar:this.pagingBar});this.centerPanel=new Ext.Panel({region:"center",layout:"fit",items:[this.grid]});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:true,items:[this.centerPanel]})},makeStatus:function(j,g,c,i,e,b){var l=c.data;var k=0;var a="#5B5B5B";upgradetitle=l.upgradetitle;k=l.upgradewidth;a=l.upgradecolor;var d="<div style='color:#808080;margin-top:3px;'>"+upgradetitle+"</div>";d+="<div style='width:100px;height:5px;background-color:#D4D4D4;'><div style='font-size:0;line-height:0;height:5px;width:"+k+"px;background-color:"+a+";'></div></div>";return d},makeOperate:function(i,e,a,j,c,g){var d=a.data;var b="<a href='javascript:void(0);'  class='gridview jianju' onclick='CNOA_project_proj_viewproj.view("+d.pid+',"'+d.name+"\");' ext:qtip='查看该项目的所有信息'><span ext:qtip='查看该项目的所有信息资料'>查看</span></a>";return b},view:function(t,K){var z=this;var o=z.baseUrl+"&task=loadPage&pid="+t+"&from=";var J="项目："+K+" 的所有信息";var i=Ext.id();var F=Ext.id();var g=Ext.id();var c=Ext.id();var D=Ext.id();var n=Ext.id();var j=Ext.id();var s=Ext.id();var H=Ext.id();var w=true;var e=true;var q=true;var E=true;var u=true;var b=true;var B=true;var y=true;var p=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",items:[z.eventPanel(t)]});var m=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",autoScroll:false,items:[z.endorsePanel(t)]});var a=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",items:[z.discussPanel(t)]});var A=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",items:[z.costPanel(t)]});var k=new Ext.Panel({html:'<div style="width:100%;height:100%;"><iframe scrolling=auto frameborder=0 width=100% height=100% id="'+H+'"></iframe></div>',listeners:{afterrender:function(){if(y){Ext.getDom(H).contentWindow.location.href=o+'viewFlowDetail&exportArray={"i":1,"f":1,"p":1,"e":1}&target=page';y=false}}}});var C=new Ext.Panel({html:'<div style="width:100%;height:100%;"><iframe scrolling=auto frameborder=0 width=100% height=100% id="'+s+'"></iframe></div>',listeners:{afterrender:function(){if(B){Ext.getDom(s).contentWindow.location.href=o+"viewgantt";B=false}}}});var r=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",items:[z.askPanel(t)]});var x=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",items:[z.taskPanel(t)]});var I=new Ext.Panel({html:'<div style="width:100%;height:100%;"><iframe scrolling=auto frameborder=0 width=100% height=100% id="'+D+'"></iframe></div>',listeners:{afterrender:function(){if(E){Ext.getDom(D).contentWindow.location.href=o+"viewdoc";E=false}}}});var v=new Ext.Panel({html:'<div style="width:100%;height:100%;"><iframe scrolling=auto frameborder=0 width=100% height=100% id="'+c+'"></iframe></div>',listeners:{afterrender:function(){if(q){Ext.getDom(c).contentWindow.location.href=o+"viewckrecord";q=false}}}});var d=new Ext.Panel({html:'<div style="width:100%;height:100%;"><iframe scrolling=auto frameborder=0 width=100% height=100% id="'+g+'"></iframe></div>',listeners:{afterrender:function(){if(e){Ext.getDom(g).contentWindow.location.href=o+"viewmember";e=false}}}});var G=new Ext.Panel({html:'<div style="width:100%;height:100%;"><iframe scrolling=auto frameborder=0 width=100% height=100% id="'+F+'"></iframe></div>',listeners:{afterrender:function(){if(w){Ext.getDom(F).contentWindow.location.href=o+"viewbaseinfo";w=false}}}});var l=new Ext.Window({title:J,width:860,height:makeWindowHeight(700),autoScroll:false,resizable:true,modal:true,layout:"border",maximizable:true,tbar:[{xtype:"buttongroup",columns:3,title:"项目信息",defaults:{scale:"small"},items:[{text:lang("baseInfo"),iconCls:"application_view_list",tooltip:"显示项目的基本信息和进度汇报",pressed:true,enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(0)}},{text:"项目成员",iconCls:"icon-cnoa-communication",tooltip:"显示项目的所有成员和他们的角色",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(1)}},{text:"项目文档",iconCls:"icon-order-s-send",tooltip:"显示项目的所有文档和对应成员的权限",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(3)}},{text:"项目费用",iconCls:"icon-coins",tooltip:"显示项目所花费的费用",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(7)}},{text:"任务列表",iconCls:"icon-btn-desktopList",tooltip:"显示该项目的所有任务列表",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(4)}}]},{xtype:"buttongroup",columns:2,title:"项目跟踪",defaults:{scale:"small"},items:[{text:"问题跟踪",iconCls:"icon-system-help",tooltip:"显示该项目的问题的所有讨论细节",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(5)}},{text:"审批记录",iconCls:"icon-diary-todo",tooltip:"显示项目被审批的所有记录和变更记录",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(2)}},{text:"项目流程",iconCls:"all-department-tree",tooltip:"显示项目绑定的流程",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(8)}},{text:"项目事件",iconCls:"icon-order-s-draft",tooltip:"显示项目变更后的所有事件记录",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(11)}}]},{xtype:"buttongroup",columns:1,title:"项目交流 ",defaults:{scale:"small"},items:[{text:"项目讨论区",iconCls:"icon-CNOA-Web-IM",tooltip:"讨论该项目的一些问题",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(9)}},{text:"项目批注&nbsp;&nbsp;&nbsp;&nbsp;",iconCls:"icon-system-theme-setup",tooltip:"对该项目的一些批注",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(10)}}]},{xtype:"buttongroup",columns:2,title:lang("opt"),height:69,defaults:{scale:"small"},items:[{text:"最大化窗口",iconCls:"icon-fileview-column",tooltip:"恢复窗口原来的大小",handler:function(L){if(l.maximized===true){L.setText("最大化窗口")}else{L.setText("恢复窗口")}l.toggleMaximize()}},{text:lang("close"),iconCls:"icon-dialog-cancel",tooltip:"关闭窗口",handler:function(){l.close()}}]}],listeners:{show:function(){},close:function(){}},items:[{xtype:"panel",id:i,region:"center",layout:"card",activeItem:0,hideBorders:true,border:false,items:[G,d,v,I,x,r,C,A,k,a,m,p]}]}).show()},eventPanel:function(c){var e=this;var j=Ext.id();var d=[{name:"eid"},{name:"type"},{name:"title"},{name:"content"},{name:"posttime"},{name:"truename"}];var l=new Ext.data.GroupingStore({autoLoad:true,proxy:new Ext.data.HttpProxy({url:e.baseUrl+"&task=geteventlist&pid="+c}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:d}),sortInfo:{field:"eid",direction:"ASC"},groupOnSort:false,groupField:"type",sortData:function(){},listeners:{load:function(o,m,n){}}});var b=new Ext.grid.CheckboxSelectionModel({singleSelect:false});var k=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"eid",dataIndex:"eid",hidden:true},{header:"",dataIndex:"type",hidden:true},{header:"类型",dataIndex:"type",width:120,sortable:true,menuDisabled:true},{header:lang("title"),dataIndex:"title",width:120,sortable:true,menuDisabled:true},{header:"操作内容",dataIndex:"content",width:200,sortable:true,menuDisabled:true},{header:"修改时间",dataIndex:"posttime",width:120,sortable:true,menuDisabled:true},{header:"操作人姓名",dataIndex:"truename",width:80,sortable:true,menuDisabled:true},{header:lang("opt"),dataIndex:"eid",width:80,sortable:true,menuDisabled:true,renderer:this.viewdiff.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);var i=new Ext.grid.GridPanel({border:false,store:l,loadMask:{msg:lang("waiting")},cm:k,sm:b,stripeRows:true,hideBorders:true,tbar:[{text:lang("refresh"),iconCls:"icon-system-refresh",handler:function(m,n){l.reload()}},{text:"列表模式",enableToggle:true,allowDepress:false,iconCls:"icon-system-s-report",toggleGroup:"project_proj_myproj_event_expand",tooltip:"列表模式",handler:function(m,n){l.clearGrouping()}},{text:"分组模式",pressed:true,enableToggle:true,allowDepress:false,iconCls:"icon-view-form-png",toggleGroup:"project_proj_myproj_event_expand",tooltip:"分组模式",handler:function(m,n){l.groupBy("type",true);i.view.collapseAllGroups()}},{text:"展开所有分组",enableToggle:true,allowDepress:false,iconCls:"icon-style-tree",toggleGroup:"project_proj_myproj_event_expand",tooltip:"展开所有分组",handler:function(m,n){l.groupBy("type",true);i.view.expandAllGroups()}}],view:new Ext.grid.GroupingView({forceFit:false,startCollapsed:true})});var a=new Ext.Panel({region:"center",layout:"fit",items:[i]});var g=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",autoScroll:false,items:[a]});return g},viewdiff:function(g,d,a,i,b,e){var c=a.data;return"<a href='javascript:void(0)' onclick='CNOA_project_proj_viewproj.viewdiffwin("+c.eid+', "'+c.title+"\")'>查看</a>"},viewdiffwin:function(b,e){var g=this;var c=Ext.id();var a=new Ext.Panel({html:'<div style="width:100%;height:100%;"><iframe scrolling=auto frameborder=0 width=100% height=100% id="'+c+'"></iframe></div>',border:false,listeners:{afterrender:function(){Ext.getDom(c).contentWindow.location.href=g.baseUrl+"&task=viewdiffdetail&eid="+b}}});var d=new Ext.Window({title:"查看"+e,width:800,height:makeWindowHeight(600),items:[a],modal:true,layout:"fit",buttons:[{text:lang("close"),handler:function(){d.close()}}]}).show()},endorsePanel:function(c){var j=this;var b=[{name:"eid"},{name:"posttime"},{name:"postname"},{name:"content"}];this.endorseStore=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:j.baseUrl+"&task=endorseprojlist&pid="+c}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:b}),listeners:{load:function(m,k,l){j.endorsedata=k}}});var i=new Ext.grid.CheckboxSelectionModel({singleSelect:false});var d=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"批注领导",dataIndex:"postname",width:80,sortable:true,menuDisabled:true},{header:"批注内容",dataIndex:"content",width:350,sortable:true,menuDisabled:true,renderer:this.endorsecontent.createDelegate(this)},{header:"批注时间",dataIndex:"posttime",width:120,sortable:true,menuDisabled:true},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);var g=new Ext.grid.GridPanel({border:false,store:this.endorseStore,loadMask:{msg:lang("waiting")},cm:d,sm:i,autoScroll:true,stripeRows:true,hideBorders:true,tbar:[{text:lang("refresh"),iconCls:"icon-system-refresh",handler:function(k,l){j.endorseStore.reload()}},{text:"添加批注",iconCls:"icon-system-menu-user",handler:function(k,l){j.endorseWin(c)}}]});var a=new Ext.Panel({region:"center",layout:"fit",autoScroll:false,items:[g]});var e=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",autoScroll:false,items:[a]});return e},endorseWin:function(a){var e=this;var c=function(){if(b.getForm().isValid()){b.getForm().submit({url:e.baseUrl+"&task=endorseproj",waitMsg:lang("waiting"),method:"POST",params:{pid:a},success:function(g,i){CNOA.msg.notice(i.result.msg,"项目管理");d.close();e.endorseStore.reload()}.createDelegate(this),failure:function(g,i){CNOA.msg.alert(i.result.msg)}.createDelegate(this)})}};var b=new Ext.form.FormPanel({region:"center",border:false,labelWidth:60,labelAlign:"right",waitMsgTarget:true,items:[{xtype:"panel",border:false,bodyStyle:"padding:10px",layout:"form",items:[{xtype:"textarea",name:"content",height:"180",fieldLabel:"批注内容",allowBlank:false,width:"480"}]}]});var d=new Ext.Window({title:"项目批注窗口",width:600,height:300,modal:true,layout:"border",items:[b],buttons:[{text:"提交",handler:function(){c()}},{text:lang("close"),handler:function(){d.close()}}]}).show()},endorsecontent:function(g,d,a,i,b,e){var c=a.data;return"<a href='javascript:void(0)' onclick='CNOA_project_proj_viewproj.showendorsecontent("+c.eid+")'>"+g+"</a>"},showendorsecontent:function(a){var b=this;Ext.each(b.endorsedata,function(c,d){if(c.data.eid==a){b.showendorsecontentwin(c.data.content)}})},showendorsecontentwin:function(b){var c=this;var a=new Ext.Window({title:"批注详细信息",width:600,height:300,layout:"border",modal:true,items:[new Ext.Panel({region:"center",autoScroll:true,html:"<div><p>&nbsp;&nbsp;&nbsp;"+b+"</p></div>",layout:"fit",border:false})],buttons:[{text:lang("close"),handler:function(){a.close()}}]}).show()},discussPanel:function(c){var g=this;var a=g.baseUrl+"&task=loadPage&pid="+c+"&from=";var i=[{name:"did"},{name:"title"},{name:"postname"},{name:"count"},{name:"posttime"},{name:"lastname"},{name:"lasttime"}];g.storediscuss=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:g.baseUrl+"&task=viewdiscusslist&pid="+c}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:i})});var b=new Ext.grid.CheckboxSelectionModel({singleSelect:false});var j=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"did",dataIndex:"did",hidden:true},{header:lang("title"),dataIndex:"title",width:270,sortable:true,menuDisabled:true,renderer:this.discusstitle.createDelegate(this)},{header:"作者",dataIndex:"postname",width:100,sortable:true,menuDisabled:true},{header:"发布时间",dataIndex:"posttime",width:120,sortable:true,menuDisabled:true},{header:"回复数",dataIndex:"count",width:120,sortable:true,menuDisabled:true},{header:"最后回复人",dataIndex:"lastname",width:80,sortable:true,menuDisabled:true},{header:"最后回复时间",dataIndex:"lasttime",width:120,sortable:true,menuDisabled:true},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);var k=new Ext.grid.GridPanel({border:false,store:g.storediscuss,loadMask:{msg:lang("waiting")},cm:j,sm:b,stripeRows:true,hideBorders:true,tbar:[{text:lang("refresh"),iconCls:"icon-system-refresh",handler:function(l,m){g.storediscuss.reload()}},{text:"发帖",iconCls:"icon-expand-members",handler:function(l,m){g.discussWin(c)}},"<span class='cnoa_color_gray'>点击标题，进入该讨论帖子</span>"]});var d=new Ext.Panel({region:"center",layout:"fit",items:[k]});var e=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",autoScroll:false,items:[d]});return e},discusstitle:function(g,d,a,i,b,e){var c=a.data;return"<a href='javascript:void(0)' onclick='CNOA_project_proj_viewproj.discussview("+c.did+")'>"+g+"</a>"},discussview:function(b){var e=this;var a=new Ext.XTemplate('<div class="user_task_discuss_view">','  <div class="user_task_discuss_view_header">','    <div class="user_task_discuss_view_header_title">[讨论标题]&nbsp;&nbsp;{title}&nbsp;&nbsp;</div>','    <div class="user_task_discuss_view_header_from">&nbsp;发布人:&nbsp;&nbsp; {postname}&nbsp;&nbsp;&nbsp;&nbsp;发布时间:{posttime}</div>',"  </div>",'  <div class="user_task_discuss_view_body">','    <div class="user_task_discuss_view_body_left">','      <div class="user_task_discuss_view_body_left_body">','        <span><img src="{face}" width="120" height="130" onerror="this.src=\'./resources/images/default.jpg\'" /></span>',"      </div>","    </div>",'    <div class="user_task_discuss_view_body_right">','      <div class="user_task_discuss_view_body_right_top">#{[xindex]}&nbsp;&nbsp;<a>{postname}</a>&nbsp;&nbsp;</div>','      <div class="user_task_discuss_view_body_right_body">{content}</div>',"    </div>",'    <div class="clear"></div>',"  </div>",'  <tpl for="list">','  <div class="user_task_discuss_view_body">','    <div class="user_task_discuss_view_body_left">','      <div class="user_task_discuss_view_body_left_top"></div>','      <div class="user_task_discuss_view_body_left_body">','        <span><img src="{face}" width="120" height="130" onerror="this.src=\'./resources/images/default.jpg\'" /></span>',"      </div>","    </div>",'    <div class="user_task_discuss_view_body_right">','      <div class="user_task_discuss_view_body_right_top">#{[xindex]}&nbsp;&nbsp;<a>{postname}</a>&nbsp;&nbsp;发表于&nbsp;{posttime}<div style="float:right; padding-right:5px"><a href="javascript:void(0)" onclick="CNOA_project_proj_viewproj.replydiscuss({did},{rid})">回复</a></div></div>','      <div class="user_task_discuss_view_body_right_body">{content}</div>',"    </div>",'    <div class="clear"></div>',"  </div>","  </tpl>","</div>");e.readInfo=function(){d.getEl().mask(lang("waiting"));Ext.Ajax.request({url:e.baseUrl+"&task=getDiscussInfo",method:"POST",params:{did:b},success:function(i){var g=Ext.decode(i.responseText);if(g.success===true){rd=g.data;a.overwrite(d.body,rd);d.getEl().unmask()}else{CNOA.msg.alert(g.msg,function(){})}}})};var d=new Ext.Panel({region:"center",layout:"fit",border:false,autoScroll:true,listeners:{render:function(){e.readInfo()}},tbar:new Ext.Toolbar({items:[{text:lang("refresh"),iconCls:"icon-system-refresh",handler:function(){e.readInfo()}},{text:"回复",iconCls:"icon-expand-members",handler:function(){e.replydiscuss(b,0)}}]})});var c=new Ext.Window({title:"查看讨论窗口",width:800,height:makeWindowHeight(600),modal:true,layout:"border",items:[d],buttons:[{text:lang("close"),handler:function(){c.close()}}]}).show()},replydiscuss:function(c,a){var g=this;var d=function(){if(b.getForm().isValid()){b.getForm().submit({url:g.baseUrl+"&task=discussprojreply",waitMsg:lang("waiting"),method:"POST",params:{did:c,rid:a},success:function(i,j){CNOA.msg.notice(j.result.msg,"项目管理");e.close();g.readInfo()}.createDelegate(this),failure:function(i,j){CNOA.msg.alert(j.result.msg)}.createDelegate(this)})}};var b=new Ext.form.FormPanel({region:"center",border:false,labelWidth:60,labelAlign:"right",waitMsgTarget:true,items:[{xtype:"panel",border:false,bodyStyle:"padding:10px",layout:"form",items:[{xtype:"textarea",name:"content",height:"180",allowBlank:false,fieldLabel:"回复内容",width:"480"}]}]});var e=new Ext.Window({title:"发帖窗口",width:600,height:300,modal:true,layout:"border",items:[b],buttons:[{text:"提交",handler:function(){d()}},{text:lang("close"),handler:function(){e.close()}}]}).show()},discussWin:function(a){var e=this;var c=function(){if(b.getForm().isValid()){b.getForm().submit({url:e.baseUrl+"&task=discussprojadd",waitMsg:lang("waiting"),method:"POST",params:{pid:a},success:function(g,i){CNOA.msg.notice(i.result.msg,"项目管理");d.close();e.storediscuss.reload()}.createDelegate(this),failure:function(g,i){CNOA.msg.alert(i.result.msg)}.createDelegate(this)})}};var b=new Ext.form.FormPanel({region:"center",border:false,labelWidth:50,labelAlign:"right",bodyStyle:"padding:10px",waitMsgTarget:true,items:[{xtype:"textfield",name:"title",fieldLabel:lang("title"),allowBlank:false,width:"480"},{xtype:"textarea",name:"content",fieldLabel:lang("content"),width:"480",allowBlank:false,height:"180"}]});var d=new Ext.Window({title:"发帖窗口",width:600,height:300,modal:true,layout:"border",items:[b],buttons:[{text:"提交",handler:function(){c()}},{text:lang("close"),handler:function(){d.close()}}]}).show()},costPanel:function(d){var g=this;var b=g.baseUrl+"&task=loadPage&pid="+d+"&from=";var k=Ext.id();var e=[{name:"bid"},{name:"sname"},{name:"title"},{name:"r_cost"},{name:"t_cost"},{name:"status"},{name:"costnotes"}];var m=new Ext.data.GroupingStore({autoLoad:true,proxy:new Ext.data.HttpProxy({url:b+"viewcost"}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:e}),sortInfo:{field:"bid",direction:"ASC"},groupOnSort:false,groupField:"sname",sortData:function(){},listeners:{load:function(p,n,o){Ext.getCmp(k).getEl().update("项目的预算总花费: "+p.reader.jsonData.t_r_cost+"元&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;实际总花费："+p.reader.jsonData.t_t_cost+"元(只显示审批通过的费用)");g.columrecord=n}}});var c=new Ext.grid.CheckboxSelectionModel({singleSelect:false});var l=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"bid",dataIndex:"bid",hidden:true},{header:"",dataIndex:"sname",hidden:true},{header:"费用名称",dataIndex:"title",width:120,sortable:true,menuDisabled:true},{header:"预算费用（元）",dataIndex:"r_cost",width:100,sortable:true,menuDisabled:true},{header:"实际费用（元）",dataIndex:"t_cost",width:120,sortable:true,menuDisabled:true},{header:"状态",dataIndex:"status",width:80,sortable:true,menuDisabled:true},{header:"费用说明",dataIndex:"costnotes",width:200,sortable:true,menuDisabled:true,renderer:this.description.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);var j=new Ext.grid.GridPanel({border:false,store:m,loadMask:{msg:lang("waiting")},cm:l,sm:c,stripeRows:true,hideBorders:true,tbar:[{xtype:"box",id:k,autoEl:{tag:"div",html:""}}],view:new Ext.grid.GroupingView({forceFit:false,startCollapsed:true})});var a=new Ext.Panel({region:"center",layout:"fit",items:[j],tbar:[{text:lang("refresh"),iconCls:"icon-system-refresh",handler:function(n,o){m.reload()}},{text:"所有费用",enableToggle:true,allowDepress:false,pressed:true,iconCls:"icon-expand-members",toggleGroup:"project_proj_myproj_cost_status",tooltip:"列出该项目的所有费用，包括未审批的",handler:function(n,o){m.load({params:{type:"all"}})}},{text:"审批通过费用",enableToggle:true,allowDepress:false,iconCls:"icon-expand-members",toggleGroup:"project_proj_myproj_cost_status",tooltip:"列出该项目通过审批的费用",handler:function(n,o){m.load({params:{type:"checked"}})}},{text:"列表模式",enableToggle:true,allowDepress:false,iconCls:"icon-system-s-report",toggleGroup:"project_proj_myproj_expand",tooltip:"列表模式",handler:function(n,o){m.clearGrouping()}},{text:"分组模式",pressed:true,enableToggle:true,allowDepress:false,iconCls:"icon-view-form-png",toggleGroup:"project_proj_myproj_expand",tooltip:"分组模式",handler:function(n,o){m.groupBy("sname",true);j.view.collapseAllGroups()}},{text:"展开所有分组",enableToggle:true,allowDepress:false,iconCls:"icon-style-tree",toggleGroup:"project_proj_myproj_expand",tooltip:"展开所有分组",handler:function(n,o){m.groupBy("sname",true);j.view.expandAllGroups()}}]});var i=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",autoScroll:false,items:[a]});return i},description:function(e,c,a,g,b,d){return"<a href='javascript:void(0)' onclick='CNOA_project_proj_viewproj.costnotes("+a.data.bid+")'>"+e+"</a>"},costnotes:function(a){var b=this;Ext.each(b.columrecord,function(c,d){if(c.data.bid==a){b.costnoteswindow(c.data.costnotes,c.data.title)}})},costnoteswindow:function(b,a){var c=this;this.window=new Ext.Window({title:"费用名称("+a+")",width:600,height:300,layout:"border",modal:true,items:[new Ext.Panel({region:"center",autoScroll:true,html:"<div><p>&nbsp;&nbsp;&nbsp;"+b+"</p></div>",layout:"fit",border:false})],buttons:[{text:lang("close"),handler:function(){c.window.close()}}]}).show()},taskPanel:function(b){var i=this;var a=[{name:"tid"},{name:"title"},{name:"stime"},{name:"etime"},{name:"level"},{name:"status"},{name:"progress"},{name:"execman"}];this.taskStore=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:i.baseUrl+"&task=taskprojlist&pid="+b}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:a}),listeners:{load:function(l,j,k){}}});var g=new Ext.grid.CheckboxSelectionModel({singleSelect:false});var c=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"tid",dataIndex:"tid",hidden:true},{header:"任务标题",dataIndex:"title",width:200,sortable:true,menuDisabled:true,renderer:this.viewTaskDeltails.createDelegate(this)},{header:"任务开始时间",dataIndex:"stime",width:120,sortable:false,menuDisabled:true},{header:"任务结束时间",dataIndex:"etime",width:120,sortable:false,menuDisabled:true},{header:"任务等级",dataIndex:"level",width:60,sortable:false,menuDisabled:true},{header:"状态",dataIndex:"status",width:120,sortable:false,menuDisabled:true},{header:"进度",dataIndex:"progress",width:80,sortable:false,menuDisabled:true},{header:"负责人",dataIndex:"execman",width:100,sortable:false,menuDisabled:true},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);var e=new Ext.grid.GridPanel({region:"center",layout:"fit",border:false,store:this.taskStore,loadMask:{msg:lang("waiting")},cm:c,sm:g,stripeRows:true,hideBorders:true,tbar:[{text:lang("refresh"),iconCls:"icon-system-refresh",handler:function(j,k){i.taskStore.reload()}}]});var d=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",autoScroll:false,items:[e]});return d},viewTaskDeltails:function(d,e,a){var b=a.data;return"<a href='javascript:void(0)' onclick='CNOA_project_proj_viewproj.viewTaskDeltailsWin("+b.tid+")'>"+d+"</a>"},viewTaskDeltailsWin:function(d){var i=this;var g=i.baseUrl+"&task=viewTask&tid="+d;var c=Ext.id();var b=true;var e="任务所有信息";var a=new Ext.Panel({border:false,height:600,html:'<div style="width:100%;height:100%;"><iframe scrolling=auto frameborder=0 width=100% height=100% id="'+c+'"></iframe></div>',listeners:{afterrender:function(){if(b){Ext.getDom(c).contentWindow.location.href=g;b=false}}}});this.win=new Ext.Window({title:e,width:800,height:makeWindowHeight(600),resizable:true,modal:true,maximizable:true,items:[a]}).show()},askPanel:function(c){var j=this;var b=[{name:"aid"},{name:"title"},{name:"askname"},{name:"posttime"},{name:"status"}];this.askStore=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:j.baseUrl+"&task=askprojlist&pid="+c}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:b}),listeners:{load:function(m,k,l){}}});var i=new Ext.grid.CheckboxSelectionModel({singleSelect:false});var d=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"aid",dataIndex:"aid",hidden:true},{header:"问题标题",dataIndex:"title",width:300,sortable:true,menuDisabled:true},{header:"提问人",dataIndex:"askname",width:100,sortable:false,menuDisabled:true},{header:"提问时间",dataIndex:"posttime",width:100,sortable:false,menuDisabled:true},{header:"状态",dataIndex:"status",width:60,sortable:false,menuDisabled:true},{header:lang("opt"),dataIndex:"aid",width:140,renderer:this.viewAsk.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);var g=new Ext.grid.GridPanel({border:false,store:this.askStore,loadMask:{msg:lang("waiting")},cm:d,sm:i,stripeRows:true,hideBorders:true,tbar:[{text:lang("refresh"),iconCls:"icon-system-refresh",handler:function(k,l){j.askStore.reload()}}]});var a=new Ext.Panel({region:"center",layout:"fit",items:[g]});var e=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",autoScroll:false,items:[a]});return e},viewAsk:function(e,c,a,i,b,d){var g=this;return"<a href='javascript:void(0)' onclick='CNOA_project_proj_viewproj.viewAskDetail("+e+")'>查看</a>"},viewAskDetail:function(d){var g=this;var a=new Ext.XTemplate('<div class="user_task_discuss_view">','  <div class="user_task_discuss_view_header">','    <div class="user_task_discuss_view_header_title">[问题标题]&nbsp;&nbsp;{title}&nbsp;&nbsp;[{status}]</div>',"  </div>",'  <div class="user_task_discuss_view_body">','    <div class="user_task_discuss_view_body_left">','      <div class="user_task_discuss_view_body_left_top">{postname}[{job}]</div>','      <div class="user_task_discuss_view_body_left_body">','        <span><img src="{face}" width="120" height="130" onerror="this.src=\'./resources/images/default.jpg\'" /></span>',"      </div>","    </div>",'    <div class="user_task_discuss_view_body_right">','      <div class="user_task_discuss_view_body_right_top">#{[xindex]}&nbsp;&nbsp;<a>{postname}</a>&nbsp;&nbsp;发表于&nbsp;{time}</div>','      <div class="user_task_discuss_view_body_right_body">{content}</div>',"    </div>",'    <div class="clear"></div>',"  </div>",'  <tpl for="list">','  <div class="user_task_discuss_view_body">','    <div class="user_task_discuss_view_body_left">','      <div class="user_task_discuss_view_body_left_top">{postname}[{job}]</div>','      <div class="user_task_discuss_view_body_left_body">','        <span><img src="{face}" width="120" height="130" onerror="this.src=\'./resources/images/default.jpg\'" /></span>',"      </div>","    </div>",'    <div class="user_task_discuss_view_body_right">','      <div class="user_task_discuss_view_body_right_top">#{[xindex]}&nbsp;&nbsp;<a>{postname}</a>&nbsp;&nbsp;发表于&nbsp;{time}</div>','      <div class="user_task_discuss_view_body_right_body">{content}</div>',"    </div>",'    <div class="clear"></div>',"  </div>","  </tpl>","</div>");var b=function(){e.getEl().mask(lang("waiting"));Ext.Ajax.request({url:g.baseUrl+"&task=getAskInfo",method:"POST",params:{aid:d},success:function(k){var i=Ext.decode(k.responseText);if(i.success===true){var j=i.data;a.overwrite(e.body,j);e.getEl().unmask()}else{CNOA.msg.alert(i.msg,function(){})}}})};var e=new Ext.Panel({region:"center",layout:"fit",border:false,autoScroll:true,listeners:{render:function(){b()}}});var c=new Ext.Window({title:"项目：问题查看（双击可最大化窗口）",width:800,height:makeWindowHeight(650),resizable:true,modal:true,layout:"border",maximizable:true,items:[e],buttons:[{text:lang("refresh"),handler:function(){b()}},{text:lang("close"),handler:function(){c.close()}.createDelegate(this)}]}).show()},formatday:function(e,c,a,g,b,d){if(a.data.tday>a.data.pday){if(e<0){return""}return"<span class='cnoa_color_red'><b>"+e+"</b></span>"}else{if(e<0){return""}return"<span class='cnoa_color_green'><b>"+e+"</b></span>"}}};var CNOA_project_proj_setting_permit,CNOA_project_proj_setting_permitClass;var CNOA_project_proj_setting_permit_new;CNOA_project_proj_setting_permit_newClass=CNOA.Class.create();CNOA_project_proj_setting_permit_newClass.prototype={init:function(){var a=this;this.baseUrl="index.php?app=project&func=proj&action=setting";this.ID_textarea_deptNames=Ext.id();this.ID_button_deptNames=Ext.id();this.baseFieldNew=[{xtype:"fieldset",title:"授权范围[人员]",defaults:{style:{marginBottom:"10px"}},items:[{xtype:"textarea",height:115,anchor:"-10",readOnly:true,fieldLabel:"授权人员",name:"allUserNames"},{xtype:"hidden",name:"allUids"},{xtype:"btnForPoepleSelector",autoWidth:true,dataUrl:this.baseUrl+"&task=getAllUserListsInPermitDeptTree",style:"margin-left:95px;",cls:"btn-red1",text:lang("selectPeople"),listeners:{selected:function(d,e){var g=new Array();var c=new Array();if(e.length>0){for(var b=0;b<e.length;b++){g.push(e[b].uname);c.push(e[b].uid)}}a.newPanel.getForm().findField("allUserNames").setValue(g.join(","));a.newPanel.getForm().findField("allUids").setValue(c.join(","))},onrender:function(b){b.setSelectedUids(a.newPanel.getForm().findField("allUids").getValue().split(","))}}},{xtype:"displayfield",fieldLabel:"说明",value:"设置哪些人员可以发起项目"},{xtype:"hidden",listeners:{render:function(){a.loadFormData()}}}]}];this.newPanel=new Ext.form.FormPanel({title:"立项申请权限",hideBorders:true,border:false,waitMsgTarget:true,autoScroll:true,layout:"border",labelWidth:90,labelAlign:"right",items:[{xtype:"panel",border:false,bodyStyle:"padding:10px",layout:"form",region:"center",items:[this.baseFieldNew]}],tbar:new Ext.Toolbar({items:[{text:lang("save"),iconCls:"icon-win-save",cls:"btn-blue4",handler:function(){a.submit()}.createDelegate(this)},"->",{xtype:"cnoa_helpBtn",helpid:2012}]})})},loadFormData:function(a){var b=this;this.newPanel.getForm().load({url:b.baseUrl+"&task=loadNewPriv",method:"POST",waitTitle:lang("notice"),success:function(c,d){},failure:function(c,d){CNOA.msg.alert(d.result.msg,function(){})}})},submit:function(){var a=this;if(this.newPanel.getForm().isValid()){this.newPanel.getForm().submit({url:a.baseUrl+"&task=submitNewPriv",waitTitle:lang("notice"),method:"POST",waitMsg:lang("waiting"),params:{},success:function(b,c){CNOA.msg.notice(c.result.msg,"项目管理")},failure:function(b,c){CNOA.msg.alert(c.result.msg,function(){})}.createDelegate(this)})}}};var CNOA_project_proj_setting_permit_pass;CNOA_project_proj_setting_permit_passClass=CNOA.Class.create();CNOA_project_proj_setting_permit_passClass.prototype={init:function(){var a=this;this.baseUrl="index.php?app=project&func=proj&action=setting";this.storePass=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getPrivPassList"}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:[{name:"id",mapping:"id"},{name:"uid",mapping:"uid"},{name:"uname",mapping:"uname"}]})});this.smPass=new Ext.grid.CheckboxSelectionModel({singleSelect:true});this.columPass=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),this.smPass,{header:"id",dataIndex:"id",sortable:true,hidden:true},{header:lang("truename"),dataIndex:"uname",width:440,sortable:true},{header:lang("del"),dataIndex:"id",width:100,sortable:true,renderer:this.makeOperate.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.grid=new Ext.grid.GridPanel({store:this.storePass,sm:this.smPass,loadMask:{msg:lang("waiting")},region:"center",hideBorders:true,border:false,stripeRows:true,colModel:this.columPass,bodyStyle:"border-top-width:1px;",viewConfig:{forceFit:true},listeners:{}});this.addPanel=new Ext.form.FormPanel({region:"north",border:false,autoScroll:true,height:90,labelWidth:10,bodyStyle:"padding: 10px;",labelAlign:"right",items:[{xtype:"compositefield",items:[{xtype:"userselectorfield",width:362,name:"passUid",multiSelect:false},{xtype:"button",text:lang("add"),style:"margin-left:5px",iconCls:"icon-utils-s-add",handler:function(){a.addPass()}}]},{xtype:"displayfield",value:"选择某一个拥有审批权限的人，确定后点击"+lang("add")+"按钮，即可添加到下面列表中"}],tbar:new Ext.Toolbar({items:[{handler:function(b,c){a.storePass.reload()}.createDelegate(this),iconCls:"icon-system-refresh",text:lang("refresh")},"设置审批项目的人员，只有出现在下面列表中的人员，才有权限审批项目","->",{xtype:"cnoa_helpBtn",helpid:83}]})});this.passPanel=new Ext.Panel({layout:"border",title:"审批项目权限",items:[a.addPanel,a.grid]})},makeOperate:function(e,c,a,g,b,d){return"<a href='javascript:void(0);' onclick='CNOA_project_proj_setting_permit_pass.del("+e+");'>删除</a>"},addPass:function(){var b=this;var a=b.addPanel.getForm();if(a.isValid()){if(a.findField("passUid").getValue()==0){CNOA.msg.alert("请选择要添加的人员");return}a.submit({url:b.baseUrl+"&task=addPassPriv",waitTitle:lang("notice"),method:"POST",waitMsg:lang("waiting"),params:{},success:function(c,d){a.findField("passUid").setValue("");b.storePass.reload()},failure:function(c,d){CNOA.msg.alert(d.result.msg,function(){b.storePass.reload()})}})}},del:function(b){var a=this;CNOA.msg.cf("确定取消此人员的审批资格吗？",function(c){if(c=="yes"){Ext.Ajax.request({url:a.baseUrl+"&task=delPassPriv",method:"POST",params:{id:b},success:function(e){var d=Ext.decode(e.responseText);if(d.success===true){a.storePass.reload()}else{CNOA.msg.alert(d.msg)}}})}})}};var CNOA_project_proj_setting_permit_cost;CNOA_project_proj_setting_permit_costClass=CNOA.Class.create();CNOA_project_proj_setting_permit_costClass.prototype={init:function(){var a=this;this.baseUrl="index.php?app=project&func=proj&action=setting";this.ID_textarea_deptNames=Ext.id();this.ID_button_deptNames=Ext.id();this.baseFieldCost=[{xtype:"panel",border:false,hideBorders:true,height:300,bodyStyle:"background:none;",items:[{xtype:"fieldset",title:"费用审核人员设置",border:true,style:"marginBottom: 10px",items:[{xtype:"textarea",anchor:"-10",readOnly:true,fieldLabel:"授权人员",name:"allUserNames"},{xtype:"hidden",name:"allUids"},{xtype:"btnForPoepleSelector",dataUrl:this.baseUrl+"&task=getAllUserListsInPermitDeptTree",style:"margin-left:95px;",cls:"btn-red1",text:lang("selectPeople"),listeners:{selected:function(d,e){var g=new Array();var c=new Array();if(e.length>0){for(var b=0;b<e.length;b++){g.push(e[b].uname);c.push(e[b].uid)}}a.costPanel.getForm().findField("allUserNames").setValue(g.join(","));a.costPanel.getForm().findField("allUids").setValue(c.join(","))},onrender:function(b){b.setSelectedUids(a.costPanel.getForm().findField("allUids").getValue().split(","))}}},{xtype:"displayfield",fieldLabel:"说明",value:"设置哪些人员可以审核项目费用预算及实际开销"},{xtype:"hidden",listeners:{render:function(){a.loadFormData()}}}]}]}];this.baseFieldCost2=[{xtype:"textfield",width:200}];this.costPanel=new Ext.form.FormPanel({title:"费用审核权限",hideBorders:true,border:false,waitMsgTarget:true,autoScroll:true,layout:"border",labelWidth:90,labelAlign:"right",items:[{xtype:"panel",border:false,bodyStyle:"padding:10px",layout:"form",region:"center",items:a.baseFieldCost}],tbar:new Ext.Toolbar({items:[{text:lang("save"),iconCls:"icon-win-save",cls:"btn-blue4",handler:function(){a.submit()}.createDelegate(this)},"->",{xtype:"cnoa_helpBtn",helpid:83}]})})},loadFormData:function(a){var b=this;this.costPanel.getForm().load({url:b.baseUrl+"&task=loadCostPriv",method:"POST",waitTitle:lang("notice"),success:function(c,d){},failure:function(c,d){CNOA.msg.alert(d.result.msg,function(){})}})},submit:function(){var a=this;if(this.costPanel.getForm().isValid()){this.costPanel.getForm().submit({url:a.baseUrl+"&task=submitCostPriv",waitTitle:lang("notice"),method:"POST",waitMsg:lang("waiting"),params:{},success:function(b,c){CNOA.msg.notice(c.result.msg,"项目管理")},failure:function(b,c){CNOA.msg.alert(c.result.msg,function(){})}.createDelegate(this)})}}};CNOA_project_proj_setting_permitClass=CNOA.Class.create();CNOA_project_proj_setting_permitClass.prototype={init:function(){var a=this;this.baseUrl="index.php?app=project&func=proj&action=setting";CNOA_project_proj_setting_permit_new=new CNOA_project_proj_setting_permit_newClass();CNOA_project_proj_setting_permit_pass=new CNOA_project_proj_setting_permit_passClass();CNOA_project_proj_setting_permit_cost=new CNOA_project_proj_setting_permit_costClass();this.centerPanel=new Ext.TabPanel({region:"center",border:false,resizeTabs:true,deferredRender:false,minTabWidth:100,tabWidth:100,activeItem:0,items:[CNOA_project_proj_setting_permit_new.newPanel,CNOA_project_proj_setting_permit_pass.passPanel,CNOA_project_proj_setting_permit_cost.costPanel]});this.mainPanel=new Ext.Panel({border:false,layout:"border",items:[this.centerPanel]})}};var CNOA_project_proj_setting_code,CNOA_project_proj_setting_codeClass;CNOA_project_proj_setting_code_type_projClass=CNOA.Class.create();CNOA_project_proj_setting_code_type_projClass.prototype={init:function(b,a){var c=this;this.title=b;this.storeLoaded=false;this.baseUrl="index.php?app=project&func=proj&action=setting&task=setType&type="+a;this.dsc=Ext.data.Record.create([{name:"sname",type:"sname"},{name:"sno",type:"sno"}]);this.fields=[{name:"sid",mapping:"sid"},{name:"sno",mapping:"sno"},{name:"sname",mapping:"sname"},{name:"sorder",mapping:"sorder"}];this.store=new Ext.data.GroupingStore({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&job=getList"}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields}),listeners:{update:function(i,d,g){var e=d.data;if(g==Ext.data.Record.EDIT){c.submit(e)}}}});this.editor=new Ext.ux.grid.RowEditor({cancelText:lang("cancel"),saveText:lang("update"),errorSummary:false});this.sm=new Ext.grid.CheckboxSelectionModel({});this.cm=[new Ext.grid.RowNumberer(),this.sm,{header:"",dataIndex:"sid",hidden:true},{id:"sname",header:"代码名称",dataIndex:"sname",width:200,sortable:true,editor:{xtype:"textfield",allowBlank:false}},{header:"代码排序",dataIndex:"sorder",width:200,sortable:true,editor:{xtype:"textfield",vtype:"num",vtypeText:"代码排序只能为数字",allowBlank:false}}];this.grid=new Ext.grid.GridPanel({title:this.title,store:this.store,plain:false,stripeRows:true,loadMask:{msg:lang("waiting")},border:false,autoScroll:true,autoExpandColumn:"sname",plugins:[this.editor],columns:this.cm,view:new Ext.grid.GroupingView({markDirty:false}),listeners:{activate:function(){if(c.storeLoaded==false){c.store.load();c.storeLoaded=true}}},tbar:new Ext.Toolbar({items:[{handler:function(d,e){c.store.reload()}.createDelegate(this),iconCls:"icon-system-refresh",text:lang("refresh")},{iconCls:"icon-utils-s-add",text:lang("add"),handler:function(){var d=new c.dsc({sname:"",sno:"",sorder:0});c.editor.stopEditing();c.store.insert(0,d);c.grid.getView().refresh();c.grid.getSelectionModel().selectRow(0);c.editor.startEditing(0)}},{iconCls:"icon-utils-s-delete",text:lang("del"),tooltip:"删除记录(按住Ctrl或Shift键可以一次选择多条记录进行删除)",handler:function(d){c.editor.stopEditing();var e=c.grid.getSelectionModel().getSelections();if(e.length==0){CNOA.miniMsg.alertShowAt(d,lang("mustSelectOneRow"))}else{CNOA.msg.cf(lang("confirmToDelete"),function(j){if(j=="yes"){if(e){var k="";for(var g=0;g<e.length;g++){k+=e[g].get("sid")+",";var l=e[g];c.store.remove(l)}c.deleteList(k)}}})}}},"<span class='cnoa_color_gray'>双击可修改记录,按住Ctrl或Shift键可以一次选择多条记录</span>","->",{xtype:"cnoa_helpBtn",helpid:2013}]})})},submit:function(a){var b=this;Ext.Ajax.request({url:this.baseUrl+"&job=submit",params:a,method:"POST",success:function(e,d){var c=Ext.decode(e.responseText);if(c.success===true){b.store.reload()}else{CNOA.msg.alert(c.msg,function(){b.store.reload()})}},failure:function(c,d){CNOA.msg.alert(result.msg,function(){b.store.reload()})}})},deleteList:function(a){var b=this;Ext.Ajax.request({url:this.baseUrl+"&job=delete",method:"POST",params:{ids:a},success:function(d){var c=Ext.decode(d.responseText);if(c.success===true){b.store.reload()}else{CNOA.msg.alert(c.msg)}}})}};CNOA_project_proj_setting_codeClass=CNOA.Class.create();CNOA_project_proj_setting_codeClass.prototype={init:function(){var d=this;this.baseUrl="index.php?app=project&func=proj&action=setting";var c=new CNOA_project_proj_setting_code_type_projClass("项目类型","proj_type");var b=new CNOA_project_proj_setting_code_type_projClass("项目角色类型","proj_role");var a=new CNOA_project_proj_setting_code_type_projClass("项目费用类型","proj_cost");this.centerPanel=new Ext.TabPanel({region:"center",border:false,resizeTabs:true,deferredRender:false,minTabWidth:100,tabWidth:100,activeItem:0,items:[c.grid,b.grid,a.grid]});this.mainPanel=new Ext.Panel({border:false,layout:"border",items:[this.centerPanel]})}};var CNOA_project_proj_mytaskClass,CNOA_project_proj_mytask;CNOA_project_proj_mytaskClass=CNOA.Class.create();CNOA_project_proj_mytaskClass.prototype={init:function(){var i=this;this.edit_id=0;this.content_start=1;this.baseUrl="index.php?app=project&func=proj&action=main&module=mytask";this.ID_btn_edit=Ext.id();this.ID_btn_delete=Ext.id();this.ID_plan_content=Ext.id();var c=Ext.id();var b=Ext.id();var e=Ext.id();var k=Ext.id();this.unaccept=0;this.opentype=CNOA.project.proj.mytask.opentype;this.search={pid:0,status:"",title:"",uid:0,level:0,status:0};this.projectComboBoxDataStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:i.baseUrl+"&task=getProjectList"}),reader:new Ext.data.JsonReader({root:"data",fields:[{name:"pid"},{name:"name"}]})});this.projectComboBoxDataStore.load();this.fields=[{name:"tid"},{name:"pid"},{name:"proj"},{name:"title"},{name:"status"},{name:"level"},{name:"progress"},{name:"execman"},{name:"postter"},{name:"ttime"},{name:"ptime"},{name:"pday"},{name:"tday"},{name:"statusText"},{name:"statusColor"},{name:"urgeenable"},{name:"askenable"},{name:"lateenable"},{name:"failenable"},{name:"startenable"},{name:"finishenable"},{name:"upgradetitle"},{name:"upgradewidth"},{name:"upgradecolor"}];this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getJsonData",disableCaching:true}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields}),listeners:{load:function(p,m,r){var o=0;var n=0;var q=0;var l=0;if(p.reader.jsonData.unaccept>0){o="<span class='cnoa_color_white'>"+p.reader.jsonData.unaccept+"</span>"}if(p.reader.jsonData.checking>0){n="<span class='cnoa_color_white'>"+p.reader.jsonData.checking+"</span>"}if(p.reader.jsonData.doing>0){q="<span class='cnoa_color_white'>"+p.reader.jsonData.doing+"</span>"}if(p.reader.jsonData.unpass>0){l="<span class='cnoa_color_white'>"+p.reader.jsonData.unpass+"</span>"}Ext.getCmp(c).setText("没接收的("+o+")");Ext.getCmp(b).setText("审批中的("+n+")");Ext.getCmp(e).setText("进行中的("+q+")");Ext.getCmp(k).setText("不通过的("+l+")")}}});this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.store.load({params:{status:i.opentype}});this.colModel=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"tid",dataIndex:"tid",hidden:true},{header:lang("opt"),dataIndex:"",width:400,sortable:false,menuDisabled:true,renderer:this.makeOperate.createDelegate(this)},{header:"任务标题",dataIndex:"title",width:160,sortable:true,menuDisabled:true},{header:"所属项目",dataIndex:"proj",width:100,sortable:true,menuDisabled:true,renderer:this.project.createDelegate(this)},{header:"任务进度",dataIndex:"progress",width:100,sortable:false,menuDisabled:true,renderer:this.makeStatus.createDelegate(this)},{header:"布置人",dataIndex:"postter",width:80,sortable:false,menuDisabled:true},{header:"任务级别",dataIndex:"level",width:80,sortable:false,menuDisabled:true},{header:"任务状态",dataIndex:"status",width:80,sortable:false,menuDisabled:true},{header:"计划时间",dataIndex:"ptime",width:120,sortable:false,menuDisabled:true},{header:"计划工时(天)",dataIndex:"pday",width:80,sortable:false,menuDisabled:true},{header:"实际时间",dataIndex:"ttime",width:120,sortable:false,menuDisabled:true},{header:"实际工时(天)",dataIndex:"tday",width:80,sortable:false,menuDisabled:true,renderer:this.formatday.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.pagingBar=new Ext.PagingToolbar({displayInfo:true,store:this.store,pageSize:15,listeners:{beforechange:function(l,m){if(i.search.title!=""){m.title=i.search.title}if(i.search.uid!=0&&i.search.uid!=""){m.uid=i.search.uid}if(i.search.level!=0&&i.search.level!=""){m.level=i.search.level}if(i.search.status!=0&&i.search.status!=""){m.status=i.search.status}}}});var d=Ext.id();var g=Ext.id();var a=Ext.id();var j=Ext.id();this.searchBar=new Ext.Toolbar({items:["任务名称:",{xtype:"textfield",id:g,width:128},"&nbsp;布置人:",{xtype:"hidden",id:a},{xtype:"triggerForPeople",dataUrl:this.baseUrl+"&task=getAllUserListsInPermitDeptTree",width:100,id:a+"Tr",listeners:{selected:function(n,m,l){Ext.getCmp(a).setValue(m)}}},"&nbsp;任务级别:",{xtype:"panel",border:false,items:[new Ext.form.ComboBox({name:"level",store:new Ext.data.SimpleStore({fields:["value","level"],data:[["1","次要"],["2","一般"],["3","重要"],["4","非常重要"]]}),width:100,id:j,hiddenName:"level",valueField:"value",displayField:"level",mode:"local",triggerAction:"all",forceSelection:true,editable:false})]},{xtype:"button",text:lang("search"),style:"margin-left:5px",handler:function(){i.search.title=Ext.getCmp(g).getValue();i.search.uid=Ext.getCmp(a).getValue();i.search.level=Ext.getCmp(j).getValue();i.search.status=i.search.status;i.store.load({params:{status:i.search.status,title:i.search.title,uid:i.search.uid,level:i.search.level}})}},{xtype:"button",text:lang("clear"),style:"margin-left:5px",handler:function(){Ext.getCmp(g).setValue("");Ext.getCmp(a).setValue("");Ext.getCmp(j).setValue("");Ext.getCmp(a+"Tr").setValue("");i.search.title="";i.search.uid=0;i.search.level=0;i.store.load({params:{status:i.search.status}})}},"<span class='cnoa_color_gray'>提示:任务需要及时汇报任务进度，提问的问题可以在项目问题里面显示</span>"]});this.grid=new Ext.grid.GridPanel({store:this.store,loadMask:{msg:lang("waiting")},cm:this.colModel,sm:this.sm,stripeRows:true,hideBorders:true,border:false,viewConfig:{},listeners:{render:function(){i.searchBar.render(this.tbar)}},tbar:new Ext.Toolbar({items:[{handler:function(l,m){i.store.reload()}.createDelegate(this),iconCls:"icon-system-refresh",text:lang("refresh")},{xtype:"panel",border:false,items:[new CNOA.form.ComboBox({name:"pid",allowBlank:false,emptyText:"请选择项目名称.....",store:i.projectComboBoxDataStore,id:d,hiddenName:"pid",valueField:"pid",displayField:"name",mode:"local",width:280,allowBlank:true,triggerAction:"all",forceSelection:true,editable:false,listeners:{select:function(n,l,m){i.search.pid=n.getValue();i.store.load({params:i.search})}.createDelegate(this)}})]},{text:lang("clear"),handler:function(l){Ext.getCmp(d).setValue("");i.search.pid="";i.store.load({params:i.search})}},{text:"进行中的",iconCls:"icon-ongoing",cls:"btn-red1",tooltip:"显示正在进行中和被立项人催促的任务",id:e,enableToggle:true,pressed:i.opentype=="doing"?true:false,allowDepress:false,toggleGroup:"project_proj_mytask_type",handler:function(){i.search.status="doing";i.store.load({params:i.search})}},{text:"审批中",cls:"btn-yellow1",iconCls:"icon-waiting",tooltip:"显示已完成，但仍在审批中的任务列表",id:b,enableToggle:true,allowDepress:false,toggleGroup:"project_proj_mytask_type",handler:function(){i.search.status="checking";i.store.load({params:i.search})}},{text:"没接收的",cls:"btn-blue3",iconCls:"icon-unaccept",tooltip:"显示还没有接收的任务",id:c,pressed:i.opentype=="unaccept"?true:false,enableToggle:true,allowDepress:false,toggleGroup:"project_proj_mytask_type",handler:function(){i.search.status="unaccept";i.store.load({params:i.search})}},{text:"不通过",cls:"btn-gray1",iconCls:"icon-noPass",tooltip:"显示失败，或者审批不通过的任务",id:k,enableToggle:true,allowDepress:false,toggleGroup:"project_proj_mytask_type",handler:function(){i.search.status="unpass";i.store.load({params:i.search})}},{text:"已完成的",cls:"btn-blue3",iconCls:"icon-pass",tooltip:"显示已完成的任务",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_mytask_type",handler:function(){i.search.status="finish";i.store.load({params:i.search})}},"->",{xtype:"cnoa_helpBtn",helpid:2007}]}),bbar:this.pagingBar});this.centerPanel=new Ext.Panel({region:"center",layout:"fit",items:[this.grid]});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.centerPanel]})},makeStatus:function(j,g,c,i,e,b){var l=c.data;var k=0;var a="#5B5B5B";upgradetitle=l.upgradetitle;k=l.upgradewidth;a=l.upgradecolor;var d="<div style='color:#808080;margin-top:3px;'>"+upgradetitle+"</div>";d+="<div style='width:100px;height:5px;background-color:#D4D4D4;'><div style='font-size:0;line-height:0;height:5px;width:"+k+"px;background-color:"+a+";'></div></div>";return d},project:function(g,d,a,i,b,e){var c=a.data;return"<a href='javascript:void(0);' class='gridview' onclick='CNOA_project_proj_mytask.projectwin("+c.pid+");'>"+g+"</a>"},projectwin:function(a){var d=this;var c=d.baseUrl+"&task=viewProjectDetail&pid="+a;var b="所属项目信息";this.win=new Ext.Window({title:b,width:800,height:makeWindowHeight(600),resizable:true,modal:true,maximizable:true,html:'<div style="width:100%;height:100%;"><iframe scrolling=auto frameborder=0 width=100% height=100% src="'+c+'"></iframe></div>'}).show()},makeOperate:function(l,i,d,j,g,b){var n=d.data;var e=false;var a=false;var k=false;var m=false;e=n.urgeenable;am=n.askenable;lm=n.lateenable;k=n.failenable;a=n.startenable;m=n.finishenable;var c="";c+=e?"<a href='javascript:void(0);' class='gridview3' onclick='CNOA_project_proj_mytask.urgeTask("+n.tid+");'><span>汇报进度</span></a>":"<span class='gridview5'>汇报进度</span>";c+="<a href='javascript:void(0);' class='gridview jianju' onclick='CNOA_project_proj_mytask.viewTask("+n.tid+");'>查看</a>";c+=am?"<a href='javascript:void(0);' class='gridview3 jianju' onclick='CNOA_project_proj_mytask.askTask("+n.tid+");'>我要提问</a>":"<span class='gridview5 jianju'>我要提问</span>";c+=a?"<a href='javascript:void(0);' class='gridview jianju' onclick='CNOA_project_proj_mytask.startTask("+n.tid+");'>接收任务</a>":"<span class='gridview5 jianju'>接收任务</span>";c+=m?"<a href='javascript:void(0);' class='gridview3 jianju' onclick='CNOA_project_proj_mytask.finishTask("+n.tid+");'>任务完成,提交审批</a>":"<span class='gridview5 jianju'>任务完成,提交审批</span>";return c},askTask:function(d){var e=this;var a=new Ext.form.FormPanel({border:false,hideBorders:true,labelWidth:10,labelAlign:"top",waitMsgTarget:true,items:[{xtype:"panel",border:false,layout:"form",bodyStyle:"padding:10px",items:[{xtype:"textfield",width:580,name:"title",allowBlank:false,fieldLabel:"问题标题"},{xtype:"textarea",width:580,height:300,allowBlank:false,fieldLabel:"问题内容",name:"content"},{xtype:"textarea",width:580,height:50,fieldLabel:"问题参与者",readOnly:true,allowBlank:false,style:"margin-top:5px;",blankText:"请选择问题参与者",name:"viewNames"},new Ext.BoxComponent({autoEl:{tag:"div",style:"float:right;color:#676767;",html:"提示：问题参与者可以对该问题进行查看,回答和提问的操作"}}),{xtype:"hidden",name:"viewIDs"},{xtype:"btnForPoepleSelector",autoWidth:true,dataUrl:e.baseUrl+"&task=memberJobList&tid="+d,style:"float:left",text:"选择问题参与人",listeners:{selected:function(k,l){var m=new Array();var j=new Array();if(l.length>0){for(var g=0;g<l.length;g++){m.push(l[g].uname);j.push(l[g].uid)}}a.getForm().findField("viewNames").setValue(m.join(","));a.getForm().findField("viewIDs").setValue(j.join(","))}}}]}]});var c=new Ext.Window({width:620,height:makeWindowHeight(600),title:"我要提问",resizable:true,modal:true,layout:"fit",items:a,buttons:[{text:"提交",iconCls:"icon-order-s-accept",handler:function(){b()}.createDelegate(this)},{text:lang("cancel"),iconCls:"icon-dialog-cancel",handler:function(){c.close()}.createDelegate(this)}]}).show();var b=function(){if(a.getForm().isValid()){a.getForm().submit({url:e.baseUrl+"&task=setask",method:"POST",params:{tid:d},success:function(i,j){var g=j.result;if(g.success===true){CNOA.msg.notice(g.msg,"项目管理");e.store.reload();c.close()}else{CNOA.msg.alert(g.msg)}}})}}},deleteTask:function(b,a){var c=this;CNOA.msg.cf("确定删除本任务吗？",function(d){if(d=="yes"){Ext.Ajax.request({url:c.baseUrl+"&task=operateTask&tid="+b,method:"POST",params:{tid:b,job:"delete",status:a},success:function(g){var e=Ext.decode(g.responseText);if(e.success===true){CNOA.msg.notice(e.msg,"项目管理");c.store.reload()}else{CNOA.msg.alert(e.msg)}}})}})},repealTask:function(b,a){var c=this},urgeTask:function(d){var e=this;var a=new Ext.form.FormPanel({border:false,hideBorders:true,labelWidth:10,labelAlign:"top",waitMsgTarget:true,items:[{xtype:"panel",bodyStyle:"padding:10px",layout:"form",items:[{xtype:"textfield",width:150,name:"upgate",allowBlank:false,fieldLabel:"任务进度1~99(如果审批通过，则自动改成100)",regex:/^\d{1,2}$/i,regexText:"必须设置为0到99的整数数字"},{xtype:"textarea",width:560,height:200,fieldLabel:"进度汇报",name:"content"}]}]});var c=new Ext.Window({width:610,height:350,title:"任务进度",resizable:true,modal:true,layout:"fit",items:a,buttons:[{text:"提交",iconCls:"icon-order-s-accept",handler:function(){b()}.createDelegate(this)},{text:lang("cancel"),iconCls:"icon-dialog-cancel",handler:function(){c.close()}.createDelegate(this)}]}).show();var b=function(){var g=a.getForm().findField("upgate").getValue();var i=a.getForm().findField("content").getValue();Ext.Ajax.request({url:e.baseUrl+"&task=urgeTask&tid="+d,method:"POST",params:{tid:d,upgate:g,content:i},success:function(k){var j=Ext.decode(k.responseText);if(j.success===true){CNOA.msg.notice(j.msg,"项目管理");e.store.reload();c.close()}else{CNOA.msg.alert(j.msg)}}})}},startTask:function(a){var b=this;CNOA.msg.cf("您确定开始该任务吗？",function(c){if(c=="yes"){Ext.Ajax.request({url:b.baseUrl+"&task=startTask&tid="+a,method:"POST",params:{tid:a},success:function(e){var d=Ext.decode(e.responseText);if(d.success===true){CNOA.msg.notice(d.msg,"项目管理");b.store.reload()}else{CNOA.msg.alert(d.msg)}}})}})},finishTask:function(d){var e=this;var a=new Ext.form.FormPanel({border:false,hideBorders:true,labelWidth:10,waitMsgTarget:true,bodyStyle:"padding-top:20px;",items:[{xtype:"textarea",anchor:"-20 -20",name:"content"}]});var c=new Ext.Window({width:500,height:400,title:"任务完成总结",resizable:true,modal:true,layout:"fit",items:a,buttons:[{text:"提交总结",iconCls:"icon-order-s-accept",handler:function(){b()}.createDelegate(this)},{text:lang("cancel"),iconCls:"icon-dialog-cancel",handler:function(){c.close()}.createDelegate(this)}]}).show();var b=function(){var g=a.getForm().findField("content").getValue();Ext.Ajax.request({url:e.baseUrl+"&task=finishTask&tid="+d,method:"POST",params:{tid:d,content:g},success:function(j){var i=Ext.decode(j.responseText);if(i.success===true){CNOA.msg.notice(i.msg,"项目管理");e.store.reload();c.close()}else{CNOA.msg.alert(i.msg)}}})}},makeMiniWindow:function(j,k,a,c,d){var e=this;var b=new Ext.form.FormPanel({border:false,hideBorders:true,labelWidth:70,labelAlign:"right",waitMsgTarget:true,bodyStyle:"padding-top:20px;",items:[{xtype:"textarea",anchor:"-20 -20",name:"content",fieldLabel:k}]});var g=new Ext.Window({width:400,height:270,title:j,resizable:true,modal:true,layout:"fit",items:b,buttons:[{text:lang("ok"),iconCls:"icon-btn-save",handler:function(){i();g.close()}.createDelegate(this)},{text:lang("cancel"),iconCls:"icon-dialog-cancel",handler:function(){g.close()}.createDelegate(this)}]}).show();var i=function(){var l=b.getForm().findField("content").getValue();Ext.Ajax.request({url:e.baseUrl+"&task=operateTask&tid="+c,method:"POST",params:{tid:c,job:a,status:d,content:l},success:function(n){var m=Ext.decode(n.responseText);if(m.success===true){CNOA.msg.notice(m.msg,"项目管理");e.store.reload()}else{CNOA.msg.alert(m.msg)}}})}},makeDelayWindow:function(k,a,c,d,e){var g=this;var b=new Ext.form.FormPanel({border:false,hideBorders:true,labelWidth:70,labelAlign:"right",waitMsgTarget:true,bodyStyle:"padding-top:20px;",items:[{xtype:"displayfield",fieldLabel:"原结束时间",value:e},{xtype:"datefield",name:"newtime",width:160,minValue:e,format:"Y-m-d",fieldLabel:"修改为"}]});var i=new Ext.Window({width:400,height:270,title:k,resizable:true,modal:true,layout:"fit",items:b,buttons:[{text:lang("ok"),iconCls:"icon-btn-save",handler:function(){j();i.close()}.createDelegate(this)},{text:lang("cancel"),iconCls:"icon-dialog-cancel",handler:function(){i.close()}.createDelegate(this)}]}).show();var j=function(){var l=b.getForm().findField("newtime").getRawValue();Ext.Ajax.request({url:g.baseUrl+"&task=operateTask&tid="+c,method:"POST",params:{tid:c,job:a,status:d,newtime:l},success:function(n){var m=Ext.decode(n.responseText);if(m.success===true){CNOA.msg.notice(m.msg,"项目管理");g.store.reload()}else{CNOA.msg.alert(m.msg)}}})}},formatday:function(e,c,a,g,b,d){if(a.data.tday>a.data.pday){if(e<0){return""}return"<span class='cnoa_color_red'><b>"+e+"</b></span>"}else{if(e<0){return""}return"<span class='cnoa_color_green'><b>"+e+"</b></span>"}},viewTask:function(d){var i=this;var g=i.baseUrl+"&task=loadPage&from=viewTaskDetail&tid="+d;var c=Ext.id();var b=true;var e="任务所有信息";var a=new Ext.Panel({border:false,region:"center",html:'<div style="width:100%;height:100%;"><iframe scrolling=auto frameborder=0 width=100% height=100% id="'+c+'"></iframe></div>',listeners:{afterrender:function(){if(b){Ext.getDom(c).contentWindow.location.href=g;b=false}}}});this.win=new Ext.Window({title:e,layout:"border",width:800,height:makeWindowHeight(600),resizable:true,modal:true,maximizable:true,items:[a]}).show()}};var CNOA_project_proj_myprojClass,CNOA_project_proj_myproj;CNOA_project_proj_myprojClass=CNOA.Class.create();CNOA_project_proj_myprojClass.prototype={init:function(){var d=this;this.edit_id=0;this.forbit=false;this.content_start=1;this.baseUrl="index.php?app=project&func=proj&action=main&module=myproj";this.ID_btn_edit=Ext.id();this.ID_btn_delete=Ext.id();this.ID_plan_content=Ext.id();var b=Ext.id();var g=Ext.id();var a=Ext.id();var i=Ext.id();var l=Ext.id();var k=Ext.id();var e=Ext.id();var c=Ext.id();var j=Ext.id();this.opentype=CNOA.project.proj.myproj.opentype;this.status=2;this.storeBar={title:"",s_standard:0,e_standard:0,s_time:0,e_time:0,status:2};this.fields=[{name:"pid"},{name:"name"},{name:"number"},{name:"type"},{name:"ttime"},{name:"ptime"},{name:"pday"},{name:"tday"},{name:"posttime"},{name:"updatetime"},{name:"uidname"},{name:"execname"},{name:"checkname"},{name:"viewer"},{name:"status"},{name:"description"},{name:"checknum"},{name:"upgradetitle"},{name:"upgradewidth"},{name:"upgradecolor"},{name:"editable"},{name:"upgradable"},{name:"deleteable"},{name:"changeable"},{name:"startable"},{name:"finishable"}];this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getJsonData",disableCaching:true}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields}),listeners:{load:function(q,m,s){var n=0;var p=0;var r=0;var o=0;if(q.reader.jsonData.checkpass>0){n="<span class='cnoa_color_white'>"+q.reader.jsonData.checkpass+"</span>"}if(q.reader.jsonData.checkunpass>0){p="<span class='cnoa_color_white'>"+q.reader.jsonData.checkunpass+"</span>"}if(q.reader.jsonData.doing>0){r="<span class='cnoa_color_white'>"+q.reader.jsonData.doing+"</span>"}if(q.reader.jsonData.setting>0){o="<span class='cnoa_color_white'>"+q.reader.jsonData.setting+"</span>"}Ext.getCmp(k).setText("审批通过的("+n+")");Ext.getCmp(e).setText("审批不通过的("+p+")");Ext.getCmp(c).setText("进行中的("+r+")");Ext.getCmp(j).setText("立项/审批中的("+o+")")},exception:function(r,q,s,p,o,n){var m=Ext.decode(o.responseText);if(m.failure){CNOA.msg.alert(m.msg,function(){if(m.type=="forbit"){d.forbit=true}})}}}});if(this.opentype=="pass"){this.store.load({params:{status:7}})}else{this.store.load()}this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.colModel=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"pid",dataIndex:"pid",hidden:true},{header:lang("opt"),dataIndex:"",width:400,sortable:false,menuDisabled:true,renderer:this.makeOperate.createDelegate(this)},{header:"项目编号",dataIndex:"number",width:105,sortable:true,menuDisabled:true},{header:"项目名称",dataIndex:"name",width:155,sortable:true,menuDisabled:true},{header:"项目进度",dataIndex:"name",width:90,sortable:false,menuDisabled:true,renderer:this.makeStatus.createDelegate(this)},{header:"执行人",dataIndex:"execname",width:80,sortable:false,menuDisabled:true},{header:"审批人",dataIndex:"checkname",width:80,sortable:false,menuDisabled:true},{header:"计划时间",dataIndex:"ptime",width:120,sortable:false,menuDisabled:true},{header:"计划工时(天)",dataIndex:"pday",width:80,sortable:false,menuDisabled:true},{header:"实际时间",dataIndex:"ttime",width:120,sortable:false,menuDisabled:true},{header:"实际工时(天)",dataIndex:"tday",width:80,sortable:false,menuDisabled:true,renderer:this.formatday.createDelegate(this)},{header:"状态",dataIndex:"status",width:60,sortable:false,menuDisabled:true},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.pagingBar=new Ext.PagingToolbar({displayInfo:true,store:this.store,pageSize:15,listeners:{beforechange:function(m,n){n.status=d.storeBar.status;n.title=d.storeBar.title;n.s_standard=d.storeBar.s_standard;n.e_standard=d.storeBar.e_standard;n.s_time=d.storeBar.s_time;n.e_time=d.storeBar.e_time}}});this.searchBar=new Ext.Toolbar({items:["项目名称:",{xtype:"textfield",id:b,width:128},"&nbsp;项目进度从:",{xtype:"textfield",id:g,width:50,regex:/^(?:\d?\d|100)$/i,regexText:"必须设置为0到100的整数数字"},"~",{xtype:"textfield",id:a,width:50,regex:/^(?:\d?\d|100)$/i,regexText:"必须设置为0到100的整数数字"},"&nbsp;实际开始时间:",{xtype:"datefield",format:"Y-m-d",id:i,width:100},"&nbsp;实际结束时间:",{xtype:"datefield",format:"Y-m-d",id:l,width:100},{xtype:"button",text:lang("search"),style:"margin-left:5px",handler:function(){d.storeBar.title=Ext.getCmp(b).getValue();d.storeBar.s_standard=Ext.getCmp(g).getValue();d.storeBar.e_standard=Ext.getCmp(a).getValue();d.storeBar.s_time=Ext.getCmp(i).getRawValue();d.storeBar.e_time=Ext.getCmp(l).getRawValue();d.store.load({params:d.storeBar})}},{xtype:"button",text:lang("clear"),style:"margin-left:5px",handler:function(){Ext.getCmp(b).setValue("");Ext.getCmp(g).setValue("");Ext.getCmp(a).setValue("");Ext.getCmp(i).setValue("");Ext.getCmp(l).setValue("");d.storeBar.title=0;d.storeBar.s_standard=0;d.storeBar.e_standard=0;d.storeBar.s_time=0;d.storeBar.e_time=0;d.store.load({params:d.storeBar})}},"<span class='cnoa_color_gray'>提示:项目需提交审批后才能开始，项目变更需重新提交审批</span>"]});this.grid=new Ext.grid.GridPanel({store:this.store,loadMask:{msg:lang("waiting")},cm:this.colModel,sm:this.sm,stripeRows:true,hideBorders:true,border:false,viewConfig:{},listeners:{render:function(){d.searchBar.render(this.tbar)}},tbar:new Ext.Toolbar({items:[{handler:function(m,n){d.store.reload()}.createDelegate(this),iconCls:"icon-system-refresh",text:lang("refresh")},{handler:function(m,n){if(d.forbit){CNOA.msg.alert("您没有权限立项，请在项目基本设置里面的项目权限设置里面添加")}else{d.projapply(0)}},tooltip:"立即发起立项申请，立项申请包含项目基本信息，<br />项目成员，项目任务，项目文档，项目预算",iconCls:"icon-utils-s-add",cls:"btn-blue4",text:"立项申请"},{handler:function(m,n){d.storeBar.status=2;d.store.load({params:d.storeBar})}.createDelegate(this),iconCls:"icon-ongoing",id:c,enableToggle:true,pressed:d.opentype=="doing"?true:false,cls:"btn-red1",allowDepress:false,toggleGroup:"project_proj_myproj_type",tooltip:"显示正在进行中和审批通过的所有项目列表",text:"进行中的项目"},{handler:function(m,n){d.storeBar.status=0;d.store.load({params:d.storeBar})}.createDelegate(this),enableToggle:true,id:j,allowDepress:false,toggleGroup:"project_proj_myproj_type",cls:"btn-yellow1",iconCls:"icon-waiting",tooltip:"显示立项中的所有项目列表",text:"立项/审批中的项目"},{handler:function(m,n){d.storeBar.status=7;d.store.load({params:d.storeBar})}.createDelegate(this),id:k,pressed:d.opentype=="pass"?true:false,enableToggle:true,allowDepress:false,cls:"btn-blue3",toggleGroup:"project_proj_myproj_type",iconCls:"icon-pass",tooltip:"显示正在审批通过的所有项目列表",text:"审批通过的项目"},{handler:function(m,n){d.storeBar.status=6;d.store.load({params:d.storeBar})}.createDelegate(this),enableToggle:true,cls:"btn-gray1",allowDepress:false,id:e,toggleGroup:"project_proj_myproj_type",iconCls:"icon-noPass",tooltip:"显示审批不通过的所有项目列表",text:"审批不通过的项目"},{handler:function(m,n){d.storeBar.status=3;d.store.load({params:d.storeBar})}.createDelegate(this),enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_type",iconCls:"icon-myEntruSteRecord",cls:"btn-blue3",tooltip:"显示已经结束的所有项目列表",text:"历史项目列表"},"->",{xtype:"cnoa_helpBtn",helpid:2000}]}),bbar:this.pagingBar});this.centerPanel=new Ext.Panel({region:"center",layout:"fit",items:[this.grid]});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.centerPanel]})},projapply:function(a){var b=this;mainPanel.closeTab("CNOA_MENU_PROJECT_PROJ_APPLY");mainPanel.loadClass("index.php?app=project&func=proj&action=main&module=myproj&task=loadPage&from=applyproj&type=add&applyId="+a,"CNOA_MENU_PROJECT_PROJ_APPLY","立项申请")},projchange:function(a){var b=this;mainPanel.closeTab("CNOA_MENU_PROJECT_PROJ_APPLY");mainPanel.loadClass("index.php?app=project&func=proj&action=main&module=myproj&task=loadPage&from=applyproj&type=change&applyId="+a,"CNOA_MENU_PROJECT_PROJ_APPLY","项目变更")},makeStatus:function(j,g,c,i,e,b){var l=c.data;var k=0;var a="#5B5B5B";upgradetitle=l.upgradetitle;k=l.upgradewidth;a=l.upgradecolor;var d="<div style='color:#808080;margin-top:3px;'>"+upgradetitle+"</div>";d+="<div style='width:100px;height:5px;background-color:#D4D4D4;'><div style='font-size:0;line-height:0;height:5px;width:"+k+"px;background-color:"+a+";'></div></div>";return d},makeOperate:function(p,l,e,m,j,b){var i=this;var q=e.data;var a=false;var g=false;var d=false;var o=false;var k=false;var n=false;a=q.editable;g=q.upgradable;d=q.deleteable;o=q.changeable;sm=q.startable;n=q.finishable;var c=a?"<a href='javascript:void(0);' class='gridview4' onclick='CNOA_project_proj_myproj.projapply("+q.pid+");'>修改</a>":"<span class='gridview5'>修改</span>";c+="<a href='javascript:void(0);' class='gridview3 jianju' onclick='CNOA_project_proj_myproj.checkTask("+q.pid+");' ext:qtip='管理该项目的所有任务，<br />包括任务催促，任务<br />状态查看，任务审批'>任务管理(待审:"+q.checknum+")</a>";c+=g?"<a href='javascript:void(0);' class='gridview jianju' onclick='CNOA_project_proj_myproj.urgeProject("+q.pid+");' ext:qtip='汇报项目进度'>进度</a>":"<span class='gridview5 jianju'>进度</span>";if(i.storeBar.status==0){c+="<a href='javascript:void(0);' class='gridview3 jianju' onclick='CNOA_project_proj_myproj.deleteProject("+q.pid+");' ext:qtip='删除未审批的项目'><span class='gridview5 jianju'>删除</span></a> "}c+=o?"<a href='javascript:void(0);' class='gridview4 jianju' onclick='CNOA_project_proj_myproj.projchange("+q.pid+");' ext:qtip='项目变更指的是，<br />原有已经审批通过<br />的项目，在项目实<br />施过程中有所改变。<br />需要重新审核。'>项目变更</a>":"<span class='gridview5 jianju'>项目变更</span>";c+=sm?"<a href='javascript:void(0);' class='gridview jianju' onclick='CNOA_project_proj_myproj.startProject("+q.pid+");'><span ext:qtip='项目开始<br />的实际时间'>开始</span></a>":"<span class='gridview5 jianju'>开始</span>";c+=n?"<a href='javascript:void(0);' class='gridview3 jianju' onclick='CNOA_project_proj_myproj.finishProject("+q.pid+");' ><span ext:qtip='项目结束<br />的实际时间'>结束</span></a>":"<span class='gridview5 jianju'>结束</span>";c+="<a href='javascript:void(0);' class='gridview jianju' onclick='CNOA_project_proj_myproj.viewProject("+q.pid+', "'+q.name+"\");' ext:qtip='查看项目的详细信息'>查看</a>";return c},deleteProject:function(a){var b=this;CNOA.msg.cf("确定要删除该项目吗?",function(c){if(c=="yes"){Ext.Ajax.request({url:b.baseUrl+"&task=deleteProject",method:"POST",params:{pid:a},success:function(e){var d=Ext.decode(e.responseText);if(d.success===true){CNOA.msg.notice(d.msg,"项目管理");b.store.reload()}else{CNOA.msg.alert(d.msg,function(){})}}})}})},viewProject:function(t,K){var z=this;var o=z.baseUrl+"&task=loadPage&pid="+t+"&from=";var J="项目："+K+" 的所有信息";var i=Ext.id();var F=Ext.id();var g=Ext.id();var c=Ext.id();var D=Ext.id();var n=Ext.id();var j=Ext.id();var s=Ext.id();var H=Ext.id();var w=true;var e=true;var q=true;var E=true;var u=true;var b=true;var B=true;var y=true;var p=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",items:[z.eventPanel(t)]});var m=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",items:[z.endorsePanel(t)]});var a=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",items:[z.discussPanel(t)]});var A=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",items:[z.costPanel(t)]});var k=new Ext.Panel({html:'<div style="width:100%;height:100%;"><iframe scrolling=auto frameborder=0 width=100% height=100% id="'+H+'"></iframe></div>',listeners:{afterrender:function(){if(y){Ext.getDom(H).contentWindow.location.href=o+'viewFlowDetail&exportArray={"i":1,"f":1,"p":1,"e":1}&target=page';y=false}}}});var C=new Ext.Panel({html:'<div style="width:100%;height:100%;"><iframe scrolling=auto frameborder=0 width=100% height=100% id="'+s+'"></iframe></div>',listeners:{afterrender:function(){if(B){Ext.getDom(s).contentWindow.location.href=o+"viewgantt";B=false}}}});var r=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",items:[z.askPanel(t)]});var x=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",items:[z.taskPanel(t)]});var I=new Ext.Panel({html:'<div style="width:100%;height:100%;"><iframe scrolling=auto frameborder=0 width=100% height=100% id="'+D+'"></iframe></div>',listeners:{afterrender:function(){if(E){Ext.getDom(D).contentWindow.location.href=o+"viewdoc";E=false}}}});var v=new Ext.Panel({html:'<div style="width:100%;height:100%;"><iframe scrolling=auto frameborder=0 width=100% height=100% id="'+c+'"></iframe></div>',listeners:{afterrender:function(){if(q){Ext.getDom(c).contentWindow.location.href=o+"viewckrecord";q=false}}}});var d=new Ext.Panel({html:'<div style="width:100%;height:100%;"><iframe scrolling=auto frameborder=0 width=100% height=100% id="'+g+'"></iframe></div>',listeners:{afterrender:function(){if(e){Ext.getDom(g).contentWindow.location.href=o+"viewmember";e=false}}}});var G=new Ext.Panel({html:'<div style="width:100%;height:100%;"><iframe scrolling=auto frameborder=0 width=100% height=100% id="'+F+'"></iframe></div>',listeners:{afterrender:function(){if(w){Ext.getDom(F).contentWindow.location.href=o+"viewbaseinfo";w=false}}}});var l=new Ext.Window({title:J,width:860,height:makeWindowHeight(700),resizable:true,modal:true,layout:"border",maximizable:true,tbar:[{xtype:"buttongroup",columns:3,title:"项目信息",defaults:{scale:"small"},items:[{text:lang("baseInfo"),iconCls:"application_view_list",tooltip:"显示项目的基本信息和进度汇报",pressed:true,enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(0)}},{text:"项目成员",iconCls:"icon-communication2",tooltip:"显示项目的所有成员和他们的角色",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(1)}},{text:"项目文档",iconCls:"icon-order-s-send",tooltip:"显示项目的所有文档和对应成员的权限",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(3)}},{text:"项目费用",iconCls:"icon-coins",tooltip:"显示项目所花费的费用",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(7)}},{text:"任务列表",iconCls:"icon-btn-desktopList",tooltip:"显示该项目的所有任务列表",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(4)}}]},{xtype:"buttongroup",columns:2,title:"项目跟踪",defaults:{scale:"small"},items:[{text:"问题跟踪",iconCls:"icon-system-help",tooltip:"显示该项目的问题的所有讨论细节",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(5)}},{text:"审批记录",iconCls:"icon-user-addTask",tooltip:"显示项目被审批的所有记录和变更记录",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(2)}},{text:"项目流程",iconCls:"all-department-tree",tooltip:"显示项目绑定的流程",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(8)}},{text:"项目事件",iconCls:"icon-order-s-draft",tooltip:"显示项目变更后的所有事件记录",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(11)}}]},{xtype:"buttongroup",columns:1,title:"项目交流 ",defaults:{scale:"small"},items:[{text:"项目讨论区",iconCls:"icon-CNOA-Web-IM",tooltip:"讨论该项目的一些问题",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(9)}},{text:"项目批注&nbsp;&nbsp;&nbsp;&nbsp;",iconCls:"icon-system-theme-setup",tooltip:"对该项目的一些批注",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(10)}}]},{xtype:"buttongroup",columns:2,height:69,title:lang("opt"),defaults:{scale:"small"},items:[{text:"最大化窗口",iconCls:"icon-fileview-column",tooltip:"恢复窗口原来的大小",handler:function(L){if(l.maximized===true){L.setText("最大化窗口")}else{L.setText("恢复窗口")}l.toggleMaximize()}},{text:lang("close"),iconCls:"icon-dialog-cancel",tooltip:"关闭窗口",handler:function(){l.close()}}]}],listeners:{show:function(){},close:function(){}},items:[{xtype:"panel",id:i,region:"center",layout:"card",activeItem:0,hideBorders:true,border:false,items:[G,d,v,I,x,r,C,A,k,a,m,p]}]}).show()},eventPanel:function(c){var e=this;var j=Ext.id();var d=[{name:"eid"},{name:"type"},{name:"title"},{name:"content"},{name:"posttime"},{name:"truename"}];var l=new Ext.data.GroupingStore({autoLoad:true,proxy:new Ext.data.HttpProxy({url:e.baseUrl+"&task=geteventlist&pid="+c}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:d}),sortInfo:{field:"eid",direction:"ASC"},groupOnSort:false,groupField:"type",sortData:function(){},listeners:{load:function(o,m,n){}}});var b=new Ext.grid.CheckboxSelectionModel({singleSelect:false});var k=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"eid",dataIndex:"eid",hidden:true},{header:"",dataIndex:"type",hidden:true},{header:"类型",dataIndex:"type",width:120,sortable:true,menuDisabled:true},{header:lang("title"),dataIndex:"title",width:120,sortable:true,menuDisabled:true},{header:"操作内容",dataIndex:"content",width:200,sortable:true,menuDisabled:true},{header:"修改时间",dataIndex:"posttime",width:120,sortable:true,menuDisabled:true},{header:"操作人姓名",dataIndex:"truename",width:80,sortable:true,menuDisabled:true},{header:lang("opt"),dataIndex:"eid",width:80,sortable:true,menuDisabled:true,renderer:this.viewdiff.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);var i=new Ext.grid.GridPanel({border:false,store:l,loadMask:{msg:lang("waiting")},cm:k,sm:b,stripeRows:true,hideBorders:true,tbar:[{text:lang("refresh"),iconCls:"icon-system-refresh",handler:function(m,n){l.reload()}},{text:"列表模式",enableToggle:true,allowDepress:false,iconCls:"icon-system-s-report",toggleGroup:"project_proj_myproj_event_expand",tooltip:"列表模式",handler:function(m,n){l.clearGrouping()}},{text:"分组模式",pressed:true,enableToggle:true,allowDepress:false,iconCls:"icon-view-form-png",toggleGroup:"project_proj_myproj_event_expand",tooltip:"分组模式",handler:function(m,n){l.groupBy("type",true);i.view.collapseAllGroups()}},{text:"展开所有分组",enableToggle:true,allowDepress:false,iconCls:"icon-style-tree",toggleGroup:"project_proj_myproj_event_expand",tooltip:"展开所有分组",handler:function(m,n){l.groupBy("type",true);i.view.expandAllGroups()}}],view:new Ext.grid.GroupingView({forceFit:false,startCollapsed:true})});var a=new Ext.Panel({region:"center",layout:"fit",items:[i]});var g=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",autoScroll:false,items:[a]});return g},viewdiff:function(g,d,a,i,b,e){var c=a.data;return"<a href='javascript:void(0)' class='gridview' onclick='CNOA_project_proj_myproj.viewdiffwin("+c.eid+', "'+c.title+"\")'>查看</a>"},viewdiffwin:function(b,e){var g=this;var c=Ext.id();var a=new Ext.Panel({html:'<div style="width:100%;height:100%;"><iframe scrolling=auto frameborder=0 width=100% height=100% id="'+c+'"></iframe></div>',border:false,listeners:{afterrender:function(){Ext.getDom(c).contentWindow.location.href=g.baseUrl+"&task=viewdiffdetail&eid="+b}}});var d=new Ext.Window({title:"查看"+e,width:800,height:makeWindowHeight(600),items:[a],modal:true,layout:"fit",buttons:[{text:lang("close"),handler:function(){d.close()}}]}).show()},endorsePanel:function(c){var j=this;var b=[{name:"eid"},{name:"posttime"},{name:"postname"},{name:"content"}];this.endorseStore=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:j.baseUrl+"&task=endorseprojlist&pid="+c}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:b}),listeners:{load:function(m,k,l){j.endorsedata=k}}});var i=new Ext.grid.CheckboxSelectionModel({singleSelect:false});var d=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"批注领导",dataIndex:"postname",width:80,sortable:true,menuDisabled:true},{header:"批注内容",dataIndex:"content",width:350,sortable:true,menuDisabled:true,renderer:this.endorsecontent.createDelegate(this)},{header:"批注时间",dataIndex:"posttime",width:120,sortable:true,menuDisabled:true},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);var g=new Ext.grid.GridPanel({border:false,store:this.endorseStore,loadMask:{msg:lang("waiting")},autoScroll:true,cm:d,sm:i,stripeRows:true,hideBorders:true,tbar:[{text:lang("refresh"),iconCls:"icon-system-refresh",handler:function(k,l){j.endorseStore.reload()}}]});var a=new Ext.Panel({region:"center",layout:"fit",items:[g]});var e=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",autoScroll:false,items:[a]});return e},endorsecontent:function(g,d,a,i,b,e){var c=a.data;return"<a href='javascript:void(0)' class='gridview' onclick='CNOA_project_proj_myproj.showendorsecontent("+c.eid+")'>"+g+"</a>"},showendorsecontent:function(a){var b=this;Ext.each(b.endorsedata,function(c,d){if(c.data.eid==a){b.showendorsecontentwin(c.data.content)}})},showendorsecontentwin:function(b){var c=this;var a=new Ext.Window({title:"批注详细信息",width:600,height:300,layout:"border",modal:true,items:[new Ext.Panel({region:"center",autoScroll:true,html:"<div><p>&nbsp;&nbsp;&nbsp;"+b+"</p></div>",layout:"fit",border:false})],buttons:[{text:lang("close"),handler:function(){a.close()}}]}).show()},discussPanel:function(c){var g=this;var a=g.baseUrl+"&task=loadPage&pid="+c+"&from=";var i=[{name:"did"},{name:"title"},{name:"postname"},{name:"count"},{name:"posttime"},{name:"lastname"},{name:"lasttime"}];g.storediscuss=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:g.baseUrl+"&task=viewdiscusslist&pid="+c}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:i})});var b=new Ext.grid.CheckboxSelectionModel({singleSelect:false});var j=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"did",dataIndex:"did",hidden:true},{header:lang("title"),dataIndex:"title",width:270,sortable:true,menuDisabled:true,renderer:this.discusstitle.createDelegate(this)},{header:"作者",dataIndex:"postname",width:100,sortable:true,menuDisabled:true},{header:"发布时间",dataIndex:"posttime",width:120,sortable:true,menuDisabled:true},{header:"回复数",dataIndex:"count",width:120,sortable:true,menuDisabled:true},{header:"最后回复人",dataIndex:"lastname",width:80,sortable:true,menuDisabled:true},{header:"最后回复时间",dataIndex:"lasttime",width:120,sortable:true,menuDisabled:true},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);var k=new Ext.grid.GridPanel({border:false,store:g.storediscuss,loadMask:{msg:lang("waiting")},cm:j,sm:b,stripeRows:true,hideBorders:true,tbar:[{text:lang("refresh"),iconCls:"icon-system-refresh",handler:function(l,m){g.storediscuss.reload()}},{text:"发帖",iconCls:"icon-expand-members",handler:function(l,m){g.discussWin(c)}},"<span class='cnoa_color_gray'>点击标题，进入该讨论帖子</span>"]});var d=new Ext.Panel({region:"center",layout:"fit",items:[k]});var e=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",autoScroll:false,items:[d]});return e},discusstitle:function(g,d,a,i,b,e){var c=a.data;return"<a href='javascript:void(0)' class='gridview' onclick='CNOA_project_proj_myproj.discussview("+c.did+")'>"+g+"</a>"},discussview:function(b){var e=this;var a=new Ext.XTemplate('<div class="user_task_discuss_view">','  <div class="user_task_discuss_view_header">','    <div class="user_task_discuss_view_header_title">[讨论标题]&nbsp;&nbsp;{title}&nbsp;&nbsp;</div>','    <div class="user_task_discuss_view_header_from">&nbsp;发布人:&nbsp;&nbsp; {postname}&nbsp;&nbsp;&nbsp;&nbsp;发布时间:{posttime}</div>',"  </div>",'  <div class="user_task_discuss_view_body">','    <div class="user_task_discuss_view_body_left">','      <div class="user_task_discuss_view_body_left_body">','        <span><img src="{face}" width="120" height="130" onerror="this.src=\'./resources/images/default.jpg\'" /></span>',"      </div>","    </div>",'    <div class="user_task_discuss_view_body_right">','      <div class="user_task_discuss_view_body_right_top">#{[xindex]}&nbsp;&nbsp;<a>{postname}</a>&nbsp;&nbsp;</div>','      <div class="user_task_discuss_view_body_right_body">{content}</div>',"    </div>",'    <div class="clear"></div>',"  </div>",'  <tpl for="list">','  <div class="user_task_discuss_view_body">','    <div class="user_task_discuss_view_body_left">','      <div class="user_task_discuss_view_body_left_top"></div>','      <div class="user_task_discuss_view_body_left_body">','        <span><img src="{face}" width="120" height="130" onerror="this.src=\'./resources/images/default.jpg\'" /></span>',"      </div>","    </div>",'    <div class="user_task_discuss_view_body_right">','      <div class="user_task_discuss_view_body_right_top">#{[xindex]}&nbsp;&nbsp;<a>{postname}</a>&nbsp;&nbsp;发表于&nbsp;{posttime}<div style="float:right; padding-right:5px"><a href="javascript:void(0)"  class="gridview" onclick="CNOA_project_proj_myproj.replydiscuss({did},{rid})">回复</a></div></div>','      <div class="user_task_discuss_view_body_right_body">{content}</div>',"    </div>",'    <div class="clear"></div>',"  </div>","  </tpl>","</div>");e.readInfo=function(){d.getEl().mask(lang("waiting"));Ext.Ajax.request({url:e.baseUrl+"&task=getDiscussInfo",method:"POST",params:{did:b},success:function(i){var g=Ext.decode(i.responseText);if(g.success===true){rd=g.data;a.overwrite(d.body,rd);d.getEl().unmask()}else{CNOA.msg.alert(g.msg,function(){})}}})};var d=new Ext.Panel({region:"center",layout:"fit",border:false,autoScroll:true,listeners:{render:function(){e.readInfo()}},tbar:new Ext.Toolbar({items:[{text:lang("refresh"),iconCls:"icon-system-refresh",handler:function(){e.readInfo()}},{text:"回复",iconCls:"icon-expand-members",handler:function(){e.replydiscuss(b,0)}}]})});var c=new Ext.Window({title:"查看讨论窗口",width:800,height:makeWindowHeight(600),modal:true,layout:"border",items:[d],buttons:[{text:lang("close"),handler:function(){c.close()}}]}).show()},replydiscuss:function(c,a){var g=this;var d=function(){if(b.getForm().isValid()){b.getForm().submit({url:g.baseUrl+"&task=discussprojreply",waitMsg:lang("waiting"),method:"POST",params:{did:c,rid:a},success:function(i,j){CNOA.msg.notice(j.result.msg,"项目管理");e.close();g.readInfo()}.createDelegate(this),failure:function(i,j){CNOA.msg.alert(j.result.msg)}.createDelegate(this)})}};var b=new Ext.form.FormPanel({region:"center",border:false,labelWidth:60,labelAlign:"right",waitMsgTarget:true,items:[{xtype:"panel",border:false,bodyStyle:"padding:10px",layout:"form",items:[{xtype:"textarea",name:"content",height:"180",allowBlank:false,fieldLabel:"回复内容",width:"480"}]}]});var e=new Ext.Window({title:"发帖窗口",width:600,height:300,modal:true,layout:"border",items:[b],buttons:[{text:"提交",handler:function(){d()}},{text:lang("close"),handler:function(){e.close()}}]}).show()},discussWin:function(a){var e=this;var c=function(){if(b.getForm().isValid()){b.getForm().submit({url:e.baseUrl+"&task=discussprojadd",waitMsg:lang("waiting"),method:"POST",params:{pid:a},success:function(g,i){CNOA.msg.notice(i.result.msg,"项目管理");d.close();e.storediscuss.reload()}.createDelegate(this),failure:function(g,i){CNOA.msg.alert(i.result.msg)}.createDelegate(this)})}};var b=new Ext.form.FormPanel({region:"center",border:false,labelWidth:50,labelAlign:"right",bodyStyle:"padding:10px",waitMsgTarget:true,items:[{xtype:"textfield",name:"title",fieldLabel:lang("title"),allowBlank:false,width:"480"},{xtype:"textarea",name:"content",fieldLabel:lang("content"),width:"480",allowBlank:false,height:"180"}]});var d=new Ext.Window({title:"发帖窗口",width:600,height:300,modal:true,layout:"border",items:[b],buttons:[{text:"提交",handler:function(){c()}},{text:lang("close"),handler:function(){d.close()}}]}).show()},costPanel:function(c){var e=this;var j=Ext.id();var d=[{name:"bid"},{name:"sname"},{name:"title"},{name:"r_cost"},{name:"t_cost"},{name:"status"},{name:"costnotes"}];var l=new Ext.data.GroupingStore({autoLoad:true,proxy:new Ext.data.HttpProxy({url:e.baseUrl+"&task=viewcostdetail&pid="+c}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:d}),sortInfo:{field:"bid",direction:"ASC"},groupOnSort:false,groupField:"sname",sortData:function(){},listeners:{load:function(o,m,n){Ext.getCmp(j).getEl().update("项目的预算总花费: "+o.reader.jsonData.t_r_cost+"元&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;实际总花费："+o.reader.jsonData.t_t_cost+"元");e.columrecord=m}}});var b=new Ext.grid.CheckboxSelectionModel({singleSelect:false});var k=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"bid",dataIndex:"bid",hidden:true},{header:"",dataIndex:"sname",hidden:true},{header:"费用名称",dataIndex:"title",width:120,sortable:true,menuDisabled:true},{header:"预算费用（元）",dataIndex:"r_cost",width:100,sortable:true,menuDisabled:true},{header:"实际费用（元）",dataIndex:"t_cost",width:120,sortable:true,menuDisabled:true},{header:"状态",dataIndex:"status",width:80,sortable:true,menuDisabled:true},{header:"费用说明",dataIndex:"costnotes",width:200,sortable:true,menuDisabled:true,renderer:this.description.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);var i=new Ext.grid.GridPanel({border:false,store:l,loadMask:{msg:lang("waiting")},cm:k,sm:b,stripeRows:true,hideBorders:true,tbar:[{xtype:"box",id:j,autoEl:{tag:"div",html:""}}],view:new Ext.grid.GroupingView({forceFit:false,startCollapsed:true})});var a=new Ext.Panel({region:"center",layout:"fit",items:[i],tbar:[{text:lang("refresh"),iconCls:"icon-system-refresh",handler:function(m,n){l.reload()}},{text:"所有费用",enableToggle:true,allowDepress:false,pressed:true,iconCls:"icon-expand-members",toggleGroup:"project_proj_myproj_cost_status",tooltip:"列出该项目的所有费用，包括未审批的",handler:function(m,n){l.load({params:{type:"all"}})}},{text:"审批通过费用",enableToggle:true,allowDepress:false,iconCls:"icon-expand-members",toggleGroup:"project_proj_myproj_cost_status",tooltip:"列出该项目通过审批的费用",handler:function(m,n){l.load({params:{type:"checked"}})}},{text:"列表模式",enableToggle:true,allowDepress:false,iconCls:"icon-system-s-report",toggleGroup:"project_proj_myproj_expand",tooltip:"列表模式",handler:function(m,n){l.clearGrouping()}},{text:"分组模式",pressed:true,enableToggle:true,allowDepress:false,iconCls:"icon-view-form-png",toggleGroup:"project_proj_myproj_expand",tooltip:"分组模式",handler:function(m,n){l.groupBy("sname",true);i.view.collapseAllGroups()}},{text:"展开所有分组",enableToggle:true,allowDepress:false,iconCls:"icon-style-tree",toggleGroup:"project_proj_myproj_expand",tooltip:"展开所有分组",handler:function(m,n){l.groupBy("sname",true);i.view.expandAllGroups()}}]});var g=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",autoScroll:false,items:[a]});return g},description:function(e,c,a,g,b,d){return"<a href='javascript:void(0)' onclick='CNOA_project_proj_myproj.costnotes("+a.data.bid+")'>"+e+"</a>"},costnotes:function(a){var b=this;Ext.each(b.columrecord,function(c,d){if(c.data.bid==a){b.costnoteswindow(c.data.costnotes,c.data.title)}})},costnoteswindow:function(b,a){var c=this;this.window=new Ext.Window({title:"费用名称("+a+")",width:600,height:300,layout:"border",modal:true,items:[new Ext.Panel({region:"center",autoScroll:true,html:"<div><p>&nbsp;&nbsp;&nbsp;"+b+"</p></div>",layout:"fit",border:false})],buttons:[{text:lang("close"),handler:function(){c.window.close()}}]}).show()},taskPanel:function(b){var i=this;var a=[{name:"tid"},{name:"title"},{name:"stime"},{name:"etime"},{name:"level"},{name:"status"},{name:"progress"},{name:"execman"}];this.taskStore=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:i.baseUrl+"&task=taskprojlist&pid="+b}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:a}),listeners:{load:function(l,j,k){}}});var g=new Ext.grid.CheckboxSelectionModel({singleSelect:false});var c=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"tid",dataIndex:"tid",hidden:true},{header:"任务标题",dataIndex:"title",width:200,sortable:true,menuDisabled:true,renderer:this.viewTaskDeltails.createDelegate(this)},{header:"任务开始时间",dataIndex:"stime",width:120,sortable:false,menuDisabled:true},{header:"任务结束时间",dataIndex:"etime",width:120,sortable:false,menuDisabled:true},{header:"任务等级",dataIndex:"level",width:60,sortable:false,menuDisabled:true},{header:"状态",dataIndex:"status",width:120,sortable:false,menuDisabled:true},{header:"进度",dataIndex:"progress",width:80,sortable:false,menuDisabled:true},{header:"负责人",dataIndex:"execman",width:100,sortable:false,menuDisabled:true},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);var e=new Ext.grid.GridPanel({region:"center",layout:"fit",border:false,store:this.taskStore,loadMask:{msg:lang("waiting")},cm:c,sm:g,stripeRows:true,hideBorders:true,tbar:[{text:lang("refresh"),iconCls:"icon-system-refresh",handler:function(j,k){i.taskStore.reload()}}]});var d=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",autoScroll:false,items:[e]});return d},viewTaskDeltails:function(d,e,a){var b=a.data;return"<a href='javascript:void(0)' class='gridview' onclick='CNOA_project_proj_myproj.viewTaskDeltailsWin("+b.tid+")'>"+d+"</a>"},viewTaskDeltailsWin:function(d){var i=this;var g=i.baseUrl+"&task=loadPage&from=viewTaskdetail&tid="+d;var c=Ext.id();var b=true;var e="任务所有信息";var a=new Ext.Panel({border:false,height:568,html:'<div style="width:100%;height:100%;"><iframe scrolling=auto frameborder=0 width=100% height=100% id="'+c+'"></iframe></div>',listeners:{afterrender:function(){if(b){Ext.getDom(c).contentWindow.location.href=g;b=false}}}});this.win=new Ext.Window({title:e,width:800,height:makeWindowHeight(600),resizable:true,modal:true,maximizable:true,items:[a]}).show()},askPanel:function(c){var j=this;var b=[{name:"aid"},{name:"title"},{name:"askname"},{name:"posttime"},{name:"status"}];this.askStore=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:j.baseUrl+"&task=askprojlist&pid="+c}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:b}),listeners:{load:function(m,k,l){}}});var i=new Ext.grid.CheckboxSelectionModel({singleSelect:false});var d=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"aid",dataIndex:"aid",hidden:true},{header:"问题标题",dataIndex:"title",width:300,sortable:true,menuDisabled:true},{header:"提问人",dataIndex:"askname",width:100,sortable:false,menuDisabled:true},{header:"提问时间",dataIndex:"posttime",width:100,sortable:false,menuDisabled:true},{header:"状态",dataIndex:"status",width:60,sortable:false,menuDisabled:true},{header:lang("opt"),dataIndex:"aid",width:140,renderer:this.viewAsk.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);var g=new Ext.grid.GridPanel({border:false,store:this.askStore,loadMask:{msg:lang("waiting")},cm:d,sm:i,stripeRows:true,hideBorders:true,tbar:[{text:lang("refresh"),iconCls:"icon-system-refresh",handler:function(k,l){j.askStore.reload()}}]});var a=new Ext.Panel({region:"center",layout:"fit",items:[g]});var e=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",autoScroll:false,items:[a]});return e},viewAsk:function(e,c,a,i,b,d){var g=this;return"<a href='javascript:void(0)' class='gridview' onclick='CNOA_project_proj_myproj.viewAskDetail("+e+")'>查看</a>"},viewAskDetail:function(d){var g=this;var a=new Ext.XTemplate('<div class="user_task_discuss_view">','  <div class="user_task_discuss_view_header">','    <div class="user_task_discuss_view_header_title">[问题标题]&nbsp;&nbsp;{title}&nbsp;&nbsp;[{status}]</div>',"  </div>",'  <div class="user_task_discuss_view_body">','    <div class="user_task_discuss_view_body_left">','      <div class="user_task_discuss_view_body_left_top">{postname}[{job}]</div>','      <div class="user_task_discuss_view_body_left_body">','        <span><img src="{face}" width="120" height="130" onerror="this.src=\'./resources/images/default.jpg\'" /></span>',"      </div>","    </div>",'    <div class="user_task_discuss_view_body_right">','      <div class="user_task_discuss_view_body_right_top">#{[xindex]}&nbsp;&nbsp;<a>{postname}</a>&nbsp;&nbsp;发表于&nbsp;{time}</div>','      <div class="user_task_discuss_view_body_right_body">{content}</div>',"    </div>",'    <div class="clear"></div>',"  </div>",'  <tpl for="list">','  <div class="user_task_discuss_view_body">','    <div class="user_task_discuss_view_body_left">','      <div class="user_task_discuss_view_body_left_top">{postname}[{job}]</div>','      <div class="user_task_discuss_view_body_left_body">','        <span><img src="{face}" width="120" height="130" onerror="this.src=\'./resources/images/default.jpg\'" /></span>',"      </div>","    </div>",'    <div class="user_task_discuss_view_body_right">','      <div class="user_task_discuss_view_body_right_top">#{[xindex]}&nbsp;&nbsp;<a>{postname}</a>&nbsp;&nbsp;发表于&nbsp;{time}</div>','      <div class="user_task_discuss_view_body_right_body">{content}</div>',"    </div>",'    <div class="clear"></div>',"  </div>","  </tpl>","</div>");var b=function(){e.getEl().mask(lang("waiting"));Ext.Ajax.request({url:g.baseUrl+"&task=getAskInfo",method:"POST",params:{aid:d},success:function(k){var i=Ext.decode(k.responseText);if(i.success===true){var j=i.data;a.overwrite(e.body,j);e.getEl().unmask()}else{CNOA.msg.alert(i.msg,function(){})}}})};var e=new Ext.Panel({region:"center",layout:"fit",border:false,autoScroll:true,listeners:{render:function(){b()}}});var c=new Ext.Window({title:"项目：问题查看（双击可最大化窗口）",width:800,height:makeWindowHeight(650),resizable:true,modal:true,layout:"border",maximizable:true,items:[e],buttons:[{text:lang("refresh"),handler:function(){b()}},{text:lang("close"),handler:function(){c.close()}.createDelegate(this)}]}).show()},startProject:function(a){var b=this;CNOA.msg.cf("您确定开始该项目吗？",function(c){if(c=="yes"){Ext.Ajax.request({url:b.baseUrl+"&task=startProject",method:"POST",params:{pid:a},success:function(e){var d=Ext.decode(e.responseText);if(d.success===true){CNOA.msg.notice(d.msg,"项目管理");b.store.reload()}else{CNOA.msg.alert(d.msg)}}})}})},formatday:function(e,c,a,g,b,d){if(a.data.tday>a.data.pday){if(e<0){return""}return"<span class='cnoa_color_red'><b>"+e+"</b></span>"}else{if(e<0){return""}return"<span class='cnoa_color_green'><b>"+e+"</b></span>"}},finishProject:function(b){var e=this;var a=new Ext.form.FormPanel({border:false,hideBorders:true,labelWidth:10,waitMsgTarget:true,bodyStyle:"padding-top:20px;",items:[{xtype:"textarea",anchor:"-20 -20",name:"summary"}]});var d=new Ext.Window({width:500,height:400,title:"项目完成总结",resizable:true,modal:true,layout:"fit",items:a,buttons:[{text:"提交总结",iconCls:"icon-order-s-accept",handler:function(){c()}.createDelegate(this)},{text:lang("cancel"),iconCls:"icon-dialog-cancel",handler:function(){d.close()}.createDelegate(this)}]}).show();var c=function(){var g=a.getForm().findField("summary").getValue();Ext.Ajax.request({url:e.baseUrl+"&task=finishProject",method:"POST",params:{pid:b,summary:g},success:function(j){var i=Ext.decode(j.responseText);if(i.success===true){CNOA.msg.notice(i.msg,"项目管理");e.store.reload();d.close()}else{CNOA.msg.alert(i.msg)}}})}},urgeProject:function(b){var e=this;var a=new Ext.form.FormPanel({border:false,hideBorders:true,labelWidth:10,labelAlign:"top",waitMsgTarget:true,items:[{xtype:"panel",layout:"form",bodyStyle:"padding:10px",items:[{xtype:"textfield",width:150,name:"upgate",allowBlank:false,fieldLabel:"项目进度1~99",regex:/^\d{1,2}$/i,regexText:"必须设置为0到99的整数数字"},{xtype:"textarea",width:560,height:200,name:"content",fieldLabel:"进度汇报"}]}]});var d=new Ext.Window({width:610,height:380,title:"项目进度",resizable:true,modal:true,layout:"fit",items:a,buttons:[{text:"提交",iconCls:"icon-order-s-accept",handler:function(){c()}.createDelegate(this)},{text:lang("cancel"),iconCls:"icon-dialog-cancel",handler:function(){d.close()}.createDelegate(this)}]}).show();var c=function(){var g=a.getForm().findField("upgate").getValue();var i=a.getForm().findField("content").getValue();Ext.Ajax.request({url:e.baseUrl+"&task=urgeProject",method:"POST",params:{pid:b,upgrade:g,content:i},success:function(k){var j=Ext.decode(k.responseText);if(j.success===true){CNOA.msg.notice(j.msg,"项目管理");e.store.reload();d.close()}else{CNOA.msg.alert(j.msg)}}})}},checkTask:function(a){mainPanel.closeTab("CNOA_MENU_PROJECT_TASK_CHECK");mainPanel.loadClass("index.php?app=project&func=proj&action=main&module=myproj&task=loadPage&from=check&pid="+a,"CNOA_MENU_PROJECT_TASK_CHECK","审批项目任务","icon-page-view")}};var CNOA_project_proj_joinprojClass,CNOA_project_proj_joinproj;CNOA_project_proj_joinprojClass=CNOA.Class.create();CNOA_project_proj_joinprojClass.prototype={init:function(){var g=this;this.edit_id=0;this.content_start=1;this.baseUrl="index.php?app=project&func=proj&action=main&module=joinproj";this.ID_btn_edit=Ext.id();this.ID_btn_delete=Ext.id();this.ID_plan_content=Ext.id();var d=Ext.id();var e=Ext.id();var a=Ext.id();var b=Ext.id();var c=Ext.id();this.storeBar={title:"",s_standard:0,e_standard:0,s_time:0,e_time:0,status:""};this.fields=[{name:"pid"},{name:"name"},{name:"number"},{name:"type"},{name:"ttime"},{name:"ptime"},{name:"pday"},{name:"tday"},{name:"posttime"},{name:"updatetime"},{name:"uidname"},{name:"checkname"},{name:"viewer"},{name:"status"},{name:"description"},{name:"checknum"},{name:"upgradetitle"},{name:"upgradewidth"},{name:"upgradecolor"},{name:"editable"},{name:"upgradable"},{name:"deleteable"},{name:"changeable"},{name:"startable"},{name:"finishable"}];this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getJsonData",disableCaching:true}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields}),listeners:{exception:function(n,m,o,l,k,j){var i=Ext.decode(k.responseText);if(i.failure){CNOA.msg.alert(i.msg)}}}});this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.store.load();this.colModel=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"pid",dataIndex:"pid",hidden:true},{header:lang("opt"),dataIndex:"",width:210,sortable:false,menuDisabled:true,renderer:this.makeOperate.createDelegate(this)},{header:"项目编号",dataIndex:"number",width:105,sortable:true,menuDisabled:true},{header:"项目名称",dataIndex:"name",width:155,sortable:true,menuDisabled:true},{header:"项目进度",dataIndex:"name",width:90,sortable:false,menuDisabled:true,renderer:this.makeStatus.createDelegate(this)},{header:"审批人",dataIndex:"checkname",width:80,sortable:false,menuDisabled:true},{header:"计划时间",dataIndex:"ptime",width:120,sortable:false,menuDisabled:true},{header:"计划工时(天)",dataIndex:"pday",width:80,sortable:false,menuDisabled:true},{header:"实际时间",dataIndex:"ttime",width:120,sortable:false,menuDisabled:true},{header:"实际工时(天)",dataIndex:"tday",width:80,sortable:false,menuDisabled:true,renderer:this.formatday.createDelegate(this)},{header:"状态",dataIndex:"status",width:60,sortable:false,menuDisabled:true},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.pagingBar=new Ext.PagingToolbar({displayInfo:true,store:this.store,pageSize:15,listeners:{beforechange:function(i,j){j.status=g.status}}});this.searchBar=new Ext.Toolbar({items:["项目名称:",{xtype:"textfield",id:d,width:128},"&nbsp;项目进度从:",{xtype:"textfield",id:e,width:50,regex:/^(?:\d?\d|100)$/i,regexText:"必须设置为0到100的整数数字"},"~",{xtype:"textfield",id:a,width:50,regex:/^(?:\d?\d|100)$/i,regexText:"必须设置为0到100的整数数字"},"&nbsp;实际开始时间:",{xtype:"datefield",format:"Y-m-d",id:b,width:100},"&nbsp;实际结束时间:",{xtype:"datefield",format:"Y-m-d",id:c,width:100},{xtype:"button",text:lang("search"),style:"margin-left:5px",handler:function(){g.storeBar.title=Ext.getCmp(d).getValue();g.storeBar.s_standard=Ext.getCmp(e).getValue();g.storeBar.e_standard=Ext.getCmp(a).getValue();g.storeBar.s_time=Ext.getCmp(b).getRawValue();g.storeBar.e_time=Ext.getCmp(c).getRawValue();g.store.load({params:g.storeBar})}},{xtype:"button",text:lang("clear"),style:"margin-left:5px",handler:function(){Ext.getCmp(d).setValue("");Ext.getCmp(e).setValue("");Ext.getCmp(a).setValue("");Ext.getCmp(b).setValue("");Ext.getCmp(c).setValue("");g.storeBar.title=0;g.storeBar.s_standard=0;g.storeBar.e_standard=0;g.storeBar.s_time=0;g.storeBar.e_time=0;g.store.load({params:g.storeBar})}}]});this.grid=new Ext.grid.GridPanel({stripeRows:true,store:this.store,loadMask:{msg:lang("waiting")},cm:this.colModel,sm:this.sm,hideBorders:true,border:false,listeners:{render:function(){g.searchBar.render(this.tbar)}},tbar:new Ext.Toolbar({items:[{handler:function(i,j){g.store.reload()}.createDelegate(this),iconCls:"icon-system-refresh",text:lang("refresh")},{handler:function(i,j){g.storeBar.status="doing";g.store.load({params:g.storeBar})}.createDelegate(this),iconCls:"icon-waiting",enableToggle:true,pressed:true,cls:"btn-yellow1",allowDepress:false,toggleGroup:"project_proj_myproj_type",tooltip:"显示正在进行中和审批通过的所有项目列表",text:"进行中的项目"},{handler:function(i,j){g.storeBar.status="finish";g.store.load({params:g.storeBar})}.createDelegate(this),enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_type",cls:"btn-blue4",iconCls:"icon-pass",tooltip:"显示已经结束的所有项目列表",text:"历史项目列表"},"->",{xtype:"cnoa_helpBtn",helpid:2015}]}),bbar:this.pagingBar});this.centerPanel=new Ext.Panel({region:"center",layout:"fit",items:[this.grid]});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.centerPanel]})},projapply:function(a){var b=this;mainPanel.closeTab("CNOA_MENU_PROJECT_PROJ_APPLY");mainPanel.loadClass("index.php?app=project&func=proj&action=main&module=myproj&task=loadPage&from=applyproj&type=add&applyId="+a,"CNOA_MENU_PROJECT_PROJ_APPLY","立项申请")},projchange:function(a){var b=this;mainPanel.closeTab("CNOA_MENU_PROJECT_PROJ_APPLY");mainPanel.loadClass("index.php?app=project&func=proj&action=main&module=myproj&task=loadPage&from=applyproj&type=change&applyId="+a,"CNOA_MENU_PROJECT_PROJ_APPLY","项目变更")},makeStatus:function(j,g,c,i,e,b){var l=c.data;var k=0;var a="#5B5B5B";upgradetitle=l.upgradetitle;k=l.upgradewidth;a=l.upgradecolor;var d="<div style='color:#808080;margin-top:3px;'>"+upgradetitle+"</div>";d+="<div style='width:100px;height:5px;background-color:#D4D4D4;'><div style='font-size:0;line-height:0;height:5px;width:"+k+"px;background-color:"+a+";'></div></div>";return d},makeOperate:function(i,e,a,j,c,g){var d=a.data;var b="<a href='javascript:void(0);' class='gridview3' onclick='CNOA_project_proj_joinproj.discuss("+d.pid+");' ext:qtip='参与项目的讨论'>参与项目讨论</a>";b+="<a href='javascript:void(0);' class='gridview jianju' onclick='CNOA_project_proj_joinproj.viewProject("+d.pid+");' ext:qtip='查看项目的详细信息'>查看</a>";return b},discuss:function(d){var g=this;var a=g.baseUrl+"&task=loadPage&pid="+d+"&from=";var i=[{name:"did"},{name:"title"},{name:"postname"},{name:"count"},{name:"posttime"},{name:"lastname"},{name:"lasttime"}];g.storediscuss=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:g.baseUrl+"&task=viewdiscusslist&pid="+d}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:i})});var c=new Ext.grid.CheckboxSelectionModel({singleSelect:false});var j=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"did",dataIndex:"did",hidden:true},{header:lang("title"),dataIndex:"title",width:200,sortable:true,menuDisabled:true,renderer:this.discusstitle.createDelegate(this)},{header:"作者",dataIndex:"postname",width:100,sortable:true,menuDisabled:true},{header:"发布时间",dataIndex:"posttime",width:120,sortable:true,menuDisabled:true},{header:"回复数",dataIndex:"count",width:120,sortable:true,menuDisabled:true},{header:"最后回复人",dataIndex:"lastname",width:80,sortable:true,menuDisabled:true},{header:"最后回复时间",dataIndex:"lasttime",width:120,sortable:true,menuDisabled:true},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);var k=new Ext.grid.GridPanel({border:false,store:g.storediscuss,loadMask:{msg:lang("waiting")},cm:j,sm:c,stripeRows:true,hideBorders:true,tbar:[{text:lang("refresh"),iconCls:"icon-system-refresh",handler:function(l,m){g.storediscuss.reload()}},{text:"发帖",iconCls:"icon-expand-members",handler:function(l,m){g.discussWin(d)}},"<span class='cnoa_color_gray'>点击标题，进入该讨论帖子</span>"]});var b=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"fit",autoScroll:false,items:[k]});var e=new Ext.Window({title:"项目讨论",width:860,height:makeWindowHeight(700),resizable:true,modal:true,layout:"border",maximizable:true,items:[b],buttons:[{text:lang("close"),handler:function(){e.close()}}]}).show()},discusstitle:function(g,d,a,i,b,e){var c=a.data;return"<a href='javascript:void(0)' onclick='CNOA_project_proj_joinproj.discussview("+c.did+")'>"+g+"</a>"},discussview:function(b){var e=this;var a=new Ext.XTemplate('<div class="user_task_discuss_view">','  <div class="user_task_discuss_view_header">','    <div class="user_task_discuss_view_header_title">[讨论标题]&nbsp;&nbsp;{title}&nbsp;&nbsp;</div>','    <div class="user_task_discuss_view_header_from">&nbsp;发布人:&nbsp;&nbsp; {postname}&nbsp;&nbsp;&nbsp;&nbsp;发布时间:{posttime}</div>',"  </div>",'  <div class="user_task_discuss_view_body">','    <div class="user_task_discuss_view_body_left">','      <div class="user_task_discuss_view_body_left_body">','        <span><img src="{face}" width="120" height="130" onerror="this.src=\'./resources/images/default.jpg\'" /></span>',"      </div>","    </div>",'    <div class="user_task_discuss_view_body_right">','      <div class="user_task_discuss_view_body_right_top">#{[xindex]}&nbsp;&nbsp;<a>{postname}</a>&nbsp;&nbsp;</div>','      <div class="user_task_discuss_view_body_right_body">{content}</div>',"    </div>",'    <div class="clear"></div>',"  </div>",'  <tpl for="list">','  <div class="user_task_discuss_view_body">','    <div class="user_task_discuss_view_body_left">','      <div class="user_task_discuss_view_body_left_top"></div>','      <div class="user_task_discuss_view_body_left_body">','        <span><img src="{face}" width="120" height="130" onerror="this.src=\'./resources/images/default.jpg\'" /></span>',"      </div>","    </div>",'    <div class="user_task_discuss_view_body_right">','      <div class="user_task_discuss_view_body_right_top">#{[xindex]}&nbsp;&nbsp;<a>{postname}</a>&nbsp;&nbsp;发表于&nbsp;{posttime}<div style="float:right; padding-right:5px"><a href="javascript:void(0)" onclick="CNOA_project_proj_joinproj.replydiscuss({did},{rid})">回复</a></div></div>','      <div class="user_task_discuss_view_body_right_body">{content}</div>',"    </div>",'    <div class="clear"></div>',"  </div>","  </tpl>","</div>");e.readInfo=function(){d.getEl().mask(lang("waiting"));Ext.Ajax.request({url:e.baseUrl+"&task=getDiscussInfo",method:"POST",params:{did:b},success:function(i){var g=Ext.decode(i.responseText);if(g.success===true){rd=g.data;a.overwrite(d.body,rd);d.getEl().unmask()}else{CNOA.msg.alert(g.msg,function(){})}}})};var d=new Ext.Panel({region:"center",layout:"fit",border:false,autoScroll:true,listeners:{render:function(){e.readInfo()}},tbar:new Ext.Toolbar({items:[{text:lang("refresh"),iconCls:"icon-system-refresh",handler:function(){e.readInfo()}},{text:"回复",iconCls:"icon-expand-members",handler:function(){e.replydiscuss(b,0)}}]})});var c=new Ext.Window({title:"查看讨论窗口",width:800,height:makeWindowHeight(600),modal:true,layout:"border",items:[d],buttons:[{text:lang("close"),handler:function(){c.close()}}]}).show()},replydiscuss:function(c,a){var g=this;var d=function(){if(b.getForm().isValid()){b.getForm().submit({url:g.baseUrl+"&task=discussprojreply",waitMsg:lang("waiting"),method:"POST",params:{did:c,rid:a},success:function(i,j){CNOA.msg.notice(j.result.msg,"项目管理");e.close();g.readInfo()}.createDelegate(this),failure:function(i,j){CNOA.msg.alert(j.result.msg)}.createDelegate(this)})}};var b=new Ext.form.FormPanel({region:"center",border:false,labelWidth:60,labelAlign:"right",waitMsgTarget:true,items:[{xtype:"panel",border:false,bodyStyle:"padding:10px",layout:"form",items:[{xtype:"textarea",name:"content",height:"180",allowBlank:false,fieldLabel:"回复内容",width:"480"}]}]});var e=new Ext.Window({title:"发帖窗口",width:600,height:300,modal:true,layout:"border",items:[b],buttons:[{text:"提交",handler:function(){d()}},{text:lang("close"),handler:function(){e.close()}}]}).show()},discussWin:function(a){var e=this;var c=function(){if(b.getForm().isValid()){b.getForm().submit({url:e.baseUrl+"&task=discussprojadd",waitMsg:lang("waiting"),method:"POST",params:{pid:a},success:function(g,i){CNOA.msg.notice(i.result.msg,"项目管理");d.close();e.storediscuss.reload()}.createDelegate(this),failure:function(g,i){CNOA.msg.alert(i.result.msg)}.createDelegate(this)})}};var b=new Ext.form.FormPanel({region:"center",border:false,labelWidth:50,labelAlign:"right",bodyStyle:"padding:10px",waitMsgTarget:true,items:[{xtype:"textfield",name:"title",fieldLabel:lang("title"),allowBlank:false,width:"480"},{xtype:"textarea",name:"content",fieldLabel:lang("content"),width:"480",allowBlank:false,height:"180"}]});var d=new Ext.Window({title:"发帖窗口",width:600,height:300,modal:true,layout:"border",items:[b],buttons:[{text:"提交",handler:function(){c()}},{text:lang("close"),handler:function(){d.close()}}]}).show()},viewProject:function(b){var i=this;var g=i.baseUrl+"&task=loadPage&pid="+b+"&from=";var e=Ext.id();var c=true;var a=new Ext.Panel({region:"center",border:false,html:'<div style="width:100%;height:100%;"><iframe scrolling=auto frameborder=0 width=100% height=100% id="'+e+'"></iframe></div>',listeners:{afterrender:function(){if(c){Ext.getDom(e).contentWindow.location.href=g+"viewbaseinfo";c=false}}}});var d=new Ext.Window({title:"项目基本信息",layout:"border",width:790,height:makeWindowHeight(700),resizable:true,modal:true,maximizable:true,listeners:{show:function(){},close:function(){}},items:[a]}).show()},startProject:function(a){var b=this;CNOA.msg.cf("您确定开始该项目吗？",function(c){if(c=="yes"){Ext.Ajax.request({url:b.baseUrl+"&task=startProject",method:"POST",params:{pid:a},success:function(e){var d=Ext.decode(e.responseText);if(d.success===true){CNOA.msg.notice(d.msg,"项目管理");b.store.reload()}else{CNOA.msg.alert(d.msg)}}})}})},formatday:function(e,c,a,g,b,d){if(a.data.tday>a.data.pday){if(e<0){return""}return"<span class='cnoa_color_red'><b>"+e+"</b></span>"}else{if(e<0){return""}return"<span class='cnoa_color_green'><b>"+e+"</b></span>"}},finishProject:function(b){var e=this;var a=new Ext.form.FormPanel({border:false,hideBorders:true,labelWidth:10,waitMsgTarget:true,bodyStyle:"padding-top:20px;",items:[{xtype:"textarea",anchor:"-20 -20",name:"summary"}]});var d=new Ext.Window({width:500,height:400,title:"项目完成总结",resizable:true,modal:true,layout:"fit",items:a,buttons:[{text:"提交总结",iconCls:"icon-order-s-accept",handler:function(){c()}.createDelegate(this)},{text:lang("cancel"),iconCls:"icon-dialog-cancel",handler:function(){d.close()}.createDelegate(this)}]}).show();var c=function(){var g=a.getForm().findField("summary").getValue();Ext.Ajax.request({url:e.baseUrl+"&task=finishProject",method:"POST",params:{pid:b,summary:g},success:function(j){var i=Ext.decode(j.responseText);if(i.success===true){CNOA.msg.notice(i.msg,"项目管理");e.store.reload();d.close()}else{CNOA.msg.alert(i.msg)}}})}},urgeProject:function(b){var e=this;var a=new Ext.form.FormPanel({border:false,hideBorders:true,labelWidth:10,waitMsgTarget:true,bodyStyle:"padding-top:5px;",items:[{xtype:"displayfield",value:"项目进度1~99"},{xtype:"textfield",width:150,name:"upgate",allowBlank:false,fieldLabel:"",regex:/^\d{1,2}$/i,regexText:"必须设置为0到90的整数数字"},{xtype:"displayfield",value:"进度汇报："},{xtype:"textarea",width:560,height:200,name:"content"}]});var d=new Ext.Window({width:610,height:350,title:"项目进度",resizable:true,modal:true,layout:"fit",items:a,buttons:[{text:"提交",iconCls:"icon-order-s-accept",handler:function(){c()}.createDelegate(this)},{text:lang("cancel"),iconCls:"icon-dialog-cancel",handler:function(){d.close()}.createDelegate(this)}]}).show();var c=function(){var g=a.getForm().findField("upgate").getValue();var i=a.getForm().findField("content").getValue();Ext.Ajax.request({url:e.baseUrl+"&task=urgeProject",method:"POST",params:{pid:b,upgrade:g,content:i},success:function(k){var j=Ext.decode(k.responseText);if(j.success===true){CNOA.msg.notice(j.msg,"项目管理");e.store.reload();d.close()}else{CNOA.msg.alert(j.msg)}}})}},editTask:function(a){mainPanel.closeTab("CNOA_MENU_USER_TASK_ADDEDIT");mainPanel.loadClass("index.php?app=user&func=task&action=default&task=loadPage&from=addedit&job=edit&tid="+a,"CNOA_MENU_USER_TASK_ADDEDIT","修改任务")},deleteTask:function(b,a){var c=this;CNOA.msg.cf("确定删除本任务吗？",function(d){if(d=="yes"){Ext.Ajax.request({url:c.baseUrl+"&task=operateTask&tid="+b,method:"POST",params:{tid:b,job:"delete",status:a},success:function(g){var e=Ext.decode(g.responseText);if(e.success===true){CNOA.msg.notice(e.msg,"项目管理");c.store.reload()}else{CNOA.msg.alert(e.msg)}}})}})},checkTask:function(a){mainPanel.closeTab("CNOA_MENU_PROJECT_TASK_CHECK");mainPanel.loadClass("index.php?app=project&func=proj&action=main&module=myproj&task=loadPage&from=check&pid="+a,"CNOA_MENU_PROJECT_TASK_CHECK","审批项目任务","icon-page-view")},viewTask:function(a){mainPanel.closeTab("CNOA_MENU_USER_TASK_VIEW");mainPanel.loadClass("index.php?app=user&func=task&action=default&task=loadPage&from=view&tid="+a,"CNOA_MENU_USER_TASK_VIEW","查看任务","icon-page-view")},addTask:function(){mainPanel.closeTab("CNOA_MENU_USER_TASK_ADDEDIT");mainPanel.loadClass("index.php?app=user&func=task&action=default&task=loadPage&from=addedit&job=add","CNOA_MENU_USER_TASK_ADDEDIT","布置任务","icon-page-addedit")}};var CNOA_project_proj_docClass,CNOA_project_proj_doc;CNOA_project_proj_docClass=CNOA.Class.create();CNOA_project_proj_docClass.prototype={init:function(){var i=this;this.baseUrl="index.php?app=project&func=proj&action=main&module=doc";var d=Ext.id();var a=Ext.id();this.storeLd=false;this.sortStoreLd=false;this.canUploadFile=false;var c=Ext.id();var e=Ext.id();var b=Ext.id();var g=Ext.id();this.position="我参与的项目";this.storeBar={type:"project",parentid:0,fid:0,title:""};this.projectComboBoxDataStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:i.baseUrl+"&task=getProjectList"}),reader:new Ext.data.JsonReader({root:"data",fields:[{name:"pid"},{name:"name"}]})});this.projectComboBoxDataStore.load();this.sortStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getCostTypeList",method:"POST"}),reader:new Ext.data.JsonReader({root:"data",fields:[{name:"sid",mapping:"sid"},{name:"sname",mapping:"sname"}]})});this.sortStore.load();this.sortCombo=new Ext.form.ComboBox({autoLoad:true,triggerAction:"all",selectOnFocus:true,editable:false,store:this.sortStore,valueField:"sid",displayField:"sname",allowBlank:false,mode:"local",forceSelection:true});this.fields=[{name:"fid"},{name:"title"},{name:"size"},{name:"time"},{name:"postname"},{name:"downpath"},{name:"ext"},{name:"dl"},{name:"dt"}];this.store=new Ext.data.GroupingStore({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getJsonData"}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields}),listeners:{load:function(j){i.storeBar.parentid=j.reader.jsonData.parentid;Ext.getCmp(g).getEl().update(j.reader.jsonData.position);if(j.reader.jsonData.emptyDir){CNOA.msg.alert("该项目还没有任何目录， 您可以联系立项人在项目变更中创建目录")}if(j.reader.jsonData.uploadFile==1){i.canUploadFile=true}else{i.canUploadFile=false}}}});this.store.load({params:{type:"project"}});this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.colModel=new Ext.grid.ColumnModel([{header:"fid",dataIndex:"fid",hidden:true},{header:"",dataIndex:"",width:50,sortable:false,menuDisabled:true},{header:"目录/文件名",dataIndex:"title",width:250,sortable:false,menuDisabled:true,renderer:this.formattitle.createDelegate(this)},{header:"文件名后缀",dataIndex:"ext",width:250,sortable:true,menuDisabled:true},{header:"添加时间",dataIndex:"time",width:180,sortable:false,menuDisabled:true},{header:"大小",dataIndex:"size",width:150,sortable:false,menuDisabled:true},{header:lang("opt"),dataIndex:"fid",width:150,sortable:false,menuDisabled:true,renderer:this.operation.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.grid=new Ext.grid.GridPanel({store:this.store,width:600,plain:false,stripeRows:true,loadMask:{msg:lang("waiting")},region:"center",border:false,autoScroll:true,cm:this.colModel,sm:this.sm,view:new Ext.grid.GroupingView({markDirty:false}),listeners:{rowdblclick:function(j,k){i.storeBar.fid=j.store.getAt(k).get("fid");if(i.storeBar.type=="project"){i.storeBar.type="dir";i.store.load({params:i.storeBar});Ext.getCmp(e).enable()}else{if(i.storeBar.type=="dir"){i.storeBar.type="file";i.store.load({params:i.storeBar})}else{CNOA.msg.alert("已经到底了",function(){return})}}}},tbar:[{handler:function(j,k){i.store.reload()}.createDelegate(this),iconCls:"icon-system-refresh",text:lang("refresh")},{handler:function(j,k){if(i.storeBar.type=="file"){i.storeBar.type="dir";i.storeBar.fid=i.storeBar.parentid}else{if(i.storeBar.type=="dir"){i.storeBar.type="project"}}i.store.load({params:i.storeBar})}.createDelegate(this),listeners:{click:function(){if(i.storeBar.type=="dir"){Ext.getCmp(e).disable()}}},id:e,disabled:true,cls:"btn-blue4",iconCls:"icon-arrow-up",text:"向上"},{handler:function(j,k){if(i.storeBar.type=="file"){if(i.canUploadFile){i.uploadwin()}else{CNOA.msg.alert("您没有上传文件的权限")}}else{CNOA.msg.alert("只有在项目文件夹才可以上传文件")}}.createDelegate(this),cls:"btn-red1",iconCls:"icon-file-up",text:"上传文件"},"您的位置：",{xtype:"box",id:g,autoEl:{tag:"div",html:""}},"->",{xtype:"cnoa_helpBtn",helpid:2011}]});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.grid],listeners:{}})},operation:function(g,d,a,j,b,e){var i=this;var c=a.data;if(i.storeBar.type=="file"){h="";if(c.dl==1){h+=c.downpath}h+="&nbsp;&nbsp;&nbsp;&nbsp;";if(c.dt==1){h+="<a href='javascript:void(0)' onclick='CNOA_project_proj_doc.deletefile("+g+")'><span class='cnoa_color_red'>删除</span></a>"}return h}else{return""}},deletefile:function(a){var b=this;CNOA.msg.cf("您确定删除这个文件吗？",function(c){if(c=="yes"){Ext.Ajax.request({url:b.baseUrl+"&task=deletefile",method:"POST",params:{fid:a},success:function(e){var d=Ext.decode(e.responseText);if(d.success===true){CNOA.msg.notice(d.msg,"项目管理");b.store.reload()}else{CNOA.msg.alert(d.msg)}}})}})},uploadwin:function(){var g=this;var e=e==undefined?"0":e;var a=Ext.id();var c=function(){if(f.isValid()){f.submit({url:g.baseUrl+"&task=rename",waitTitle:lang("notice"),method:"POST",waitMsg:lang("waiting"),params:params,success:function(i,j){d.close();g.store.reload();if((type=="d")||(tp=="add")){g.refreshTree()}}.createDelegate(this),failure:function(i,j){CNOA.msg.alert(j.result.msg,function(){})}.createDelegate(this)})}};var b=new Ext.form.FormPanel({bodyStyle:"padding:10px;",border:false,waitMsgTarget:true,items:[{xtype:"textfield",width:325,hideLabel:true,allowBlank:false,name:"name",value:name,listeners:{render:function(i){i.focus.defer(100,i)}}}]});var d=new Ext.Window({width:500,height:300,layout:"fit",modal:true,title:"上传文件",resizable:false,items:[],listeners:{render:function(i){i.add(new Ext.ux.SwfUploadPanel({border:false,upload_url:"../"+g.baseUrl+"&task=upload&CNOAOASESSID="+CNOA.cookie.get("CNOAOASESSID"),post_params:{did:g.storeBar.fid},flash_url:"resources/swfupload.swf",single_file_select:false,confirm_delete:false,remove_completed:false,file_types:"*.*",file_types_description:"所有格式",listeners:{fileUploadComplete:function(){g.store.reload()},uploadError:function(k,j,l){}}}))},close:function(){}}}).show()},formattitle:function(e,c,a,i,b,d){var g=this;if(g.storeBar.type=="file"){return'<img src="/resources/images/icons_file/file.gif" align="absmiddle">&nbsp;&nbsp;'+e}else{if(g.storeBar.type=="dir"){return'<img src="'+CNOA_EXTJS_PATH+'/resources/images/default/tree/folder.gif" align="absmiddle">&nbsp;&nbsp;'+e}else{return'<img src="/resources/images/icons/icon-roduction2.png" align="absmiddle">&nbsp;&nbsp;'+e}}}};var CNOA_project_proj_costClass,CNOA_project_proj_cost;CNOA_project_proj_costClass=CNOA.Class.create();CNOA_project_proj_costClass.prototype={init:function(){var d=this;this.baseUrl="index.php?app=project&func=proj&action=main&module=cost";var c=Ext.id();var a=Ext.id();this.storeLd=false;this.sortStoreLd=false;var b=Ext.id();this.searchbar={type:"waiting",costtype:"",costtitle:"",pid:0};this.projectComboBoxDataStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:d.baseUrl+"&task=getProjectList"}),reader:new Ext.data.JsonReader({root:"data",fields:[{name:"pid"},{name:"name"}]})});this.projectComboBoxDataStore.load();this.sortStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getCostTypeList",method:"POST"}),reader:new Ext.data.JsonReader({root:"data",fields:[{name:"sid",mapping:"sid"},{name:"sname",mapping:"sname"}]})});this.sortStore.load();this.sortCombo=new Ext.form.ComboBox({autoLoad:true,triggerAction:"all",selectOnFocus:true,editable:false,store:this.sortStore,valueField:"sid",displayField:"sname",allowBlank:false,mode:"local",forceSelection:true});this.fields=[{name:"bid"},{name:"title"},{name:"costtype"},{name:"projectname"},{name:"statusname"},{name:"status"},{name:"t_cost"},{name:"posttime"},{name:"checktime"},{name:"checkname"},{name:"costnotes"},{name:"postname"}];this.store=new Ext.data.GroupingStore({autoLoad:true,proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getJsonData"}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields}),listeners:{load:function(g,e,i){d.columrecord=e}}});this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.colModel=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),this.sm,{header:"pid",dataIndex:"bid",hidden:true},{header:"预算类型",dataIndex:"costtype",width:150,sortable:false,menuDisabled:true},{header:"费用名称",dataIndex:"title",width:180,sortable:false,menuDisabled:true},{header:"审批状态",dataIndex:"statusname",width:60,sortable:false,menuDisabled:true},{header:"金额(元)",dataIndex:"t_cost",width:120,sortable:false,menuDisabled:true},{header:"项目名称",dataIndex:"projectname",width:178,sortable:false,menuDisabled:true},{header:"提交人",dataIndex:"postname",width:80,sortable:false,menuDisabled:true},{header:"审批时间",dataIndex:"checktime",width:80,sortable:false,menuDisabled:true},{header:"审批人",dataIndex:"checkname",width:80,sortable:false,menuDisabled:true},{header:"费用说明",dataIndex:"costnotes",width:80,sortable:false,menuDisabled:true,renderer:this.description.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.grid=new Ext.grid.GridPanel({store:this.store,width:600,plain:false,stripeRows:true,loadMask:{msg:lang("waiting")},region:"center",border:false,autoScroll:true,cm:this.colModel,sm:this.sm,view:new Ext.grid.GroupingView({markDirty:false}),tbar:[{handler:function(e,g){d.store.reload()}.createDelegate(this),iconCls:"icon-system-refresh",text:lang("refresh")},{xtype:"panel",border:false,items:[new CNOA.form.ComboBox({name:"pid",allowBlank:false,emptyText:"请选择项目名称.....",store:d.projectComboBoxDataStore,id:b,hiddenName:"pid",valueField:"pid",displayField:"name",mode:"local",width:280,allowBlank:true,triggerAction:"all",forceSelection:true,editable:false,listeners:{select:function(i,e,g){d.searchbar.pid=i.getValue();d.store.load({params:d.searchbar})}.createDelegate(this)}})]},{text:lang("clear"),handler:function(e){Ext.getCmp(b).setValue("");d.searchbar.pid=0;d.store.load({params:d.searchbar})}},{text:"审批通过",iconCls:"icon-customes-task",cls:"btn-blue3",handler:function(e){var g=d.grid.getSelectionModel().getSelections();if(g.length==0){CNOA.miniMsg.alertShowAt(e,"您还没有选择需要通过审批的费用")}else{CNOA.msg.cf("确定要提交审批吗?",function(k){if(k=="yes"){if(g){var l="";for(var j=0;j<g.length;j++){l+=g[j].get("bid")+",";var m=g[j]}d.submitCheck(l,"pass")}}})}}},{text:"审批不通过",cls:"btn-gray1",iconCls:"icon-customes-task",handler:function(e){var g=d.grid.getSelectionModel().getSelections();if(g.length==0){CNOA.miniMsg.alertShowAt(e,"您还没有选择需要不通过审批的费用")}else{CNOA.msg.cf("确定要提交审批吗?",function(k){if(k=="yes"){if(g){var l="";for(var j=0;j<g.length;j++){l+=g[j].get("bid")+",";var m=g[j]}d.submitCheck(l,"unpass")}}})}}},"<span class='cnoa_color_gray'>提示:您可以针对项目来对单个项目费用进行审批，每个人负责独立的项目</span>","->",{xtype:"cnoa_helpBtn",helpid:2011}]});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.grid],listeners:{},tbar:new Ext.Toolbar({style:"border-left-width:1px;",items:["费用类别:",{xtype:"panel",border:false,items:[new Ext.form.ComboBox({name:"sid",store:d.sortStore,hiddenName:"sid",valueField:"sid",displayField:"sname",id:c,mode:"local",width:160,triggerAction:"all",forceSelection:true,editable:false,listeners:{select:function(i,e,g){}.createDelegate(this)}})]},"费用名称:",{xtype:"textfield",width:168,id:a},{xtype:"button",text:lang("search"),style:"margin-left:5px",handler:function(){d.searchbar.costtype=Ext.getCmp(c).getValue();d.searchbar.costtitle=Ext.getCmp(a).getValue();d.store.load({params:d.searchbar})}},{xtype:"button",text:lang("clear"),handler:function(){Ext.getCmp(c).setValue();Ext.getCmp(a).setValue();d.searchbar.costtype="";d.searchbar.costtitle="";d.store.load({params:d.searchbar})}},{xtype:"button",handler:function(e,g){d.searchbar.type="waiting";d.store.load({params:d.searchbar})}.createDelegate(this),iconCls:"icon-apply-cost-check",enableToggle:true,pressed:true,allowDepress:false,toggleGroup:"project_proj_apply_cost_check",cls:"btn-yellow1",tooltip:"显示未审核的费用",text:"未审批"},{xtype:"button",handler:function(e,g){d.searchbar.type="checked";d.store.load({params:d.searchbar})}.createDelegate(this),enableToggle:true,cls:"btn-red1",allowDepress:false,toggleGroup:"project_proj_apply_cost_check",iconCls:"icon-pass",tooltip:"显示已审核的费用",text:"已审批"},{xtype:"button",handler:function(e,g){d.searchbar.type="unpass";d.store.load({params:d.searchbar})}.createDelegate(this),enableToggle:true,cls:"btn-gray1",allowDepress:false,toggleGroup:"project_proj_apply_cost_check",iconCls:"icon-noPass",tooltip:"显示审核不通过的费用",text:"审批不通过"}]})})},description:function(e,c,a,g,b,d){return"<a href='javascript:void(0)' onclick='CNOA_project_proj_cost.costnotes("+a.data.bid+")'>"+e+"</a>"},costnotes:function(a){var b=this;Ext.each(b.columrecord,function(c,d){if(c.data.bid==a){b.costnoteswindow(c.data.costnotes,c.data.title)}})},costnoteswindow:function(b,a){var c=this;this.window=new Ext.Window({title:"费用名称("+a+")",width:600,height:300,layout:"border",modal:true,items:[new Ext.Panel({region:"center",autoScroll:true,html:"<div><p>&nbsp;&nbsp;&nbsp;"+b+"</p></div>",layout:"fit",border:false})],buttons:[{text:lang("close"),handler:function(){c.window.close()}}]}).show()},budgetSubmit:function(a){var b=this;Ext.Ajax.request({url:this.baseUrl+"&task=submitBudget",params:a,method:"POST",success:function(e,d){var c=Ext.decode(e.responseText);if(c.success===true){b.store.reload()}else{CNOA.msg.alert(c.msg,function(){b.store.load({params:{applyId:CNOA.project.proj.applyproj.applyID}})})}},failure:function(c,d){CNOA.msg.alert(result.msg,function(){b.store.reload()})}})},deleteData:function(a){var b=this;Ext.Ajax.request({url:this.baseUrl+"&task=deletebudget",method:"POST",params:{ids:a},success:function(d){var c=Ext.decode(d.responseText);if(c.success===true){CNOA.msg.notice(c.msg,"项目管理");b.store.reload()}else{CNOA.msg.alert(c.msg)}}})},submitCheck:function(b,a){var c=this;Ext.Ajax.request({url:this.baseUrl+"&task=submitCostCheck",params:{bid:b,type:a},method:"POST",success:function(g,e){var d=Ext.decode(g.responseText);if(d.success===true){CNOA.msg.notice(d.msg,"项目管理");c.store.reload()}else{CNOA.msg.alert(d.msg,function(){c.store.load({params:{applyId:CNOA.project.proj.applyproj.applyID}})})}},failure:function(d,e){CNOA.msg.alert(result.msg,function(){c.store.reload()})}})},budgetStatus:function(e,c,a,g,b,d){e=a.data.status;if(e==0){return"未审批"}else{if(e==1){return"<span class='cnoa_color_green'>审批中</span>"}else{if(e==2){return"<span class='cnoa_color_blue'>审批通过</span>"}else{if(e==3){return"<span class='cnoa_color_red'>审批不通过</span>"}}}}}};var CNOA_project_proj_checkTaskClass,CNOA_project_proj_checkTask;CNOA_project_proj_checkTaskClass=CNOA.Class.create();CNOA_project_proj_checkTaskClass.prototype={init:function(){var e=this;this.edit_id=0;this.content_start=1;this.baseUrl="index.php?app=project&func=proj&action=main&module=myproj&pid="+CNOA.project.proj.checktask.pid;var d=Ext.id();var a=Ext.id();var b=Ext.id();this.fields=[{name:"tid"},{name:"title"},{name:"status"},{name:"statusname"},{name:"level"},{name:"progress"},{name:"execman"},{name:"postter"},{name:"administer"},{name:"ttime"},{name:"ptime"},{name:"pday"},{name:"tday"},{name:"agreeable"},{name:"disagreeable"},{name:"upgradetitle"},{name:"upgradewidth"},{name:"upgradecolor"}];this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getCheckTaskList",disableCaching:true}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields}),listeners:{load:function(i,g,j){Ext.getCmp(d).setText("待审("+i.reader.jsonData.waiting+")");Ext.getCmp(a).setText("已审批("+i.reader.jsonData.checked+")");Ext.getCmp(b).setText("进行中/未开时("+i.reader.jsonData.doing+")")}}});this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.store.load();this.colModel=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"tid",dataIndex:"tid",hidden:true},{header:"任务标题",dataIndex:"title",width:160,sortable:true,menuDisabled:true},{header:"任务进度",dataIndex:"progress",width:100,sortable:false,menuDisabled:true,renderer:this.makeStatus.createDelegate(this)},{header:"布置人",dataIndex:"postter",width:80,sortable:false,menuDisabled:true},{header:"执行人",dataIndex:"administer",width:80,sortable:false,menuDisabled:true},{header:"任务级别",dataIndex:"level",width:80,sortable:false,menuDisabled:true},{header:"计划时间",dataIndex:"ptime",width:120,sortable:false,menuDisabled:true},{header:"计划工时(天)",dataIndex:"pday",width:80,sortable:false,menuDisabled:true},{header:"实际时间",dataIndex:"ttime",width:120,sortable:false,menuDisabled:true},{header:"实际工时(天)",dataIndex:"tday",width:80,sortable:false,menuDisabled:true,renderer:this.formatday.createDelegate(this)},{header:"状态",dataIndex:"statusname",width:80,sortable:false,menuDisabled:true},{header:lang("opt"),dataIndex:"",width:100,sortable:false,menuDisabled:true,renderer:this.makeOperate.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.pagingBar=new Ext.PagingToolbar({displayInfo:true,store:this.store,pageSize:15,listeners:{beforechange:function(g,i){if(e.search.title!=""){i.title=e.search.title}if(e.search.uid!=0&&e.search.uid!=""){i.uid=e.search.uid}if(e.search.execman!=0&&e.search.execman!=""){i.execman=e.search.execman}if(e.search.examapp!=0&&e.search.examapp!=""){i.examapp=e.search.examapp}}}});var c=Ext.id();this.grid=new Ext.grid.GridPanel({store:this.store,loadMask:{msg:lang("waiting")},cm:this.colModel,sm:this.sm,stripeRows:true,hideBorders:true,border:false,listeners:{rowdblclick:function(g,i){},cellclick:function(g,k,i,j){},cellclick:function(i,l,j,k){var g=i.getStore().getAt(l);if(j==2){this.viewTask(g.data.tid)}}.createDelegate(this)},tbar:new Ext.Toolbar({items:[{handler:function(g,i){e.store.reload()}.createDelegate(this),iconCls:"icon-system-refresh",text:lang("refresh")},{text:"待审",iconCls:"icon-system-menu-user",tooltip:"显示需要审批的项目任务列表",id:d,enableToggle:true,pressed:true,allowDepress:false,toggleGroup:"project_proj_myproject_checktask",handler:function(){e.hurry=false;e.store.load({params:{status:"waitting"}})}},{text:"已审批",iconCls:"icon-system-menu-user",tooltip:"显示已完成审批的任务列表",id:a,enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproject_checktask",handler:function(){e.hurry=false;e.store.load({params:{status:"checked"}})}},{text:"进行/未开始",iconCls:"icon-system-menu-user",tooltip:"显示进行中的任务列表",id:b,enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproject_checktask",handler:function(){e.hurry=true;e.store.load({params:{status:"doing"}})}},"<span class='cnoa_color_gray'>注意:如果需要催促任务，可以点击进行/未开始的任务按钮，然后就可以催促任务了。</span>","->",{xtype:"cnoa_helpBtn",helpid:2006}]})});this.centerPanel=new Ext.Panel({region:"center",layout:"fit",items:[this.grid]});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.centerPanel]})},makeStatus:function(j,g,c,i,e,b){var l=c.data;var k=0;var a="#5B5B5B";upgradetitle=l.upgradetitle;k=l.upgradewidth;a=l.upgradecolor;var d="<div style='color:#808080;margin-top:3px;'>"+upgradetitle+"</div>";d+="<div style='width:100px;height:5px;background-color:#D4D4D4;'><div style='font-size:0;line-height:0;height:5px;width:"+k+"px;background-color:"+a+";'></div></div>";return d},makeOperate:function(l,i,c,j,e,a){var d=this;var m=c.data;var k=false;var g=false;if(m.status==6){k=true;g=true}var b="";b+="&nbsp;&nbsp;";b+="<a href='javascript:void(0);' onclick='CNOA_project_proj_checkTask.viewTask("+m.tid+");'>查看</a>";b+="&nbsp;&nbsp;&nbsp;/&nbsp;&nbsp;&nbsp;";b+=d.hurry?"<a href='javascript:void(0);' onclick='CNOA_project_proj_checkTask.hurryup("+m.tid+");'>催促</a>":"<span class='cnoa_color_gray2'>催促</span>";b+="&nbsp;&nbsp;";b+="<br />";b+="&nbsp;&nbsp;";b+=k?"<a href='javascript:void(0);' onclick='CNOA_project_proj_checkTask.agreeTask("+m.tid+");'><span class='cnoa_color_green'>同意</span></a>":"<span class='cnoa_color_gray'>同意</span>";b+="&nbsp;&nbsp;&nbsp;/&nbsp;&nbsp;&nbsp;";b+=g?"<a href='javascript:void(0);' onclick='CNOA_project_proj_checkTask.disagreeTask("+m.tid+");'><span class='cnoa_color_red'>不同意</span></a>":"<span class='cnoa_color_gray'>不同意</span>";return b},agreeTask:function(d){var e=this;var a=new Ext.form.FormPanel({border:false,hideBorders:true,labelWidth:10,waitMsgTarget:true,bodyStyle:"padding-top:20px;",items:[{xtype:"textarea",anchor:"-20 -20",name:"content",emptyText:"意见为空提交，表示无意见审批同意..."}]});var c=new Ext.Window({width:500,height:400,title:"任务审批同意意见",resizable:true,modal:true,layout:"fit",items:a,buttons:[{text:"提交",iconCls:"icon-order-s-accept",handler:function(){b()}.createDelegate(this)},{text:lang("cancel"),iconCls:"icon-dialog-cancel",handler:function(){c.close()}.createDelegate(this)}]}).show();var b=function(){var g=a.getForm().findField("content").getValue();Ext.Ajax.request({url:e.baseUrl+"&task=agreeTask",method:"POST",params:{tid:d,content:g},success:function(j){var i=Ext.decode(j.responseText);if(i.success===true){CNOA.msg.notice(i.msg,"项目管理");e.store.reload();c.close()}else{CNOA.msg.alert(i.msg)}}})}},disagreeTask:function(d){var e=this;var a=new Ext.form.FormPanel({border:false,hideBorders:true,labelWidth:10,waitMsgTarget:true,bodyStyle:"padding-top:20px;",items:[{xtype:"textarea",anchor:"-20 -20",name:"content",emptyText:"意见为空提交，表示无意见审批不同意..."}]});var c=new Ext.Window({width:500,height:400,title:"任务审批不同意意见",resizable:true,modal:true,layout:"fit",items:a,buttons:[{text:"提交",iconCls:"icon-order-s-accept",handler:function(){b()}.createDelegate(this)},{text:lang("cancel"),iconCls:"icon-dialog-cancel",handler:function(){c.close()}.createDelegate(this)}]}).show();var b=function(){var g=a.getForm().findField("content").getValue();Ext.Ajax.request({url:e.baseUrl+"&task=disagreeTask",method:"POST",params:{tid:d,content:g},success:function(j){var i=Ext.decode(j.responseText);if(i.success===true){CNOA.msg.notice(i.msg,"项目管理");e.store.reload();c.close()}else{CNOA.msg.alert(i.msg)}}})}},formatday:function(e,c,a,g,b,d){if(a.data.tday>a.data.pday){return"<span class='cnoa_color_red'><b>"+e+"</b></span>"}else{return"<span class='cnoa_color_green'><b>"+e+"</b></span>"}},viewTask:function(b,a){var e=this;var d=e.baseUrl+"&task=loadPage&from=viewTaskdetail&tid="+b;var c="任务的详细信息";this.win=new Ext.Window({title:c,width:800,height:makeWindowHeight(600),resizable:true,modal:true,maximizable:true,html:'<div style="width:100%;height:100%;"><iframe scrolling=auto frameborder=0 width=100% height=100% src="'+d+'"></iframe></div>'}).show()},hurryup:function(d){var e=this;var a=new Ext.form.FormPanel({border:false,hideBorders:true,labelWidth:10,waitMsgTarget:true,bodyStyle:"padding-top:20px;",items:[{xtype:"textarea",anchor:"-20 -20",name:"content",emptyText:"意见为空提交，表示无意见催促..."}]});var c=new Ext.Window({width:500,height:400,title:"任务催促",resizable:true,modal:true,layout:"fit",items:a,buttons:[{text:"提交",iconCls:"icon-order-s-accept",handler:function(){b()}.createDelegate(this)},{text:lang("cancel"),iconCls:"icon-dialog-cancel",handler:function(){c.close()}.createDelegate(this)}]}).show();var b=function(){var g=a.getForm().findField("content").getValue();Ext.Ajax.request({url:e.baseUrl+"&task=hurryup",method:"POST",params:{tid:d,content:g},success:function(j){var i=Ext.decode(j.responseText);if(i.success===true){CNOA.msg.notice(i.msg,"项目管理");e.store.reload();c.close()}else{CNOA.msg.alert(i.msg)}}})}}};var CNOA_project_proj_askClass,CNOA_project_proj_ask;CNOA_project_proj_askClass=CNOA.Class.create();CNOA_project_proj_askClass.prototype={init:function(){var g=this;this.edit_id=0;this.content_start=1;this.baseUrl="index.php?app=project&func=proj&action=main&module=ask";this.tpl=new Ext.XTemplate('<div class="user_task_discuss_view">','  <div class="user_task_discuss_view_header">','    <div class="user_task_discuss_view_header_title">[问题标题]&nbsp;&nbsp;{title}&nbsp;&nbsp;[{status}]</div>',"  </div>",'  <div class="user_task_discuss_view_body">','    <div class="user_task_discuss_view_body_left">','      <div class="user_task_discuss_view_body_left_top">{postname}[{job}]</div>','      <div class="user_task_discuss_view_body_left_body">','        <span><img src="{face}" width="120" height="130" onerror="this.src=\'./resources/images/default.jpg\'" /></span>',"      </div>","    </div>",'    <div class="user_task_discuss_view_body_right">','      <div class="user_task_discuss_view_body_right_top">#{[xindex]}&nbsp;&nbsp;<a>{postname}</a>&nbsp;&nbsp;发表于&nbsp;{time}</div>','      <div class="user_task_discuss_view_body_right_body">{content}</div>',"    </div>",'    <div class="clear"></div>',"  </div>",'  <tpl for="list">','  <div class="user_task_discuss_view_body">','    <div class="user_task_discuss_view_body_left">','      <div class="user_task_discuss_view_body_left_top">{postname}[{job}]</div>','      <div class="user_task_discuss_view_body_left_body">','        <span><img src="{face}" width="120" height="130" onerror="this.src=\'./resources/images/default.jpg\'" /></span>',"      </div>","    </div>",'    <div class="user_task_discuss_view_body_right">','      <div class="user_task_discuss_view_body_right_top">#{[xindex]}&nbsp;&nbsp;<a>{postname}</a>&nbsp;&nbsp;发表于&nbsp;{time}</div>','      <div class="user_task_discuss_view_body_right_body">{content}</div>',"    </div>",'    <div class="clear"></div>',"  </div>","  </tpl>","</div>");this.storeBar={title:"",content:"",stime:0,etime:0,status:"",pid:0};this.ID_btn_edit=Ext.id();this.ID_btn_delete=Ext.id();this.ID_plan_content=Ext.id();var d=Ext.id();var b=Ext.id();var a=Ext.id();var e=Ext.id();var c=Ext.id();this.projectComboBoxDataStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:g.baseUrl+"&task=getProjectList"}),reader:new Ext.data.JsonReader({root:"data",fields:[{name:"pid"},{name:"name"}]})});this.projectComboBoxDataStore.load();this.fields=[{name:"aid"},{name:"title"},{name:"content"},{name:"time"},{name:"askname"},{name:"statusname"}];this.searchBar=new Ext.Toolbar({items:["问题标题:",{xtype:"textfield",id:b,width:128},"&nbsp;问题内容:",{xtype:"textfield",id:c,width:200},"&nbsp;提问时间:",{xtype:"datefield",format:"Y-m-d",width:100,id:a},"~",{xtype:"datefield",format:"Y-m-d",width:100,id:e},{xtype:"button",text:lang("search"),style:"margin-left:5px",handler:function(){g.storeBar.title=Ext.getCmp(b).getValue();g.storeBar.content=Ext.getCmp(c).getValue();g.storeBar.stime=Ext.getCmp(a).getRawValue();g.storeBar.etime=Ext.getCmp(e).getRawValue();g.store.load({params:g.storeBar})}},{xtype:"button",text:lang("clear"),style:"margin-left:5px",listeners:{mouseout:function(i){}},handler:function(){Ext.getCmp(b).setValue("");Ext.getCmp(c).setValue("");Ext.getCmp(a).setValue("");Ext.getCmp(e).setValue("");g.storeBar.title="";g.storeBar.content="";g.storeBar.stime=0;g.storeBar.etime=0;g.store.load({params:g.storeBar})}}]});this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getJsonData",disableCaching:true}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields}),listeners:{exception:function(n,m,o,l,k,j){var i=Ext.decode(k.responseText);if(i.failure){CNOA.msg.alert(i.msg)}}}});this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.store.load();this.colModel=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"pid",dataIndex:"pid",hidden:true},{header:"问题标题/内容",dataIndex:"title",width:600,sortable:true,menuDisabled:true,renderer:this.titleContent.createDelegate(this)},{header:"提问人",dataIndex:"askname",width:100,sortable:false,menuDisabled:true},{header:"提问时间",dataIndex:"time",width:120,sortable:false,menuDisabled:true},{header:"状态",dataIndex:"statusname",width:60,sortable:false,menuDisabled:true},{header:lang("opt"),dataIndex:"",width:400,renderer:this.makeOperate.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.pagingBar=new Ext.PagingToolbar({displayInfo:true,store:this.store,pageSize:15,listeners:{beforechange:function(i,j){j.status=g.storeBar.status;j.pid=g.storeBar.pid;if(g.storeBar.title!=""){j.title=g.storeBar.title}if(g.storeBar.content!=0&&g.storeBar.content!=""){j.content=g.storeBar.content}if(g.storeBar.stime!=0&&g.storeBar.stime!=""){j.stime=g.storeBar.stime}if(g.storeBar.etime!=0&&g.storeBar.etime!=""){j.etime=g.storeBar.etime}}}});this.grid=new Ext.grid.GridPanel({store:this.store,stripeRows:true,loadMask:{msg:lang("waiting")},cm:this.colModel,sm:this.sm,hideBorders:true,border:false,viewConfig:{},listeners:{celldblclick:function(j,m,k,l){var i=j.getStore().getAt(m);if(k==2){this.talkAsk(i.data.aid,i.data.title)}}.createDelegate(this),render:function(){g.searchBar.render(this.tbar)}},tbar:new Ext.Toolbar({items:[{handler:function(i,j){g.store.reload()}.createDelegate(this),iconCls:"icon-system-refresh",text:lang("refresh")},{xtype:"panel",border:false,items:[new CNOA.form.ComboBox({name:"pid",allowBlank:false,emptyText:"请选择项目名称.....",store:g.projectComboBoxDataStore,id:d,hiddenName:"pid",valueField:"pid",displayField:"name",mode:"local",width:280,allowBlank:true,triggerAction:"all",forceSelection:true,editable:false,listeners:{select:function(k,i,j){g.storeBar.pid=k.getValue();g.store.load({params:g.storeBar})}.createDelegate(this)}})]},{text:lang("clear"),handler:function(i){Ext.getCmp(d).setValue("");g.storeBar.pid=0;g.store.load({params:g.storeBar})}},{handler:function(i,j){g.storeBar.status="waiting";g.store.load({params:g.storeBar})}.createDelegate(this),iconCls:"icon-waiting",enableToggle:true,pressed:true,allowDepress:false,cls:"btn-yellow1",toggleGroup:"project_proj_ask_type",tooltip:"显示待解决的您参与的问题",text:"待解决的问题"},{handler:function(i,j){g.storeBar.status="my";g.store.load({params:g.storeBar})}.createDelegate(this),iconCls:"icon-system-s-userSelf-help",enableToggle:true,cls:"btn-blue3",allowDepress:false,toggleGroup:"project_proj_ask_type",tooltip:"显示由您发起的所有问题列表,你可以管理你的问题",text:"管理我的问题"},{handler:function(i,j){g.storeBar.status="solved";g.store.load({params:g.storeBar})}.createDelegate(this),enableToggle:true,allowDepress:false,cls:"btn-blue3",toggleGroup:"project_proj_ask_type",iconCls:"icon-pass",tooltip:"显示您参与的已解决的问题",text:"已解决问题"},"<span class='cnoa_color_gray'>问题发布者为该问题的管理者，双击问题标题可查看该问题的讨论区</span>","->",{xtype:"cnoa_helpBtn",helpid:2009}]}),bbar:this.pagingBar});this.centerPanel=new Ext.Panel({region:"center",layout:"fit",items:[this.grid]});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.centerPanel]})},titleContent:function(e,c,a,i,b,d){var g=this;return a.data.title+"<br />"+a.data.content},makeStatus:function(l,i,d,j,g,b){var n=d.data;var m=n.status;var k="&nbsp;";var a=0;var c="#5B5B5B";k=n.statusText;a=n.progress;c=n.statusColor;var e="<div style='color:#808080;margin-top:3px;'>"+k+"</div>";e+="<div style='width:100px;height:5px;background-color:#D4D4D4;'><div style='font-size:0;line-height:0;height:5px;width:"+a+"px;background-color:"+c+";'></div></div>";return e},makeOperate:function(m,k,e,l,i,b){var g=this;var o=e.data;var n=true;var d=false;var a=false;var j=false;if(g.storeBar.status=="waiting"){d=false;a=false;j=false}else{if(g.storeBar.status=="my"){d=true;a=true;j=true}else{if(g.storeBar.status=="solved"){d=false;a=false;j=false}}}var c="<a href='javascript:void(0);' class='gridview' onclick='CNOA_project_proj_ask.talkAsk("+o.aid+', "'+o.title+"\");'>讨论/查看</a>";c+=d?"<a href='javascript:void(0);' class='gridview3 jianju' onclick='CNOA_project_proj_ask.deleteAsk("+o.aid+");'>删除</a>":"<span class='gridview5 jianju'>删除</span>";c+=a?"<a href='javascript:void(0);' class='gridview jianju' onclick='CNOA_project_proj_ask.solvedAsk("+o.aid+");'>已解决</a>":"<span  class='gridview5 jianju'>已解决</span>";c+=j?"<a href='javascript:void(0);' class='gridview3 jianju'  onclick='CNOA_project_proj_ask.unsolvedAsk("+o.aid+");'>未解决</a>":"<span  class='gridview5 jianju'>未解决</span>";return c},solvedAsk:function(a){var b=this;CNOA.msg.cf("您确定该问题设置已解决了吗？",function(c){if(c=="yes"){Ext.Ajax.request({url:b.baseUrl+"&task=solved",method:"POST",params:{aid:a,type:"solved"},success:function(e){var d=Ext.decode(e.responseText);if(d.success===true){CNOA.msg.alert(d.msg,function(){b.store.reload()})}else{CNOA.msg.alert(d.msg)}}})}})},unsolvedAsk:function(a){var b=this;CNOA.msg.cf("您确定该问题设置未解决了吗？",function(c){if(c=="yes"){Ext.Ajax.request({url:b.baseUrl+"&task=solved",method:"POST",params:{aid:a,type:"unsolved"},success:function(e){var d=Ext.decode(e.responseText);if(d.success===true){CNOA.msg.alert(d.msg,function(){b.store.reload()})}else{CNOA.msg.alert(d.msg)}}})}})},deleteAsk:function(a){var b=this;CNOA.msg.cf("您确定要删除该问题吗？",function(c){if(c=="yes"){Ext.Ajax.request({url:b.baseUrl+"&task=delete",method:"POST",params:{aid:a},success:function(e){var d=Ext.decode(e.responseText);if(d.success===true){CNOA.msg.alert(d.msg,function(){b.store.reload()})}else{CNOA.msg.alert(d.msg)}}})}})},talkAsk:function(b,d,a){var e=this;var c=Ext.id();this.replyForm=new Ext.form.FormPanel({border:false,hideBorders:true,waitMsgTarget:true,hideLabels:true,bodyStyle:"padding:0px;",items:[{xtype:"textarea",name:"reply",anchor:"0",height:150}]});this.reply=new Ext.Panel({region:"south",title:"回复",height:150,collapsible:true,split:true,animCollapse:false,margins:"0 0 0 0",items:[this.replyForm],listeners:{collapse:function(){}}});this.contentPanel=new Ext.Panel({region:"center",layout:"fit",border:false,autoScroll:true,listeners:{render:function(){e.readInfo(b)}}});this.replyButton={text:"回复",handler:function(){e.submitReply(b)}};this.window=new Ext.Window({title:"项目："+d+"（双击可最大化窗口）",width:800,height:makeWindowHeight(650),resizable:true,modal:true,layout:"border",maximizable:true,items:[this.contentPanel,this.reply],buttons:[{text:"回复",id:c,handler:function(){e.submitReply(b)}},{text:lang("refresh"),handler:function(){e.readInfo(b)}},{text:lang("close"),handler:function(){if(this.replyForm.getForm().findField("reply").getValue()==""){this.window.close()}else{CNOA.msg.cf("回复内容不为空，还没发表，是否继续关闭？",function(g){if(g=="yes"){this.window.close()}}.createDelegate(this))}}.createDelegate(this)}]}).show()},submitReply:function(a){var d=this;var b=this.replyForm.getForm().findField("reply").getValue();Ext.Ajax.request({url:d.baseUrl+"&task=submitReply",method:"POST",params:{aid:a,content:b},success:function(e){var c=Ext.decode(e.responseText);if(c.success===true){CNOA.msg.alert(c.msg,function(){d.readInfo(a);d.replyForm.getForm().findField("reply").setValue("")})}else{CNOA.msg.alert(c.msg)}}})},readInfo:function(a){var b=this;b.contentPanel.getEl().mask(lang("waiting"));Ext.Ajax.request({url:b.baseUrl+"&task=getDiscussInfo",method:"POST",params:{aid:a},success:function(e){var c=Ext.decode(e.responseText);if(c.success===true){var d=c.data;b.tpl.overwrite(b.contentPanel.body,d);b.contentPanel.getEl().unmask()}else{CNOA.msg.alert(c.msg,function(){})}}})}};var CNOA_project_proj_approveClass,CNOA_project_proj_approve;CNOA_project_proj_approveClass=CNOA.Class.create();CNOA_project_proj_approveClass.prototype={init:function(){var a=this;this.edit_id=0;this.columrecord="";this.content_start=1;this.baseUrl="index.php?app=project&func=proj&action=main&module=approve";this.ID_btn_edit=Ext.id();this.ID_btn_delete=Ext.id();this.ID_plan_content=Ext.id();this.search={title:"",uid:0,execman:0,examapp:0};this.fields=[{name:"pid"},{name:"name"},{name:"number"},{name:"ttime"},{name:"ptime"},{name:"pday"},{name:"tday"},{name:"applyname"},{name:"status"},{name:"description"},{name:"ag"},{name:"disag"}];this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getJsonData",disableCaching:true}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields}),listeners:{exception:function(i,g,j,e,d,c){var b=Ext.decode(d.responseText);if(b.failure){CNOA.msg.alert(b.msg,function(){})}},load:function(c,b,d){a.columrecord=b}}});this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.store.load();this.colModel=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"pid",dataIndex:"pid",hidden:true},{header:lang("opt"),dataIndex:"pid",width:400,renderer:this.makeOperate.createDelegate(this)},{header:"项目编号",dataIndex:"number",width:100,sortable:true,menuDisabled:true},{header:"项目名称",dataIndex:"name",width:160,sortable:false,menuDisabled:true},{header:"申请人",dataIndex:"applyname",width:80,sortable:false,menuDisabled:true},{header:"计划时间",dataIndex:"ptime",width:120,sortable:false,menuDisabled:true},{header:"计划工时(天)",dataIndex:"pday",width:80,sortable:false,menuDisabled:true},{header:"实际时间",dataIndex:"ttime",width:120,sortable:false,menuDisabled:true},{header:"实际工时(天)",dataIndex:"tday",width:80,sortable:false,menuDisabled:true,renderer:this.formatday.createDelegate(this)},{header:"状态",dataIndex:"status",width:60,sortable:false,menuDisabled:true},{header:"审批时间(最近)",dataIndex:"posttime",width:90,sortable:false,menuDisabled:true},{header:"项目描述",dataIndex:"description",width:120,renderer:this.description.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.pagingBar=new Ext.PagingToolbar({displayInfo:true,store:this.store,pageSize:15,listeners:{beforechange:function(b,c){if(a.search.title!=""){c.title=a.search.title}if(a.search.uid!=0&&a.search.uid!=""){c.uid=a.search.uid}if(a.search.execman!=0&&a.search.execman!=""){c.execman=a.search.execman}if(a.search.examapp!=0&&a.search.examapp!=""){c.examapp=a.search.examapp}}}});ID_Search_projecttitle=Ext.id();ID_Search_projectnumber=Ext.id();ID_Search_projectapply=Ext.id();ID_Search_projectapplyname=Ext.id();ID_Search_projectstime=Ext.id();ID_Search_projectetime=Ext.id();this.searchBar=new Ext.Toolbar({items:["项目名称:",{xtype:"textfield",id:ID_Search_projecttitle,width:128},"&nbsp;项目编号:",{xtype:"cnoa_textfield",id:ID_Search_projectnumber,width:100},"&nbsp;申请人:",{xtype:"hidden",id:ID_Search_projectapply},{xtype:"triggerForPeople",dataUrl:a.baseUrl+"&task=getAllUserListsInPermitDeptTree",width:108,id:ID_Search_projectapplyname,listeners:{selected:function(d,c,b){Ext.getCmp(ID_Search_projectapply).setValue(c)}}},"&nbsp;审批时间:",{xtype:"datefield",id:ID_Search_projectstime,format:"Y-m-d",width:100},"~:",{xtype:"datefield",id:ID_Search_projectetime,format:"Y-m-d",width:100},{xtype:"button",text:lang("search"),style:"margin-left:5px",handler:function(){a.search.title=Ext.getCmp(ID_Search_projecttitle).getValue();a.search.number=Ext.getCmp(ID_Search_projectnumber).getValue();a.search.apply=Ext.getCmp(ID_Search_projectapply).getValue();a.search.stime=Ext.getCmp(ID_Search_projectstime).getRawValue();a.search.etime=Ext.getCmp(ID_Search_projectetime).getRawValue();a.store.load({params:{type:a.type,title:a.search.title,number:a.search.number,applyman:a.search.apply,stime:a.search.stime,etime:a.search.etime}})}},{xtype:"button",text:lang("clear"),style:"margin-left:5px",handler:function(){Ext.getCmp(ID_Search_projecttitle).setValue("");Ext.getCmp(ID_Search_projectnumber).setValue("");Ext.getCmp(ID_Search_projectapply).setValue("");Ext.getCmp(ID_Search_projectapplyname).setValue("");Ext.getCmp(ID_Search_projectstime).setValue("");Ext.getCmp(ID_Search_projectetime).setValue("");a.store.load({params:{type:a.type}})}}]});this.grid=new Ext.grid.GridPanel({stripeRows:true,store:this.store,loadMask:{msg:lang("waiting")},cm:this.colModel,sm:this.sm,hideBorders:true,border:false,viewConfig:{},listeners:{rowdblclick:function(c,e){var d=c.getSelectionModel().getSelections();var b=d[0].get("pid");CNOA_project_proj_approve.viewProject(b)},render:function(){a.searchBar.render(this.tbar)}},tbar:new Ext.Toolbar({items:[{handler:function(b,c){a.store.reload()}.createDelegate(this),iconCls:"icon-system-refresh",text:lang("refresh")},{handler:function(b,c){a.type="wait";a.store.load({params:{type:a.type}})}.createDelegate(this),iconCls:"icon-utils-s-edit",enableToggle:true,pressed:true,allowDepress:false,cls:"btn-red1",toggleGroup:"project_proj_approve_type",tooltip:"显示所有待审和项目和需要重新审批的变更项目列表",text:"待审/变更项目"},{handler:function(b,c){a.type="checked";a.store.load({params:{type:a.type}})}.createDelegate(this),enableToggle:true,cls:"btn-blue3",allowDepress:false,toggleGroup:"project_proj_approve_type",iconCls:"icon-pass",tooltip:"显示已审的所有项目列表",text:"已审项目"},"<span class='cnoa_color_gray'>注意:<span class='cnoa_color_blue'>项目变更</span>指的是，原有已经审批通过的项目，在项目实施过程中有所改变。需要重新审核。</span>","->",{xtype:"cnoa_helpBtn",helpid:2010}]}),bbar:this.pagingBar});this.centerPanel=new Ext.Panel({region:"center",layout:"fit",items:[this.grid]});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.centerPanel]})},makeStatus:function(l,i,d,j,g,b){var n=d.data;var m=n.status;var k="&nbsp;";var a=0;var c="#5B5B5B";k=n.statusText;a=n.progress;c=n.statusColor;var e="<div style='color:#808080;margin-top:3px;'>"+k+"</div>";e+="<div style='width:100px;height:5px;background-color:#D4D4D4;'><div style='font-size:0;line-height:0;height:5px;width:"+a+"px;background-color:"+c+";'></div></div>";return e},makeOperate:function(k,g,c,i,d,a){var l=c.data;var j=false;var e=false;j=l.ag;e=l.disag;var b="<a href='javascript:void(0);' class='gridview' onclick='CNOA_project_proj_approve.viewProject("+k+");' ext:qtip='查看项目的详细资料，项目的审批流程'>查看</a>";b+="<a href='javascript:void(0);' class='gridview4 jianju' onclick='CNOA_project_proj_approve.viewCkRecord("+k+");' ext:qtip='查看项目变更详细资料和审批的记录'>审批/变更记录</a>";b+=j?"<a href='javascript:void(0);' class='gridview3 jianju' onclick='CNOA_project_proj_approve.agree("+k+");'><span ext:qtip='同意后立项人才能开始此项目'>同意</span></a>":"<span  class='gridview5 jianju'>同意</span>";b+=e?"<a href='javascript:void(0);' class='gridview4 jianju' onclick='CNOA_project_proj_approve.disagree("+k+");'><span ext:qtip='不同意立项人不能开始此项目'>不同意</span></a>":"<span  class='gridview5 jianju'>不同意</span>";b+="<a href='javascript:void(0);' class='gridview4 jianju' onclick='CNOA_project_proj_approve.deleteproj("+k+");'>删除</a>";return b},deleteproj:function(a){var b=this;CNOA.msg.cf("确定删除该项目吗，删除后该项目的所有信息和资料将无法还原，请谨慎使用！",function(c){if(c=="yes"){Ext.Ajax.request({url:b.baseUrl+"&task=deleteproj",params:{pid:a},method:"POST",success:function(g,e){var d=Ext.decode(g.responseText);if(d.success===true){}else{CNOA.msg.alert(d.msg,function(){b.store.load({params:{applyId:b.pid}})})}},failure:function(d,e){CNOA.msg.alert(result.msg,function(){b.store.reload()})}})}})},viewProject:function(t,K){var z=this;var o=z.baseUrl+"&task=loadPage&pid="+t+"&from=";var J="项目的所有信息";var i=Ext.id();var F=Ext.id();var g=Ext.id();var c=Ext.id();var D=Ext.id();var n=Ext.id();var j=Ext.id();var s=Ext.id();var H=Ext.id();var w=true;var e=true;var q=true;var E=true;var u=true;var b=true;var B=true;var y=true;var p=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",items:[z.eventPanel(t)]});var m=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",items:[z.endorsePanel(t)]});var a=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",items:[z.discussPanel(t)]});var A=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",items:[z.costPanel(t)]});var k=new Ext.Panel({html:'<div style="width:100%;height:100%;"><iframe scrolling=auto frameborder=0 width=100% height=100% id="'+H+'"></iframe></div>',listeners:{afterrender:function(){if(y){Ext.getDom(H).contentWindow.location.href=o+'viewFlowDetail&exportArray={"i":1,"f":1,"p":1,"e":1}&target=page';y=false}}}});var C=new Ext.Panel({html:'<div style="width:100%;height:100%;"><iframe scrolling=auto frameborder=0 width=100% height=100% id="'+s+'"></iframe></div>',listeners:{afterrender:function(){if(B){Ext.getDom(s).contentWindow.location.href=o+"viewgantt";B=false}}}});var r=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",items:[z.askPanel(t)]});var x=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",items:[z.taskPanel(t)]});var I=new Ext.Panel({html:'<div style="width:100%;height:100%;"><iframe scrolling=auto frameborder=0 width=100% height=100% id="'+D+'"></iframe></div>',listeners:{afterrender:function(){if(E){Ext.getDom(D).contentWindow.location.href=o+"viewdoc";E=false}}}});var v=new Ext.Panel({html:'<div style="width:100%;height:100%;"><iframe scrolling=auto frameborder=0 width=100% height=100% id="'+c+'"></iframe></div>',listeners:{afterrender:function(){if(q){Ext.getDom(c).contentWindow.location.href=o+"viewckrecord";q=false}}}});var d=new Ext.Panel({html:'<div style="width:100%;height:100%;"><iframe scrolling=auto frameborder=0 width=100% height=100% id="'+g+'"></iframe></div>',listeners:{afterrender:function(){if(e){Ext.getDom(g).contentWindow.location.href=o+"viewmember";e=false}}}});var G=new Ext.Panel({html:'<div style="width:100%;height:100%;"><iframe scrolling=auto frameborder=0 width=100% height=100% id="'+F+'"></iframe></div>',listeners:{afterrender:function(){if(w){Ext.getDom(F).contentWindow.location.href=o+"viewbaseinfo";w=false}}}});var l=new Ext.Window({title:J,width:860,height:makeWindowHeight(700),resizable:true,modal:true,layout:"border",maximizable:true,tbar:[{xtype:"buttongroup",columns:3,title:"项目信息",defaults:{scale:"small"},items:[{text:lang("baseInfo"),iconCls:"application_view_list",tooltip:"显示项目的基本信息和进度汇报",pressed:true,enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(0)}},{text:"项目成员",iconCls:"icon-cnoa-communication",tooltip:"显示项目的所有成员和他们的角色",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(1)}},{text:"项目文档",iconCls:"icon-order-s-send",tooltip:"显示项目的所有文档和对应成员的权限",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(3)}},{text:"项目费用",iconCls:"icon-coins",tooltip:"显示项目所花费的费用",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(7)}},{text:"任务列表",iconCls:"icon-btn-desktopList",tooltip:"显示该项目的所有任务列表",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(4)}}]},{xtype:"buttongroup",columns:2,title:"项目跟踪",defaults:{scale:"small"},items:[{text:"问题跟踪",iconCls:"icon-system-help",tooltip:"显示该项目的问题的所有讨论细节",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(5)}},{text:"审批记录",iconCls:"icon-diary-todo",tooltip:"显示项目被审批的所有记录和变更记录",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(2)}},{text:"项目流程",iconCls:"all-department-tree",tooltip:"显示项目绑定的流程",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(8)}},{text:"项目事件",iconCls:"icon-order-s-draft",tooltip:"显示项目变更后的所有事件记录",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(11)}}]},{xtype:"buttongroup",columns:1,title:"项目交流 ",defaults:{scale:"small"},items:[{text:"项目讨论区",iconCls:"icon-CNOA-Web-IM",tooltip:"讨论该项目的一些问题",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(9)}},{text:"项目批注&nbsp;&nbsp;&nbsp;&nbsp;",iconCls:"icon-system-theme-setup",tooltip:"对该项目的一些批注",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_myproj_view",handler:function(){Ext.getCmp(i).getLayout().setActiveItem(10)}}]},{xtype:"buttongroup",columns:2,title:lang("opt"),height:69,defaults:{scale:"small"},items:[{text:"最大化窗口",iconCls:"icon-fileview-column",tooltip:"恢复窗口原来的大小",handler:function(L){if(l.maximized===true){L.setText("最大化窗口")}else{L.setText("恢复窗口")}l.toggleMaximize()}},{text:lang("close"),iconCls:"icon-dialog-cancel",tooltip:"关闭窗口",handler:function(){l.close()}}]}],listeners:{show:function(){},close:function(){}},items:[{xtype:"panel",id:i,region:"center",layout:"border",layout:"card",activeItem:0,hideBorders:true,border:false,items:[G,d,v,I,x,r,C,A,k,a,m,p]}]}).show()},eventPanel:function(c){var e=this;var j=Ext.id();var d=[{name:"eid"},{name:"type"},{name:"title"},{name:"content"},{name:"posttime"},{name:"truename"}];var l=new Ext.data.GroupingStore({autoLoad:true,proxy:new Ext.data.HttpProxy({url:e.baseUrl+"&task=geteventlist&pid="+c}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:d}),sortInfo:{field:"eid",direction:"ASC"},groupOnSort:false,groupField:"type",sortData:function(){},listeners:{load:function(o,m,n){}}});var b=new Ext.grid.CheckboxSelectionModel({singleSelect:false});var k=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"eid",dataIndex:"eid",hidden:true},{header:"",dataIndex:"type",hidden:true},{header:"类型",dataIndex:"type",width:120,sortable:true,menuDisabled:true},{header:lang("title"),dataIndex:"title",width:120,sortable:true,menuDisabled:true},{header:"操作内容",dataIndex:"content",width:200,sortable:true,menuDisabled:true},{header:"修改时间",dataIndex:"posttime",width:120,sortable:true,menuDisabled:true},{header:"操作人姓名",dataIndex:"truename",width:80,sortable:true,menuDisabled:true},{header:lang("opt"),dataIndex:"eid",width:80,sortable:true,menuDisabled:true,renderer:this.viewdiff.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);var i=new Ext.grid.GridPanel({stripeRows:true,border:false,store:l,loadMask:{msg:lang("waiting")},cm:k,sm:b,hideBorders:true,tbar:[{text:lang("refresh"),iconCls:"icon-system-refresh",handler:function(m,n){l.reload()}},{text:"列表模式",enableToggle:true,allowDepress:false,iconCls:"icon-system-s-report",toggleGroup:"project_proj_myproj_event_expand",tooltip:"列表模式",handler:function(m,n){l.clearGrouping()}},{text:"分组模式",pressed:true,enableToggle:true,allowDepress:false,iconCls:"icon-view-form-png",toggleGroup:"project_proj_myproj_event_expand",tooltip:"分组模式",handler:function(m,n){l.groupBy("type",true);i.view.collapseAllGroups()}},{text:"展开所有分组",enableToggle:true,allowDepress:false,iconCls:"icon-style-tree",toggleGroup:"project_proj_myproj_event_expand",tooltip:"展开所有分组",handler:function(m,n){l.groupBy("type",true);i.view.expandAllGroups()}}],view:new Ext.grid.GroupingView({forceFit:false,startCollapsed:true})});var a=new Ext.Panel({region:"center",layout:"fit",items:[i]});var g=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",autoScroll:false,items:[a]});return g},viewdiff:function(g,d,a,i,b,e){var c=a.data;return"<a href='javascript:void(0)' onclick='CNOA_project_proj_approve.viewdiffwin("+c.eid+', "'+c.title+"\")'>查看</a>"},viewdiffwin:function(b,e){var g=this;var c=Ext.id();var a=new Ext.Panel({html:'<div style="width:100%;height:100%;"><iframe scrolling=auto frameborder=0 width=100% height=100% id="'+c+'"></iframe></div>',border:false,listeners:{afterrender:function(){Ext.getDom(c).contentWindow.location.href=g.baseUrl+"&task=viewdiffdetail&eid="+b}}});var d=new Ext.Window({title:"查看"+e,width:800,height:makeWindowHeight(600),items:[a],modal:true,layout:"fit",buttons:[{text:lang("close"),handler:function(){d.close()}}]}).show()},endorsePanel:function(c){var j=this;var b=[{name:"eid"},{name:"posttime"},{name:"postname"},{name:"content"}];this.endorseStore=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:j.baseUrl+"&task=endorseprojlist&pid="+c}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:b}),listeners:{load:function(m,k,l){j.endorsedata=k}}});var i=new Ext.grid.CheckboxSelectionModel({singleSelect:false});var d=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"批注领导",dataIndex:"postname",width:80,sortable:true,menuDisabled:true},{header:"批注内容",dataIndex:"content",width:350,sortable:true,menuDisabled:true,renderer:this.endorsecontent.createDelegate(this)},{header:"批注时间",dataIndex:"posttime",width:120,sortable:true,menuDisabled:true},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);var g=new Ext.grid.GridPanel({stripeRows:true,border:false,store:this.endorseStore,loadMask:{msg:lang("waiting")},cm:d,sm:i,hideBorders:true,tbar:[{text:lang("refresh"),iconCls:"icon-system-refresh",handler:function(k,l){j.endorseStore.reload()}}]});var a=new Ext.Panel({region:"center",layout:"fit",items:[g]});var e=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",autoScroll:false,items:[a]});return e},endorsecontent:function(g,d,a,i,b,e){var c=a.data;return"<a href='javascript:void(0)' onclick='CNOA_project_proj_approve.showendorsecontent("+c.eid+")'>"+g+"</a>"},showendorsecontent:function(a){var b=this;Ext.each(b.endorsedata,function(c,d){if(c.data.eid==a){b.showendorsecontentwin(c.data.content)}})},showendorsecontentwin:function(b){var c=this;var a=new Ext.Window({title:"批注详细信息",width:600,height:300,layout:"border",modal:true,items:[new Ext.Panel({region:"center",autoScroll:true,html:"<div><p>&nbsp;&nbsp;&nbsp;"+b+"</p></div>",layout:"fit",border:false})],buttons:[{text:lang("close"),handler:function(){a.close()}}]}).show()},discussPanel:function(c){var g=this;var a=g.baseUrl+"&task=loadPage&pid="+c+"&from=";var i=[{name:"did"},{name:"title"},{name:"postname"},{name:"count"},{name:"posttime"},{name:"lastname"},{name:"lasttime"}];g.storediscuss=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:g.baseUrl+"&task=viewdiscusslist&pid="+c}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:i})});var b=new Ext.grid.CheckboxSelectionModel({singleSelect:false});var j=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"did",dataIndex:"did",hidden:true},{header:lang("title"),dataIndex:"title",width:270,sortable:true,menuDisabled:true,renderer:this.discusstitle.createDelegate(this)},{header:"作者",dataIndex:"postname",width:100,sortable:true,menuDisabled:true},{header:"发布时间",dataIndex:"posttime",width:120,sortable:true,menuDisabled:true},{header:"回复数",dataIndex:"count",width:120,sortable:true,menuDisabled:true},{header:"最后回复人",dataIndex:"lastname",width:80,sortable:true,menuDisabled:true},{header:"最后回复时间",dataIndex:"lasttime",width:120,sortable:true,menuDisabled:true},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);var k=new Ext.grid.GridPanel({stripeRows:true,border:false,store:g.storediscuss,loadMask:{msg:lang("waiting")},cm:j,sm:b,hideBorders:true,tbar:[{text:lang("refresh"),iconCls:"icon-system-refresh",handler:function(l,m){g.storediscuss.reload()}},{text:"发帖",iconCls:"icon-expand-members",handler:function(l,m){g.discussWin(c)}},"<span class='cnoa_color_gray'>点击标题，进入该讨论帖子</span>"]});var d=new Ext.Panel({region:"center",layout:"fit",items:[k]});var e=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",autoScroll:false,items:[d]});return e},discusstitle:function(g,d,a,i,b,e){var c=a.data;return"<a href='javascript:void(0)' onclick='CNOA_project_proj_approve.discussview("+c.did+")'>"+g+"</a>"},discussview:function(b){var e=this;var a=new Ext.XTemplate('<div class="user_task_discuss_view">','  <div class="user_task_discuss_view_header">','    <div class="user_task_discuss_view_header_title">[讨论标题]&nbsp;&nbsp;{title}&nbsp;&nbsp;</div>','    <div class="user_task_discuss_view_header_from">&nbsp;发布人:&nbsp;&nbsp; {postname}&nbsp;&nbsp;&nbsp;&nbsp;发布时间:{posttime}</div>',"  </div>",'  <div class="user_task_discuss_view_body">','    <div class="user_task_discuss_view_body_left">','      <div class="user_task_discuss_view_body_left_body">','        <span><img src="{face}" width="120" height="130" onerror="this.src=\'./resources/images/default.jpg\'" /></span>',"      </div>","    </div>",'    <div class="user_task_discuss_view_body_right">','      <div class="user_task_discuss_view_body_right_top">#{[xindex]}&nbsp;&nbsp;<a>{postname}</a>&nbsp;&nbsp;</div>','      <div class="user_task_discuss_view_body_right_body">{content}</div>',"    </div>",'    <div class="clear"></div>',"  </div>",'  <tpl for="list">','  <div class="user_task_discuss_view_body">','    <div class="user_task_discuss_view_body_left">','      <div class="user_task_discuss_view_body_left_top"></div>','      <div class="user_task_discuss_view_body_left_body">','        <span><img src="{face}" width="120" height="130" onerror="this.src=\'./resources/images/default.jpg\'" /></span>',"      </div>","    </div>",'    <div class="user_task_discuss_view_body_right">','      <div class="user_task_discuss_view_body_right_top">#{[xindex]}&nbsp;&nbsp;<a>{postname}</a>&nbsp;&nbsp;发表于&nbsp;{posttime}<div style="float:right; padding-right:5px"><a href="javascript:void(0)" onclick="CNOA_project_proj_approve.replydiscuss({did},{rid})">回复</a></div></div>','      <div class="user_task_discuss_view_body_right_body">{content}</div>',"    </div>",'    <div class="clear"></div>',"  </div>","  </tpl>","</div>");e.readInfo=function(){d.getEl().mask(lang("waiting"));Ext.Ajax.request({url:e.baseUrl+"&task=getDiscussInfo",method:"POST",params:{did:b},success:function(i){var g=Ext.decode(i.responseText);if(g.success===true){rd=g.data;a.overwrite(d.body,rd);d.getEl().unmask()}else{CNOA.msg.alert(g.msg,function(){})}}})};var d=new Ext.Panel({region:"center",layout:"fit",border:false,autoScroll:true,listeners:{render:function(){e.readInfo()}},tbar:new Ext.Toolbar({items:[{text:lang("refresh"),iconCls:"icon-system-refresh",handler:function(){e.readInfo()}},{text:"回复",iconCls:"icon-expand-members",handler:function(){e.replydiscuss(b,0)}}]})});var c=new Ext.Window({title:"查看讨论窗口",width:800,height:makeWindowHeight(600),modal:true,layout:"border",items:[d],buttons:[{text:lang("close"),handler:function(){c.close()}}]}).show()},replydiscuss:function(c,a){var g=this;var d=function(){if(b.getForm().isValid()){b.getForm().submit({url:g.baseUrl+"&task=discussprojreply",waitMsg:lang("waiting"),method:"POST",params:{did:c,rid:a},success:function(i,j){CNOA.msg.notice(j.result.msg,"项目管理");e.close();g.readInfo()}.createDelegate(this),failure:function(i,j){CNOA.msg.alert(j.result.msg)}.createDelegate(this)})}};var b=new Ext.form.FormPanel({region:"center",border:false,labelWidth:60,labelAlign:"right",waitMsgTarget:true,items:[{xtype:"panel",border:false,bodyStyle:"padding:10px",layout:"form",items:[{xtype:"textarea",name:"content",height:"180",allowBlank:false,fieldLabel:"回复内容",width:"480"}]}]});var e=new Ext.Window({title:"发帖窗口",width:600,height:300,modal:true,layout:"border",items:[b],buttons:[{text:"提交",handler:function(){d()}},{text:lang("close"),handler:function(){e.close()}}]}).show()},discussWin:function(a){var e=this;var c=function(){if(b.getForm().isValid()){b.getForm().submit({url:e.baseUrl+"&task=discussprojadd",waitMsg:lang("waiting"),method:"POST",params:{pid:a},success:function(g,i){CNOA.msg.notice(i.result.msg,"项目管理");d.close();e.storediscuss.reload()}.createDelegate(this),failure:function(g,i){CNOA.msg.alert(i.result.msg)}.createDelegate(this)})}};var b=new Ext.form.FormPanel({region:"center",border:false,labelWidth:50,labelAlign:"right",bodyStyle:"padding:10px",waitMsgTarget:true,items:[{xtype:"textfield",name:"title",fieldLabel:lang("title"),allowBlank:false,width:"480"},{xtype:"textarea",name:"content",fieldLabel:lang("content"),width:"480",allowBlank:false,height:"180"}]});var d=new Ext.Window({title:"发帖窗口",width:600,height:300,modal:true,layout:"border",items:[b],buttons:[{text:"提交",handler:function(){c()}},{text:lang("close"),handler:function(){d.close()}}]}).show()},costPanel:function(c){var e=this;var j=Ext.id();var d=[{name:"bid"},{name:"sname"},{name:"title"},{name:"r_cost"},{name:"t_cost"},{name:"status"},{name:"costnotes"}];var l=new Ext.data.GroupingStore({autoLoad:true,proxy:new Ext.data.HttpProxy({url:e.baseUrl+"&task=viewcostdetail&pid="+c}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:d}),sortInfo:{field:"bid",direction:"ASC"},groupOnSort:false,groupField:"sname",sortData:function(){},listeners:{load:function(o,m,n){Ext.getCmp(j).getEl().update("项目的预算总花费: "+o.reader.jsonData.t_r_cost+"元&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;实际总花费："+o.reader.jsonData.t_t_cost+"元");e.columrecord=m}}});var b=new Ext.grid.CheckboxSelectionModel({singleSelect:false});var k=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"bid",dataIndex:"bid",hidden:true},{header:"",dataIndex:"sname",hidden:true},{header:"费用名称",dataIndex:"title",width:120,sortable:true,menuDisabled:true},{header:"预算费用（元）",dataIndex:"r_cost",width:100,sortable:true,menuDisabled:true},{header:"实际费用（元）",dataIndex:"t_cost",width:120,sortable:true,menuDisabled:true},{header:"状态",dataIndex:"status",width:80,sortable:true,menuDisabled:true},{header:"费用说明",dataIndex:"costnotes",width:200,sortable:true,menuDisabled:true,renderer:this.costnotes.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);var i=new Ext.grid.GridPanel({stripeRows:true,border:false,store:l,loadMask:{msg:lang("waiting")},cm:k,sm:b,hideBorders:true,tbar:[{xtype:"box",id:j,autoEl:{tag:"div",html:""}}],view:new Ext.grid.GroupingView({forceFit:false,startCollapsed:true})});var a=new Ext.Panel({region:"center",layout:"fit",items:[i],tbar:[{text:lang("refresh"),iconCls:"icon-system-refresh",handler:function(m,n){l.reload()}},{text:"所有费用",enableToggle:true,allowDepress:false,pressed:true,iconCls:"icon-expand-members",toggleGroup:"project_proj_myproj_cost_status",tooltip:"列出该项目的所有费用，包括未审批的",handler:function(m,n){l.load({params:{type:"all"}})}},{text:"审批通过费用",enableToggle:true,allowDepress:false,iconCls:"icon-expand-members",toggleGroup:"project_proj_myproj_cost_status",tooltip:"列出该项目通过审批的费用",handler:function(m,n){l.load({params:{type:"checked"}})}},{text:"列表模式",enableToggle:true,allowDepress:false,iconCls:"icon-system-s-report",toggleGroup:"project_proj_myproj_expand",tooltip:"列表模式",handler:function(m,n){l.clearGrouping()}},{text:"分组模式",pressed:true,enableToggle:true,allowDepress:false,iconCls:"icon-view-form-png",toggleGroup:"project_proj_myproj_expand",tooltip:"分组模式",handler:function(m,n){l.groupBy("sname",true);i.view.collapseAllGroups()}},{text:"展开所有分组",enableToggle:true,allowDepress:false,iconCls:"icon-style-tree",toggleGroup:"project_proj_myproj_expand",tooltip:"展开所有分组",handler:function(m,n){l.groupBy("sname",true);i.view.expandAllGroups()}}]});var g=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",autoScroll:false,items:[a]});return g},taskPanel:function(b){var i=this;var a=[{name:"tid"},{name:"title"},{name:"stime"},{name:"etime"},{name:"level"},{name:"status"},{name:"progress"},{name:"execman"}];this.taskStore=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:i.baseUrl+"&task=taskprojlist&pid="+b}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:a}),listeners:{load:function(l,j,k){}}});var g=new Ext.grid.CheckboxSelectionModel({singleSelect:false});var c=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"tid",dataIndex:"tid",hidden:true},{header:"任务标题",dataIndex:"title",width:200,sortable:true,menuDisabled:true,renderer:this.viewTaskDeltails.createDelegate(this)},{header:"任务开始时间",dataIndex:"stime",width:120,sortable:false,menuDisabled:true},{header:"任务结束时间",dataIndex:"etime",width:120,sortable:false,menuDisabled:true},{header:"任务等级",dataIndex:"level",width:60,sortable:false,menuDisabled:true},{header:"状态",dataIndex:"status",width:120,sortable:false,menuDisabled:true},{header:"进度",dataIndex:"progress",width:80,sortable:false,menuDisabled:true},{header:"负责人",dataIndex:"execman",width:100,sortable:false,menuDisabled:true},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);var e=new Ext.grid.GridPanel({region:"center",layout:"fit",border:false,store:this.taskStore,loadMask:{msg:lang("waiting")},cm:c,sm:g,stripeRows:true,hideBorders:true,tbar:[{text:lang("refresh"),iconCls:"icon-system-refresh",handler:function(j,k){i.taskStore.reload()}}]});var d=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",autoScroll:false,items:[e]});return d},viewTaskDeltails:function(d,e,a){var b=a.data;return"<a href='javascript:void(0)' onclick='CNOA_project_proj_approve.viewTaskDeltailsWin("+b.tid+")'>"+d+"</a>"},viewTaskDeltailsWin:function(d){var i=this;var g=i.baseUrl+"&task=loadPage&from=viewTaskdetail&tid="+d;var c=Ext.id();var b=true;var e="任务所有信息";var a=new Ext.Panel({border:false,html:'<div style="width:100%;height:100%;"><iframe scrolling=auto frameborder=0 width=100% height=100% id="'+c+'"></iframe></div>',listeners:{afterrender:function(){if(b){Ext.getDom(c).contentWindow.location.href=g;b=false}}}});this.win=new Ext.Window({title:e,width:800,height:makeWindowHeight(600),resizable:true,modal:true,maximizable:true,items:[a]}).show()},askPanel:function(c){var j=this;var b=[{name:"aid"},{name:"title"},{name:"askname"},{name:"posttime"},{name:"status"}];this.askStore=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:j.baseUrl+"&task=askprojlist&pid="+c}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:b}),listeners:{load:function(m,k,l){}}});var i=new Ext.grid.CheckboxSelectionModel({singleSelect:false});var d=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"aid",dataIndex:"aid",hidden:true},{header:"问题标题",dataIndex:"title",width:300,sortable:true,menuDisabled:true},{header:"提问人",dataIndex:"askname",width:100,sortable:false,menuDisabled:true},{header:"提问时间",dataIndex:"posttime",width:100,sortable:false,menuDisabled:true},{header:"状态",dataIndex:"status",width:60,sortable:false,menuDisabled:true},{header:lang("opt"),dataIndex:"aid",width:140,renderer:this.viewAsk.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);var g=new Ext.grid.GridPanel({stripeRows:true,border:false,store:this.askStore,loadMask:{msg:lang("waiting")},cm:d,sm:i,hideBorders:true,tbar:[{text:lang("refresh"),iconCls:"icon-system-refresh",handler:function(k,l){j.askStore.reload()}}]});var a=new Ext.Panel({region:"center",layout:"fit",items:[g]});var e=new Ext.Panel({collapsible:false,hideBorders:true,border:false,region:"center",layout:"border",autoScroll:false,items:[a]});return e},viewAsk:function(e,c,a,i,b,d){var g=this;return"<a href='javascript:void(0)' onclick='CNOA_project_proj_approve.viewAskDetail("+e+")'>查看</a>"},viewAskDetail:function(d){var g=this;var a=new Ext.XTemplate('<div class="user_task_discuss_view">','  <div class="user_task_discuss_view_header">','    <div class="user_task_discuss_view_header_title">[问题标题]&nbsp;&nbsp;{title}&nbsp;&nbsp;[{status}]</div>',"  </div>",'  <div class="user_task_discuss_view_body">','    <div class="user_task_discuss_view_body_left">','      <div class="user_task_discuss_view_body_left_top">{postname}[{job}]</div>','      <div class="user_task_discuss_view_body_left_body">','        <span><img src="{face}" width="120" height="130" onerror="this.src=\'./resources/images/default.jpg\'" /></span>',"      </div>","    </div>",'    <div class="user_task_discuss_view_body_right">','      <div class="user_task_discuss_view_body_right_top">#{[xindex]}&nbsp;&nbsp;<a>{postname}</a>&nbsp;&nbsp;发表于&nbsp;{time}</div>','      <div class="user_task_discuss_view_body_right_body">{content}</div>',"    </div>",'    <div class="clear"></div>',"  </div>",'  <tpl for="list">','  <div class="user_task_discuss_view_body">','    <div class="user_task_discuss_view_body_left">','      <div class="user_task_discuss_view_body_left_top">{postname}[{job}]</div>','      <div class="user_task_discuss_view_body_left_body">','        <span><img src="{face}" width="120" height="130" onerror="this.src=\'./resources/images/default.jpg\'" /></span>',"      </div>","    </div>",'    <div class="user_task_discuss_view_body_right">','      <div class="user_task_discuss_view_body_right_top">#{[xindex]}&nbsp;&nbsp;<a>{postname}</a>&nbsp;&nbsp;发表于&nbsp;{time}</div>','      <div class="user_task_discuss_view_body_right_body">{content}</div>',"    </div>",'    <div class="clear"></div>',"  </div>","  </tpl>","</div>");var b=function(){e.getEl().mask(lang("waiting"));Ext.Ajax.request({url:g.baseUrl+"&task=getAskInfo",method:"POST",params:{aid:d},success:function(k){var i=Ext.decode(k.responseText);if(i.success===true){var j=i.data;a.overwrite(e.body,j);e.getEl().unmask()}else{CNOA.msg.alert(i.msg,function(){})}}})};var e=new Ext.Panel({region:"center",layout:"fit",border:false,autoScroll:true,listeners:{render:function(){b()}}});var c=new Ext.Window({title:"项目：问题查看（双击可最大化窗口）",width:800,height:makeWindowHeight(650),resizable:true,modal:true,layout:"border",maximizable:true,items:[e],buttons:[{text:lang("refresh"),handler:function(){b()}},{text:lang("close"),handler:function(){c.close()}.createDelegate(this)}]}).show()},costnotes:function(e,c,a,g,b,d){return"<a href='javascript:void(0)' onclick='CNOA_project_proj_approve.costnotesdes("+a.data.bid+")'>"+e+"</a>"},costnotesdes:function(a){var b=this;Ext.each(b.columrecord,function(c,d){if(c.data.bid==a){b.costnoteswindow(c.data.costnotes,c.data.title)}})},costnoteswindow:function(b,a){var c=this;this.window=new Ext.Window({title:"费用名称("+a+")",width:600,height:300,layout:"border",modal:true,items:[new Ext.Panel({region:"center",autoScroll:true,html:"<div><p>&nbsp;&nbsp;&nbsp;"+b+"</p></div>",layout:"fit",border:false})],buttons:[{text:lang("close"),handler:function(){c.window.close()}}]}).show()},viewCkRecord:function(c){var i=this;var g=i.baseUrl+"&task=loadPage&from=viewCkRecord&pid="+c;var d=Ext.id();var b=true;var e="项目审批信息";var a=new Ext.Panel({border:false,html:'<div style="width:100%;height:100%;"><iframe scrolling=auto frameborder=0 width=100% height=100% id="'+d+'"></iframe></div>',listeners:{afterrender:function(){if(b){Ext.getDom(d).contentWindow.location.href=g;b=false}}}});this.win=new Ext.Window({title:e,width:800,height:makeWindowHeight(600),resizable:true,modal:true,maximizable:true,items:[a]}).show()},description:function(e,c,a,g,b,d){return"<a href='javascript:void(0)' onclick='CNOA_project_proj_approve.showdescription("+a.data.pid+")'>"+e+"</a>"},showdescription:function(a){var b=this;Ext.each(b.columrecord,function(c,d){if(c.data.pid==a){b.showdescriptionwindow(c.data.description,c.data.name)}})},showdescriptionwindow:function(b,a){var c=this;this.window=new Ext.Window({title:"项目名称("+a+")项目描述",width:600,height:300,layout:"border",modal:true,items:[new Ext.Panel({region:"center",autoScroll:true,html:"<div><p>&nbsp;&nbsp;&nbsp;"+b+"</p></div>",layout:"fit",border:false})],buttons:[{text:lang("close"),handler:function(){c.window.close()}}]}).show()},agree:function(a){var b=this;this.baseField=[{xtype:"fieldset",title:"项目同意原因",defaults:{border:false},items:[{xtype:"panel",layout:"form",defaults:{style:{marginBottom:"10px"},border:false},items:[{xtype:"textarea",fieldLabel:"",name:"agreereson",width:430,height:180}]}]}];this.formPanel=new Ext.form.FormPanel({hideBorders:true,border:false,waitMsgTarget:true,layout:"border",labelWidth:10,labelAlign:"right",items:[{xtype:"panel",border:false,bodyStyle:"padding:10px",layout:"form",region:"center",autoScroll:true,items:[this.baseField]}]});this.window=new Ext.Window({title:"同意项目",width:520,height:330,modal:true,layout:"fit",resizable:false,border:false,items:[this.formPanel],buttons:[{text:"同意",handler:function(){b.submit(a,"agree")}},{text:lang("cancel"),handler:function(){b.window.close()}}]}).show()},disagree:function(a){var b=this;this.baseField=[{xtype:"fieldset",title:"项目不同意原因",defaults:{border:false},items:[{xtype:"panel",layout:"form",defaults:{style:{marginBottom:"10px"},border:false},items:[{xtype:"textarea",fieldLabel:"",name:"disagreereson",width:430,height:180}]}]}];this.formPanel=new Ext.form.FormPanel({hideBorders:true,border:false,waitMsgTarget:true,layout:"border",labelWidth:10,labelAlign:"right",items:[{xtype:"panel",border:false,bodyStyle:"padding:10px",layout:"form",region:"center",autoScroll:true,items:[this.baseField]}]});this.window=new Ext.Window({title:"不同意项目",width:520,height:330,modal:true,layout:"fit",resizable:false,border:false,items:[this.formPanel],buttons:[{text:"不同意",handler:function(){b.submit(a,"disagree")}},{text:lang("cancel"),handler:function(){b.window.close()}}]}).show()},formatday:function(e,c,a,g,b,d){if(a.data.tday>a.data.pday){if(e<0){return""}return"<span class='cnoa_color_red'><b>"+e+"</b></span>"}else{if(e<0){return""}return"<span class='cnoa_color_green'><b>"+e+"</b></span>"}},submit:function(a,b){var c=this;if(c.formPanel.getForm().isValid()){c.formPanel.getForm().submit({url:c.baseUrl+"&task=submitCheck",waitMsg:lang("waiting"),params:{pid:a,type:b},method:"POST",success:function(d,e){CNOA.msg.notice(e.result.msg,"项目管理");c.window.close();c.store.reload()}.createDelegate(this),failure:function(d,e){CNOA.msg.alert(e.result.msg)}.createDelegate(this)})}}};CNOA_project_proj_applyprojbaseinfoClass=CNOA.Class.create();CNOA_project_proj_applyprojbaseinfoClass.prototype={init:function(){var g=this;this.ID_button_deptNames=Ext.id();this.ID_textarea_deptNames=Ext.id();var a=Ext.id();var c=Ext.id();var e=Ext.id();var d=CNOA.project.proj.applyproj.applyID;var b=CNOA.project.proj.applyproj.applyType;this.baseUrl="index.php?app=project&func=proj&action=main&module=myproj";this.projectTypeComboBoxDataStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:g.baseUrl+"&task=getProjectTypeList"}),reader:new Ext.data.JsonReader({root:"data",fields:[{name:"sid",mapping:"sid"},{name:"sname"}]})});this.projectTypeComboBoxDataStore.load();this.projectCheckComboBoxDataStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:g.baseUrl+"&task=getCheckList"}),reader:new Ext.data.JsonReader({root:"data",fields:[{name:"uid_pass",mapping:"uid"},{name:"checkname"}]})});this.projectCheckComboBoxDataStore.load();this.projectFlowComboBoxDataStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:g.baseUrl+"&task=getFowList"}),reader:new Ext.data.JsonReader({root:"data",fields:[{name:"ulid"},{name:"title"}]})});this.projectFlowComboBoxDataStore.load();this.baseField=[{xtype:"fieldset",title:"立项的基本信息",defaults:{style:{},border:false},items:[{xtype:"panel",hideBorders:true,border:false,layout:"table",autoWidth:true,layoutConfig:{columns:2},items:[{xtype:"panel",layout:"form",width:350,defaults:{style:{marginBottom:"10px"},border:false},items:[{xtype:"cnoa_textfield",width:230,name:"number",fieldLabel:"项目编号"}]},{xtype:"panel",layout:"form",width:350,defaults:{style:{marginBottom:"10px"},border:false},items:[{xtype:"cnoa_textfield",width:230,allowBlank:false,name:"name",fieldLabel:"项目名称"}]}]},{xtype:"panel",hideBorders:true,border:false,layout:"table",autoWidth:true,layoutConfig:{columns:2},items:[{xtype:"panel",layout:"form",width:350,defaults:{style:{marginBottom:"10px"},border:false},items:[{xtype:"panel",layout:"table",fieldLabel:"项目计划开始<span class='cnoa_color_red'>*</span>",items:[{xtype:"datefield",width:130,format:"Y-m-d",allowBlank:false,name:"stime",fieldLabel:""},{xtype:"timefield",width:100,increment:60,name:"stime_h",editable:true,format:"H:i"}]}]},{xtype:"panel",layout:"form",width:350,defaults:{style:{marginBottom:"10px"},border:false},items:[{xtype:"panel",layout:"table",fieldLabel:"计划结束时间<span class='cnoa_color_red'>*</span>",items:[{xtype:"datefield",width:130,format:"Y-m-d",allowBlank:false,name:"etime",fieldLabel:""},{xtype:"timefield",width:100,increment:60,name:"etime_h",editable:true,format:"H:i"}]}]}]},{xtype:"panel",hideBorders:true,border:false,layout:"table",autoWidth:true,layoutConfig:{columns:2},items:[{xtype:"panel",layout:"form",width:350,defaults:{style:{},border:false},items:[{xtype:"panel",layout:"form",border:false,items:[new CNOA.form.ComboBox({fieldLabel:"项目类型",name:"sid",allowBlank:false,store:g.projectTypeComboBoxDataStore,hiddenName:"sid",valueField:"sid",helpTip:"如果您有权限，可在项目基本设置->代码设置->项目<br />类型里面添加，修改和删除项目类型操作。",displayField:"sname",mode:"local",width:230,allowBlank:false,triggerAction:"all",forceSelection:true,editable:false,listeners:{select:function(k,i,j){}.createDelegate(this)}})]}]},{xtype:"panel",layout:"form",width:350,defaults:{style:{},border:false},items:[{xtype:"panel",layout:"form",border:false,items:[new CNOA.form.ComboBox({fieldLabel:"项目审批人",name:"uid_pass",store:g.projectCheckComboBoxDataStore,hiddenName:"uid_pass",valueField:"uid_pass",id:a,displayField:"checkname",helpTip:"如果您有权限，可在项目基本设置->权限设置->审批<br />项目权限里面添加，修改和删除项目审批人操作。",mode:"local",width:230,allowBlank:false,triggerAction:"all",forceSelection:true,editable:false,listeners:{select:function(k,i,j){}.createDelegate(this)}})]}]}]},{xtype:"cnoa_textfield",width:230,style:"margin-top:5px;",readOnly:true,value:CNOA_USER_TRUENAME,fieldLabel:"项目创建人"},{xtype:"textarea",width:580,height:50,readOnly:true,style:"margin-top:5px;",fieldLabel:"项目查看者",blankText:"请选择项目查看者",name:"viewNames"},new Ext.BoxComponent({autoEl:{tag:"div",style:"margin-left:95px;margin-top:5px;margin-bottom:5px;color:#676767;",html:"注意:项目查看者可以查看该项目的所有细节资料，请谨慎选择。建议：您也可以选择某个关键的项目成员<br />为项目查看者！"}}),{xtype:"hidden",name:"viewIDs"},{xtype:"btnForPoepleSelector",autoWidth:true,dataUrl:g.baseUrl+"&task=getAllUserListsInPermitDeptTree",style:"margin-left:94px;margin-bottom:8px",text:"选择",listeners:{selected:function(l,m){var n=new Array();var k=new Array();if(m.length>0){for(var j=0;j<m.length;j++){n.push(m[j].uname);k.push(m[j].uid)}}g.baseinfoFormPanel.getForm().findField("viewNames").setValue(n.join(","));g.baseinfoFormPanel.getForm().findField("viewIDs").setValue(k.join(","))},onrender:function(i){i.setSelectedUids(g.baseinfoFormPanel.getForm().findField("viewIDs").getValue().split(","))}}},{xtype:"textarea",fieldLabel:"项目描述",name:"description",width:580,height:250},{xtype:"flashfile",fieldLabel:"添加文档",name:"document",style:"margin-top:5px;",inputPre:"filesUpload"}]}];this.baseinfoFormPanel=new Ext.form.FormPanel({border:false,labelWidth:90,labelAlign:"right",waitMsgTarget:true,bodyStyle:"padding:5px 10px 10px 10px;",items:[{xtype:"panel",border:false,bodyStyle:"padding:10px",layout:"form",region:"center",autoScroll:true,items:[this.baseField]}]});this.mainPanel=new Ext.Panel({title:lang("baseInfo"),hideBorders:true,autoScroll:true,border:false,items:[this.baseinfoFormPanel],tbar:new Ext.Toolbar({items:[{text:lang("save"),iconCls:"icon-btn-save",handler:function(){if(CNOA.project.proj.applyproj.applyID!=0){g.edit()}else{g.submit()}}},{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){CNOA.msg.cf("确定要关闭吗",function(i){if(i=="yes"){mainPanel.closeTab("CNOA_MENU_PROJECT_PROJ_APPLY")}})}},"->",{xtype:"cnoa_helpBtn",helpid:2001}]})});if(CNOA.project.proj.applyproj.applyID!=0){g.loadFormData()}if(CNOA.project.proj.applyproj.applyType=="change"){Ext.getCmp(a).disabled=true}},edit:function(){var a=this;if(a.baseinfoFormPanel.getForm().isValid()){a.baseinfoFormPanel.getForm().submit({url:a.baseUrl+"&task=editbaseinfo",waitMsg:lang("waiting"),params:{pid:CNOA.project.proj.applyproj.applyID,type:CNOA.project.proj.applyproj.applyType},method:"POST",success:function(b,c){CNOA.msg.alert(c.result.msg,function(){a.baseinfoFormPanel.getForm().findField("document").setValue("");a.loadFormData()})}.createDelegate(this),failure:function(b,c){CNOA.msg.alert(c.result.msg)}.createDelegate(this)})}},submit:function(){var a=this;if(a.baseinfoFormPanel.getForm().isValid()){a.baseinfoFormPanel.getForm().submit({url:a.baseUrl+"&task=submitbaseinfo",waitMsg:lang("waiting"),method:"POST",success:function(b,c){CNOA.msg.alert("保存成功,请继续输入其他资料!",function(){CNOA.project.proj.applyproj.applyID=c.result.applyId;CNOA_project_proj_applyprojmember.setPid(c.result.applyId);CNOA_project_proj_applyprojtask.setPid(c.result.applyId);CNOA_project_proj_applyprojdocument.setPid(c.result.applyId);CNOA_project_proj_applyprojbudget.setPid(c.result.applyId);CNOA_project_proj_applyprojmember.mainPanel.enable();CNOA_project_proj_applyprojtask.mainPanel.enable();CNOA_project_proj_applyprojdocument.mainPanel.enable();CNOA_project_proj_applyprojbudget.mainPanel.enable();CNOA_project_proj_applyproj.panelTab.setActiveTab(1)})}.createDelegate(this),failure:function(b,c){CNOA.msg.alert(c.result.msg)}.createDelegate(this)})}},loadFormData:function(){var a=this;a.baseinfoFormPanel.getForm().load({url:a.baseUrl+"&task=editApplyBaseInfoList",params:{pid:CNOA.project.proj.applyproj.applyID},method:"POST",success:function(b,c){CNOA_project_proj_applyprojmember.mainPanel.enable();CNOA_project_proj_applyprojtask.mainPanel.enable();CNOA_project_proj_applyprojdocument.mainPanel.enable();CNOA_project_proj_applyprojbudget.mainPanel.enable();if(c.result.data.ulid==0){a.baseinfoFormPanel.getForm().findField("ulid").setValue(" ")}},failure:function(b,c){CNOA.msg.alert(c.result.msg,function(){})}.createDelegate(this)})}};CNOA_project_proj_applyprojmemberClass=CNOA.Class.create();CNOA_project_proj_applyprojmemberClass.prototype={init:function(){var g=this;var e=Ext.id();var d=Ext.id();var a=Ext.id();var b=Ext.id();var c=CNOA.project.proj.applyproj.applyID;this.pid=CNOA.project.proj.applyproj.applyID;this.baseUrl="index.php?app=project&func=proj&action=main&module=myproj&type="+CNOA.project.proj.applyproj.applyType;this.sortStoreLd=false;this.storeLd=false;this.memberSearch={uid:this.membersearchuid,sortid:this.membersearchsortid};this.memberSearch.membersearchuid="";this.memberSearch.membersearchsortid="";this.dsc=Ext.data.Record.create([{name:"name",type:"string"},{name:"sname",type:"string"},{name:"uid",type:"number"}]);this.fields=[{name:"mid"},{name:"name",mapping:"name"},{name:"sid",mapping:"sortid"},{name:"uid"}];this.sortStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getSortJobList",method:"POST"}),reader:new Ext.data.JsonReader({root:"data",fields:[{name:"sid",mapping:"sid"},{name:"sname",mapping:"sname"}]})});this.sortCombo=new Ext.form.ComboBox({autoLoad:true,triggerAction:"all",selectOnFocus:true,editable:false,store:this.sortStore,valueField:"sid",displayField:"sname",allowBlank:false,mode:"local",forceSelection:true});this.store=new Ext.data.GroupingStore({reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields}),listeners:{update:function(l,i,k){var j={mid:i.data.mid,sid:i.data.sid,uid:i.data.uid,applyId:g.pid};if(k==Ext.data.Record.EDIT){g.submit(j)}}}});this.editor=new Ext.ux.grid.RowEditor({cancelText:lang("cancel"),saveText:lang("update"),errorSummary:false});this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.cm=[new Ext.grid.RowNumberer(),this.sm,{header:"",dataIndex:"mid",hidden:true},{header:"",dataIndex:"uid",width:1,sortable:true,editor:{xtype:"hidden",id:e}},{id:"sid",header:"项目角色",dataIndex:"sid",width:200,sortable:true,editor:this.sortCombo,renderer:function(i){var j;g.sortStore.each(function(k){if(k.get("sid")==i){j=k;return}});return j==null?i:j.get("sname")}},{header:"名字",dataIndex:"name",width:300,sortable:true,editor:{xtype:"triggerForPeople",allowBlank:false,dataUrl:g.baseUrl+"&task=getAllUserListsInPermitDeptTree",width:230,listeners:{selected:function(k,j,i){Ext.getCmp(e).setValue(j)},opened:function(){g.editor.getEl().setStyle("display","none")},closed:function(){try{g.editor.getEl().setStyle("display","block")}catch(i){}}}}}];this.grid=new Ext.grid.GridPanel({stripeRows:true,store:this.store,width:600,plain:false,loadMask:{msg:lang("waiting")},region:"center",border:false,autoScroll:true,plugins:[this.editor],columns:this.cm,view:new Ext.grid.GroupingView({markDirty:false}),tbar:[{handler:function(i,j){g.store.load()}.createDelegate(this),iconCls:"icon-system-refresh",text:lang("refresh")},{iconCls:"icon-utils-s-add",cls:"btn-blue4",text:"添加新成员",tooltip:"添加一个新的项目成员",handler:function(){var i=new g.dsc({name:""});g.editor.stopEditing();g.store.insert(0,i);g.grid.getView().refresh();g.grid.getSelectionModel().selectRow(0);g.editor.startEditing(0)}},{iconCls:"icon-utils-s-delete",text:lang("del"),tooltip:"删除记录(按住Ctrl或Shift键可以一次选择多条记录进行删除)",handler:function(i){g.editor.stopEditing();var j=g.grid.getSelectionModel().getSelections();if(j.length==0){CNOA.miniMsg.alertShowAt(i,lang("mustSelectOneRow"))}else{CNOA.msg.cf(lang("confirmToDelete"),function(l){if(l=="yes"){if(j){var m="";for(var k=0;k<j.length;k++){m+=j[k].get("mid")+",";var n=j[k];g.store.remove(n)}g.deleteData(m)}}})}}},"<span class='cnoa_color_gray'>双击可修改记录，如果您有权限，您可以在项目基本设置->代码设置->项目角色类型<span class='cnoa_color_red'>添加/修改和删除项目角色</span></span>","->",{xtype:"cnoa_helpBtn",helpid:2002}]});this.mainPanel=new Ext.Panel({title:"项目成员",collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.grid],listeners:{activate:function(){if(!g.sortStoreLd){g.sortStore.load();g.sortStoreLd=true}if(!g.storeLd){g.store.proxy=new Ext.data.HttpProxy({url:g.baseUrl+"&task=memberlist&pid="+g.pid});g.store.load();g.storeLd=true}}},tbar:new Ext.Toolbar({items:["项目角色:",{xtype:"panel",border:false,layout:"fit",items:[new Ext.form.ComboBox({name:"sid",store:g.sortStore,id:a,hiddenName:"sid",valueField:"sid",displayField:"sname",blankText:"如果您有权限，可在项目基本设置->代码设置-><br />项目角色类型里面添加，修改和删除项目角色类型操作。",mode:"local",width:160,triggerAction:"all",forceSelection:true,editable:false,listeners:{select:function(k,i,j){}.createDelegate(this)}})]},"名字:",{xtype:"hidden",id:b},{xtype:"panel",border:false,layout:"fit",items:[{xtype:"triggerForPeople",dataUrl:g.baseUrl+"&task=getAllUserListsInPermitDeptTree",width:168,id:d,listeners:{selected:function(k,j,i){Ext.getCmp(b).setValue(j)}}}]},{xtype:"button",text:lang("search"),style:"margin-left:5px",handler:function(){g.memberSearch.membersearchuid=Ext.getCmp(b).getValue();g.memberSearch.membersearchsortid=Ext.getCmp(a).getValue();g.store.load({params:g.memberSearch})}},{xtype:"button",text:lang("clear"),handler:function(){g.memberSearch.membersearchuid="";g.memberSearch.membersearchsortid="";Ext.getCmp(b).setValue("");Ext.getCmp(d).setValue("");Ext.getCmp(a).setValue("");g.store.load({params:g.memberSearch})}}]})})},submit:function(a){var b=this;Ext.Ajax.request({url:this.baseUrl+"&task=submitmember",params:a,method:"POST",success:function(e,d){var c=Ext.decode(e.responseText);if(c.success===true){b.store.reload()}else{CNOA.msg.alert(c.msg,function(){b.store.load({params:{applyId:b.pid}})})}},failure:function(c,d){CNOA.msg.alert(result.msg,function(){b.store.reload()})}})},deleteData:function(a){var b=this;Ext.Ajax.request({url:this.baseUrl+"&task=deletemember",method:"POST",params:{ids:a,pid:CNOA.project.proj.applyproj.applyID},success:function(d){var c=Ext.decode(d.responseText);if(c.success===true){CNOA.msg.alert(c.msg,function(){b.store.reload()})}else{CNOA.msg.alert(c.msg)}}})},setPid:function(a){var b=this;b.pid=a}};CNOA_project_proj_applyprojtaskClass=CNOA.Class.create();CNOA_project_proj_applyprojtaskClass.prototype={init:function(){var g=this;this.type="add";this.baseUrl="index.php?app=project&func=proj&action=main&module=myproj&type2="+CNOA.project.proj.applyproj.applyType;this.pid=CNOA.project.proj.applyproj.applyID;this.storeLd=false;this.projectExecmanComboBoxDataStoreLd=false;var a=Ext.id();var c=Ext.id();var e=Ext.id();var b=Ext.id();var d=Ext.id();this.tasksearch={title:this.title,stime:this.stime,etime:this.etime,people:this.people};this.tasksearch.title="";this.tasksearch.stime="";this.tasksearch.etime="";this.tasksearch.people="";g.projectNeedTaskComboBoxDataStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:g.baseUrl+"&task=getNeedTaskList"}),reader:new Ext.data.JsonReader({root:"data",fields:[{name:"needtask",mapping:"tid"},{name:"title"}]})});g.projectExecmanComboBoxDataStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:g.baseUrl+"&task=getMemberList"}),reader:new Ext.data.JsonReader({root:"data",fields:[{name:"execman"},{name:"execname"}]})});this.fields=[{name:"tid"},{name:"title"},{name:"execname"},{name:"number"},{name:"stime"},{name:"etime"},{name:"pday"},{name:"needtask"},{name:"level"},{name:"milepost"}];this.store=new Ext.data.Store({reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields}),listeners:{exception:function(n,m,o,l,k,j){var i=Ext.decode(k.responseText);if(i.failure){CNOA.msg.alert(i.msg)}}}});this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.pagingBar=new Ext.PagingToolbar({displayInfo:true,store:this.store,pageSize:15,listeners:{beforechange:function(i,j){if(g.tasksearch.title!=""){j.title=g.tasksearch.title}if(g.tasksearch.stime!=""){j.stime=g.tasksearch.stime}if(g.tasksearch.etime!=""){j.etime=g.tasksearch.etime}if(g.tasksearch.people!=""){j.people=g.tasksearch.people}}}});this.colModel=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),this.sm,{header:"tid",dataIndex:"tid",hidden:true},{header:"任务编号",dataIndex:"number",width:100,sortable:true,menuDisabled:true},{header:"任务名称",dataIndex:"title",width:100,sortable:true,menuDisabled:true},{header:"前置任务(名称)",dataIndex:"needtask",width:100,sortable:true,menuDisabled:true},{header:"执行人",dataIndex:"execname",width:120,sortable:true,menuDisabled:true},{header:"开始",dataIndex:"stime",width:120,sortable:true,menuDisabled:true},{header:"结束",dataIndex:"etime",width:120,sortable:true,menuDisabled:true},{header:"计划工时(天)",dataIndex:"pday",width:100,sortable:true,menuDisabled:true},{header:"任务等级",dataIndex:"level",width:80,sortable:false,menuDisabled:true},{header:"里程碑",dataIndex:"milepost",width:100,sortable:false,menuDisabled:true},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.list=new Ext.grid.GridPanel({stripeRows:true,border:false,store:this.store,loadMask:{msg:lang("waiting")},cm:this.colModel,sm:this.sm,hideBorders:true,listeners:{rowdblclick:function(i,j){var k=g.list.getSelectionModel().getSelections();if(k.length==0){CNOA.miniMsg.alertShowAt(i,lang("mustSelectOneRow"))}else{g.type="edit";g.edit_id=k[0].get("tid");g.taskwindow()}}},tbar:[{text:lang("refresh"),iconCls:"icon-system-refresh",handler:function(i,j){g.store.reload()}},{text:"新建任务",iconCls:"icon-utils-s-add",cls:"btn-blue4",handler:function(){g.type="add";g.taskwindow()}},{text:"修改任务",iconCls:"icon-utils-s-edit",cls:"btn-red1",handler:function(i,j){var k=g.list.getSelectionModel().getSelections();if(k.length==0){CNOA.miniMsg.alertShowAt(i,lang("mustSelectOneRow"))}else{g.type="edit";g.edit_id=k[0].get("tid");g.taskwindow()}}.createDelegate(this)},{text:lang("del"),iconCls:"icon-utils-s-delete",handler:function(i){var j=g.list.getSelectionModel().getSelections();if(j.length==0){CNOA.miniMsg.alertShowAt(btn,lang("mustSelectOneRow"))}else{CNOA.msg.cf(lang("confirmToDelete"),function(l){if(l=="yes"){if(j){var m="";for(var k=0;k<j.length;k++){m+=j[k].get("tid")+",";var n=j[k];g.store.remove(n)}g.deleteData(m)}}})}}},"<span class='cnoa_color_gray'>双击可修改任务信息，按住ctrl或shift键可选择多个</span>","->",{xtype:"cnoa_helpBtn",helpid:2003}],bbar:this.pagingBar});this.center=new Ext.Panel({region:"center",layout:"fit",items:[this.list]});this.mainPanel=new Ext.Panel({title:"项目任务",hideBorders:true,autoScroll:true,layout:"fit",border:false,items:[this.center],listeners:{activate:function(){if(!g.storeLd){g.store.proxy=new Ext.data.HttpProxy({url:g.baseUrl+"&task=getTaskList&pid="+g.pid});g.store.load();g.storeLd=true}if(!g.projectExecmanComboBoxDataStoreLd){g.projectExecmanComboBoxDataStore.load({params:{pid:g.pid}});g.projectExecmanComboBoxDataStoreLd=true}}},tbar:new Ext.Toolbar({style:"border-left-width:1px;",items:["任务名称:",{xtype:"textfield",width:168,id:a},"执行人:",{xtype:"panel",border:false,layout:"fit",items:[new Ext.form.ComboBox({name:"execman",store:g.projectExecmanComboBoxDataStore,hiddenName:"execman",valueField:"execman",displayField:"execname",mode:"local",width:200,id:b,triggerAction:"all",forceSelection:true,editable:false,listeners:{select:function(k,i,j){}.createDelegate(this)}})]},"开始时间:",{xtype:"panel",border:false,layout:"fit",items:[{xtype:"datefield",width:120,format:"Y-m-d",id:c}]},"结束时间:",{xtype:"panel",border:false,layout:"fit",items:[{xtype:"datefield",width:120,format:"Y-m-d",id:e}]},{xtype:"button",text:lang("search"),style:"margin-left:5px",handler:function(){g.tasksearch.title=Ext.getCmp(a).getValue();g.tasksearch.stime=Ext.getCmp(c).getRawValue();g.tasksearch.etime=Ext.getCmp(e).getRawValue();g.tasksearch.people=Ext.getCmp(b).getValue();g.store.load({params:g.tasksearch})}},{xtype:"button",text:lang("clear"),handler:function(){Ext.getCmp(a).setValue("");Ext.getCmp(c).setValue("");Ext.getCmp(e).setValue("");Ext.getCmp(b).setValue("");g.tasksearch.title="";g.tasksearch.stime="";g.tasksearch.etime="";g.tasksearch.people="";g.store.load({params:g.tasksearch})}}]})})},setPid:function(a){var b=this;b.pid=a},taskwindow:function(){var i=this;var g=Ext.id();this.ID_projectNeedTaskComboBoxData=Ext.id();this.ID_level=Ext.id();i.projectNeedTaskComboBoxDataStore.load({params:{pid:i.pid}});i.projectExecmanComboBoxDataStore.load({params:{pid:i.pid}});var a=[{name:"title"}];var e=[{xtype:"fieldset",title:"项目任务",defaults:{border:false},items:[{xtype:"panel",hideBorders:true,border:false,layout:"table",autoWidth:true,layoutConfig:{columns:2},items:[{xtype:"panel",layout:"form",width:360,defaults:{style:{marginBottom:"10px"},border:false},items:[{xtype:"cnoa_textfield",width:230,name:"number",fieldLabel:"任务序号"}]},{xtype:"panel",layout:"form",width:360,defaults:{style:{marginBottom:"10px"},border:false},items:[{xtype:"cnoa_textfield",width:230,allowBlank:false,name:"title",fieldLabel:"任务名称"}]}]},{xtype:"panel",hideBorders:true,border:false,layout:"table",autoWidth:true,layoutConfig:{columns:2},items:[{xtype:"panel",layout:"form",width:360,defaults:{style:{marginBottom:"10px"},border:false},items:[{xtype:"hidden",name:"applyId",value:CNOA.project.proj.applyproj.applyID},{xtype:"panel",layout:"form",border:false,items:[new CNOA.form.ComboBox({fieldLabel:"前置任务",name:"needtask",helpTip:"选择在该任务完成前，必须完成的任务名字，无则表示该任务<br />在规定时间开始，无前置任务约束。括号内是任务执行人",store:i.projectNeedTaskComboBoxDataStore,hiddenName:"needtask",valueField:"needtask",id:i.ID_projectNeedTaskComboBoxData,displayField:"title",mode:"local",width:230,triggerAction:"all",forceSelection:true,editable:false,listeners:{select:function(l,j,k){}.createDelegate(this)}})]}]},{xtype:"panel",layout:"form",width:360,defaults:{style:{marginBottom:"10px"},border:false},items:[{xtype:"panel",layout:"form",border:false,items:[{xtype:"panel",layout:"form",border:false,items:[new Ext.form.ComboBox({fieldLabel:"执行人",name:"execman",store:i.projectExecmanComboBoxDataStore,hiddenName:"execman",valueField:"execman",displayField:"execname",allowBlank:false,mode:"local",width:230,triggerAction:"all",forceSelection:true,editable:false,listeners:{select:function(l,j,k){}.createDelegate(this)}})]}]}]}]},{xtype:"panel",hideBorders:true,border:false,layout:"table",autoWidth:true,layoutConfig:{columns:2},items:[{xtype:"panel",layout:"form",width:360,defaults:{style:{marginBottom:"10px"},border:false},items:[{xtype:"panel",layout:"table",fieldLabel:"计划周期开始<span class='cnoa_color_red'>*</span>",items:[{xtype:"datefield",width:130,format:"Y-m-d",allowBlank:false,name:"stime",fieldLabel:""},{xtype:"timefield",width:100,increment:60,name:"stime_h",editable:false,format:"H:i"}]}]},{xtype:"panel",layout:"form",width:360,defaults:{style:{marginBottom:"10px"},border:false},items:[{xtype:"panel",layout:"table",fieldLabel:"计划周期结束<span class='cnoa_color_red'>*</span>",items:[{xtype:"datefield",width:130,format:"Y-m-d",allowBlank:false,name:"etime",fieldLabel:""},{xtype:"timefield",width:100,increment:60,name:"etime_h",editable:false,format:"H:i"}]}]}]},{xtype:"panel",hideBorders:true,border:false,layout:"table",autoWidth:true,layoutConfig:{columns:2},items:[{xtype:"panel",layout:"form",width:360,defaults:{style:{marginBottom:"10px"},border:false},items:[{xtype:"panel",layout:"form",border:false,items:[new Ext.form.ComboBox({fieldLabel:"任务级别",name:"level",store:new Ext.data.SimpleStore({fields:["value","level"],data:[["1","次要"],["2","一般"],["3","重要"],["4","非常重要"]]}),width:230,id:i.ID_level,hiddenName:"level",valueField:"value",displayField:"level",mode:"local",triggerAction:"all",forceSelection:true,editable:false})]}]}]},{xtype:"checkbox",width:350,style:"margin-left:5px;margin-top:3px;",name:"milepost",fieldLabel:"标记为里程碑",boxLabel:"<span class='cnoa_color_gray'>里程碑一般是项目中完成阶段性工作的标志。</span>"},{xtype:"textarea",fieldLabel:"任务描述",name:"content",style:"margin-bottom:10px",width:590,height:80},{xtype:"textarea",fieldLabel:"任务奖罚说明",name:"prizepunish",style:"margin-bottom:10px",width:590,height:80},{xtype:"flashfile",fieldLabel:"添加文档",name:"document",style:"margin-top:5px;",inputPre:"filesUpload"}]}];i.taskFormPanel=new Ext.form.FormPanel({hideBorders:true,border:false,waitMsgTarget:true,region:"center",layout:"border",labelWidth:100,labelAlign:"right",items:[{xtype:"panel",border:false,bodyStyle:"padding:10px",layout:"form",region:"center",autoScroll:true,items:[e]}]});var d=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:i.baseUrl+"&task=getPreTask&pid="+i.pid,disableCaching:true}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:a})});var c=new Ext.grid.ColumnModel([{header:"任务名称",dataIndex:"title",width:200,sortable:true,menuDisabled:true}]);var b=new Ext.grid.GridPanel({stripeRows:true,border:false,region:"west",width:200,autoScroll:true,store:d,loadMask:{msg:lang("waiting")},style:"border-right-width:2px",cm:c,viewConfig:{forceFit:true}});this.window=new Ext.Window({title:"项目任务",width:1000,height:makeWindowHeight(580),modal:true,layout:"border",resizable:false,border:false,items:[i.taskFormPanel,b],buttons:[{text:"提交",handler:function(){i.taskSubmit()}},{text:lang("cancel"),handler:function(){i.window.close()}}]}).show();if(i.type=="edit"){i.taskloadFormData()}},taskloadFormData:function(){var a=this;a.taskFormPanel.getForm().load({url:a.baseUrl+"&task=editTaskList",params:{tid:a.edit_id},method:"POST",waitMsg:lang("waiting"),success:function(b,c){if(c.result.data.needtask==0){Ext.getCmp(a.ID_projectNeedTaskComboBoxData).setValue("")}if(c.result.data.level==0){Ext.getCmp(a.ID_level).setValue("")}},failure:function(b,c){CNOA.msg.alert(c.result.msg,function(){})}.createDelegate(this)})},taskSubmit:function(){var a=this;if(a.taskFormPanel.getForm().isValid()){a.taskFormPanel.getForm().submit({url:a.baseUrl+"&task=submitTask",waitMsg:lang("waiting"),params:{tid:a.edit_id,pid:CNOA.project.proj.applyproj.applyID,type:a.type},method:"POST",success:function(b,c){CNOA.msg.alert(c.result.msg,function(){a.window.close();a.store.reload()})}.createDelegate(this),failure:function(b,c){CNOA.msg.alert(c.result.msg)}.createDelegate(this)})}},deleteData:function(a){var b=this;Ext.Ajax.request({url:this.baseUrl+"&task=deletetask",method:"POST",params:{ids:a,pid:CNOA.project.proj.applyproj.applyID},success:function(d){var c=Ext.decode(d.responseText);if(c.success===true){CNOA.msg.alert(c.msg,function(){b.store.reload()})}else{CNOA.msg.alert(c.msg)}}})}};CNOA_project_proj_applyprojdocumentPermitJobClass=CNOA.Class.create();CNOA_project_proj_applyprojdocumentPermitJobClass.prototype={init:function(){var b=this;var a=CNOA.project.proj.applyproj.applyID;this.baseUrl="index.php?app=project&func=proj&action=main&module=myproj&pid="+a;this.fields=[{name:"sid"},{name:"sname"}];this.directoryPermitByJobStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:b.baseUrl+"&task=directoryPermitByJobList",disableCaching:true}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields})});this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.directoryPermitByJobStore.load();this.colModel=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"sid",dataIndex:"sid",hidden:true},{header:"项目角色名称",dataIndex:"sname",width:180,sortable:true,menuDisabled:true},{header:"下载",dataIndex:"sid",width:80,sortable:true,menuDisabled:true,renderer:b.downloadfile},{header:"上传",dataIndex:"sid",width:80,sortable:true,menuDisabled:true,renderer:b.uploadfile},{header:"删除文件",dataIndex:"sid",width:80,sortable:true,menuDisabled:true,renderer:b.deletefile},{header:lang("selectAll"),dataIndex:"sid",width:80,sortable:true,menuDisabled:true,renderer:b.selectall},{header:"",dataIndex:"",width:1,menuDisabled:true,resizable:false}]);this.grid=new Ext.grid.GridPanel({stripeRows:true,border:false,region:"center",autoScroll:true,store:this.directoryPermitByJobStore,loadMask:{msg:lang("waiting")},cm:this.colModel,sm:this.sm,hideBorders:true});this.mainPanel=new Ext.Panel({title:"角色权限",collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.grid]})},downloadfile:function(e,c,a,g,b,d){return"<label><input row='CNOA_PROJECT_PROJ_APPLYPROJ_DIRPREMIT_JOB"+g+"' name='job["+e+"][dl]' type='checkbox' value='1' id='CNOA_PROJECT_PROJ_APPLYPROJ_DIRPREMIT_JOB_DOWNLOAD"+e+"'/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>"},uploadfile:function(e,c,a,g,b,d){return"<label><input row='CNOA_PROJECT_PROJ_APPLYPROJ_DIRPREMIT_JOB"+g+"' name='job["+e+"][up]' type='checkbox' value='1' id='CNOA_PROJECT_PROJ_APPLYPROJ_DIRPREMIT_JOB_UPLOAD"+e+"'/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>"},mkdir:function(e,c,a,g,b,d){return"<label><input row='CNOA_PROJECT_PROJ_APPLYPROJ_DIRPREMIT_JOB"+g+"' name='job["+e+"][md]' type='checkbox' value='1' id='CNOA_PROJECT_PROJ_APPLYPROJ_DIRPREMIT_JOB_MKDIR"+e+"'/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>"},deletefile:function(e,c,a,g,b,d){return"<label><input row='CNOA_PROJECT_PROJ_APPLYPROJ_DIRPREMIT_JOB"+g+"' name='job["+e+"][dt]' type='checkbox' value='1' id='CNOA_PROJECT_PROJ_APPLYPROJ_DIRPREMIT_JOB_DELETE"+e+"'/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>"},selectall:function(e,c,a,g,b,d){return"<label><input type='checkbox' onclick='CNOA_project_proj_applyprojdocumentPermitJob.selectall2("+g+",this)' id='CNOA_PROJECT_PROJ_APPLYPROJ_DIRPREMIT_JOB_ALL"+e+"'/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>"},selectall2:function(c,b){var a=Ext.query("input[row^=CNOA_PROJECT_PROJ_APPLYPROJ_DIRPREMIT_JOB"+c+"]");Ext.each(a,function(d,e){d.checked=b.checked})}};CNOA_project_proj_applyprojdocumentPermitMemberClass=CNOA.Class.create();CNOA_project_proj_applyprojdocumentPermitMemberClass.prototype={init:function(){var b=this;var a=CNOA.project.proj.applyproj.applyID;this.baseUrl="index.php?app=project&func=proj&action=main&module=myproj&pid="+a;this.fields=[{name:"mid"},{name:"name"}];this.directoryPermitByJobStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:b.baseUrl+"&task=directoryPermitByPersonList",disableCaching:true}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields})});this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.directoryPermitByJobStore.load();this.colModel=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"mid",dataIndex:"mid",hidden:true},{header:"项目参与人",dataIndex:"name",width:180,sortable:true,menuDisabled:true},{header:"下载",dataIndex:"mid",width:80,sortable:true,menuDisabled:true,renderer:b.downloadfile},{header:"上传",dataIndex:"mid",width:80,sortable:true,menuDisabled:true,renderer:b.uploadfile},{header:"删除文件",dataIndex:"mid",width:80,sortable:true,menuDisabled:true,renderer:b.deletefile},{header:lang("selectAll"),dataIndex:"mid",width:80,sortable:true,menuDisabled:true,renderer:b.selectall},{header:"",dataIndex:"",width:1,menuDisabled:true,resizable:false}]);this.grid=new Ext.grid.GridPanel({stripeRows:true,border:false,region:"center",autoScroll:true,store:this.directoryPermitByJobStore,loadMask:{msg:lang("waiting")},cm:this.colModel,sm:this.sm,hideBorders:true});this.mainPanel=new Ext.Panel({title:lang("userPermit"),collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.grid]})},downloadfile:function(e,c,a,g,b,d){return"<label><input row='CNOA_PROJECT_PROJ_APPLYPROJ_DIRPREMIT_MEMBER"+g+"' name='mem["+e+"][dl]' type='checkbox' value='1' id='CNOA_PROJECT_PROJ_APPLYPROJ_DIRPREMIT_MEMBER_DOWNLOAD"+e+"'/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>"},uploadfile:function(e,c,a,g,b,d){return"<label><input row='CNOA_PROJECT_PROJ_APPLYPROJ_DIRPREMIT_MEMBER"+g+"' name='mem["+e+"][up]' type='checkbox' value='1' id='CNOA_PROJECT_PROJ_APPLYPROJ_DIRPREMIT_MEMBER_UPLOAD"+e+"'/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>"},mkdir:function(e,c,a,g,b,d){return"<label><input row='CNOA_PROJECT_PROJ_APPLYPROJ_DIRPREMIT_MEMBER"+g+"' name='mem["+e+"][md]' type='checkbox' value='1' id='CNOA_PROJECT_PROJ_APPLYPROJ_DIRPREMIT_MEMBER_MKDIR"+e+"'/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>"},deletefile:function(e,c,a,g,b,d){return"<label><input row='CNOA_PROJECT_PROJ_APPLYPROJ_DIRPREMIT_MEMBER"+g+"' name='mem["+e+"][dt]' type='checkbox' value='1' id='CNOA_PROJECT_PROJ_APPLYPROJ_DIRPREMIT_MEMBER_DELETE"+e+"'/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>"},selectall:function(e,c,a,g,b,d){return"<label><input type='checkbox' onclick='CNOA_project_proj_applyprojdocumentPermitMember.selectall2("+g+",this)' id='CNOA_PROJECT_PROJ_APPLYPROJ_DIRPREMIT_MEMBER_ALL"+e+"'/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>"},selectall2:function(c,b){var a=Ext.query("input[row^=CNOA_PROJECT_PROJ_APPLYPROJ_DIRPREMIT_MEMBER"+c+"]");Ext.each(a,function(d,e){d.checked=b.checked})}};CNOA_project_proj_applyprojdocumentClass=CNOA.Class.create();CNOA_project_proj_applyprojdocumentClass.prototype={init:function(){var b=this;this.pid=CNOA.project.proj.applyproj.applyID;this.storeLd=false;var a=Ext.id();this.baseUrl="index.php?app=project&func=proj&action=main&module=myproj";this.dsc=Ext.data.Record.create([{name:"dorder",type:"string"},{name:"title",type:"string"}]);this.fields=[{name:"did"},{name:"title"},{name:"dorder"}];this.store=new Ext.data.GroupingStore({reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields}),listeners:{update:function(g,c,e){var d=c.data;if(e==Ext.data.Record.EDIT){b.directorySubmit(d)}}}});this.editor=new Ext.ux.grid.RowEditor({cancelText:lang("cancel"),saveText:lang("update"),errorSummary:false});this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.cm=[new Ext.grid.RowNumberer(),this.sm,{header:"",dataIndex:"did",hidden:true},{header:"目录名字",dataIndex:"title",width:400,sortable:true,editor:{xtype:"textfield",allowBlank:false},renderer:b.folder},{header:"排序号",dataIndex:"dorder",width:300,sortable:true,editor:{xtype:"textfield",allowBlank:true,regex:/^([0-9]{1,}\.[0-9]{1,}|[0-9]{1,})$/i,regexText:"必须设置最多10位数字"}},{header:"目录权限",dataIndex:"",width:200,sortable:true,renderer:this.directoryPermit.createDelegate(this)}];this.grid=new Ext.grid.GridPanel({stripeRows:true,store:this.store,width:600,plain:false,loadMask:{msg:lang("waiting")},region:"center",border:false,autoScroll:true,plugins:[this.editor],columns:this.cm,listeners:{cellclick:function(c,i,g,d){if(g==5){return false}}},view:new Ext.grid.GroupingView({markDirty:false}),tbar:[{handler:function(c,d){b.store.reload()}.createDelegate(this),iconCls:"icon-system-refresh",text:lang("refresh")},{iconCls:"icon-utils-s-add",text:lang("add"),tooltip:"添加一个新的项目目录",handler:function(){var c=new b.dsc({name:""});b.editor.stopEditing();b.store.insert(0,c);b.grid.getView().refresh();b.grid.getSelectionModel().selectRow(0);b.editor.startEditing(0)}},{iconCls:"icon-utils-s-delete",text:lang("del"),tooltip:"删除记录(按住Ctrl或Shift键可以一次选择多条记录进行删除)",handler:function(c){b.editor.stopEditing();var d=b.grid.getSelectionModel().getSelections();if(d.length==0){CNOA.miniMsg.alertShowAt(c,lang("mustSelectOneRow"))}else{CNOA.msg.cf("确定要删该文件夹吗，删除该文件夹，会删除该文件夹下面的所有文件",function(g){if(g=="yes"){if(d){var j="";for(var e=0;e<d.length;e++){j+=d[e].get("did")+",";var k=d[e];b.store.remove(k)}b.deleteData(j)}}})}}},"<span class='cnoa_color_gray'>双击可修改记录,按住Ctrl或Shift键可以一次选择多条记录，排序号是从小到大，从上到下列出。</span>","->",{xtype:"cnoa_helpBtn",helpid:2004}]});this.mainPanel=new Ext.Panel({title:"项目文档",collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.grid],listeners:{activate:function(){if(!b.storeLd){b.store.proxy=new Ext.data.HttpProxy({url:b.baseUrl+"&task=directoryList&pid="+b.pid});b.store.load();b.storeLd=true}}},tbar:new Ext.Toolbar({style:"border-left-width:1px;",items:["目录名字:",{xtype:"textfield",width:168,id:a},{xtype:"button",text:lang("search"),style:"margin-left:5px",handler:function(){title=Ext.getCmp(a).getValue();b.store.load({params:{title:title}})}},{xtype:"button",text:lang("clear"),handler:function(){title="";Ext.getCmp(a).setValue("");b.store.load({params:{title:title}})}}]})})},directorySubmit:function(a){var b=this;Ext.Ajax.request({url:this.baseUrl+"&task=submitDocument&pid="+b.pid,params:a,method:"POST",success:function(e,d){var c=Ext.decode(e.responseText);if(c.success===true){b.store.reload()}else{CNOA.msg.alert(c.msg,function(){b.store.load()})}},failure:function(c,d){CNOA.msg.alert(result.msg,function(){b.store.reload()})}})},deleteData:function(a){var b=this;Ext.Ajax.request({url:this.baseUrl+"&task=deletedirectory",method:"POST",params:{ids:a},success:function(d){var c=Ext.decode(d.responseText);if(c.success===true){CNOA.msg.alert(c.msg,function(){b.store.reload()})}else{CNOA.msg.alert(c.msg)}}})},folder:function(e,c,a,g,b,d){if(e==undefined){e=""}return'<img src="'+CNOA_EXTJS_PATH+'/resources/images/default/tree/folder.gif" align="absmiddle">&nbsp;&nbsp;'+e},directoryPermit:function(e,c,a,g,b,d){return"<a href='javascript:void(0);' class='gridview' onclick='CNOA_project_proj_applyprojdocument.setdirectoryPermit("+a.data.did+")' ext:qtip='可以设置项目参与者或者项目角色<br />对此文件夹的权限'>设置权限</a>"},setdirectoryPermit:function(b){var c=this;CNOA_project_proj_applyprojdocumentPermitJob=new CNOA_project_proj_applyprojdocumentPermitJobClass();CNOA_project_proj_applyprojdocumentPermitMember=new CNOA_project_proj_applyprojdocumentPermitMemberClass();var a=new Ext.TabPanel({border:false,activeTab:0,bodyStyle:"margin-bottom:100px;",deferredRender:false,items:[CNOA_project_proj_applyprojdocumentPermitJob.mainPanel,CNOA_project_proj_applyprojdocumentPermitMember.mainPanel]});this.docFormPanel=new Ext.form.FormPanel({border:false,layout:"fit",region:"center",waitMsgTarget:true,tbar:["<span class='cnoa_color_gray'>注意:如果该项目成员的角色权限和用户权限不一样，</span><span class='cnoa_color_red'>则该成员以用户权限为主。</span>"],items:[a]});this.directoryPermitWindow=new Ext.Window({title:"目录权限",width:550,layout:"border",height:makeWindowHeight(600),modal:true,resizable:false,border:false,items:[this.docFormPanel],buttons:[{text:"提交",handler:function(){c.submit(b)}},{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){c.directoryPermitWindow.close()}}]}).show();c.loadFormData(b)},loadFormData:function(a){var b=this;b.docFormPanel.getForm().load({url:b.baseUrl+"&task=editDirectoryPermit",params:{did:a},method:"POST",success:function(c,d){Ext.each(d.result.data,function(e,g){if(e.jid==0){Ext.fly("CNOA_PROJECT_PROJ_APPLYPROJ_DIRPREMIT_MEMBER_DOWNLOAD"+e.uid).dom.checked=Number(e.dl);Ext.fly("CNOA_PROJECT_PROJ_APPLYPROJ_DIRPREMIT_MEMBER_UPLOAD"+e.uid).dom.checked=Number(e.up);Ext.fly("CNOA_PROJECT_PROJ_APPLYPROJ_DIRPREMIT_MEMBER_DELETE"+e.uid).dom.checked=Number(e.dt)}else{Ext.fly("CNOA_PROJECT_PROJ_APPLYPROJ_DIRPREMIT_JOB_DOWNLOAD"+e.jid).dom.checked=Number(e.dl);Ext.fly("CNOA_PROJECT_PROJ_APPLYPROJ_DIRPREMIT_JOB_UPLOAD"+e.jid).dom.checked=Number(e.up);Ext.fly("CNOA_PROJECT_PROJ_APPLYPROJ_DIRPREMIT_JOB_DELETE"+e.jid).dom.checked=Number(e.dt)}})},failure:function(c,d){CNOA.msg.alert(d.result.msg,function(){b.directoryPermitWindow.close()})}.createDelegate(this)})},submit:function(a){var b=this;if(b.docFormPanel.getForm().isValid()){b.docFormPanel.getForm().submit({url:b.baseUrl+"&task=directorypermit",waitMsg:lang("waiting"),params:{did:a},method:"POST",success:function(c,d){CNOA.msg.alert(d.result.msg,function(){b.directoryPermitWindow.close()})}.createDelegate(this),failure:function(c,d){CNOA.msg.alert(d.result.msg)}.createDelegate(this)})}},setPid:function(a){var b=this;b.pid=a}};CNOA_project_proj_applyprojbudgetClass=CNOA.Class.create();CNOA_project_proj_applyprojbudgetClass.prototype={init:function(){var d=this;var c=CNOA.project.proj.applyproj.applyID;this.pid=CNOA.project.proj.applyproj.applyID;this.baseUrl="index.php?app=project&func=proj&action=main&module=myproj&type="+CNOA.project.proj.applyproj.applyType;var b=Ext.id();var a=Ext.id();this.storeLd=false;this.sortStoreLd=false;this.searchbar={type:this.type,costtype:this.costtype,costtitle:this.costtitle};this.sortStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getBudgetTypeList",method:"POST"}),reader:new Ext.data.JsonReader({root:"data",fields:[{name:"sid",mapping:"sid"},{name:"sname",mapping:"sname"}]})});this.sortCombo=new Ext.form.ComboBox({autoLoad:true,triggerAction:"all",selectOnFocus:true,editable:false,store:this.sortStore,valueField:"sid",displayField:"sname",allowBlank:false,mode:"local",forceSelection:true});this.dsc=Ext.data.Record.create([{name:"sid",type:"string"},{name:"name",type:"string"}]);this.fields=[{name:"bid"},{name:"title"},{name:"sid"},{name:"number"},{name:"r_cost"},{name:"t_cost"},{name:"posttime"},{name:"updatetime"},{name:"status"},{name:"costnotes"}];this.coststore=new Ext.data.GroupingStore({reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields}),listeners:{update:function(j,e,i){var g=e.data;if(g.status==2){CNOA.msg.alert("该费用已经通过审批,不能提交修改!",function(){d.store.reload()})}else{if(g.status==1){CNOA.msg.alert("该费用正在审批中,不能提交修改!",function(){d.store.reload()})}else{if(i==Ext.data.Record.EDIT){d.budgetSubmit(g)}}}}}});this.editor=new Ext.ux.grid.RowEditor({cancelText:lang("cancel"),saveText:lang("update"),errorSummary:false});this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.cm=[new Ext.grid.RowNumberer(),this.sm,{header:"",dataIndex:"bid",hidden:true},{id:"sid",header:"预算类型",dataIndex:"sid",width:200,sortable:true,editor:this.sortCombo,renderer:function(e){var g;d.sortStore.each(function(i){if(i.get("sid")==e){g=i;return}});return g==null?e:g.get("sname")}},{header:"费用名称",dataIndex:"title",width:100,sortable:true,editor:{xtype:"textfield",allowBlank:false}},{header:"计划金额(元)",dataIndex:"r_cost",width:120,sortable:true,editor:{xtype:"textfield",allowBlank:false,regex:/^([0-9]{1,}\.[0-9]{1,}|[0-9]{1,})$/i,regexText:"必须设置为纯数字或小数点数字"}},{header:"实际金额(元)",dataIndex:"t_cost",width:120,sortable:true,editor:{xtype:"textfield",regex:/^([0-9]{1,}\.[0-9]{1,}|[0-9]{1,})$/i,regexText:"必须设置为纯数字或小数点数字"}},{header:"审批状态",dataIndex:"",width:60,sortable:true,renderer:this.budgetStatus.createDelegate(this)},{header:"费用审批时间",dataIndex:"updatetime",width:100,sortable:true},{header:"费用说明",dataIndex:"costnotes",width:350,sortable:true,editor:{xtype:"textfield"}}];this.grid=new Ext.grid.GridPanel({stripeRows:true,store:this.coststore,width:600,plain:false,loadMask:{msg:lang("waiting")},region:"center",border:false,autoScroll:true,plugins:[this.editor],columns:this.cm,sm:this.sm,view:new Ext.grid.GroupingView({markDirty:false}),tbar:[{handler:function(e,g){d.coststore.reload()}.createDelegate(this),iconCls:"icon-system-refresh",text:lang("refresh")},{iconCls:"icon-utils-s-add",text:lang("add"),tooltip:"添加一个新的项目预算",handler:function(){var g=new d.dsc({name:""});d.editor.stopEditing();d.coststore.insert(0,g);d.grid.getView().refresh();d.grid.getSelectionModel().selectRow(0);d.editor.startEditing(0)}},{iconCls:"icon-utils-s-delete",text:lang("del"),tooltip:"删除记录(按住Ctrl或Shift键可以一次选择多条记录进行删除)，<br />如果想删除已审批和审批中的预算，可以在<项目费用审批>中删除，需要有项目费用审批的权限。",handler:function(e){d.editor.stopEditing();var g=d.grid.getSelectionModel().getSelections();if(g.length==0){CNOA.miniMsg.alertShowAt(e,lang("mustSelectOneRow"))}else{CNOA.msg.cf(lang("confirmToDelete"),function(k){if(k=="yes"){if(g){var l="";for(var j=0;j<g.length;j++){l+=g[j].get("bid")+",";var m=g[j];d.coststore.remove(m)}d.deleteData(l)}}})}}},{text:"提交审批",iconCls:"icon-tree-im-self",tooltip:"提交审批给费用审批人，提交审批后不能修改数据，<br />除非审批不通过，可一次选择多条数据进行审批",handler:function(e){d.editor.stopEditing();var g=d.grid.getSelectionModel().getSelections();if(g.length==0){CNOA.miniMsg.alertShowAt(e,lang("mustSelectOneRow"))}else{CNOA.msg.cf("确定要提交审批吗?",function(k){if(k=="yes"){if(g){var l="";for(var j=0;j<g.length;j++){l+=g[j].get("bid")+",";var m=g[j]}d.submitCheck(l)}}})}}},{handler:function(e,g){d.searchbar.type="wait";d.coststore.load({params:{type:"wait"}})}.createDelegate(this),iconCls:"icon-roduction2",enableToggle:true,pressed:true,allowDepress:false,toggleGroup:"project_proj_apply_check",tooltip:"显示未审核的费用",text:"未审核列表"},{handler:function(e,g){d.searchbar.type="passing";d.coststore.load({params:{type:"passing"}})}.createDelegate(this),iconCls:"icon-roduction2",enableToggle:true,allowDepress:false,toggleGroup:"project_proj_apply_check",tooltip:"显示审核中的费用",text:"审核中列表"},{handler:function(e,g){d.searchbar.type="pass";d.coststore.load({params:{type:"pass"}})}.createDelegate(this),enableToggle:true,allowDepress:false,toggleGroup:"project_proj_apply_check",iconCls:"icon-roduction2",tooltip:"显示已审核的费用",text:"已审核列表"},{handler:function(e,g){d.searchbar.type="unpass";d.coststore.load({params:{type:"unpass"}})}.createDelegate(this),enableToggle:true,allowDepress:false,toggleGroup:"project_proj_apply_check",iconCls:"icon-roduction2",tooltip:"显示审核不通过的费用",text:"审核不通过列表"},"<span class='cnoa_color_gray'>双击可修改记录,按住Ctrl或Shift键可以一次选择多条记录</span>","->",{xtype:"cnoa_helpBtn",helpid:2005}]});this.mainPanel=new Ext.Panel({title:"项目预算",collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.grid],listeners:{activate:function(){if(!d.sortStoreLd){d.sortStore.load();_sortStoreLd=true}if(!d.storeLd){d.coststore.proxy=new Ext.data.HttpProxy({url:d.baseUrl+"&task=budgetList&pid="+d.pid});d.coststore.load();d.storeLd=true}}},tbar:new Ext.Toolbar({style:"border-left-width:1px;",items:["费用类别:",{xtype:"panel",border:false,layout:"fit",items:[new Ext.form.ComboBox({name:"sid",store:d.sortStore,hiddenName:"sid",valueField:"sid",displayField:"sname",id:b,mode:"local",width:160,triggerAction:"all",forceSelection:true,editable:false,listeners:{select:function(i,e,g){}.createDelegate(this)}})]},"费用名称:",{xtype:"textfield",width:168,id:a},{xtype:"button",text:lang("search"),style:"margin-left:5px",handler:function(){d.searchbar.costtype=Ext.getCmp(b).getValue();d.searchbar.costtitle=Ext.getCmp(a).getValue();d.coststore.load({params:d.searchbar})}},{xtype:"button",text:lang("clear"),handler:function(){Ext.getCmp(b).setValue();Ext.getCmp(a).setValue();d.searchbar.costtype="";d.searchbar.costtitle="";d.coststore.load({params:d.searchbar})}}]})})},budgetSubmit:function(a){var b=this;Ext.Ajax.request({url:this.baseUrl+"&task=submitBudget&pid="+b.pid,params:a,method:"POST",success:function(e,d){var c=Ext.decode(e.responseText);if(c.success===true){b.coststore.reload()}else{CNOA.msg.alert(c.msg,function(){b.coststore.load({params:{applyId:b.pid}})})}},failure:function(c,d){CNOA.msg.alert(result.msg,function(){b.coststore.reload()})}})},deleteData:function(a){var b=this;Ext.Ajax.request({url:this.baseUrl+"&task=deletebudget",method:"POST",params:{ids:a},success:function(d){var c=Ext.decode(d.responseText);if(c.success===true){CNOA.msg.alert(c.msg,function(){b.coststore.reload()})}else{CNOA.msg.alert(c.msg)}}})},submitCheck:function(a){var b=this;Ext.Ajax.request({url:this.baseUrl+"&task=submitBudgetCheck&pid="+b.pid,params:{bid:a},method:"POST",success:function(e,d){var c=Ext.decode(e.responseText);if(c.success===true){CNOA.msg.alert(c.msg,function(){b.coststore.reload()})}else{CNOA.msg.alert(c.msg,function(){b.coststore.load({params:{applyId:CNOA.project.proj.applyproj.applyID}})})}},failure:function(c,d){CNOA.msg.alert(result.msg,function(){b.coststore.reload()})}})},budgetStatus:function(e,c,a,g,b,d){e=a.data.status;if(e==0){return"未提交"}else{if(e==1){return"<span class='cnoa_color_green'>审批中</span>"}else{if(e==2){return"<span class='cnoa_color_blue'>审批通过</span>"}else{if(e==3){return"<span class='cnoa_color_red'>审批不通过</span>"}}}}},setPid:function(a){var b=this;this.pid=a}};CNOA_project_proj_applyprojClass=CNOA.Class.create();CNOA_project_proj_applyprojClass.prototype={init:function(){var a=this;this.baseUrl="index.php?app=project&func=proj&action=main&module=myproj";CNOA_project_proj_applyprojbaseinfo=new CNOA_project_proj_applyprojbaseinfoClass();CNOA_project_proj_applyprojmember=new CNOA_project_proj_applyprojmemberClass();CNOA_project_proj_applyprojtask=new CNOA_project_proj_applyprojtaskClass();CNOA_project_proj_applyprojdocument=new CNOA_project_proj_applyprojdocumentClass();CNOA_project_proj_applyprojbudget=new CNOA_project_proj_applyprojbudgetClass();CNOA_project_proj_applyprojmember.mainPanel.disable();CNOA_project_proj_applyprojtask.mainPanel.disable();CNOA_project_proj_applyprojdocument.mainPanel.disable();CNOA_project_proj_applyprojbudget.mainPanel.disable();this.panelTab=new Ext.TabPanel({border:false,activeTab:0,region:"center",deferredRender:false,bodyStyle:"margin-bottom:100px;",items:[CNOA_project_proj_applyprojbaseinfo.mainPanel,CNOA_project_proj_applyprojmember.mainPanel,CNOA_project_proj_applyprojtask.mainPanel,CNOA_project_proj_applyprojdocument.mainPanel,CNOA_project_proj_applyprojbudget.mainPanel]});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,region:"center",border:false,layout:"border",autoScroll:false,items:[this.panelTab],tbar:[{text:"提交审批",tooltip:"提交审批后，该项目不可修改或者编辑，审批通过后，可以<br />进行项目变更操作，审批不通过，可进行该项目的修改和删除",iconCls:"icon-tree-im-self",style:"margin-left:5px",handler:function(){if(CNOA.project.proj.applyproj.applyID==0){CNOA.msg.alert("你还没有保存，不能提交审核！")}else{if(CNOA.project.proj.applyproj.applyType=="change"){a.change_reason()}else{a.submitcheck()}}}},"<span class='cnoa_color_gray'>注意:只有通过审批的项目才能执行。<span class='cnoa_color_red'>项目变更</span>需要重新审批，并且填写详细原因。</span>"]})},change_reason:function(){var b=this;var a=[{xtype:"fieldset",title:"项目变更详细原因(必填*)",defaults:{border:false},items:[{xtype:"panel",layout:"form",defaults:{style:{marginBottom:"10px"},border:false},items:[{xtype:"textarea",fieldLabel:"",allowBlank:false,name:"content",width:720,height:350}]}]}];this.formPanel=new Ext.form.FormPanel({hideBorders:true,border:false,waitMsgTarget:true,layout:"border",labelWidth:10,labelAlign:"right",items:[{xtype:"panel",border:false,bodyStyle:"padding:10px",layout:"form",region:"center",autoScroll:true,items:[a]}]});this.window=new Ext.Window({title:"项目变更原因",width:800,height:makeWindowHeight(530),modal:true,layout:"fit",resizable:false,border:false,items:[b.formPanel],buttons:[{text:"提交",handler:function(){b.exchengsubmit()}},{text:lang("cancel"),handler:function(){b.window.close()}}]}).show()},submitcheck:function(){var a=this;Ext.Ajax.request({url:this.baseUrl+"&task=submitcheck",params:{pid:CNOA.project.proj.applyproj.applyID},method:"POST",waitMsg:lang("waiting"),success:function(d,c){var b=Ext.decode(d.responseText);if(b.success===true){CNOA.msg.alert("提交审批成功,您可以在<审批中的项目>找到此项目！")}else{CNOA.msg.alert(b.msg)}},failure:function(b,c){CNOA.msg.alert(result.msg,function(){})}})},exchengsubmit:function(){var a=this;if(a.formPanel.getForm().isValid()){a.formPanel.getForm().submit({url:a.baseUrl+"&task=porjectexchenge",waitMsg:lang("waiting"),method:"POST",params:{pid:CNOA.project.proj.applyproj.applyID},success:function(b,c){CNOA.msg.alert(c.result.msg,function(){a.window.close()})}.createDelegate(this),failure:function(b,c){CNOA.msg.alert(c.result.msg)}.createDelegate(this)})}}};var sm_project_proj=1;