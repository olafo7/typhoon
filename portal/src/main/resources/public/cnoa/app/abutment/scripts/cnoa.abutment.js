var CNOA_abutment_abutment_database,CNOA_abutment_abutment_databaseClass;CNOA_abutment_abutment_databaseClass=new CNOA.Class.create();CNOA_abutment_abutment_databaseClass.prototype={init:function(){this.baseUrl="index.php?app=abutment&func=abutment&action=database";var a=this.getDatabaseGrid();this.mainPanel=new Ext.Panel({layout:"fit",border:false,items:[a]})},getDatabaseGrid:function(){var e=this;var b=[{name:"id"},{name:"name"},{name:"dbname"},{name:"host"},{name:"chart"},{name:"user"},{name:"dbType"}];var f=new Ext.grid.CheckboxSelectionModel({singleSelect:true});var a=new Ext.grid.ColumnModel({defaults:{align:"center",menuDisabled:true},columns:[new Ext.grid.RowNumberer(),f,{header:"id",dataIndex:"id",hidden:true},{header:"数据源名称",dataIndex:"name",width:150,align:"left"},{header:"数据库名称",dataIndex:"dbname",width:100},{header:"数据库HOST",dataIndex:"host",width:100},{header:"数据库类型",dataIndex:"dbType",width:100},{header:"字符集",dataIndex:"chart",width:100},{header:"用户",dataIndex:"user",width:50},{header:lang("opt"),dataIndex:"",width:100,renderer:e.makeOperate}]});e.abutmentStore=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:e.baseUrl+"&task=getDatabase",disableCaching:true}),reader:new Ext.data.JsonReader({root:"data",fields:b})});var d=new Ext.grid.GridPanel({region:"center",store:e.abutmentStore,cm:a,sm:f,tbar:new Ext.Toolbar({items:[{text:"增加数据源",cls:"btn-blue4",handler:function(){e.abutmentWin().show()}},{text:"增加本地数据源",cls:"btn-blue4",handler:function(){Ext.Ajax.request({url:e.baseUrl+"&task=createLocalDB",success:function(g){var h=Ext.decode(g.responseText);if(h.success){CNOA.msg.notice2(h.msg);e.abutmentStore.reload()}else{CNOA.msg.alert(h.msg)}}})}},{text:"刷新",handler:function(){e.abutmentStore.reload()}},"-",{text:lang("modify"),iconCls:"icon-utils-s-edit",handler:function(g){var h=d.getSelectionModel().getSelections();if(h.length==0){CNOA.miniMsg.alertShowAt(g,lang("mustSelectOneRow"))}else{if(h.length>1){CNOA.miniMsg.alertShowAt(g,lang("onlyOneItem"))}else{e.abutmentWin(h[0].json).show()}}}}]})});var c=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,region:"center",items:[d]});return c},makeOperate:function(c,b,a){var d=a.json.id;c="<a href='javascript:void(0);'  class='gridview4' onclick='CNOA_abutment_abutment_database.deleteAbutment("+d+");'>删除</a>";return c},abutmentWin:function(b){var d=this;if(b){var c=1}var e=function(){if(a.getForm().isValid()){a.getForm().submit({url:d.baseUrl+"&task=saveDatabase",method:"POST",waitMsg:lang("notice"),success:function(g,h){CNOA.msg.notice2(h.result.msg);d.abutmentStore.reload();f.close()},failure:function(g,h){CNOA.msg.alert(h.result.msg)}})}};var a=new Ext.form.FormPanel({labelAlign:"right",labelWidth:85,border:false,bodyBorder:false,bodyStyle:"padding-right: 10px;",items:[{xtype:"textfield",name:"id",hidden:true},{xtype:"textfield",fieldLabel:"数据源名称",allowBlank:false,width:160,name:"name"},{xtype:"textfield",fieldLabel:"数据库HOST",allowBlank:false,width:160,readOnly:c?true:false,cls:c?"x-item-disabled":"",value:"127.0.0.1",name:"host"},{xtype:"textfield",fieldLabel:"数据库名称",allowBlank:false,width:160,readOnly:c?true:false,cls:c?"x-item-disabled":"",name:"dbname"},{xtype:"combo",displayField:"name",valueField:"name",hiddenName:"dbType",triggerAction:"all",width:160,fieldLabel:"数据库类型",value:"MYSQL",editable:false,allowBlank:false,readOnly:c?true:false,cls:c?"x-item-disabled":"",mode:"local",store:new Ext.data.ArrayStore({fields:["name"],data:[["MYSQL"],["SQL SERVER"]]}),listeners:{select:function(g){if(g.value=="MYSQL"){a.getForm().findField("chart").setValue("UTF8")}else{a.getForm().findField("chart").setValue("GBK")}}}},{xtype:"combo",displayField:"name",valueField:"name",hiddenName:"chart",triggerAction:"all",fieldLabel:"数据库字符集",width:160,editable:false,allowBlank:false,value:"UTF8",mode:"local",store:new Ext.data.ArrayStore({fields:["name"],data:[["UTF8"],["GBK"]]})},{xtype:"textfield",fieldLabel:"数据库用户",width:160,allowBlank:false,name:"user"},{xtype:"textfield",fieldLabel:"数据库密码",width:160,inputType:"password",name:"password"}],keys:[{key:13,fn:function(){e()},scope:this}],listeners:{}});var f=new Ext.Window({width:500,bodyStyle:"padding: 10px;",title:"增加数据源",items:[a],buttons:[{text:"测试连接",handler:function(){if(a.getForm().isValid()){a.getForm().submit({url:d.baseUrl+"&task=testConnect",method:"POST",waitMsg:lang("notice"),success:function(g,h){CNOA.msg.alert(h.result.msg)},failure:function(g,h){CNOA.msg.alert(h.result.msg)}})}}},{text:"确定",handler:e},{text:"取消",handler:function(){f.close()}}]});if(b){a.getForm().setValues(b)}return f},deleteAbutment:function(b){var a=this;CNOA.msg.cf("确定删除？",function(c){if(c=="yes"){Ext.Ajax.request({url:a.baseUrl+"&task=deleteAbutment",params:{id:b},success:function(d){var e=Ext.decode(d.responseText);if(e.success){CNOA.msg.notice2(e.msg);a.abutmentStore.reload()}else{CNOA.msg.alert(e.msg)}}})}})}};var CNOA_abutment_abutment_flow,CNOA_abutment_abutment_flowClass;CNOA_abutment_abutment_flowClass=new CNOA.Class.create();CNOA_abutment_abutment_flowClass.prototype={init:function(){this.baseUrl="index.php?app=abutment&func=abutment&action=flow";var a=this.getDatabaseGrid();this.mainPanel=new Ext.Panel({layout:"fit",border:false,items:[a]})},getDatabaseGrid:function(){var e=this;var b=[{name:"id"},{name:"name"},{name:"flowName"},{name:"sheetName"}];var f=new Ext.grid.CheckboxSelectionModel({singleSelect:true});var a=new Ext.grid.ColumnModel({defaults:{menuDisabled:true},columns:[new Ext.grid.RowNumberer(),f,{header:"id",dataIndex:"id",hidden:true},{header:"名称",dataIndex:"name",width:300},{header:"流程名称",dataIndex:"flowName",width:300},{header:"数据表名称",dataIndex:"sheetName",width:300},{header:lang("opt"),dataIndex:"",width:150,align:"center",renderer:e.makeOperate}]});e.abutmentStore=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:e.baseUrl+"&task=getJsonData",disableCaching:true}),reader:new Ext.data.JsonReader({root:"data",fields:b})});var d=new Ext.grid.GridPanel({region:"center",store:e.abutmentStore,cm:a,sm:f,tbar:new Ext.Toolbar({items:[{text:"流程对接",cls:"btn-blue4",handler:function(){e.abutmentFlowWin().show()}},{text:"刷新",handler:function(){e.abutmentStore.reload()}},"-",{text:lang("modify"),iconCls:"icon-utils-s-edit",handler:function(g){var h=d.getSelectionModel().getSelections();if(h.length==0){CNOA.miniMsg.alertShowAt(g,lang("mustSelectOneRow"))}else{if(h.length>1){CNOA.miniMsg.alertShowAt(g,lang("onlyOneItem"))}else{e.abutmentFlowWin(h[0].json).show()}}}}]})});var c=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,region:"center",items:[d]});return c},makeOperate:function(c,b,a){var c="";c+=" <a href='javascript:void(0);'  class='gridview4' onclick='CNOA_abutment_abutment_flow.setOpen("+a.json.id+");'>"+(a.json.open==1?"禁用":"启用")+"</a>";c+=" <a href='javascript:void(0);'  class='gridview4' onclick='CNOA_abutment_abutment_flow.deleteFlow("+a.json.id+");'>删除</a>";return c},abutmentFlowWin:function(o){var q=this;if(o){var k=1}var h=function(){if(d.getForm().isValid()){d.getForm().submit({url:q.baseUrl+"&task=saveAbutment",method:"POST",waitMsg:lang("notice"),success:function(s,t){CNOA.msg.notice2(t.result.msg);q.abutmentStore.reload();b.close()},failure:function(s,t){CNOA.msg.alert(t.result.msg)}})}};var j=new Ext.data.ArrayStore({fields:["id","name"]});var i=new Ext.data.ArrayStore({fields:["id","name"]});var e=new Ext.data.ArrayStore({fields:["name","mapName"]});var r=function(s){$.ajax({type:"POST",url:"index.php?app=main&func=system&action=engine&task=getAbutmentFlowInfo",data:"flowId="+s,success:function(x){var x=$.parseJSON(x);var u=[],w=null,v=0,t;for(v=0,t=x.fields.length;v<t;++v){w=x.fields[v];u[v]=[w.id,w.name]}i.loadData(u)}})};var g=function(s){$.ajax({type:"POST",url:"index.php?app=main&func=system&action=engine&task=getAbutmentFlowDetailInfo",data:"detailId="+s,success:function(x){var x=$.parseJSON(x);var u=[],w=null,v=0,t;for(v=0,t=x.fields.length;v<t;++v){w=x.fields[v];u[v]=[w.id,w.name]}j.loadData(u)}})};var p=function(s){$.ajax({type:"POST",url:"index.php?app=abutment&func=abutment&action=sheet&task=getSheetFields",data:"id="+s,success:function(y){var y=$.parseJSON(y);var u=[],w=null,v=0,t;for(var x in y.fields){w=y.fields[x];u[v]=[w.name,w.mapName];v++}e.loadData(u)}})};var n=Ext.id();var l=Ext.id();var a=Ext.id();var c=Ext.id();var f=new Ext.data.Store({autoLoad:false,proxy:new Ext.data.HttpProxy({url:"index.php?app=main&func=system&action=engine&task=getAbutmentFlowDetail"}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:["id","name"]}),listeners:{load:function(){if(o){Ext.getCmp("detailId").setValue(o.detailId)}}}});var d=new Ext.form.FormPanel({labelAlign:"right",labelWidth:85,autoScroll:true,width:600,border:false,bodyBorder:false,bodyStyle:"padding-right: 10px;",items:[{xtype:"textfield",fieldLabel:"名称",name:"name",width:150,allowBlank:false},{xtype:"combo",displayField:"name",valueField:"id",hiddenName:"sheetId",id:"sheetId",triggerAction:"all",fieldLabel:"选择数据表",readOnly:k?true:false,cls:k?"x-item-disabled":"",editable:false,allowBlank:false,width:250,mode:"local",store:new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:"index.php?app=abutment&func=abutment&action=sheet&task=getDatasheet"}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:["id","name"]}),listeners:{load:function(){if(o){Ext.getCmp("sheetId").setValue(o.sheetId)}}}}),listeners:{select:function(s){p(s.value)}}},{xtype:"combo",displayField:"name",valueField:"flowId",hiddenName:"flowId",id:"flowId",triggerAction:"all",fieldLabel:"选择流程",editable:false,readOnly:k?true:false,cls:k?"x-item-disabled":"",allowBlank:false,width:250,mode:"local",store:new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:"index.php?app=main&func=system&action=engine&task=getAbutmentFlows"}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:["flowId","name"]}),listeners:{load:function(){if(o){Ext.getCmp("flowId").setValue(o.flowId);f.load({params:{flowId:o.flowId}})}}}}),listeners:{select:function(s){r(s.value);f.load({params:{flowId:s.value}})}}},{xtype:"combo",displayField:"name",valueField:"id",hiddenName:"detailId",id:"detailId",triggerAction:"all",fieldLabel:"选择明细表",editable:false,readOnly:k?true:false,cls:k?"x-item-disabled":"",width:250,mode:"local",store:f,listeners:{select:function(s){g(s.value)}}},{border:false,fieldLabel:"数据传送类型",layout:"table",items:[{xtype:"combo",displayField:"name",valueField:"name",hiddenName:"outType",triggerAction:"all",fieldLabel:"数据传送类型",editable:false,allowBlank:false,width:250,value:"INSERT",mode:"local",store:new Ext.data.ArrayStore({fields:["name"],data:[["INSERT"],["UPDATE"]]}),listeners:{select:function(s){if(s.value=="UPDATE"){Ext.getCmp("inWhereSql").show()}else{Ext.getCmp("inWhereSql").hide()}}}},{xtype:"displayfield",id:"inWhereSql",hidden:true,html:'<span style="color:red">　注：需要填写WHERE子句</span>'}]},{xtype:"compositefield",fieldLabel:lang("dataMapping"),items:[{xtype:"multiselect",id:n,height:150,width:120,valueField:"name",displayField:"mapName",mode:"local",typeAhead:true,triggerAction:"all",store:e,tbar:[{text:"数据表字段"}]},{xtype:"multiselect",id:l,height:150,width:120,valueField:"id",displayField:"name",mode:"local",typeAhead:true,triggerAction:"all",store:i,tbar:[{text:"流程表单字段"}],listeners:{click:function(s){Ext.getCmp(a).setValue("")}}},{xtype:"multiselect",id:a,height:150,width:120,valueField:"id",displayField:"name",mode:"local",typeAhead:true,triggerAction:"all",store:j,tbar:[{text:"流程明细表字段"}],listeners:{click:function(s){Ext.getCmp(l).setValue("")}}},{xtype:"button",text:lang("add"),style:{marginTop:"125px"},handler:function(){var v=Ext.getCmp(n).getRawValue();var t=Ext.getCmp(l).getRawValue();var y=Ext.getCmp(a).getRawValue();if(v.length==0||(t.length==0&&y.length==0)){CNOA.msg.alert(lang("noStepSelect"))}else{if(v.length>1||t.length>1||y.length>1){CNOA.msg.alert(lang("noStepMore"))}else{var s=$("#"+n+" dl.ux-mselect-selected").text();if(t.length!=0){var x=$("#"+l+" dl.ux-mselect-selected").text();var w=t}else{var x=$("#"+a+" dl.ux-mselect-selected").text();var w="detail_"+y}var u=m("fieldsAbutment[]",x+"=>"+s,w+"|"+v);$("#"+c).append(u)}}}}]},{xtype:"displayfield",fieldLabel:lang("stepMappingGX"),id:c,style:{marginBottom:"10px"}},{xtype:"textarea",width:360,fieldLabel:"WHERE子句",height:80,name:"whereSQL",id:"whereSQL"},{border:false,fieldLabel:"选择参数",layout:"table",items:[{xtype:"combo",valueField:"name",displayField:"mapName",triggerAction:"all",editable:false,width:250,mode:"local",store:e,listeners:{select:function(u){var w=$("input[name='fieldsAbutment[]']"),t=false;for(var s=0;s<w.length;s++){if(w[s].value.split("|")[1]==u.value){t=true;break}}if(t){var x=Ext.getCmp("whereSQL");var v=x.getValue()+"{"+u.value+"}";x.setValue(v)}else{CNOA.msg.alert("字段【"+u.lastSelectionText+"】没设置映射")}}}},{xtype:"button",text:"测试子句",style:"margin-left:20px;",handler:function(){var s=d.getForm(),t=s.findField("sheetId").getValue(),u=s.findField("whereSQL").getValue();if(t&&u){Ext.Ajax.request({url:q.baseUrl+"&task=testWhereSql",params:{sheetId:t,whereSQL:u},success:function(w){var v=Ext.decode(w.responseText);if(v.failure===true){CNOA.msg.alert(v.msg)}else{CNOA.msg.alert(v.msg)}}})}else{CNOA.msg.alert("没选择数据表或者没填写where子句")}}}]},{xtype:"displayfield",html:'<span style="color:red">注：审批下拉框应设置通过为同意，不通知则为不同意</span>'},{xtype:"hidden",name:"edit"}],keys:[{key:13,fn:function(){h()},scope:this}]});var m=function(t,v,u){var s=["<span>",v,'<a style="margin-left:5px;" onclick="$(this).parent().remove();">'+lang("del")+'</a><input type="hidden" name="',t,'" value="',u,'"/><br/></span>'];return s.join("")};var b=new Ext.Window({width:600,title:"流程对接",layout:"fit",items:[d],buttons:[{text:"确定",handler:h},{text:"取消",handler:function(){b.close()}}]});if(o){d.getForm().setValues({name:o.name,edit:o.id,outType:o.outType,whereSQL:o.whereSQL});r(o.flowId);p(o.sheetId);if(o.detailId){g(o.detailId)}$.ajax({type:"POST",url:q.baseUrl+"&task=getAbutmenData",data:"id="+o.id,success:function(v){var u=$.parseJSON(v).data;for(var t=0;t<u.length;t++){var s=m("fieldsAbutment[]",u[t].flowText+"=>"+u[t].sheetText,u[t].value);$("#"+c).append(s)}}})}return b},deleteFlow:function(b){var a=this;CNOA.msg.cf("确定删除？",function(c){if(c=="yes"){Ext.Ajax.request({url:a.baseUrl+"&task=deleteFlow",params:{id:b},success:function(d){var e=Ext.decode(d.responseText);if(e.success){CNOA.msg.notice2(e.msg);a.abutmentStore.reload()}else{CNOA.msg.alert(e.msg)}}})}})},setOpen:function(b){var a=this;Ext.Ajax.request({url:a.baseUrl+"&task=setOpen",params:{id:b},success:function(c){var d=Ext.decode(c.responseText);if(d.success){CNOA.msg.notice2(d.msg);a.abutmentStore.reload()}else{CNOA.msg.alert(d.msg)}}})}};var CNOA_abutment_abutment_sheet,CNOA_abutment_abutment_sheetClass;CNOA_abutment_abutment_sheetClass=new CNOA.Class.create();CNOA_abutment_abutment_sheetClass.prototype={init:function(){this.baseUrl="index.php?app=abutment&func=abutment&action=sheet";var a=this.getDatasheetGrid();this.mainPanel=new Ext.Panel({layout:"fit",border:false,items:[a]})},getDatasheetGrid:function(){var e=this;var b=[{name:"id"},{name:"name"},{name:"sid"},{name:"database"},{name:"sheet"}];var f=new Ext.grid.CheckboxSelectionModel({singleSelect:true});var a=new Ext.grid.ColumnModel({defaults:{align:"center",menuDisabled:true},columns:[new Ext.grid.RowNumberer(),f,{header:"id",dataIndex:"id",hidden:true},{header:"sid",dataIndex:"sid",hidden:true},{header:"名称",dataIndex:"name",width:200,align:"left",editor:new Ext.form.TextField({allowBlank:false})},{header:"数据源名称",dataIndex:"database",width:150,align:"left"},{header:"表名",dataIndex:"sheet",width:250},{header:lang("opt"),dataIndex:"",width:150,renderer:e.makeOperate}]});e.datasheetStore=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:e.baseUrl+"&task=getDatasheet",disableCaching:true}),reader:new Ext.data.JsonReader({root:"data",fields:b})});var d=new Ext.grid.EditorGridPanel({region:"center",store:e.datasheetStore,cm:a,sm:f,tbar:new Ext.Toolbar({items:[{text:"增加映射表",cls:"btn-blue4",handler:function(){e.datasheetWin().show()}},{text:"刷新",handler:function(){e.datasheetStore.reload()}}]}),listeners:{afteredit:function(i){var h=i.field,k=i.record.get("id"),g=i.value,j=i.row;e.updateSheetName(k,h,g)}}});var c=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,region:"center",items:[d]});return c},makeOperate:function(c,b,a){var c='<a href="javascript:void(0)" class="gridview jianju" onclick="CNOA_abutment_abutment_sheet.mapWin('+a.json.id+","+a.json.sid+",'"+a.json.sheet+"')\">设置映射</a>";c+="　<a href='javascript:void(0);'  class='gridview4' onclick='CNOA_abutment_abutment_sheet.deleteSheet("+a.json.id+");'>删除</a>";return c},mapWin:function(b,c,h){var i=this,d=b;var f=[{name:"id"},{name:"name"},{name:"mapName"}];var j=new Ext.grid.ColumnModel({defaults:{align:"center",menuDisabled:true},columns:[new Ext.grid.RowNumberer(),{header:"id",dataIndex:"id",hidden:true},{header:"字段名",dataIndex:"name",width:150,align:"left"},{header:"映射名",dataIndex:"mapName",width:150,editor:new Ext.form.TextField({allowBlank:false})}]});var e=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:i.baseUrl+"&task=getDbFieldsName",disableCaching:true}),reader:new Ext.data.JsonReader({root:"data",fields:f}),baseParams:{id:b,sid:c,sheet:h}});var a=new Ext.grid.EditorGridPanel({region:"center",store:e,border:false,cm:j,height:600,tbar:new Ext.Toolbar({items:[{text:"刷新",handler:function(){e.reload()}}]}),listeners:{afteredit:function(m){var l=m.field,o=m.record.get("id"),k=m.value,n=m.row;i.updateMapName(o,l,k,n,d)}}});var g=new Ext.Window({width:500,title:"设置字段映射",items:[a],buttons:[{text:"确定",handler:function(){g.close()}},{text:"取消",handler:function(){g.close()}}]}).show();return g},datasheetWin:function(){var c=this;var d=function(){if(a.getForm().isValid()){a.getForm().submit({url:c.baseUrl+"&task=saveDatasheet",method:"POST",waitMsg:lang("notice"),success:function(f,g){CNOA.msg.notice2(g.result.msg);c.datasheetStore.reload();e.close()},failure:function(f,g){CNOA.msg.alert(g.result.msg)}})}};var b=new Ext.data.Store({autoLoad:false,proxy:new Ext.data.HttpProxy({url:c.baseUrl+"&task=getDbTablesName"}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:["id","name"]})});var a=new Ext.form.FormPanel({labelAlign:"right",labelWidth:85,border:false,bodyBorder:false,bodyStyle:"padding-right: 10px;",items:[{fieldLabel:lang("name"),xtype:"textfield",name:"name",allowBlank:false,width:250},{xtype:"combo",id:"database",fieldLabel:"选择数据源",displayField:"name",valueField:"id",hiddenName:"id",editable:false,allowBlank:false,triggerAction:"all",mode:"local",width:250,store:new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:c.baseUrl+"&task=getDatabase"}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:["id","name"]})}),listeners:{select:function(f){Ext.getCmp("sheet").setValue("");b.reload({params:{id:f.value}})}}},{xtype:"combo",id:"sheet",fieldLabel:"选择数据表",displayField:"name",valueField:"name",editable:true,allowBlank:false,triggerAction:"all",mode:"local",width:250,store:b}],keys:[{key:13,fn:function(){d()},scope:this}],listeners:{}});var e=new Ext.Window({width:500,height:250,bodyStyle:"padding: 10px;",title:"数据表对接",items:[a],buttons:[{text:"确定",handler:d},{text:"取消",handler:function(){e.close()}}]});return e},updateMapName:function(f,c,b,e,d){var a=this;Ext.Ajax.request({url:a.baseUrl+"&task=updateMapName",params:{id:f,field:c,value:b,row:e,fid:d},success:function(h){var g=Ext.decode(h.responseText);if(g.failure===true){CNOA.msg.alert(g.msg)}else{CNOA.msg.notice2(g.msg)}}})},updateSheetName:function(f,c,b,e,d){var a=this;Ext.Ajax.request({url:a.baseUrl+"&task=updateSheetName",params:{id:f,field:c,value:b},success:function(h){var g=Ext.decode(h.responseText);if(g.failure===true){CNOA.msg.alert(g.msg)}else{CNOA.msg.notice2(g.msg)}}})},deleteSheet:function(b){var a=this;CNOA.msg.cf("确定删除？",function(c){if(c=="yes"){Ext.Ajax.request({url:a.baseUrl+"&task=deleteSheet",params:{id:b},success:function(d){var e=Ext.decode(d.responseText);if(e.success){CNOA.msg.notice2(e.msg);a.datasheetStore.reload()}else{CNOA.msg.alert(e.msg)}}})}})}};var CNOA_abutment_abutment_sqldetail,CNOA_abutment_abutment_sqldetailClass;CNOA_abutment_abutment_sqldetailClass=new CNOA.Class.create();CNOA_abutment_abutment_sqldetailClass.prototype={init:function(){this.baseUrl="index.php?app=abutment&func=abutment&action=sqldetail";var a=this.getSqldetailGrid();this.mainPanel=new Ext.Panel({layout:"fit",border:false,items:[a]})},getSqldetailGrid:function(){var e=this;var b=[{name:"id"},{name:"selectorSQL"},{name:"databaseId"},{name:"name"}];var f=new Ext.grid.CheckboxSelectionModel({singleSelect:true});var a=new Ext.grid.ColumnModel({defaults:{align:"center",menuDisabled:true},columns:[new Ext.grid.RowNumberer(),f,{header:"id",dataIndex:"id",hidden:true},{header:"明细表名称",dataIndex:"name",width:150,align:"left",editor:new Ext.form.TextField({allowBlank:false})},{header:lang("opt"),dataIndex:"",width:160,renderer:e.makeOperate}]});e.sqldetailStore=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:e.baseUrl+"&task=getSqldetail",disableCaching:true}),reader:new Ext.data.JsonReader({root:"data",fields:b}),listeners:{load:function(k){var j=k.reader.jsonData.data,g=[];for(var h=0;h<j.length;h++){g[j[h].id]=j[h]}e.storeArr=g}}});var d=new Ext.grid.EditorGridPanel({region:"center",store:e.sqldetailStore,cm:a,sm:f,tbar:new Ext.Toolbar({items:[{text:"增加SQL数据明细",cls:"btn-blue4",handler:function(){e.adddetail()}},{text:"刷新",handler:function(){e.sqldetailStore.reload()}}]}),listeners:{afteredit:function(i){var h=i.field,k=i.record.get("id"),g=i.value,j=i.row;e.updateDetailName(k,h,g)}}});var c=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,region:"center",items:[d]});return c},makeOperate:function(c,b,a){var d=a.json.id;c="<a href='javascript:void(0);'  class='gridview3' onclick='CNOA_abutment_abutment_sqldetail.setSqldetail("+d+");'>设置SQL数据明细</a>";c+=" <a href='javascript:void(0);'  class='gridview4' onclick='CNOA_abutment_abutment_sqldetail.deleteSqldetail("+d+");'>删除</a>";return c},adddetail:function(){var a=this;Ext.Ajax.request({url:a.baseUrl+"&task=adddetail",success:function(b){var c=Ext.decode(b.responseText);if(c.success){CNOA.msg.notice2(c.msg);a.sqldetailStore.reload()}else{CNOA.msg.alert(c.msg)}}})},updateDetailName:function(d,c,b){var a=this;Ext.Ajax.request({url:a.baseUrl+"&task=updateDetailName",params:{id:d,field:c,value:b},success:function(f){var e=Ext.decode(f.responseText);if(e.failure===true){CNOA.msg.alert(e.msg)}else{CNOA.msg.notice2(e.msg);a.sqldetailStore.reload()}}})},deleteSqldetail:function(b){var a=this;CNOA.msg.cf("删除前请确认流程中没使用到此明细表",function(c){if(c=="yes"){Ext.Ajax.request({url:a.baseUrl+"&task=deleteSqldetail",params:{id:b},success:function(d){var e=Ext.decode(d.responseText);if(e.success){CNOA.msg.notice2(e.msg);a.sqldetailStore.reload()}else{CNOA.msg.alert(e.msg)}}})}})},setSelector:function(b,a){var h=this;var d=[{name:"id"},{name:"name"}];var j=[{name:"id"},{name:"sid"},{name:"sheet"},{name:"name"}];var c=new Ext.data.Store({autoLoad:false,proxy:new Ext.data.HttpProxy({url:h.baseUrl+"&task=getSheet",disableCaching:true}),reader:new Ext.data.JsonReader({root:"data",fields:j})});var e=new Ext.data.Store({autoLoad:false,proxy:new Ext.data.HttpProxy({url:h.baseUrl+"&task=getSheetFields",disableCaching:true}),reader:new Ext.data.JsonReader({root:"data",fields:j})});var g=function(k){if(i.getForm().isValid()){i.getForm().submit({url:h.baseUrl+"&task=saveSelector1",method:"POST",waitMsg:lang("notice"),success:function(l,m){CNOA.msg.notice2(m.result.msg);f.close()},failure:function(l,m){CNOA.msg.alert(m.result.msg)}})}};var i=new Ext.form.FormPanel({labelAlign:"right",labelWidth:85,border:false,bodyBorder:false,bodyStyle:"padding-right: 10px;",items:[{xtype:"combo",displayField:"name",valueField:"id",hiddenName:"database",id:"database",triggerAction:"all",fieldLabel:"选择数据源",editable:false,allowBlank:false,width:250,mode:"local",store:new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:h.baseUrl+"&task=getDatabase"}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:["id","name"]}),listeners:{}}),listeners:{select:function(k){c.load({params:{id:k.value}})}}},{xtype:"combo",displayField:"name",valueField:"id",hiddenName:"sheet",id:"sheet",triggerAction:"all",fieldLabel:"选择数据表",editable:false,allowBlank:false,width:250,mode:"local",store:c,listeners:{select:function(k){var l=k.store.reader.jsonData.data[0];e.load({params:{id:l.id,sid:l.sid,sheet:l.sheet}})}}},{xtype:"combo",displayField:"name",valueField:"name",hiddenName:"selectorId",id:"selectorId",triggerAction:"all",fieldLabel:"选择ID",editable:false,allowBlank:false,width:250,mode:"local",store:e,listeners:{select:function(k){}}},{xtype:"combo",displayField:"name",valueField:"name",hiddenName:"selectorName",id:"selectorName",triggerAction:"all",fieldLabel:"选择名称",editable:false,allowBlank:false,width:250,mode:"local",store:e,listeners:{select:function(k){}}}]});var f=new Ext.Window({width:500,bodyStyle:"padding: 10px;",title:"添加选择器",items:[i],buttons:[{text:"确定",handler:g},{text:"取消",handler:function(){f.close()}}]}).show()},setSqldetail:function(b){var i=this;var h=function(){if(c.getForm().isValid()){var l=Ext.getCmp("selectorSQL").getValue();l=l.replace("from","fro^m");Ext.getCmp("selectorSQL").setValue(l);c.getForm().submit({url:i.baseUrl+"&task=saveSqldetail",params:{id:b},method:"POST",waitMsg:lang("notice"),success:function(m,n){CNOA.msg.notice2(n.result.msg);i.sqldetailStore.reload();f.close()},failure:function(m,n){CNOA.msg.alert(n.result.msg);l=l.replace("fro^m","from");Ext.getCmp("selectorSQL").setValue(l)}})}};var g=new Ext.data.ArrayStore({fields:["name"]});var k=new Ext.data.ArrayStore({fields:["name"]});var c=new Ext.form.FormPanel({labelAlign:"right",labelWidth:85,border:false,bodyBorder:false,bodyStyle:"padding-right: 10px;",items:[{xtype:"combo",id:"databaseId",fieldLabel:"选择数据源",displayField:"name",valueField:"id",hiddenName:"databaseId",editable:false,allowBlank:false,triggerAction:"all",mode:"local",width:260,store:new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:i.baseUrl+"&task=getDatabase"}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:["id","name"]}),listeners:{load:function(){if(i.storeArr[b].databaseId!=0){c.getForm().findField("databaseId").setValue(i.storeArr[b].databaseId)}if(i.storeArr[b].selectorSQL){c.getForm().findField("selectorSQL").setValue(i.storeArr[b].selectorSQL)}}}})},{xtype:"textarea",width:360,fieldLabel:"SQL语句",height:80,name:"selectorSQL",allowBlank:false,id:"selectorSQL"},{border:false,fieldLabel:"选择参数",layout:"table",items:[{xtype:"combo",displayField:"name",valueField:"param",triggerAction:"all",width:200,editable:false,mode:"local",store:new Ext.data.ArrayStore({fields:["param","name"],data:[["uid","当前用户ID"],["username","当前用户登录名"],["truename","当前用户姓名"],["deptId","当前用户部门ID"],["deptName","当前用户部门名"],["start","start"],["limit","limit"]]}),listeners:{select:function(m){var l=Ext.getCmp("selectorSQL");var n=l.getValue()+"{"+m.value+"}";l.setValue(n)}}},{xtype:"button",style:"margin-left:15px;",text:"获取字段",handler:function(){var m=Ext.getCmp("databaseId").getValue(),l=Ext.getCmp("selectorSQL").getValue();l=l.replace("from","fro^m");if(!m||!l){CNOA.msg.alert("数据源或者SQL不能为空")}else{d.load({params:{id:b,databaseId:m,selectorSQL:l,"new":1}})}}},{xtype:"button",style:"margin-left:15px;",text:"添加搜索",handler:function(){i.setSearchWin(b)}}]}],keys:[{key:13,fn:function(){h()},scope:this}]});var e=[{name:"name"},{name:"mapName"}];var j=new Ext.grid.ColumnModel({defaults:{align:"center",menuDisabled:true},columns:[new Ext.grid.RowNumberer(),{header:"字段名",dataIndex:"name",width:150,align:"left"},{header:"映射名",dataIndex:"mapName",width:150,editor:new Ext.form.TextField({allowBlank:true})}]});var d=new Ext.data.Store({autoLoad:false,proxy:new Ext.data.HttpProxy({url:i.baseUrl+"&task=getDbFieldName",disableCaching:true}),reader:new Ext.data.JsonReader({root:"data",fields:e})});var a=new Ext.grid.EditorGridPanel({region:"center",store:d,border:false,cm:j,height:600,listeners:{afteredit:function(n){var m=n.field,l=n.value,o=n.row;i.updateMapName(b,m,l,o)},afterrender:function(){if(i.storeArr[b].databaseId!=0&&i.storeArr[b].selectorSQL){d.load({params:{id:b,databaseId:i.storeArr[b].databaseId,selectorSQL:i.storeArr[b].selectorSQL.replace("from","fro^m")}})}}}});var f=new Ext.Window({width:500,bodyStyle:"padding: 10px;",title:"添加明细表",items:[c,a],buttons:[{text:"测试SQL",handler:function(){var m=Ext.getCmp("databaseId").getValue(),l=Ext.getCmp("selectorSQL").getValue();l=l.replace("from","fro^m");if(!m||!l){alert("数据源或者SQL不能为空")}else{Ext.Ajax.request({url:i.baseUrl+"&task=testSQL",params:{databaseId:m,selectorSQL:l,id:b},success:function(o){var n=Ext.decode(o.responseText);if(n.failure===true){CNOA.msg.alert(n.msg)}else{CNOA.msg.alert(n.msg)}}})}}},{text:"预览",handler:function(){var m=Ext.getCmp("databaseId").getValue(),l=Ext.getCmp("selectorSQL").getValue();l=l.replace("from","fro^m");l=l.replace(/\n/g,"%0a");if(!m||!l){alert("数据源或者SQL不能为空")}else{i.showDetailWin(b,m,l)}}},{text:"确定",handler:h},{text:"取消",handler:function(){f.close()}}]}).show();return f},updateMapName:function(e,c,b,d){var a=this;Ext.Ajax.request({url:a.baseUrl+"&task=updateMapName",params:{field:c,value:b,row:d,id:e},success:function(g){var f=Ext.decode(g.responseText);if(f.failure===true){CNOA.msg.alert(f.msg)}else{CNOA.msg.notice2(f.msg)}}})},showDetailWin:function(a,j,g){var k=this;var i=new Ext.grid.CustomGridPanel({border:false,pageSize:100,region:"center",customFiledUrl:k.baseUrl+"&task=getCustomerCustomField&id="+a,storeUrl:k.baseUrl+"&task=getCustomerList&id="+a+"&databaseId="+j+"&selectorSQL="+g,loadMask:{msg:lang("waiting")},listeners:{afterrender:function(h){setTimeout(function(){h.store.reload()},200)}}});var d=Ext.getBody().getBox(),l=d.width-20,e=d.height-20;var b=new Ext.form.FormPanel({border:false,height:150,hidden:true,region:"north",labelAlign:"right",padding:5,autoScroll:true,split:true,defaults:{xtype:"textfield"}});var c=new Ext.Toolbar({items:[{text:lang("expandSearch"),handler:function(h){if(b.isVisible()){b.hide()}else{h.setText(lang("foldSearch"));b.show()}f.doLayout()}},{text:lang("search"),handler:function(h){k.searchParams=b.getForm().getValues();i.store.reload({params:k.searchParams});i.store.searchStore=k.searchParams}},{text:lang("clear"),style:"margin-left:5px",handler:function(h){k.searchParams={};Ext.each(b.getForm().items.items,function(n,m){var o=n.getXType();if(o=="compositefield"||o=="checkboxgroup"){Ext.each(n.items.items,function(p){p.setValue("")})}else{n.setValue("")}});i.store.reload({params:k.searchParams});i.searchStore=k.searchParams}}]});Ext.Ajax.request({url:this.baseUrl+"&task=getCustomerSearchFields&id="+a,method:"POST",success:function(n){var o=Ext.decode(n.responseText),m;for(var h=0;h<o.msg.length;h++){m=new Ext.Panel({fieldLabel:o.msg[h].mapName,border:false,layout:"table",items:[{xtype:"textfield",name:"search|"+o.msg[h].id},{xtype:"radiogroup",style:"margin-left: 30px",width:250,items:[{boxLabel:"LIKE",name:"searchType|"+o.msg[h].id,inputValue:0,checked:true},{boxLabel:"=",name:"searchType|"+o.msg[h].id,inputValue:1},{boxLabel:">",name:"searchType|"+o.msg[h].id,inputValue:2},{boxLabel:"<",name:"searchType|"+o.msg[h].id,inputValue:3}]}]});b.add(m)}b.doLayout()}});var f=new Ext.Window({title:"添加选择器",layout:"border",height:e,width:l,items:[b,i],tbar:c}).show();return f},setSearchWin:function(g){var e=this;var b=[{name:"id"},{name:"name"}];var a=new Ext.grid.ColumnModel({defaults:{align:"center",menuDisabled:true},columns:[{header:"id",dataIndex:"id",hidden:false,width:30},{header:lang("name"),dataIndex:"name",width:180,align:"left",editor:new Ext.form.TextField({allowBlank:false})},{header:lang("opt"),dataIndex:"",width:120,renderer:function(j,i,h){var k=h.json.id;j="<a href='javascript:void(0);'  class='gridview3' onclick='CNOA_abutment_abutment_sqldetail.setSearchFields("+k+");'>设置</a>";j+=" <a href='javascript:void(0);'  class='gridview4' onclick='CNOA_abutment_abutment_sqldetail.addSearch("+k+");'>添加</a>";return j}}]});var c=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:e.baseUrl+"&task=getSearchList&id="+g,disableCaching:true}),reader:new Ext.data.JsonReader({root:"data",fields:b})});var d=new Ext.grid.EditorGridPanel({region:"center",store:c,cm:a,tbar:new Ext.Toolbar({items:[{text:"增加搜索",cls:"btn-blue4",handler:function(){Ext.Ajax.request({url:e.baseUrl+"&task=addSearch",params:{id:g},success:function(h){var i=Ext.decode(h.responseText);if(i.success){CNOA.msg.notice2(i.msg);c.reload()}else{CNOA.msg.alert(i.msg)}}})}},{text:"刷新",handler:function(){c.reload()}}]}),listeners:{afteredit:function(j){var i=j.field,l=j.record.get("id"),h=j.value,k=j.row;Ext.Ajax.request({url:e.baseUrl+"&task=updateSearchName",params:{id:l,field:i,value:h},success:function(n){var m=Ext.decode(n.responseText);if(m.failure===true){CNOA.msg.alert(m.msg)}else{CNOA.msg.notice2(m.msg);c.reload()}}})}}});var f=new Ext.Window({title:"添加搜索",items:[d],height:300,layout:"fit",modal:true,border:false}).show()},addSearch:function(c){var a=Ext.getCmp("selectorSQL");var b=a.getValue()+"{search"+c+"}";a.setValue(b)},setSearchFields:function(g){var e=this;var b=[{name:"id"},{name:"name"},{name:"mapName"}];var a=new Ext.grid.ColumnModel({defaults:{align:"center",menuDisabled:true},columns:[{header:"id",dataIndex:"id",hidden:true},{header:"字段",dataIndex:"name",width:180,align:"left",editor:new Ext.form.TextField({allowBlank:false})},{header:"映射名",dataIndex:"mapName",width:180,align:"left",editor:new Ext.form.TextField({allowBlank:false})},{header:lang("opt"),dataIndex:"",width:50,renderer:function(j,i,h){var k=h.json.id;j="<a href='javascript:void(0);'  class='gridview4' onclick='CNOA_abutment_abutment_sqldetail.delSearchFields("+k+");'>删除</a>";return j}}]});var c=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:e.baseUrl+"&task=getSearchField&id="+g,disableCaching:true}),reader:new Ext.data.JsonReader({root:"data",fields:b})});e.searchFiledsStore=c;var d=new Ext.grid.EditorGridPanel({region:"center",store:c,cm:a,tbar:new Ext.Toolbar({items:[{text:"增加搜索字段",cls:"btn-blue4",handler:function(){Ext.Ajax.request({url:e.baseUrl+"&task=addSearchField",params:{id:g},success:function(h){var i=Ext.decode(h.responseText);if(i.success){CNOA.msg.notice2(i.msg);c.reload()}else{CNOA.msg.alert(i.msg)}}})}},{text:"刷新",handler:function(){c.reload()}}]}),listeners:{afteredit:function(j){var i=j.field,l=j.record.get("id"),h=j.value,k=j.row;Ext.Ajax.request({url:e.baseUrl+"&task=updateSearchFieldName",params:{id:l,field:i,value:h},success:function(n){var m=Ext.decode(n.responseText);if(m.failure===true){CNOA.msg.alert(m.msg)}else{CNOA.msg.notice2(m.msg);c.reload()}}})}}});var f=new Ext.Window({title:"设置搜索字段",items:[d],height:300,layout:"fit",modal:true,border:false}).show()},delSearchFields:function(b){var a=this;Ext.Ajax.request({url:a.baseUrl+"&task=delSearchFields",params:{id:b},success:function(d){var c=Ext.decode(d.responseText);if(c.failure===true){CNOA.msg.alert(c.msg)}else{CNOA.msg.notice2(c.msg);a.searchFiledsStore.reload()}}})}};var CNOA_abutment_abutment_sqlselector,CNOA_abutment_abutment_sqlselectorClass;CNOA_abutment_abutment_sqlselectorClass=new CNOA.Class.create();CNOA_abutment_abutment_sqlselectorClass.prototype={init:function(){this.baseUrl="index.php?app=abutment&func=abutment&action=sqlselector";var a=this.getSqlselectorGrid();this.mainPanel=new Ext.Panel({layout:"fit",border:false,items:[a]})},getSqlselectorGrid:function(){var e=this;var b=[{name:"id"},{name:"selectorName"},{name:"selectorStyle"},{name:"selectorType"},{name:"selectorTypeName"},{name:"selectorStyleName"},{name:"databaseId"},{name:"databaseName"},{name:"selectorSQL"},{name:"display"},{name:"value"}];var f=new Ext.grid.CheckboxSelectionModel({singleSelect:true});var a=new Ext.grid.ColumnModel({defaults:{align:"center",menuDisabled:true},columns:[new Ext.grid.RowNumberer(),f,{header:"id",dataIndex:"id",hidden:true},{header:"选择器名称",dataIndex:"selectorName",width:150,align:"left"},{header:"显示样式",dataIndex:"selectorStyleName",width:80,align:"left"},{header:"选择器类型",dataIndex:"selectorTypeName",width:100,align:"left"},{header:"数据源",dataIndex:"databaseName",width:100,align:"left"},{header:"SQL语句",dataIndex:"selectorSQL",width:200,align:"left"},{header:"显示值",dataIndex:"display",width:80,align:"left"},{header:"实际值",dataIndex:"value",width:80,align:"left"},{header:lang("opt"),dataIndex:"",width:160,renderer:e.makeOperate}]});e.sqlselectorStore=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:e.baseUrl+"&task=getSqlselector",disableCaching:true}),reader:new Ext.data.JsonReader({root:"data",fields:b})});var d=new Ext.grid.GridPanel({region:"center",store:e.sqlselectorStore,cm:a,sm:f,tbar:new Ext.Toolbar({items:[{text:"增加选择器",cls:"btn-blue4",handler:function(){e.selectorWin().show()}},{text:"刷新",handler:function(){e.sqlselectorStore.reload()}},"-",{text:lang("modify"),iconCls:"icon-utils-s-edit",handler:function(g){var h=d.getSelectionModel().getSelections();if(h.length==0){CNOA.miniMsg.alertShowAt(g,lang("mustSelectOneRow"))}else{if(h.length>1){CNOA.miniMsg.alertShowAt(g,lang("onlyOneItem"))}else{e.selectorWin(h[0].json).show()}}}}]})});var c=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,region:"center",items:[d]});return c},makeOperate:function(d,b,a){var e=a.json.id,c=a.json.style;d="<a href='javascript:void(0);'  class='gridview4' onclick='CNOA_abutment_abutment_sqlselector.deleteSqlselector("+e+");'>删除</a>";return d},selectorWin:function(l){var h=this;if(l){var j=1}var g=function(){var p="";var i=Ext.getCmp("normalPanel").getStore();Ext.each(i.data.items,function(q){if(q.data.display!==""){p+=q.data.value+"|"+q.data.display+","}});if(a.getForm().isValid()){var o=Ext.getCmp("selectorSQL").getValue();o=o.replace("from","fro^m");Ext.getCmp("selectorSQL").setValue(o);a.getForm().submit({url:h.baseUrl+"&task=saveSqlselector",params:{items:p},method:"POST",waitMsg:lang("notice"),success:function(q,r){CNOA.msg.notice2(r.result.msg);h.sqlselectorStore.reload();d.close()},failure:function(q,r){CNOA.msg.alert(r.result.msg);o=o.replace("fro^m","from");Ext.getCmp("selectorSQL").setValue(o)}})}};var f=new Ext.data.ArrayStore({fields:["name"]});var n=new Ext.data.ArrayStore({fields:["name"]});var m=new Ext.data.ArrayStore({fields:["value","display"]});var a=new Ext.form.FormPanel({labelAlign:"right",labelWidth:85,border:false,bodyBorder:false,bodyStyle:"padding-right: 10px;",items:[{xtype:"textfield",name:"id",hidden:true},{fieldLabel:"选择器类型",xtype:"radiogroup",id:"selectorType",width:180,items:[{boxLabel:"SQL选择器",name:"selectorType",inputValue:0,checked:true},{boxLabel:"普通选择器",name:"selectorType",inputValue:1}],listeners:{change:function(i){if(i.getValue()==1){Ext.getCmp("SQLPanel").hide();Ext.getCmp("normalPanel").show()}else{Ext.getCmp("SQLPanel").show();Ext.getCmp("normalPanel").hide()}}}},{xtype:"textfield",fieldLabel:"选择器名称",allowBlank:false,width:260,name:"selectorName",id:"selectorName"},{xtype:"combo",displayField:"name",valueField:"id",hiddenName:"selectorStyle",id:"selectorStyle",triggerAction:"all",width:260,fieldLabel:"显示样式",editable:false,allowBlank:false,mode:"local",value:1,store:new Ext.data.ArrayStore({fields:["id","name"],data:[["1","下拉"],["2","标签"]]})},{xtype:"panel",layout:"form",border:false,height:170,id:"SQLPanel",items:[{xtype:"combo",id:"databaseId",fieldLabel:"选择数据源",displayField:"name",valueField:"id",hiddenName:"databaseId",editable:false,triggerAction:"all",mode:"local",width:260,store:new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:h.baseUrl+"&task=getDatabase"}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:["id","name"]}),listeners:{load:function(i){if(l){Ext.getCmp("databaseId").setValue(l.databaseId)}}}})},{xtype:"textarea",width:360,fieldLabel:"SQL语句",height:80,name:"selectorSQL",id:"selectorSQL"},{xtype:"combo",displayField:"name",valueField:"param",triggerAction:"all",width:260,fieldLabel:"选择参数",editable:false,mode:"local",store:new Ext.data.ArrayStore({fields:["param","name"],data:[["uid","当前用户ID"],["username","当前用户登录名"],["truename","当前用户姓名"],["deptId","当前用户部门ID"],["deptName","当前用户部门名"]]}),listeners:{select:function(o){var i=Ext.getCmp("selectorSQL");var p=i.getValue()+"{"+o.value+"}";i.setValue(p)}}},{border:false,fieldLabel:"默认值",layout:"table",layoutConfig:{columns:3},items:[{xtype:"combo",displayField:"name",valueField:"name",triggerAction:"all",hiddenName:"display",id:"display",width:125,editable:false,mode:"local",store:f},{xtype:"combo",displayField:"name",valueField:"name",triggerAction:"all",hiddenName:"value",id:"value",width:125,editable:false,style:"margin-left:10px;",mode:"local",store:n},{xtype:"button",style:"margin-left:20px;",text:"获取字段",handler:function(){var o=Ext.getCmp("databaseId").getValue(),i=Ext.getCmp("selectorSQL").getValue();i=i.replace("from","fro^m");if(!o||!i){CNOA.msg.alert("数据源或者SQL不能为空")}else{Ext.Ajax.request({url:h.baseUrl+"&task=getDbFieldName",params:{databaseId:o,selectorSQL:i},success:function(r){var q=Ext.decode(r.responseText);if(q.failure===true){CNOA.msg.alert(q.msg)}else{var p=[["请选择显示值"]];var t=[["请选择实际值"]];for(var s=0;s<q.length;s++){p.push([q[s]]);t.push([q[s]])}f.loadData(p);n.loadData(t);Ext.getCmp("display").setValue("请选择显示值");Ext.getCmp("value").setValue("请选择实际值")}}})}}}]}]},{xtype:"editorgrid",id:"normalPanel",height:165,hidden:true,fieldLabel:"相关选项",tbar:new Ext.Toolbar({items:[{text:"增加项",handler:function(){var i=Ext.getCmp("normalPanel").getStore().recordType;var o=new i({display:"双击修改",value:"双击修改"});var q=m.getCount();Ext.getCmp("normalPanel").stopEditing();m.insert(q,o);Ext.getCmp("normalPanel").startEditing(q,0)}}]}),cm:new Ext.grid.ColumnModel({columns:[{header:"显示值",dataIndex:"display",width:100,editor:{xtype:"textfield"}},{header:"实际值",dataIndex:"value",width:100,editor:{xtype:"textfield"}}]}),store:m}],keys:[{key:13,fn:function(){g()},scope:this}]});var d=new Ext.Window({width:500,bodyStyle:"padding: 10px;",title:"添加选择器",items:[a],buttons:[{text:"测试SQL",handler:function(){var o=Ext.getCmp("databaseId").getValue(),i=Ext.getCmp("selectorSQL").getValue();i=i.replace("from","fro^m");if(!o||!i){alert("数据源或者SQL不能为空")}else{Ext.Ajax.request({url:h.baseUrl+"&task=testSQL",params:{databaseId:o,selectorSQL:i},success:function(q){var p=Ext.decode(q.responseText);if(p.failure===true){CNOA.msg.alert(p.msg)}else{CNOA.msg.alert(p.msg)}}})}}},{text:"确定",handler:g},{text:"取消",handler:function(){d.close()}}]}).show();if(l){if(l.selectorType==0){a.getForm().setValues({id:l.id,databaseId:l.databaseId,display:l.display,selectorSQL:l.selectorSQL,selectorStyle:l.selectorStyle,value:l.value,selectorName:l.selectorName})}else{var e=l.items.split(","),c=[],k;for(var b=0;b<e.length;b++){k=e[b].split("|");c.push(k)}m.loadData(c);a.getForm().setValues({id:l.id,selectorStyle:l.selectorStyle,selectorName:l.selectorName})}Ext.getCmp("selectorType").setValue(l.selectorType)}return d},deleteSqlselector:function(b){var a=this;CNOA.msg.cf("删除前请确认流程中没使用到此选择器",function(c){if(c=="yes"){Ext.Ajax.request({url:a.baseUrl+"&task=deleteSqlselector",params:{id:b},success:function(d){var e=Ext.decode(d.responseText);if(e.success){CNOA.msg.notice2(e.msg);a.sqlselectorStore.reload()}else{CNOA.msg.alert(e.msg)}}})}})}};var sm_abutment_abutment=1;