CNOA_flow_flow_fmanger_mgrClass=CNOA.Class.create();CNOA_flow_flow_fmanger_mgrClass.prototype={init:function(){var a=this;this.edit_id=0;this.sort=0;this.baseUrl="index.php?app=flow&func=flow&action=user";this.baseUrl="index.php?app=flow&func=flow&action=fmanger";this.ID_btn_edit=Ext.id();this.ID_btn_delete=Ext.id();this.ID_tree_treeRoot=Ext.id();this.ID_find_name=Ext.id();this.ID_find_title=Ext.id();this.ID_find_beginTime=Ext.id();this.ID_find_endTime=Ext.id();this.ID_find_status=Ext.id();this.ID_find_buildUser=Ext.id();this.ID_find_getUser=Ext.id();this.searchParams={name:"",title:"",document:"",beginTime:"",endTime:"",status:0,buildUser:""};this.fields=[{name:"lid"},{name:"ulid"},{name:"uname"},{name:"name"},{name:"flowname"},{name:"title"},{name:"level"},{name:"step"},{name:"despanseStatus"},{name:"posttime"},{name:"status"}];this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getAllFlowJsonData",disableCaching:true}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields}),listeners:{load:function(d,b,c){if(d.reader.jsonData.hasDel==true){Ext.getCmp(a.ID_btn_delete).show()}else{Ext.getCmp(a.ID_btn_delete).hide()}}}});this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.store.load();this.colModel=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),this.sm,{header:"ulid",dataIndex:"ulid",hidden:true},{header:"流程编号",dataIndex:"name",width:180,sortable:true,menuDisabled:true},{header:"发起人",dataIndex:"uname",width:100,sortable:true,menuDisabled:true},{header:"所属流程",dataIndex:"flowname",width:120,sortable:true,menuDisabled:true},{header:lang("title"),dataIndex:"title",width:120,sortable:true,menuDisabled:true},{header:"重要等级",dataIndex:"level",width:60,sortable:false,menuDisabled:true},{header:"当前步骤",dataIndex:"step",width:70,sortable:false,menuDisabled:true},{header:"状态",dataIndex:"status",width:50,sortable:false,menuDisabled:true,renderer:this.makeStatus.createDelegate(this)},{header:"分发状态",dataIndex:"despanseStatus",width:70,sortable:false,menuDisabled:true},{header:"发起日期",dataIndex:"posttime",width:110,sortable:false,menuDisabled:true},{header:lang("opt"),dataIndex:"ulid",width:80,sortable:false,menuDisabled:true,renderer:this.makeOperate.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.pagingBar=new Ext.PagingToolbar({displayInfo:true,store:this.store,style:"border-left-width:1px;",pageSize:15,listeners:{beforechange:function(b,c){c.sort=a.sort;if(a.searchParams.name!=""){c.name=a.searchParams.name}if(a.searchParams.title!=""){c.title=a.searchParams.title}if(a.searchParams.beginTime!=""){c.beginTime=a.searchParams.beginTime}if(a.searchParams.endTime!=""){c.endTime=a.searchParams.endTime}if(a.searchParams.status!=0){c.status=a.searchParams.status}if(a.searchParams.buildUser!=""){c.buildUser=a.searchParams.buildUser}}}});this.grid=new Ext.grid.GridPanel({stripeRows:true,store:this.store,bodyStyle:"border-left-width:1px;",loadMask:{msg:lang("waiting")},cm:this.colModel,sm:this.sm,hideBorders:true,border:false,region:"center",viewConfig:{},listeners:{rowdblclick:function(b,c){},rowclick:function(b,f,c,d){}},tbar:new Ext.Toolbar({style:"border-left-width:1px;",items:[{iconCls:"icon-system-refresh",text:lang("refresh"),handler:function(b,c){a.store.reload()}.createDelegate(this)},{handler:function(b,c){a.openExportExcelWindow()}.createDelegate(this),iconCls:"icon-excel",tooltip:"导出流程列表为Excel文件",text:"导出"},{iconCls:"icon-utils-s-delete",text:lang("del"),hidden:true,id:a.ID_btn_delete,handler:function(b,c){var d=a.grid.getSelectionModel().getSelections();if(d.length==0){CNOA.miniMsg.alertShowAt(b,"您还没有选择需要删除的信息")}else{CNOA.msg.cf("确定要删除吗",function(f){if(f=="yes"){if(d){var h="";for(var e=0;e<d.length;e++){h+=d[e].get("ulid")+",";var g=d[e]}a.deleteFlow(h)}}})}}.createDelegate(this)},"->",{xtype:"cnoa_helpBtn",helpid:11}]}),bbar:this.pagingBar});this.treeRoot=new Ext.tree.AsyncTreeNode({text:"所有分类",sid:"0",iconCls:"icon-tree-root-cnoa",id:this.ID_tree_treeRoot,expanded:true});this.treeLoader=new Ext.tree.TreeLoader({dataUrl:this.baseUrl+"&task=getSortList&type=tree",preloadChildren:true,clearOnLoad:false,listeners:{load:function(b){a.sortTree.selectPath(a.ID_tree_treeRoot)}.createDelegate(this)}});this.sortTree=new Ext.tree.TreePanel({hideBorders:true,border:false,rootVisible:true,lines:true,animCollapse:false,animate:false,loader:this.treeLoader,root:this.treeRoot,autoScroll:true,listeners:{click:function(b){a.sort=b.attributes.sid;a.store.load({params:{sort:a.sort}})}}});this.sortPanel=new Ext.Panel({region:"west",layout:"fit",split:true,width:120,minWidth:80,maxWidth:380,bodyStyle:"border-right-width:1px;",items:[this.sortTree],tbar:new Ext.Toolbar({style:"border-right-width:1px;",items:["流程分类","->",{handler:function(b,c){a.treeRoot.reload()}.createDelegate(this),iconCls:"icon-system-refresh",tooltip:lang("refresh"),text:lang("refresh")}]})});this.gridCt=new Ext.Panel({border:false,layout:"fit",items:[this.grid],region:"center",listeners:{afterrender:function(){new Ext.Toolbar({style:"border-left-width:1px;",items:["发起开始时间：",{xtype:"datefield",width:130,format:"Y-m-d",editable:false,allowBlank:true,id:a.ID_find_beginTime}," 发起最后时间：",{xtype:"datefield",width:130,format:"Y-m-d",editable:false,allowBlank:true,id:a.ID_find_endTime},{xtype:"hidden",id:a.ID_find_buildUser},"发起人",{xtype:"triggerForPeople",dataUrl:a.baseUrl+"&task=getAllUserListsInPermitDeptTree",width:130,id:a.ID_find_getUser,listeners:{selected:function(d,c,b){Ext.getCmp(a.ID_find_buildUser).setValue(c)}}},{text:lang("search"),handler:function(){a.searchParams={name:Ext.getCmp(a.ID_find_name).getValue(),title:Ext.getCmp(a.ID_find_title).getValue(),beginTime:Ext.getCmp(a.ID_find_beginTime).getRawValue(),endTime:Ext.getCmp(a.ID_find_endTime).getRawValue(),status:Ext.getCmp(a.ID_find_status).getValue(),buildUser:Ext.getCmp(a.ID_find_buildUser).getValue()};a.store.load({params:a.searchParams})}},{text:lang("clear"),handler:function(){Ext.getCmp(a.ID_find_name).setValue("");Ext.getCmp(a.ID_find_title).setValue("");Ext.getCmp(a.ID_find_beginTime).setRawValue("");Ext.getCmp(a.ID_find_endTime).setRawValue("");Ext.getCmp(a.ID_find_status).setValue(-99);Ext.getCmp(a.ID_find_buildUser).setValue("");Ext.getCmp(a.ID_find_getUser).setValue("");a.searchParams={name:"",title:"",document:"",beginTime:"",endTime:"",status:0,buildUser:""};a.store.load()}}]}).render(this.tbar)}},tbar:new Ext.Toolbar({style:"border-left-width:1px;",items:["标题：",{xtype:"textfield",width:200,id:a.ID_find_title}," 编号名称",{xtype:"textfield",width:150,id:a.ID_find_name},"当前状态：",{xtype:"combo",id:a.ID_find_status,editable:false,width:100,mode:"local",triggerAction:"all",valueField:"value",displayField:"display",store:new Ext.data.ArrayStore({fields:["value","display"],data:[[-99,""],[-1,"已删除"],[0,"未发布"],[1,"办理中"],[2,"已办理"],[3,"已退件"],[4,"已撤销"]]}),value:-99}]})});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.gridCt,this.sortPanel]})},openExportExcelWindow:function(){var e=this;var c=function(){if(a.getForm().isValid()){a.getForm().submit({url:e.baseUrl+"&task=exportExcel",waitMsg:lang("waiting"),params:{},method:"POST",success:function(f,g){d.close();e.openDownloadExcelWindow(g.result.msg)},failure:function(f,g){CNOA.msg.alert(g.result.msg,function(){})}})}};var b=Ext.id();var a=new Ext.form.FormPanel({border:false,bodyStyle:"padding:10px;",waitMsgTarget:true,labelWidth:110,items:[{xtype:"hidden",name:"uid",id:b},{xtype:"triggerForPeople",fieldLabel:"发起人",dataUrl:e.baseUrl+"&task=getAllUserListsInPermitDeptTree",width:100,allowBlank:false,listeners:{selected:function(h,g,f){Ext.getCmp(b).setValue(g)}}},{xtype:"datefield",fieldLabel:"流程发起开始时间",width:170,format:"Y-m-d",editable:false,allowBlank:false,name:"stime"},{xtype:"datefield",fieldLabel:"流程发起最后时间",width:170,format:"Y-m-d",editable:false,allowBlank:false,name:"etime"}]});var d=new Ext.Window({width:320,height:170,title:"导出工作流程",resizable:false,modal:true,layout:"fit",items:a,buttons:[{text:"导出",iconCls:"icon-excel",handler:function(){c()}.createDelegate(this)},{text:lang("cancel"),iconCls:"icon-dialog-cancel",handler:function(){d.close()}.createDelegate(this)}]}).show()},openDownloadExcelWindow:function(a){var b=new Ext.Window({width:320,height:150,title:"下载EXCEL表格",resizable:false,modal:true,layout:"fit",bodyStyle:"padding:10px;background-color: #FFF;",html:"请点击下载：<br/>"+a,buttons:[{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){b.close()}.createDelegate(this)}]}).show()},makeStatus:function(a){var b="";if(a==0){b="<span class='cnoa_color_gray'>未发送</span>"}else{if(a==1){b="<span class='cnoa_color_orange'>办理中</span>"}else{if(a==2){b="<span class='cnoa_color_green'>已办理</span>"}else{if(a==3){b="<span class='cnoa_color_red'>已退件</span> "}else{if(a==4){b="<span class='cnoa_color_gray'>已撤销</span>"}}}}}return b},makeOperate:function(i,f,d,g,e,a){var j=d.data;var b=j.status;var c="<a href='javascript:void(0);' onclick='CNOA_flow_flow_fmanger_mgr.showFlow("+i+");'>查看</a>";return c},deleteFlow:function(a){var b=this;Ext.Ajax.request({url:b.baseUrl+"&task=deleteflow",method:"POST",params:{ulids:a},success:function(d){var c=Ext.decode(d.responseText);if(c.success===true){CNOA.msg.notice(c.msg,"工作流管理");b.store.reload()}else{CNOA.msg.alert(c.msg)}}})},showFlow:function(a){mainPanel.closeTab("CNOA_MENU_FLOW_USER_VIEWFLOW");mainPanel.loadClass("index.php?app=flow&func=flow&action=user&task=loadPage&from=showflow&ulid="+a,"CNOA_MENU_FLOW_USER_SHOWFLOW","查看工作流程","icon-flow")}};var CNOA_flow_flow_settingflowClass,CNOA_flow_flow_settingflow;var CNOA_flow_flow_settingflow_addeditClass,CNOA_flow_flow_settingflow_addedit;var CNOA_flow_flow_settingflow_designClass,CNOA_flow_flow_settingflow_design;var CNOA_flow_flow_settingflow_mgrClass,CNOA_flow_flow_settingflow_mgr;CNOA_flow_flow_settingflow_addeditClass=CNOA.Class.create();CNOA_flow_flow_settingflow_addeditClass.prototype={init:function(a){var b=this;this.ID_window_numberTip=Ext.id();this.ID_btn_addedit_save=Ext.id();this.ID_window_formSelect=Ext.id();this.edit_id=0;this.title=a=="edit"?"流程信息":"新建流程";this.action=a;this.baseUrl="index.php?app=flow&func=flow&action=setting";this.sortStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getSortList&type=combo",disableCaching:true}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:[{name:"sid"},{name:"name"}]}),listeners:{load:function(){if(b.sort!=0){b.sortSelector.setValue(b.sort)}}}});this.sortStore.load();this.sortSelector=new Ext.form.ComboBox({store:this.sortStore,valueField:"sid",displayField:"name",hiddenName:"sid",mode:"local",allowBlank:false,width:290,triggerAction:"all",forceSelection:true,editable:false,fieldLabel:lang("sort2"),listeners:{select:function(e,c,d){}}});this.formPanel=new Ext.form.FormPanel({labelAlign:"right",labelWidth:70,waitMsgTarget:true,border:false,bodyStyle:"padding: 10px;",items:[{xtype:"textfield",width:290,fieldLabel:lang("flowName"),allowBlank:false,name:"name"},this.sortSelector,{xtype:"panel",hideBorders:true,border:false,layout:"table",autoWidth:true,layoutConfig:{columns:2},items:[{xtype:"panel",layout:"form",width:370,items:[{xtype:"textfield",allowBlank:false,name:"formname",readOnly:true,fieldLabel:"工作表单",width:290},{xtype:"hidden",allowBlank:false,name:"formid"}]},{xtype:"panel",layout:"form",items:[{xtype:"button",text:lang("select"),autoWidth:true,handler:function(){b.showFormSelectWidnow(b.sortSelector.getValue(),b.sortSelector.getRawValue())}}]}]},{xtype:"panel",hideBorders:true,border:false,layout:"table",autoWidth:true,layoutConfig:{columns:2},items:[{xtype:"panel",layout:"form",width:370,items:[{xtype:"textfield",allowBlank:false,name:"number",fieldLabel:"编号格式",width:290}]},{xtype:"panel",layout:"form",items:[{xtype:"button",text:"格式说明",autoWidth:true,handler:function(){try{Ext.getCmp(b.ID_window_numberTip).show()}catch(c){b.showNumberTipWidnow()}}}]}]},{xtype:"textarea",fieldLabel:lang("remark"),name:"about",width:387,height:137}],listeners:{afterrender:function(c){if(a=="sortEdit"){}}}});this.mainPanel=new Ext.Window({title:this.title,width:500,height:328,layout:"fit",modal:true,maximizable:true,resizable:false,items:[this.formPanel],buttons:[{text:lang("save"),id:b.ID_btn_addedit_save,iconCls:"icon-order-s-accept",handler:function(){b.submitForm()}},{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){b.close()}}],listeners:{close:function(){try{var c=Ext.getCmp(b.ID_window_numberTip);c.close();Ext.destroy(c)}catch(d){}}}})},show:function(){this.mainPanel.show();if(this.action=="edit"){this.loadForm()}},close:function(){this.mainPanel.close()},submitForm:function(){var c=this;var b=this.formPanel.getForm();if(b.isValid()){b.submit({url:c.baseUrl+"&task=flow"+c.action,waitTitle:lang("notice"),method:"POST",waitMsg:lang("waiting"),params:{lid:c.edit_id},success:function(d,e){CNOA_flow_flow_settingflow.store.reload();CNOA.msg.notice(e.result.msg,"工作流管理");c.close()}.createDelegate(this),failure:function(d,e){CNOA.msg.alert(e.result.msg,function(){}.createDelegate(this))}.createDelegate(this)})}else{var a=Ext.getCmp(c.ID_btn_addedit_save).getEl().getBox();a=[a.x+35,a.y+26];CNOA.miniMsg.alert(lang("formValid"),a)}},loadForm:function(){var b=this;var a=this.formPanel.getForm();a.load({url:b.baseUrl+"&task=floweditLoadForm",params:{lid:b.edit_id},method:"POST",waitMsg:lang("waiting"),success:function(c,d){}.createDelegate(this),failure:function(c,d){b.close();CNOA.msg.alert(d.result.msg,function(){})}.createDelegate(this)})},showNumberTipWidnow:function(){var d=this;var b=function(e){var f=d.formPanel.getForm().findField("number");f.setValue(f.getValue()+""+e)};var a=new Ext.form.FormPanel({labelAlign:"right",labelWidth:50,waitMsgTarget:true,border:false,bodyStyle:"padding: 10px;",defaults:{xtype:"displayfield",width:290,style:"cursor: pointer;"},items:[{fieldLabel:"{F}",value:"此变量表示当前的流程名称",listeners:{render:function(e){e.getEl().on("click",function(){b("{F}")})}}},{fieldLabel:"{U}",value:"此变量表示当前的流程发起者",listeners:{render:function(e){e.getEl().on("click",function(){b("{U}")})}}},{fieldLabel:"{Y}",value:"此变量表示当前时间的四位年份值，如2008",listeners:{render:function(e){e.getEl().on("click",function(){b("{Y}")})}}},{fieldLabel:"{M}",value:"此变量表示当前时间的两位月份值，如12",listeners:{render:function(e){e.getEl().on("click",function(){b("{M}")})}}},{fieldLabel:"{D}",value:"此变量表示当前时间的两位日期值，如31",listeners:{render:function(e){e.getEl().on("click",function(){b("{D}")})}}},{fieldLabel:"{H}",value:"此变量表示当前时间的两位小时值，如08",listeners:{render:function(e){e.getEl().on("click",function(){b("{H}")})}}},{fieldLabel:"{I}",value:"此变量表示当前时间的两位分钟值，如59",listeners:{render:function(e){e.getEl().on("click",function(){b("{I}")})}}},{fieldLabel:"{S}",value:"此变量表示当前时间的两位秒钟值，如59",listeners:{render:function(e){e.getEl().on("click",function(){b("{S}")})}}},{fieldLabel:"{N}",value:"此变量表示当天的系统流水号，{N}表示一位流水号，{NNNNN}表示五位流水号，最多五位，如00001",listeners:{render:function(e){e.getEl().on("click",function(){b("{N}")})}}},{fieldLabel:"示例",value:"如：{F}{Y}{M}{D}-{NNNN}，将会被转化为：流程名称20080808-0008"}]});var c=new Ext.Window({title:"流程编号规则说明",id:this.ID_window_numberTip,width:420,height:345,layout:"fit",closeAction:"hide",maximizable:true,resizable:false,items:[a],buttons:[{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){c.hide()}}],listeners:{deactivate:function(e){e.hide()},show:function(e){var f=e.getPosition();e.setPosition(f[0]+24,f[1]+136)}}}).show()},showFormSelectWidnow:function(a,f){var h=this;var d=function(k){var j=c.getSelectionModel().getSelectedNode();var i=h.formPanel.getForm();if(j==null){i.findField("formname").setValue("");i.findField("formid").setValue("")}else{i.findField("formname").setValue(j.text);i.findField("formid").setValue(j.attributes.fid)}e.close()};var b=new Ext.tree.AsyncTreeNode({expanded:false});var g=new Ext.tree.TreeLoader({dataUrl:h.baseUrl+"&task=getFormList&type=tree&sort="+a,preloadChildren:true,clearOnLoad:false,listeners:{load:function(i){}.createDelegate(this)}});var c=new Ext.tree.TreePanel({hideBorders:true,border:false,rootVisible:false,lines:true,animCollapse:false,animate:false,loader:g,root:b,autoScroll:true,listeners:{click:function(i){}.createDelegate(this)}});c.getSelectionModel().on("beforeselect",function(j,i){return i.isLeaf()});var e=new Ext.Window({title:"选择工作表单 - "+f,id:h.ID_window_formSelect,width:420,height:345,layout:"fit",closeAction:"close",maximizable:true,resizable:false,modal:true,items:[c],buttons:[{text:lang("save"),iconCls:"icon-order-s-accept",handler:function(){d()}},{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){e.close()}}],listeners:{deactivate:function(i){i.close()},show:function(i){}}}).show()}};CNOA_flow_flow_settingflow_designClass=CNOA.Class.create();CNOA_flow_flow_settingflow_designClass.prototype={init:function(b,a){var c=this;this.ID_window_numberTip=Ext.id();this.ID_btn_addedit_save=Ext.id();this.ID_CNOA_flow_flow_setting_design_ct=Ext.id();this.ID_DESIGN_BUTTON="flow_flow_setting_design_button_";this.ID_DESIGN_LINE="flow_flow_setting_design_line_";this.flowId=b;this.flowName=a;this.data=null;this.flowFormItems=null;this.newStepCount=1;this.baseUrl="index.php?app=flow&func=flow&action=setting";this.treeRoot=new Ext.tree.TreeNode({expanded:true});this.treePanel=new Ext.tree.TreePanel({root:this.treeRoot,border:false,id:"flow_flow_design",rootVisible:false});this.rightPanel=new Ext.Panel({border:false,region:"east",width:180,minWidth:180,maxWidth:180,split:true,autoScroll:true,bodyStyle:"padding-top:4px;",items:[this.treePanel],tbar:["步骤概预："]});this.centerPanel=new Ext.Panel({border:false,region:"center",autoScroll:true,bodyStyle:"background:#FFF url('./resources/images/mxgraph/grid.gif');",html:"<table width='100%' border='0' cellspacing='0' cellpadding='0'><tr><td align='center' valign='top' style='padding-top:20px;'><div id='"+this.ID_CNOA_flow_flow_setting_design_ct+"'></div></td></tr></table>",listeners:{afterrender:function(d){c.readFlowData()}}});this.mainPanel=new Ext.Window({title:"设计流程 - "+this.flowName,width:700,height:makeWindowHeight(600),layout:"border",modal:true,maximizable:true,resizable:true,items:[this.centerPanel,this.rightPanel],buttons:[{text:lang("save"),id:c.ID_btn_addedit_save,iconCls:"icon-order-s-accept",handler:function(){c.submitFlowData()}},{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){c.close()}}],listeners:{close:function(){},afterrender:function(d){d.el.on("contextmenu",function(f){f.preventDefault()},this)}}})},show:function(){this.mainPanel.show()},close:function(){this.mainPanel.close()},readFlowData:function(){var a=this;a.mainPanel.getEl().mask(lang("waiting"));Ext.Ajax.request({url:a.baseUrl+"&task=flowdesignLoadData",method:"POST",params:{lid:a.flowId},success:function(c){var b=Ext.decode(c.responseText);if(b.success===true){if(b.data.length<1){a.data=[{name:"开始",id:"0",type:"start"}]}else{a.data=b.data}a.flowFormItems=b.flowFormItems}else{CNOA.msg.alert(b.msg)}a.makeFlowViewport();a.mainPanel.getEl().unmask()}})},submitFlowData:function(){var h=this;h.mainPanel.getEl().mask(lang("waiting"));var c=0,b;var a=true;for(var d=0;d<this.data.length;d++){var f=this.data[d];if(f.smsdeal=="1"){c=f.id;b=f}if((c>0)&&((f.id-1)==c)){try{if(f.operator.station.length>0){CNOA.msg.alert("因为上一步骤[<span class='cnoa_color_red'>"+b.name+"</span>]启用了手机短信审批，步骤:[<span class='cnoa_color_red'>"+f.name+"</span>] 只能是单人办理，不可设置经办角色为岗位！");a=false}else{if(f.operator.user.length>1){CNOA.msg.alert("因为上一步骤[<span class='cnoa_color_red'>"+b.name+"</span>]启用了手机短信审批，步骤:[<span class='cnoa_color_red'>"+f.name+"</span>] 只能是单人办理，不可设置经办角色多于一人！");a=false}else{a=true}}}catch(g){}}}if(!a){this.mainPanel.getEl().unmask();return}Ext.Ajax.request({url:h.baseUrl+"&task=flowdesignSubmitData",method:"POST",params:{lid:h.flowId,data:Ext.encode(h.data)},success:function(i){var e=Ext.decode(i.responseText);if(e.success===true){CNOA.msg.notice(e.msg,"工作流管理");h.close()}else{CNOA.msg.alert(e.msg)}h.mainPanel.getEl().unmask()}})},makeFlowViewport:function(){var f=this;document.getElementById(f.ID_CNOA_flow_flow_setting_design_ct).innerHTML="";var b=0;Ext.each(f.data,function(e,g,h){f.createButton(e.id,e.name,e.type);f.createLine(e.id);b=e.id});try{var d=document.getElementById(f.ID_CNOA_flow_flow_setting_design_ct);var a=document.getElementById(f.ID_DESIGN_LINE+b);d.removeChild(a)}catch(c){}},deleteNode:function(b){var d=this;var a=new Array();var c=0;Ext.each(d.data,function(e,f,g){if(e.id!=b){e.id=c;a.push(e);c++}});d.data=a;d.makeFlowViewport()},addNode:function(c){var e=this;var a=new Array();var b={name:"新步骤"+this.newStepCount++,type:"node"};var d=0;Ext.each(e.data,function(f,g,h){f.id=d;a.push(f);d++;if(f.id==c){b.id=d;a.push(b);d++}});e.data=a;e.makeFlowViewport()},createButton:function(e,a,b){var d=this;var c=new Ext.menu.Menu({items:[{text:"设置步骤",handler:function(){d.settingNode(e)}},{text:"添加下一步",handler:function(){d.addNode(e)}},{text:"删除本步骤",disabled:b=="start"?true:false,handler:function(){d.deleteNode(e)}}]});new Ext.Button({text:a,scale:"large",btype:b,id:this.ID_DESIGN_BUTTON+e,enableToggle:true,toggleGroup:"flow_flow_setting_design_btn",renderTo:d.ID_CNOA_flow_flow_setting_design_ct,autoWidth:true,handler:function(f){f.toggle(true)},listeners:{render:function(f){f.el.on("contextmenu",function(g){f.toggle(true);g.preventDefault();if(b!="end"){c.showAt(g.getXY())}},this)},toggle:function(g,f){if(f){d.makeViewTreeData(e)}}}})},makeViewTreeData:function(l){var r=this;var k=function(B,e){return new Ext.tree.TreeNode({iconCls:e?"icon-none":"icon-fileview-column2",text:B,expanded:true})};var i=r.getDataById(l);if((i.operator===null)||(i.operator===undefined)){i.operator={user:[],station:[]}}var x=k("<b>步骤名称</b>",false);var w=k("<span style='color:#616161'>"+i.name+"</span>",true);x.appendChild(w);var g=k("<b>上一步骤名称</b>",false);var d=k("<span style='color:#616161'>"+r.getDataById(parseInt(l)-1).name+"</span>",true);g.appendChild(d);var p=k("<b>下一步骤名称</b>",false);var n=k("<span style='color:#616161'>"+r.getDataById(parseInt(l)+1).name+"</span>",true);p.appendChild(n);var A=k("<b>经办角色</b>",false);var y=k("<b>人员</b>",false);var u=k("<b>岗位</b>",false);try{Ext.each(i.operator.user,function(e,B){var C=k("<span style='color:#616161'>"+e.name+"</span>",true);y.appendChild(C)});if(i.operator.user.length==0){}}catch(t){}try{Ext.each(i.operator.station,function(e,B){var C=k("<span style='color:#616161'>"+e.name+"</span>",true);u.appendChild(C)});if(i.operator.station.length==0){}}catch(t){}A.appendChild(y);A.appendChild(u);if(i.id==0){if((i.operator.station.length==0)&&(i.operator.user.length==0)){A.childNodes=[];A.appendChild(k("<span style='color:#616161'>任意人</span>",true))}}var a=k("<b>表单字段</b>",false);var z=k("<b>使用字段</b>",true);var v=k("<b>使用宏控件</b>",true);Ext.each(i.formitems,function(e,B){if(e.need){var C="";if(e.must){C="(<span style='color:red'>必填</span>)"}else{C="(<span style='color:#008200'>选填</span>)"}z.appendChild(k("<span style='color:#616161'>"+e.name+C+"</span>",true))}if(e.used){v.appendChild(k("<span style='color:#616161'>"+e.name+"</span>",true))}});a.appendChild(z);a.appendChild(v);var j=i.operatorperson=="2"?"<span style='color:#616161'>多人办理</span>":"<span style='color:#616161'>单人办理</span>";var s=i.operatortype=="1"?"<span style='color:#616161'>任意一人同意</span>":"<span style='color:#616161'>所有人同意</span>";var h=k("<b>经办方式</b>",false);var f=k("<span style='color:#616161'>"+j+"</span>",true);h.appendChild(f);if(i.operatorperson=="2"){var c=k("<b>转下一步条件: </b>",false);var b=k("<span style='color:#616161'>"+s+"</span>",true);c.appendChild(b);h.appendChild(c)}var q=k("<b>允许操作</b>",false);if(parseInt(i.upAttach)==1){var o=k("<span style='color:#616161'>允许上传附件</span>",true);q.appendChild(o)}if(parseInt(i.downAttach)==1){var m=k("<span style='color:#616161'>允许下载附件</span>",true);q.appendChild(m)}r.treeRoot=new Ext.tree.TreeNode({expanded:true});if(i.type=="end"){r.treeRoot.appendChild([x,g])}else{r.treeRoot.appendChild([x,g,p,A,a,h,q])}r.treePanel.setRootNode(r.treeRoot)},getDataById:function(c){var b=this;c=parseInt(c);if((c<0)||(c>b.data.length-1)){return{name:"无",id:"-1"}}var a;Ext.each(b.data,function(d,e,f){if(d.id==c){a=d}});return a},createLine:function(a){var b=this;new Ext.BoxComponent({id:this.ID_DESIGN_LINE+a,renderTo:b.ID_CNOA_flow_flow_setting_design_ct,autoEl:{tag:"div",html:'<img src="./resources/images/cnoa/arrow.gif" />'}})},settingNode:function(i){var q=this;var v=Ext.id();var b=null;var g=q.getDataById(i);var j={user:[],station:[]};try{j.user=g.operator.user}catch(u){j.user=[]}try{j.station=g.operator.station}catch(u){j.station=[]}var k=function(){var z={};var A=c.getForm();z.id=i;z.name=A.findField("name").getValue();z.upAttach=A.findField("upAttach").getValue()?"1":"0";z.downAttach=A.findField("downAttach").getValue()?"1":"0";try{z.smsdeal=A.findField("smsdeal").getValue()?"1":"0"}catch(B){}z.operatortype=A.findRadioCheckBoxGroupField("operatortype").getValue();z.operatorperson=A.findRadioCheckBoxGroupField("operatorperson").getValue();z.operator=j;if(z.smsdeal=="1"){var w=true;if(j.station.length>0){CNOA.msg.alert("因为启用了手机短信审批，本步骤只能是单人办理，不可设置经办角色为岗位！");w=false}else{if(j.user.length>1){CNOA.msg.alert("因为启用了手机短信审批，本步骤只能是单人办理，不可设置经办角色多于一人！");w=false}}if(!w){return}}var C=new Array();var y=Ext.query("div[id^=FLOW_FLOWDESIGN_WINDOW_TABB_CHECKBOX_CT_]");Ext.each(y,function(e,E){var F=new Object();F.name=e.title;Ext.each(e.children,function(H,G){if(H.id.indexOf("FLOW_FLOWDESIGN_WINDOW_TABB_CHECKBOX_MUST_")!=-1){F.itemid=H.id.replace("FLOW_FLOWDESIGN_WINDOW_TABB_CHECKBOX_MUST_","");F.must=H.checked}if(H.id.indexOf("FLOW_FLOWDESIGN_WINDOW_TABB_CHECKBOX_NEED_")!=-1){F.need=H.checked}if(H.id.indexOf("FLOW_FLOWDESIGN_WINDOW_TABB_CHECKBOX_USED_")!=-1){F.itemid=H.id.replace("FLOW_FLOWDESIGN_WINDOW_TABB_CHECKBOX_USED_","");F.used=H.checked}});C.push(F)});z.formitems=C;var D=0;Ext.each(q.data,function(e,E,F){if(e.id==i){q.data[E]=z;D=E+1}});var x=A.findField("stepOver").getValue();if(x){if(D!=q.data.length){CNOA.msg.alert("本步骤不是最后一个步骤，不能结束")}else{q.data.push({name:"结束",id:D,type:"end"})}}a.close();q.makeFlowViewport();Ext.getCmp(q.ID_DESIGN_BUTTON+i).toggle(true)};var d=[];d.push({xtype:"fieldset",title:"步骤属性",anchor:"99%",border:true,autoHeight:true,defaults:{xtype:"textfield"},items:[{xtype:"textfield",width:290,fieldLabel:"步骤名称",allowBlank:false,name:"name"},{xtype:"panel",layout:"table",autoWidth:true,border:false,layoutConfig:{columns:2},items:[{xtype:"panel",layout:"form",border:false,width:174,items:[{xtype:"checkbox",fieldLabel:"允许操作",boxLabel:"允许上传附件",name:"upAttach"}]},{xtype:"checkbox",boxLabel:"允许下载附件",name:"downAttach"}]},{xtype:"checkbox",fieldLabel:"后续步骤",name:"stepOver",boxLabel:"结束"}]});operatorpersonGroup_id=Ext.id();operatorperson2_id=Ext.id();d.push({xtype:"fieldset",title:"经办方式",anchor:"99%",border:true,autoHeight:true,defaults:{width:200,xtype:"textfield"},items:[{xtype:"radiogroup",fieldLabel:"经办方式",id:operatorpersonGroup_id,name:"operatorpersonGroup",items:[{boxLabel:"单人办理",name:"operatorperson",inputValue:"1",checked:true},{boxLabel:"多人办理",name:"operatorperson",inputValue:"2",id:operatorperson2_id}],listeners:{change:function(w,e){var x=Ext.getCmp(v);if(e.inputValue=="2"){x.show()}else{x.hide()}}.createDelegate(this),render:function(e){}}},{xtype:"panel",border:false,hidden:false,width:560,layout:"form",id:v,defaults:{width:200,xtype:"textfield"},items:[{xtype:"radiogroup",fieldLabel:"处理方式",name:"operatortypeGroup",items:[{boxLabel:"任意一人同意",name:"operatortype",inputValue:"1"},{boxLabel:"所有人同意",name:"operatortype",inputValue:"2",checked:true}],listeners:{change:function(w,e){}.createDelegate(this),render:function(e){}}},{xtype:"displayfield",width:560,value:"<span style='color:#666'>任意一人同意：只要本步骤中有一人同意，则流程进入下一步骤。<br />　所有人同意：所有人同意后流程才会进入下一步骤。</span>"}]}]});if(g.type=="node"&&CNOA_SMS_ENABLE==1){d.push({xtype:"fieldset",title:"手机短信审批",anchor:"99%",border:true,items:[{xtype:"checkbox",width:200,name:"smsdeal",fieldLabel:"短信审批",boxLabel:"启用手机短信审批",listeners:{check:function(w,e){if(e){Ext.getCmp(operatorpersonGroup_id).setValue("1");Ext.getCmp(operatorperson2_id).hide()}else{Ext.getCmp(operatorperson2_id).show()}}}}]})}var r=function(w,y,e){var x="";if(w=="textfield"){x="单行文本框"}else{if(w=="textarea"){x="多行文本框"}else{if(w=="select"){x="下拉选择框"}else{x="宏控件"}}}return x};var m=function(x,A,w){var e="FLOW_FLOWDESIGN_WINDOW_TABB_CHECKBOX_NEED_"+x;var C="FLOW_FLOWDESIGN_WINDOW_TABB_CHECKBOX_MUST_"+x;var B="FLOW_FLOWDESIGN_WINDOW_TABB_CHECKBOX_USED_"+x;var z="";if((w.data.type=="textfield")||(w.data.type=="textarea")||(w.data.type=="select")){var y="onclick=\"if(this.checked){Ext.getDom('"+C+"').disabled=false;}else{Ext.getDom('"+C+"').checked=false;Ext.getDom('"+C+"').disabled=true;}\"";z+='<div id="FLOW_FLOWDESIGN_WINDOW_TABB_CHECKBOX_CT_'+x+'" title="'+w.data.title+'">';z+='<label for="'+e+'">可填</label><input type="checkbox" id="'+e+'" '+y+" />";z+="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";z+='<label for="'+C+'">必填</label><input type="checkbox" id="'+C+'" disabled="true" />';z+="</div>"}else{z+='<div id="FLOW_FLOWDESIGN_WINDOW_TABB_CHECKBOX_CT_'+x+'" title="'+w.data.title+'">';z+='<label for="'+B+'">使用</label><input type="checkbox" id="'+B+'" />';z+="</div>"}return z};var h={data:q.flowFormItems};var n=new Ext.data.Store({proxy:new Ext.data.MemoryProxy(h),reader:new Ext.data.JsonReader({root:"data"},[{name:"itemid"},{name:"title"},{name:"htmltag"},{name:"type"}])});n.load();var l=new Ext.grid.RowSelectionModel({singleSelect:true});var p=new Ext.grid.ColumnModel([{header:"itemid",dataIndex:"itemid",hidden:true},{header:"表单名称",dataIndex:"title",width:408},{header:"表单类型",dataIndex:"type",width:125,renderer:r},{header:"操作<input type='checkbox' id='CNOA_FLOW_SETTING_DESIGNFIELD_checkallneed'>&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp<input type='checkbox' id='CNOA_FLOW_SETTING_DESIGNFIELD_checkallmust'>",dataIndex:"itemid",width:132,sortable:false,renderer:m}]);var s=new Ext.grid.GridPanel({stripeRows:true,store:n,cm:p,sm:l,viewConfig:{},listeners:{afterrender:function(){var w=setInterval(function(){try{Ext.each(b,function(z,A){if(z.need){Ext.getDom("FLOW_FLOWDESIGN_WINDOW_TABB_CHECKBOX_NEED_"+z.itemid).checked=true;Ext.getDom("FLOW_FLOWDESIGN_WINDOW_TABB_CHECKBOX_MUST_"+z.itemid).disabled=false}if(z.must){Ext.getDom("FLOW_FLOWDESIGN_WINDOW_TABB_CHECKBOX_MUST_"+z.itemid).checked=true}if(z.used){Ext.getDom("FLOW_FLOWDESIGN_WINDOW_TABB_CHECKBOX_USED_"+z.itemid).checked=true}clearInterval(w)})}catch(y){}},300);var x=Ext.fly("CNOA_FLOW_SETTING_DESIGNFIELD_checkallneed").on("click",function(){if(this.dom.checked){Ext.select("input[id^=FLOW_FLOWDESIGN_WINDOW_TABB_CHECKBOX_NEED_]").each(function(){this.dom.checked=true});Ext.select("input[id^=FLOW_FLOWDESIGN_WINDOW_TABB_CHECKBOX_USED_]").each(function(){this.dom.checked=true});Ext.select("input[id^=FLOW_FLOWDESIGN_WINDOW_TABB_CHECKBOX_MUST_]").each(function(){this.dom.disabled=false})}else{Ext.select("input[id^=FLOW_FLOWDESIGN_WINDOW_TABB_CHECKBOX_NEED_]").each(function(){this.dom.checked=false});Ext.select("input[id^=FLOW_FLOWDESIGN_WINDOW_TABB_CHECKBOX_MUST_]").each(function(){this.dom.checked=false});Ext.select("input[id^=FLOW_FLOWDESIGN_WINDOW_TABB_CHECKBOX_USED_]").each(function(){this.dom.checked=false});Ext.select("input[id^=FLOW_FLOWDESIGN_WINDOW_TABB_CHECKBOX_MUST_]").each(function(){this.dom.disabled=true})}});var e=Ext.fly("CNOA_FLOW_SETTING_DESIGNFIELD_checkallmust").on("click",function(){var y=this.dom.checked;Ext.select("input[id^=FLOW_FLOWDESIGN_WINDOW_TABB_CHECKBOX_MUST_]").each(function(){if(!this.dom.disabled&&y){this.dom.checked=true}else{this.dom.checked=false}})})}}});var o;try{o=g.operator.station}catch(u){o=[]}this.selectorForStationStore=new Ext.data.ArrayStore({proxy:new Ext.data.MemoryProxy(o),fields:[{name:"sid"},{name:"text",mapping:"name"}]});this.selectorForStationStore.load();this.selectorForStation=new Ext.ux.form.MultiSelect({name:"multiselect",width:334,height:343,valueField:"sid",displayField:"text",hiddenName:"sid",store:this.selectorForStationStore,tbar:[lang("selectStation")+"&nbsp;&nbsp;","->",{xtype:"stationbutton",text:lang("select"),iconCls:"icon-order-s-spAdd",multiSelect:true,listeners:{dataloaded:function(e){var w=[];q.selectorForStationStore.each(function(x){w.push(x.json.sid)});e.selectItems(w)},confirm:function(e,A){q.selectorForStationStore.removeAll();var x=[],w,y;j.station=new Array();for(var z=0;z<A.length;z++){w=e.getItemId(A[z]);y=e.getItemText(A[z]);x.push(new Ext.data.Record({sid:w,text:y}));j.station.push({sid:w,name:y})}q.selectorForStationStore.add(x)}}},"-",{text:lang("clear"),iconCls:"icon-clear",handler:function(){q.selectorForStationStore.removeAll();j.station=new Array()}}],ddReorder:true});var t;try{t=g.operator.user}catch(u){t=[]}this.selectorForPeopleStore=new Ext.data.ArrayStore({proxy:new Ext.data.MemoryProxy(t),fields:[{name:"uid"},{name:"uname",mapping:"name"}]});this.selectorForPeopleStore.load();this.selectorForPeople=new Ext.ux.form.MultiSelect({name:"multiselect",width:334,height:343,valueField:"uid",displayField:"uname",hiddenName:"uid",store:this.selectorForPeopleStore,tbar:["选择人员&nbsp;&nbsp;","->",{xtype:"btnForPoepleSelector",text:lang("select"),dataUrl:q.baseUrl+"&task=getAllUserListsInPermitDeptTree",iconCls:"icon-order-s-spAdd",listeners:{selected:function(x,y){if(y.length>0){q.selectorForPeopleStore.removeAll();j.user=new Array();for(var w=0;w<y.length;w++){var e=new Ext.data.Record(y[w]);q.selectorForPeople.store.add(e);j.user.push({uid:y[w].uid,name:y[w].uname})}}},onrender:function(e){}}},"-",{text:lang("clear"),iconCls:"icon-clear",handler:function(){q.selectorForPeopleStore.removeAll();j.user=new Array()}}],ddReorder:true});this.selectorPanel=new Ext.Panel({border:false,items:[{margins:"5 5 5 5",layout:"column",autoScroll:true,border:false,items:[{columnWidth:0.5,baseCls:"x-plain",bodyStyle:"padding:5px 0 5px 5px",layout:"fit",items:[this.selectorForPeople]},{columnWidth:0.5,baseCls:"x-plain",bodyStyle:"padding:5px",items:[this.selectorForStation]}]}]});var f=new Ext.TabPanel({activeTab:0,hideBorders:true,deferredRender:false,border:false,autoScroll:true,defaults:{hideBorders:true,border:false},items:[{title:lang("baseInfo"),layout:"form",labelAlign:"right",labelWidth:70,height:352,items:d,bodyStyle:"padding: 10px;",defaults:{width:250},listeners:{activate:function(){}.createDelegate(this)}},{title:"表单字段",layout:"fit",height:352,items:[{xtype:"panel",hideBorders:true,border:false,autoScroll:true,items:[s]}],listeners:{activate:function(){}.createDelegate(this)}},{title:"经办角色",items:[this.selectorPanel],listeners:{activate:function(){}.createDelegate(this)}}]});var c=new Ext.form.FormPanel({autoWidth:true,border:false,hideBorders:true,labelWidth:70,labelAlign:"right",waitMsgTarget:true,items:[f]});var a=new Ext.Window({title:"设置步骤",width:700,height:makeWindowHeight(450),layout:"fit",modal:true,closeAction:"close",resizable:false,items:[c],buttons:[{text:lang("ok"),iconCls:"icon-order-s-accept",handler:function(){k()}},{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){a.close()}}],listeners:{show:function(e){}}}).show();(function(){var x={};Ext.each(q.data,function(e,y,z){if(e.id==i){x.data=e;b=e.formitems}});c.getForm().loadRecord(x);Ext.getCmp(v).hide();try{if(x.data.operatorperson=="2"){Ext.getCmp(v).show()}}catch(w){}}())}};CNOA_flow_flow_settingflowClass=CNOA.Class.create();CNOA_flow_flow_settingflowClass.prototype={init:function(){var a=this;this.edit_id=0;this.sort=0;this.baseUrl="index.php?app=flow&func=flow&action=setting";this.ID_btn_edit=Ext.id();this.ID_btn_delete=Ext.id();this.ID_tree_treeRoot=Ext.id();this.ID_find_name=Ext.id();this.ID_find_flowFrom=Ext.id();this.renderPublish=function(k,i,f,j,g,c){var e="";function l(){return new Ext.Button({text:k=="1"?"禁用":"启用",width:40,handler:function(){a.setFlowPublish(f.get("lid"))}}).render(document.body,d)}var d=Ext.id();if(k=="1"){var b=l.defer(1,this,[d,k]);e="<span class='cnoa_color_green' style='float:left;width:44px;'>可用</span><span id='"+d+"'></span>"}else{var b=l.defer(1,this,[d,k]);e="<span class='cnoa_color_gray' style='float:left;width:44px;'>不可用</span><span id='"+d+"'></span>"}return e};this.storeBar={flowFrom:"",name:""};this.fields=[{name:"lid"},{name:"name"},{name:"sname"},{name:"publish"}];this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getFlowJsonData",disableCaching:true}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields})});this.flowFrom=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:a.baseUrl+"&task=getFlowFrom",disableCaching:true}),reader:new Ext.data.JsonReader({root:"data",fields:[{name:"sid"},{name:"name"}]}),listeners:{load:function(c,b){}},autoLoad:true});this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.store.load();this.colModel=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),this.sm,{header:"lid",dataIndex:"lid",hidden:true},{header:lang("flowName"),dataIndex:"name",width:120,sortable:true,menuDisabled:true},{header:lang("sort2"),dataIndex:"sname",width:70,sortable:false,menuDisabled:true},{header:"状态 / 操作",dataIndex:"publish",width:70,sortable:false,menuDisabled:true,renderer:this.renderPublish},{header:lang("opt"),dataIndex:"lid",width:120,sortable:false,menuDisabled:true,renderer:this.makeOperate.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.pagingBar=new Ext.PagingToolbar({displayInfo:true,store:this.store,style:"border-left-width:1px;",pageSize:15,listeners:{beforechange:function(b,c){c.sort=a.sort}}});this.grid=new Ext.grid.GridPanel({stripeRows:true,store:this.store,bodyStyle:"border-left-width:1px;",loadMask:{msg:lang("waiting")},cm:this.colModel,sm:this.sm,hideBorders:true,border:false,region:"center",viewConfig:{forceFit:true},listeners:{rowdblclick:function(b,c){},rowclick:function(b,f,c,d){}},tbar:new Ext.Toolbar({style:"border-left-width:1px;",items:[{iconCls:"icon-system-refresh",text:lang("refresh"),handler:function(b,c){a.store.reload()}.createDelegate(this)},"-",{handler:function(b,c){CNOA_flow_flow_settingflow_addedit=new CNOA_flow_flow_settingflow_addeditClass("add");CNOA_flow_flow_settingflow_addedit.show()}.createDelegate(this),iconCls:"icon-utils-s-add",text:"新建流程"},"-","流程名称：",{xtype:"textfield",id:a.ID_find_name,name:"name",width:110},"所属流程分类",{xtype:"combo",id:a.ID_find_flowFrom,width:110,name:"flowFrom",valueField:"sid",hiddenName:"worktimeId",displayField:"name",triggerAction:"all",mode:"local",editable:false,store:a.flowFrom,listeners:{select:function(d,b,c){}}},"-",{text:lang("search"),handler:function(){a.storeBar={name:Ext.getCmp(a.ID_find_name).getValue(),flowFrom:Ext.getCmp(a.ID_find_flowFrom).getValue()};a.store.load({params:a.storeBar})}},"-",{text:lang("clear"),handler:function(){Ext.getCmp(a.ID_find_name).setValue("");Ext.getCmp(a.ID_find_flowFrom).setValue("");a.storeBar={name:"",flowFrom:""};a.store.load()}},"->",{xtype:"cnoa_helpBtn",helpid:10}]}),bbar:this.pagingBar});this.treeRoot=new Ext.tree.AsyncTreeNode({text:"所有分类",sid:"0",iconCls:"icon-tree-root-cnoa",id:this.ID_tree_treeRoot,expanded:true});this.treeLoader=new Ext.tree.TreeLoader({dataUrl:this.baseUrl+"&task=getSortList&type=tree",preloadChildren:true,clearOnLoad:false,listeners:{load:function(b){a.sortTree.selectPath(a.ID_tree_treeRoot)}.createDelegate(this)}});this.sortTree=new Ext.tree.TreePanel({hideBorders:true,border:false,rootVisible:true,lines:true,animCollapse:false,animate:false,loader:this.treeLoader,root:this.treeRoot,autoScroll:true,listeners:{click:function(b){a.sort=b.attributes.sid;a.store.load({params:{sort:a.sort}})}}});this.sortPanel=new Ext.Panel({region:"west",layout:"fit",split:true,width:140,minWidth:80,maxWidth:380,bodyStyle:"border-right-width:1px;",items:[this.sortTree],tbar:new Ext.Toolbar({style:"border-right-width:1px;",items:["流程分类","->",{handler:function(b,c){a.treeRoot.reload()}.createDelegate(this),iconCls:"icon-system-refresh",tooltip:lang("refresh"),text:lang("refresh")}]})});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.grid,this.sortPanel]})},makeOperate:function(i,f,d,g,e,b){var j=d.data;var a="./resources/images/icons/";var c="<div style='margin-top:2px;'><a href='javascript:void(0);' onclick='CNOA_flow_flow_settingflow.editPanel("+i+");'><img src='"+a+"page_addedit.png' style='margin:0 2px 4px 0' align='absmiddle' />编辑</a>";c+="&nbsp;&nbsp;&nbsp;";c+="<a href='javascript:void(0);' onclick='CNOA_flow_flow_settingflow.deleteList("+i+");'><img src='"+a+"cross.gif' style='margin:0 2px 4px 0' align='absmiddle' />删除</a>";c+="&nbsp;&nbsp;&nbsp;";c+="<a href='javascript:void(0);' onclick='CNOA_flow_flow_settingflow.designPanel("+i+', "'+j.name+"\");'><img src='"+a+"frame-edit.png' style='margin:0 2px 4px 0' align='absmiddle' />设计流程</a>";c+="&nbsp;&nbsp;&nbsp;";c+="</div>";return c},deleteList:function(a){var b=this;CNOA.msg.cf("确认删除吗？",function(c){if(c=="yes"){Ext.Ajax.request({url:b.baseUrl+"&task=flowdelete",method:"POST",params:{lid:a},success:function(e){var d=Ext.decode(e.responseText);if(d.success===true){CNOA.msg.notice(d.msg,"工作流管理");b.store.reload()}else{CNOA.msg.alert(d.msg)}}})}})},editPanel:function(a){CNOA_flow_flow_settingflow_addedit=new CNOA_flow_flow_settingflow_addeditClass("edit");CNOA_flow_flow_settingflow_addedit.edit_id=a;CNOA_flow_flow_settingflow_addedit.show()},designPanel:function(b,a){CNOA_flow_flow_settingflow_design=new CNOA_flow_flow_settingflow_designClass(b,a);CNOA_flow_flow_settingflow_design.show()},designPanel2:function(b,a){CNOA_flow_flow_settingflow_design2=new CNOA_flow_flow_settingflow_designClass2(b,a);CNOA_flow_flow_settingflow_design2.show()},setFlowPublish:function(a){var b=this;Ext.Ajax.request({url:b.baseUrl+"&task=setFlowPublish",method:"POST",params:{lid:a},success:function(d){var c=Ext.decode(d.responseText);if(c.success===true){b.store.reload()}else{CNOA.msg.alert(c.msg)}}})}};var CNOA_flow_flow_settingformClass,CNOA_flow_flow_settingform;var CNOA_flow_flow_settingform_addeditClass,CNOA_flow_flow_settingform_addedit;CNOA_flow_flow_settingform_addeditClass=CNOA.Class.create();CNOA_flow_flow_settingform_addeditClass.prototype={init:function(a){var b=this;this.ID_window_numberTip=Ext.id();this.ID_btn_addedit_save=Ext.id();this.edit_id=0;this.title=a=="Edit"?"表单信息":"新建表单";this.action=a;this.baseUrl="index.php?app=flow&func=flow&action=setting";this.sortStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getSortList&type=combo",disableCaching:true}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:[{name:"sid"},{name:"name"}]}),listeners:{load:function(){if(b.sort!=0){b.sortSelector.setValue(b.sort)}}}});this.sortStore.load();this.sortSelector=new Ext.form.ComboBox({store:this.sortStore,valueField:"sid",displayField:"name",hiddenName:"sid",mode:"local",allowBlank:false,width:290,triggerAction:"all",forceSelection:true,editable:false,fieldLabel:lang("sort2"),listeners:{select:function(e,c,d){}}});this.formPanel=new Ext.form.FormPanel({fileUpload:true,labelAlign:"right",labelWidth:70,waitMsgTarget:true,border:false,bodyStyle:"padding: 10px;",items:[{xtype:"textfield",width:290,fieldLabel:"表单名称",allowBlank:false,name:"name"},this.sortSelector,{xtype:"textarea",fieldLabel:lang("remark"),name:"about",width:387,height:137}],listeners:{afterrender:function(c){if(a=="sortEdit"){}}}});this.mainPanel=new Ext.Window({title:this.title,width:500,height:280,layout:"fit",modal:true,maximizable:false,resizable:false,items:[this.formPanel],buttons:[{text:lang("save"),id:b.ID_btn_addedit_save,iconCls:"icon-order-s-accept",handler:function(){b.submitForm()}},{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){b.close()}}],listeners:{close:function(){try{var c=Ext.getCmp(b.ID_window_numberTip);c.close();Ext.destroy(c)}catch(d){}}}})},show:function(){this.mainPanel.show();if(this.action=="Edit"){this.loadForm()}},close:function(){this.mainPanel.close()},submitForm:function(){var c=this;var b=this.formPanel.getForm();if(b.isValid()){b.submit({url:c.baseUrl+"&task=form"+c.action,waitTitle:lang("notice"),method:"POST",waitMsg:lang("waiting"),params:{fid:c.edit_id},success:function(d,e){CNOA_flow_flow_settingform.store.reload();CNOA.msg.notice(e.result.msg,"工作流管理");c.close()}.createDelegate(this),failure:function(d,e){CNOA.msg.alert(e.result.msg,function(){}.createDelegate(this))}.createDelegate(this)})}else{var a=Ext.getCmp(c.ID_btn_addedit_save).getEl().getBox();a=[a.x+35,a.y+26];CNOA.miniMsg.alert(lang("formValid"),a)}},loadForm:function(){var b=this;var a=this.formPanel.getForm();a.load({url:b.baseUrl+"&task=formeditLoadForm",params:{fid:b.edit_id},method:"POST",waitMsg:lang("waiting"),success:function(c,d){}.createDelegate(this),failure:function(c,d){b.close();CNOA.msg.alert(d.result.msg,function(){})}.createDelegate(this)})}};CNOA_flow_flow_settingformClass=CNOA.Class.create();CNOA_flow_flow_settingformClass.prototype={init:function(){var a=this;this.edit_id=0;this.sort=0;this.baseUrl="index.php?app=flow&func=flow&action=setting";this.ID_btn_edit=Ext.id();this.ID_btn_delete=Ext.id();this.ID_tree_treeRoot=Ext.id();this.ID_find_name=Ext.id();this.ID_find_flowFrom=Ext.id();this.storeBar={flowFrom:"",name:""};this.fields=[{name:"fid"},{name:"name"},{name:"about"},{name:"sname"}];this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getFormJsonData",disableCaching:true}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields})});this.flowFrom=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:a.baseUrl+"&task=getFlowFrom",disableCaching:true}),reader:new Ext.data.JsonReader({root:"data",fields:[{name:"sid"},{name:"name"}]}),listeners:{load:function(c,b){}},autoLoad:true});this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.store.load();this.colModel=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),this.sm,{header:"fid",dataIndex:"fid",hidden:true},{header:"表单名称",dataIndex:"name",width:100,sortable:true,menuDisabled:true},{header:lang("remark"),dataIndex:"about",width:120,sortable:false,menuDisabled:true},{header:lang("sort2"),dataIndex:"sname",width:70,sortable:false,menuDisabled:true},{header:lang("opt"),dataIndex:"fid",width:100,sortable:false,menuDisabled:true,renderer:this.makeOperate.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.pagingBar=new Ext.PagingToolbar({displayInfo:true,store:this.store,style:"border-left-width:1px;",pageSize:15,listeners:{beforechange:function(b,c){c.sort=a.sort}}});this.grid=new Ext.grid.GridPanel({stripeRows:true,store:this.store,bodyStyle:"border-left-width:1px;",loadMask:{msg:lang("waiting")},cm:this.colModel,sm:this.sm,hideBorders:true,border:false,region:"center",viewConfig:{forceFit:true},listeners:{rowdblclick:function(b,c){},rowclick:function(b,f,c,d){}},tbar:new Ext.Toolbar({style:"border-left-width:1px;",items:[{iconCls:"icon-system-refresh",text:lang("refresh"),handler:function(b,c){a.store.reload()}.createDelegate(this)},"-",{handler:function(b,c){CNOA_flow_flow_settingform_addedit=new CNOA_flow_flow_settingform_addeditClass("Add");CNOA_flow_flow_settingform_addedit.show()}.createDelegate(this),iconCls:"icon-utils-s-add",text:"新建表单"},"-","表单名称：",{xtype:"textfield",id:a.ID_find_name,name:"name",width:110},"所属流程分类",{xtype:"combo",id:a.ID_find_flowFrom,width:110,name:"flowFrom",valueField:"sid",hiddenName:"worktimeId",displayField:"name",triggerAction:"all",mode:"local",editable:false,store:a.flowFrom,listeners:{select:function(d,b,c){}}},"-",{text:lang("search"),handler:function(){a.storeBar={name:Ext.getCmp(a.ID_find_name).getValue(),flowFrom:Ext.getCmp(a.ID_find_flowFrom).getValue()};a.store.load({params:a.storeBar})}},"-",{text:lang("clear"),handler:function(){Ext.getCmp(a.ID_find_name).setValue("");Ext.getCmp(a.ID_find_flowFrom).setValue("");a.storeBar={name:"",flowFrom:""};a.store.load()}},"->",{xtype:"cnoa_helpBtn",helpid:12}]}),bbar:this.pagingBar});this.treeRoot=new Ext.tree.AsyncTreeNode({text:"所有分类",sid:"0",iconCls:"icon-tree-root-cnoa",id:this.ID_tree_treeRoot,expanded:true});this.treeLoader=new Ext.tree.TreeLoader({dataUrl:this.baseUrl+"&task=getSortList&type=tree",preloadChildren:true,clearOnLoad:false,listeners:{load:function(b){a.sortTree.selectPath(a.ID_tree_treeRoot)}.createDelegate(this)}});this.sortTree=new Ext.tree.TreePanel({hideBorders:true,border:false,rootVisible:true,lines:true,animCollapse:false,animate:false,loader:this.treeLoader,root:this.treeRoot,autoScroll:true,listeners:{click:function(b){a.sort=b.attributes.sid;a.store.load({params:{sort:a.sort}})}}});this.sortPanel=new Ext.Panel({region:"west",layout:"fit",split:true,width:140,minWidth:80,maxWidth:380,bodyStyle:"border-right-width:1px;",items:[this.sortTree],tbar:new Ext.Toolbar({style:"border-right-width:1px;",items:["流程分类","->",{handler:function(b,c){a.treeRoot.reload()}.createDelegate(this),iconCls:"icon-system-refresh",tooltip:lang("refresh"),text:lang("refresh")}]})});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.grid,this.sortPanel]})},makeOperate:function(i,f,d,g,e,b){var j=d.data;var a="./resources/images/icons/";var c="<div style='margin-top:2px;'><a href='javascript:void(0);' onclick='CNOA_flow_flow_settingform.editPanel("+i+");'><img src='"+a+"page_addedit.png' style='margin:0 2px 4px 0' align='absmiddle' />编辑</a>";c+="&nbsp;&nbsp;&nbsp;";c+="<a href='javascript:void(0);' onclick='CNOA_flow_flow_settingform.designForm("+i+");'><img src='"+a+"frame-edit.png' style='margin:0 2px 4px 0' align='absmiddle' />设计表单</a>";c+="&nbsp;&nbsp;&nbsp;";c+="<a href='javascript:void(0);' onclick='CNOA_flow_flow_settingform.deleteList("+i+");'><img src='"+a+"cross.gif' style='margin:0 2px 4px 0' align='absmiddle' />删除</a>";c+="</div>";return c},designForm:function(a){var f=this;var j=this.baseUrl+"&task=formdesign&fid="+a;var c=Ext.getBody().getBox();var i=c.width-60;var d=c.height-60;var b=Ext.id();var g=function(k,h){if(k===false){return}e.getEl().mask(lang("waiting"));Ext.Ajax.request({url:f.baseUrl+"&task=saveFormDesignData",method:"POST",params:{content:k,fid:a},success:function(m){var l=Ext.decode(m.responseText);if(l.success===true){CNOA.msg.notice(l.msg,"工作流管理");if(h.close){e.close()}}else{CNOA.msg.alert(l.msg,function(){})}e.getEl().unmask()}})};this.fckLoaded=function(){e.getEl().unmask()};var e=new Ext.Window({title:"智能表单设计器",width:i,height:d,layout:"fit",modal:true,maximizable:true,resizable:true,html:'<iframe scrolling="auto" frameborder="0" width="100%" height="100%" id="'+b+'"></iframe>',buttons:[{text:lang("save"),iconCls:"icon-order-s-accept",handler:function(){g(Ext.getDom(b).contentWindow.getContentText(),{close:false})}},{text:"保存并关闭",iconCls:"icon-order-s-accept",handler:function(){g(Ext.getDom(b).contentWindow.getContentText(),{close:true})}},{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){e.close()}}],listeners:{show:function(h){Ext.getDom(b).contentWindow.location.href=j+"&r="+Math.random();h.getEl().mask(lang("waiting"))},close:function(){try{Ext.getDom(b).src=""}catch(h){}}}}).show()},deleteList:function(a){var b=this;CNOA.msg.cf("确认删除吗？",function(c){if(c=="yes"){Ext.Ajax.request({url:b.baseUrl+"&task=formdelete",method:"POST",params:{fid:a},success:function(e){var d=Ext.decode(e.responseText);if(d.success===true){CNOA.msg.notice(d.msg,"工作流管理");b.store.reload()}else{CNOA.msg.alert(d.msg)}}})}})},editPanel:function(a){CNOA_flow_flow_settingform_addedit=new CNOA_flow_flow_settingform_addeditClass("Edit");CNOA_flow_flow_settingform_addedit.edit_id=a;CNOA_flow_flow_settingform_addedit.show()}};var CNOA_flow_flow_settingsortClass,CNOA_flow_flow_settingsort;CNOA_flow_flow_settingsortClass=CNOA.Class.create();CNOA_flow_flow_settingsortClass.prototype={init:function(){var a=this;this.baseUrl="index.php?app=flow&func=flow&action=setting";this.edit_id=0;this.ID_btn_add=Ext.id();this.ID_btn_edit=Ext.id();this.ID_btn_addedit_save=Ext.id();this.ID_textarea_deptNames=Ext.id();this.ID_button_deptNames=Ext.id();this.ID_allUserButton=Ext.id();this.fields=[{name:"sid"},{name:"name"},{name:"type"},{name:"about"}];this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=sortGetJsonData"}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields})});this.store.load({params:{start:0}});this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:true});this.colModel=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),this.sm,{header:"sid",dataIndex:"sid",width:20,sortable:true,hidden:true},{header:"分类名称",dataIndex:"name",width:80,sortable:true},{header:lang("remark"),dataIndex:"about",width:120,sortable:true},{header:"类型",dataIndex:"type",width:60,sortable:true,renderer:this.makeType.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.grid=new Ext.grid.GridPanel({stripeRows:true,store:this.store,loadMask:{msg:lang("waiting")},cm:this.colModel,sm:this.sm,hideBorders:true,autoWidth:true,hideBorders:true,border:false,viewConfig:{forceFit:true},listeners:{rowdblclick:function(c,d){var b=c.getStore().getAt(d).get("sid");a.editPanel(b)},rowclick:function(b,c){}}});this.centerPanel=new Ext.Panel({region:"center",layout:"fit",autoScroll:true,items:[this.grid],tbar:new Ext.Toolbar({items:[{id:this.ID_btn_refreshList,handler:function(b,c){CNOA_flow_flow_settingsort.store.reload()}.createDelegate(this),iconCls:"icon-system-refresh",tooltip:lang("refresh"),text:lang("refresh")},"-",{id:this.ID_btn_add,handler:function(b,c){a.showAddEditWindow("sortAdd")},iconCls:"icon-utils-s-add",text:lang("add")},"-",{text:lang("modify"),iconCls:"icon-utils-s-edit",handler:function(c,d){var e=a.grid.getSelectionModel().getSelections();if(e.length==0){var b=c.getEl().getBox();b=[b.x+12,b.y+26];CNOA.miniMsg.alert(lang("mustSelectOneRow"),b)}else{a.editPanel(e[0].get("sid"))}}.createDelegate(this)},"-",{text:lang("del"),iconCls:"icon-utils-s-delete",handler:function(c,d){var e=this.grid.getSelectionModel().getSelections();if(e.length==0){var b=c.getEl().getBox();b=[b.x+12,b.y+26];CNOA.miniMsg.alert(lang("mustSelectOneRow"),b)}else{CNOA.msg.cf("确定要删除该分类吗？",function(f){if(f=="yes"){if(e){var g="";g+=e[0].get("sid");a.deleteRecord(g)}}})}}.createDelegate(this)},"-","<span style='color:#999'>"+lang("dblclickToEdit")+"</span>","->",{xtype:"cnoa_helpBtn",helpid:13}]})});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:true,items:[this.centerPanel]})},makeType:function(f,d,a,g,c,e){var b=f=="user"?"自定义":"系统分类";return b},editPanel:function(a){var b=this;b.edit_id=a;this.showAddEditWindow("sortEdit")},showAddEditWindow:function(b){var g=this;var e=b=="sortEdit"?"修改分类":"添加分类";var f=function(){var h=a.getForm();h.load({url:g.baseUrl+"&task=sortLoadFormData",params:{sid:g.edit_id},method:"POST",waitMsg:lang("waiting"),success:function(i,j){if(j.result.data.type=="sys"){}}.createDelegate(this),failure:function(i,j){d.close();CNOA.msg.alert(j.result.msg,function(){})}.createDelegate(this)})};var a=new Ext.form.FormPanel({labelAlign:"right",waitMsgTarget:true,border:false,bodyStyle:"padding: 10px;",items:[{xtype:"textfield",width:320,fieldLabel:"分类名称",allowBlank:false,name:"name"},{xtype:"textarea",fieldLabel:lang("remark"),name:"about",width:320,height:100},{xtype:"textarea",id:this.ID_textarea_deptNames,height:60,width:320,readOnly:true,fieldLabel:"流程查看部门",name:"deptNames"},{xtype:"hidden",name:"deptIds"},{xtype:"deptMultipleSelector",autoWidth:true,style:"margin-left:105px;",id:this.ID_button_deptNames,deptListUrl:this.baseUrl+"&task=getStructTree",listeners:{selected:function(j,h,i){a.getForm().findField("deptNames").setValue(h);a.getForm().findField("deptIds").setValue(i)},load:function(h){h.setSelectedIds(a.getForm().findField("deptIds").getValue())}}},{xtype:"textarea",height:60,width:320,readOnly:true,fieldLabel:"流程删除权限(选择人)",name:"allUserNames"},{xtype:"hidden",name:"allUids"},{xtype:"btnForPoepleSelector",autoWidth:true,id:this.ID_allUserButton,dataUrl:g.baseUrl+"&task=getAllUserListsInPermitDeptTree",style:"margin-left:105px;",text:lang("selectPeople"),listeners:{selected:function(k,l){var m=new Array();var j=new Array();if(l.length>0){for(var h=0;h<l.length;h++){m.push(l[h].uname);j.push(l[h].uid)}}a.getForm().findField("allUserNames").setValue(m.join(","));a.getForm().findField("allUids").setValue(j.join(","))},onrender:function(h){h.setSelectedUids(a.getForm().findField("allUids").getValue().split(","))}}}],listeners:{afterrender:function(h){if(b=="sortEdit"){f()}}}});var d=new Ext.Window({title:e,modal:true,layout:"fit",width:500,height:400,resizable:false,items:[a],buttons:[{text:lang("save"),id:g.ID_btn_addedit_save,iconCls:"icon-order-s-accept",handler:function(){c()}},{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){d.close()}}]}).show();var c=function(){var i=a.getForm();if(i.isValid()){i.submit({url:g.baseUrl+"&task="+b,waitTitle:lang("notice"),method:"POST",waitMsg:lang("waiting"),params:{sid:g.edit_id},success:function(j,k){g.store.reload();CNOA.msg.notice(k.result.msg,"工作流管理");d.close()}.createDelegate(this),failure:function(j,k){CNOA.msg.alert(k.result.msg,function(){}.createDelegate(this))}.createDelegate(this)})}else{var h=Ext.getCmp(g.ID_btn_addedit_save).getEl().getBox();h=[h.x+35,h.y+26];CNOA.miniMsg.alert(lang("formValid"),h)}}},deleteRecord:function(a){var b=this;Ext.Ajax.request({url:b.baseUrl+"&task=sortDelete",method:"POST",params:{sid:a},success:function(d){var c=Ext.decode(d.responseText);if(c.success===true){CNOA.msg.notice(c.msg,"工作流管理");b.store.reload()}else{CNOA.msg.alert(c.msg)}}})}};var CNOA_flow_flow_manage_flowlistClass,CNOA_flow_flow_manage_flowlist;CNOA_flow_flow_manage_flowlistClass=CNOA.Class.create();CNOA_flow_flow_manage_flowlistClass.prototype={init:function(){var a=this;this.edit_id=0;this.sort=0;this.baseUrl="index.php?app=flow&func=flow&action=manage";this.ID_btn_edit=Ext.id();this.ID_btn_delete=Ext.id();this.ID_tree_treeRoot=Ext.id();this.fields=[{name:"ulid"},{name:"lid"},{name:"name"},{name:"flowname"},{name:"title"},{name:"level"},{name:"stepText"},{name:"uname"},{name:"posttime"},{name:"status"},{name:"allowOperate"}];this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getdealflowJsonData",disableCaching:true}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields})});this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.store.load();this.colModel=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"ulid",dataIndex:"ulid",hidden:true},{header:"流程编号 / 标题",dataIndex:"name",width:240,sortable:true,menuDisabled:true,renderer:this.makeTitle.createDelegate(this)},{header:"所属流程",dataIndex:"flowname",width:120,sortable:true,menuDisabled:true},{header:"重要等级",dataIndex:"level",width:60,sortable:false,menuDisabled:true},{header:"当前步骤",dataIndex:"stepText",width:150,sortable:false,menuDisabled:true},{header:"状态",dataIndex:"status",width:50,sortable:false,menuDisabled:true,renderer:this.makeStatus.createDelegate(this)},{header:"发起人 / 发起日期",dataIndex:"uname",width:150,sortable:false,menuDisabled:true,renderer:this.makeUname.createDelegate(this)},{header:"查看 / 操作",dataIndex:"ulid",width:150,sortable:false,menuDisabled:true,renderer:this.makeOperate.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.pagingBar=new Ext.PagingToolbar({displayInfo:true,store:this.store,pageSize:15,listeners:{beforechange:function(b,c){c.sort=a.sort}}});this.grid=new Ext.grid.GridPanel({stripeRows:true,store:this.store,loadMask:{msg:lang("waiting")},cm:this.colModel,hideBorders:true,border:false,region:"center",viewConfig:{},listeners:{rowdblclick:function(b,c){},rowclick:function(b,f,c,d){}},tbar:new Ext.Toolbar({items:[{iconCls:"icon-system-refresh",text:lang("refresh"),handler:function(b,c){a.store.reload()}.createDelegate(this)},"->",{xtype:"cnoa_helpBtn",helpid:9}]}),bbar:this.pagingBar});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.grid]})},makeTitle:function(f,d,a,g,b,e){var c=a.data;return f+"<br /><span class='cnoa_color_gray'>标题: "+c.title+"</span>"},makeUname:function(f,d,a,g,b,e){var c=a.data;return f+"<br /><span class='cnoa_color_gray'>"+c.posttime+"</span>"},makeStatus:function(a){var b="";if(a==0){b="<span class='cnoa_color_gray'>未发送</span>"}else{if(a==1){b="<span class='cnoa_color_orange'>办理中</span>"}else{if(a==2){b="<span class='cnoa_color_green'>已办理</span>"}else{if(a==3){b="<span class='cnoa_color_red'>已退件</span> "}else{if(a==4){b="<span class='cnoa_color_gray'>已撤销</span>"}}}}}return b},makeOperate:function(j,g,d,i,f,a){var k=d.data;var b=k.status;var e=k.allowOperate;var c="";c+="<a href='javascript:void(0);' onclick='CNOA_flow_flow_manage_flowlist.showFlow("+j+");' ext:qtip='查看详细内容'>查看</a>";c+="&nbsp;&nbsp;";c+="<a href='javascript:void(0);' onclick='CNOA_flow_flow_manage_flowlist.viewFlowEvent("+j+', "'+k.name+"\");' ext:qtip='查看流程事件日志'>事件</a>";c+="&nbsp;&nbsp;";c+="<a href='javascript:void(0);' onclick='CNOA_flow_flow_manage_flowlist.viewFlowProgress("+j+', "'+k.name+"\");' ext:qtip='查看流程办理进度'>进度</a>";c+="&nbsp;&nbsp;";c+="<a href='javascript:void(0);' onclick='CNOA_flow_flow_manage_flowlist.viewFlow2("+k.lid+', "'+k.flowname+"\");' ext:qtip='查看流程图'>[流程图]</a>";c+="<br />";c+=e==1?"<a href='javascript:void(0);' onclick='CNOA_flow_flow_manage_flowlist.viewFlow("+j+");' ext:qtip='办理流程'><span class='cnoa_color_red'>办理</span></a>":"<span class='cnoa_color_gray2'>办理</span>";return c},showFlow:function(a){mainPanel.closeTab("CNOA_MENU_FLOW_USER_VIEWFLOW");mainPanel.loadClass("index.php?app=flow&func=flow&action=user&task=loadPage&from=showflow&ulid="+a,"CNOA_MENU_FLOW_USER_SHOWFLOW","查看工作流程","icon-flow")},viewFlow:function(a){mainPanel.closeTab("CNOA_MENU_FLOW_USER_VIEWFLOW");mainPanel.loadClass("index.php?app=flow&func=flow&action=user&task=loadPage&from=viewflow&ulid="+a,"CNOA_MENU_FLOW_USER_VIEWFLOW","查看工作流程","icon-flow")},viewFlow2:function(b,a){CNOA_flow_flow_flowpreview=new CNOA_flow_flow_flowpreviewClass(b,a);CNOA_flow_flow_flowpreview.show()},viewFlowEvent:function(b,d){var c=new CNOA_flow_flow_flowViewEventClass(b,false);var a=new Ext.Window({title:"查看流程详细事件 - "+d,layout:"fit",width:650,height:300,modal:true,maximizable:true,items:[c.grid],buttons:[{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){a.close()}.createDelegate(this)}]}).show()},viewFlowProgress:function(b,d){var c=new CNOA_flow_flow_flowViewProgressClass(b,false);var a=new Ext.Window({title:"查看流程详细进度 - "+d,layout:"fit",width:650,height:300,modal:true,maximizable:true,items:[c.grid],buttons:[{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){a.close()}.createDelegate(this)}]}).show()}};var cnoa_flow_user_flow_attach_btn="";function makeFlowAttacBtn(g,e,d,f){var c=function(j,a){var i,l="none";var k=j.substring(j.lastIndexOf(".")+1).toLowerCase();switch(k){case"jpg":case"bmp":case"png":i="jpg.gif";l="pic";break;case"rar":case"zip":case"7z":i="rar.gif";break;case"txt":i="txt.gif";l="txt";break;case"xls":case"xlsx":i="excel.gif";l="xls";break;case"doc":case"docx":i="word.gif";l="doc";break;default:i="file.gif";break}if(a==true){return l}else{return'<img src="./resources/images/icons_file/'+i+'" width=16 height=16 align="absmiddle" >'+j+" ("+f+")"}};var b=Ext.fly(g);b.dom.innerHTML=c(d);var h=new Ext.menu.Menu({id:"menu_"+g,items:[{text:d,disabled:true},"-",{xtype:"swfdownloadmenuitem",text:"下载",iconCls:"icon-file-down",dlurl:e,dlname:d},{text:"查看 / 预览",hidden:(c(d,true)=="pic"||c(d,true)=="txt"||c(d,true)=="xls")?false:true,handler:function(){window.open("./resources/preview.php?url="+encodeURIComponent(e))}},{text:"编辑",pressed:false,hidden:true,handler:function(){window.open("./index.php?action=commonJob&act=viewDocForActivex&url="+encodeURIComponent(e))}}]});b.dom.onmouseover=function(a){try{Ext.getCmp(cnoa_flow_user_flow_attach_btn).hide();Ext.fly(cnoa_flow_user_flow_attach_btn.replace("menu_","")).dom.style.backgroundColor="#F2E6E6"}catch(j){}Ext.fly(g).dom.style.backgroundColor="#CEC1FF";if(Ext.isIE){i=[window.event.clientX,window.event.clientY]}else{var i=[a.clientX,a.clientY]}h.showAt(i);cnoa_flow_user_flow_attach_btn="menu_"+g}}var CNOA_flow_flow_flowViewReaderClass=CNOA.Class.create();CNOA_flow_flow_flowViewReaderClass.prototype={init:function(a){var b=this;this.ulid=a;this.baseUrl="index.php?app=flow&func=flow&action=user";this.fields=[{name:"jid"},{name:"name"},{name:"viewtime"},{name:"say"}];this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getReaderList&ulid="+this.ulid,disableCaching:true}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields})});this.store.load();this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.colModel=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"名字",dataIndex:"name",width:100,sortable:false,menuDisabled:true},{header:"所属部门",dataIndex:"jid",width:124,sortable:true,menuDisabled:true},{header:"评阅内容",dataIndex:"say",width:267,sortable:true,menuDisabled:true},{header:"日期",dataIndex:"viewtime",width:100,sortable:true,menuDisabled:true},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.grid=new Ext.grid.GridPanel({stripeRows:true,store:this.store,bodyStyle:"border-left-width:1px;",loadMask:{msg:lang("waiting")},cm:this.colModel,sm:this.sm,hideBorders:true,border:false,autoHeight:true,viewConfig:{},listeners:{rowclick:function(d,h,g){var c=d.getStore().getAt(h);var f=new Ext.Window({title:"查看流程评阅意见",layout:"fit",width:400,height:260,modal:true,maximizable:true,items:[{xtype:"panel",border:false,autoScroll:true,bodyStyle:"padding:10px;",html:c.data.say.replace(/\r\n/ig,"<br />").replace(/\n/ig,"<br />")}],buttons:[{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){f.close()}.createDelegate(this)}]}).show()}}})},showSay:function(){var d=this;var a=new Ext.form.FormPanel({border:false,hideBorders:true,labelWidth:70,labelAlign:"right",waitMsgTarget:true,autoScroll:true,bodyStyle:"padding-top:10px;",listeners:{render:function(e){}},items:[{xtype:"textarea",anchor:"-25 -25",name:"say",allowBlank:false,fieldLabel:"评阅意见",value:"同意"}]});var c=new Ext.Window({width:440,height:310,title:"发表评阅意见",resizable:true,modal:true,layout:"fit",items:[a],tbar:new Ext.Toolbar({items:"如果已经发表过意见，则本次意见会替换掉原来的意见"}),buttons:[{text:lang("ok"),iconCls:"icon-btn-save",handler:function(){b()}.createDelegate(this)},{text:lang("cancel"),iconCls:"icon-dialog-cancel",handler:function(){c.close()}.createDelegate(this)}]}).show();var b=function(){if(a.getForm().isValid()){a.getForm().submit({url:d.baseUrl+"&task=addDispenseSay",waitTitle:lang("notice"),method:"POST",waitMsg:lang("waiting"),params:{ulid:d.ulid},success:function(e,f){CNOA.msg.notice(f.result.msg,"工作流管理");d.store.load();c.close()}.createDelegate(this),failure:function(e,f){CNOA.msg.alert(f.result.msg,function(){c.close()}.createDelegate(this))}.createDelegate(this)})}}}};var CNOA_flow_flow_flowViewProgressClass=CNOA.Class.create();CNOA_flow_flow_flowViewProgressClass.prototype={init:function(c,b,a){var d=this;this.baseUrl="index.php?app=flow&func=flow&action=user";this.ulid=c;if(b==undefined){this.autoHeight=true}else{this.autoHeight=b}if(a==undefined){this.autoGroup=true}else{this.autoGroup=a}this.renderProgressStatusText=function(m,j,g,k,i,e){var n=g.data.status;var l="#00000";if(n==1){l="#FF0000"}else{if(n==2){l="#008000"}else{if(n==3){l="#FF00FF"}else{if(n==4){l="#808080"}}}}var f="<span style='color:"+l+";'>"+m+"</span>";return f};this.renderNodenameText=function(i,g,e,j,f,h){return"<span ext:qtip='"+i+"'>"+i+"</span>"};this.renderProgressOperatText=function(l,j,e,m,g,k){var i=e.data;var f=l+"<br /><span style='color:#808080;'>"+i.stime+"</span>";return f};this.fields=[{name:"unid"},{name:"status"},{name:"statusText"},{name:"stepid"},{name:"uname"},{name:"stime"},{name:"utime"},{name:"say"},{name:"nodename"},{name:"nodetype"}];if(this.autoGroup){this.store=new Ext.data.GroupingStore({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getProgressList&ulid="+this.ulid}),reader:new Ext.data.JsonReader({totalProperty:"totalPorperty",root:"data",fields:this.fields}),sortInfo:{field:"unid",direction:"ASC"},groupOnSort:false,groupField:"nodename",sortData:function(){}})}else{this.store=new Ext.data.GroupingStore({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getProgressList&ulid="+this.ulid}),reader:new Ext.data.JsonReader({totalProperty:"totalPorperty",root:"data",fields:this.fields})})}this.store.load({params:{start:0,limit:15}});this.grid=new Ext.grid.GridPanel({stripeRows:true,store:this.store,autoScroll:true,hideBorders:true,border:false,columns:[new Ext.grid.RowNumberer(),{header:"unid",width:10,sortable:true,dataIndex:"unid",hidden:true},{header:"步骤名称",width:160,sortable:true,dataIndex:"nodename",renderer:this.renderNodenameText},{header:"状态",width:60,sortable:true,dataIndex:"statusText",renderer:this.renderProgressStatusText},{header:"经办人 / 开始时间",width:250,sortable:true,dataIndex:"uname",renderer:this.renderProgressOperatText},{header:"持续时间",width:60,sortable:true,dataIndex:"utime"},{header:"办理理由",width:160,sortable:true,dataIndex:"say",id:"say"}],autoExpandColumn:"say",autoHeight:this.autoHeight,listeners:{rowclick:function(f,h){var e=f.getStore().getAt(h);var g=new Ext.Window({title:"查看流程事件办理理由",layout:"fit",width:400,height:260,modal:true,maximizable:true,items:[{xtype:"panel",border:false,autoScroll:true,bodyStyle:"padding:10px;",html:e.data.say.replace(/\r\n/ig,"<br />").replace(/\n/ig,"<br />")}],buttons:[{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){g.close()}.createDelegate(this)}]}).show()}}})}};var CNOA_flow_flow_flowViewEventClass=CNOA.Class.create();CNOA_flow_flow_flowViewEventClass.prototype={init:function(b,a){var c=this;this.baseUrl="index.php?app=flow&func=flow&action=user";this.ulid=b;this.autoHeight=a==undefined?true:false;this.renderEventType=function(l,i,f,j,g,d){var m=f.data;var k="#00000";if(m.type==1){k="#FF0000"}else{if(m.type==2){k="#008000"}else{if(m.type==3){k="#FF8040"}else{if(m.type==4){k="#FF00FF"}else{if(m.type==5){k="#008000"}else{if(m.type==6){k="#408080"}else{if(m.type==7){k="#0080FF"}}}}}}}var e="<span style='color:#FFF;display:block;height:16px;background-color:"+k+";text-indent:3px;'>"+m.typename+"</span>";return e};this.renderStepnameText=function(h,f,d,i,e,g){return"<span ext:qtip='"+h+"'>"+h+"</span>"};this.renderEventOther=function(i,g,d){var f=d.data;var e=f.uname+"<br />";e+="<span style='color:#8C8C8C'>"+f.posttime+"</span>";return e};this.fields=[{name:"eid"},{name:"type"},{name:"typename"},{name:"title"},{name:"say"},{name:"uname"},{name:"stepname"},{name:"posttime"}];this.store=new Ext.data.GroupingStore({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getEventList&ulid="+c.ulid}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields})});this.store.load();this.colModel=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"eid",dataIndex:"eid",width:20,sortable:true,menuDisabled:true,hidden:true},{header:"类型",dataIndex:"type",width:80,menuDisabled:true,sortable:true,renderer:this.renderEventType.createDelegate(this)},{header:"步骤",dataIndex:"stepname",width:100,menuDisabled:true,sortable:true,renderer:this.renderStepnameText.createDelegate(this)},{header:"经办人 / 时间",dataIndex:"other",width:150,sortable:false,resizable:false,menuDisabled:true,renderer:this.renderEventOther.createDelegate(this)},{header:"办理理由(点击查看)",dataIndex:"say",id:"say",width:260,menuDisabled:true,sortable:false}]);this.grid=new Ext.grid.GridPanel({stripeRows:true,ds:this.store,autoScroll:true,loadMask:{msg:lang("waiting")},cm:this.colModel,hideBorders:true,border:false,autoHeight:this.autoHeight,autoExpandColumn:"say",listeners:{cellclick:function(d,j,f,i){var g=d.getStore().getAt(j).data;if(g.say!=""){var h=new Ext.Window({title:"查看流程事件办理理由",layout:"fit",width:400,height:260,modal:true,maximizable:true,items:[{xtype:"panel",border:false,autoScroll:true,bodyStyle:"padding:10px;",html:g.say.replace(/\r\n/ig,"<br />").replace(/\n/ig,"<br />")}],buttons:[{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){h.close()}.createDelegate(this)}]}).show()}}}})}};var CNOA_flow_flow_flowpreviewClass,CNOA_flow_flow_flowpreview;CNOA_flow_flow_flowpreviewClass=CNOA.Class.create();CNOA_flow_flow_flowpreviewClass.prototype={init:function(b,a){var c=this;this.ID_window_numberTip=Ext.id();this.ID_btn_addedit_save=Ext.id();this.ID_CNOA_flow_flow_setting_design_ct=Ext.id();this.ID_DESIGN_BUTTON="flow_flow_user_flowpreview_button_";this.ID_DESIGN_LINE="flow_flow_user_flowpreview_line_";this.flowId=b;this.flowName=a;this.data=null;this.newStepCount=1;this.baseUrl="index.php?app=flow&func=flow&action=user";this.treeRoot=new Ext.tree.TreeNode({expanded:true});this.treePanel=new Ext.tree.TreePanel({root:this.treeRoot,border:false,id:"flow_flow_preview",rootVisible:false});this.rightPanel=new Ext.Panel({border:false,region:"east",width:180,minWidth:180,maxWidth:180,split:true,autoScroll:true,bodyStyle:"padding-top:4px;",items:[this.treePanel]});this.centerPanel=new Ext.Panel({border:false,region:"center",autoScroll:true,bodyStyle:"background:#FFF url('./resources/images/mxgraph/grid.gif');",html:"<table width='100%' border='0' cellspacing='0' cellpadding='0'><tr><td align='center' valign='top' style='padding-top:20px;'><div id='"+this.ID_CNOA_flow_flow_setting_design_ct+"'></div></td></tr></table>",listeners:{afterrender:function(d){c.readFlowData()}}});this.mainPanel=new Ext.Window({title:"查看流程 - "+this.flowName,width:700,height:makeWindowHeight(600),layout:"border",modal:true,maximizable:true,resizable:true,items:[this.centerPanel,this.rightPanel],buttons:[{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){c.close()}}],listeners:{close:function(){},afterrender:function(d){d.el.on("contextmenu",function(f){f.preventDefault()},this)}}})},show:function(){this.mainPanel.show()},close:function(){this.mainPanel.close()},readFlowData:function(){var a=this;a.mainPanel.getEl().mask(lang("waiting"));Ext.Ajax.request({url:a.baseUrl+"&task=flowpreviewLoadData",method:"POST",params:{lid:a.flowId},success:function(c){var b=Ext.decode(c.responseText);if(b.success===true){if(b.data.length<1){a.data=[{name:"开始",id:"0",type:"start"}]}else{a.data=b.data}}else{CNOA.msg.alert(b.msg)}a.makeFlowViewport();a.mainPanel.getEl().unmask()}})},makeFlowViewport:function(){var f=this;document.getElementById(f.ID_CNOA_flow_flow_setting_design_ct).innerHTML="";var b=0;Ext.each(f.data,function(e,g,h){f.createButton(e.id,e.name,e.type);f.createLine(e.id);b=e.id});try{var d=document.getElementById(f.ID_CNOA_flow_flow_setting_design_ct);var a=document.getElementById(f.ID_DESIGN_LINE+b);d.removeChild(a)}catch(c){}},deleteNode:function(b){var d=this;var a=new Array();var c=0;Ext.each(d.data,function(e,f,g){if(e.id!=b){e.id=c;a.push(e);c++}});d.data=a;d.makeFlowViewport()},addNode:function(c){var e=this;var a=new Array();var b={name:"新步骤"+this.newStepCount++,type:"node"};var d=0;Ext.each(e.data,function(f,g,h){f.id=d;a.push(f);d++;if(f.id==c){b.id=d;a.push(b);d++}});e.data=a;e.makeFlowViewport()},createButton:function(d,a,b){var c=this;new Ext.Button({text:a,scale:"large",btype:b,id:this.ID_DESIGN_BUTTON+d,enableToggle:true,toggleGroup:"flow_flow_setting_design_btn",renderTo:c.ID_CNOA_flow_flow_setting_design_ct,autoWidth:true,handler:function(e){e.toggle(true)},listeners:{render:function(e){},toggle:function(f,e){if(e){c.makeViewTreeData(d)}}}})},makeViewTreeData:function(l){var r=this;var k=function(B,e){return new Ext.tree.TreeNode({iconCls:e?"icon-none":"icon-fileview-column2",text:B,expanded:true})};var i=r.getDataById(l);if((i.operator===null)||(i.operator===undefined)){i.operator={user:[],station:[]}}var x=k("<b>步骤名称</b>",false);var v=k("<span style='color:#616161'>"+i.name+"</span>",true);x.appendChild(v);var g=k("<b>上一步骤名称</b>",false);var d=k("<span style='color:#616161'>"+r.getDataById(parseInt(l)-1).name+"</span>",true);g.appendChild(d);var p=k("<b>下一步骤名称</b>",false);var n=k("<span style='color:#616161'>"+r.getDataById(parseInt(l)+1).name+"</span>",true);p.appendChild(n);var A=k("<b>经办角色</b>",false);var y=k("<b>人员</b>",false);var u=k("<b>岗位</b>",false);try{Ext.each(i.operator.user,function(e,B){var C=k("<span style='color:#616161'>"+e.name+"</span>",true);y.appendChild(C)});if(i.operator.user.length==0){}}catch(t){}try{Ext.each(i.operator.station,function(e,B){var C=k("<span style='color:#616161'>"+e.name+"</span>",true);u.appendChild(C)});if(i.operator.station.length==0){}}catch(t){}A.appendChild(y);A.appendChild(u);if(i.id==0){if((i.operator.station.length==0)&&(i.operator.user.length==0)){A.childNodes=[];A.appendChild(k("<span style='color:#616161'>任意人</span>",true))}}var a=k("<b>表单字段</b>",false);var z=k("<b>可填字段</b>",true);var w=k("<b>必填字段</b>",true);Ext.each(i.formitems,function(e,B){if(e.need){z.appendChild(k("<span style='color:#616161'>"+e.name+"</span>",true))}if(e.must){w.appendChild(k("<span style='color:#616161'>"+e.name+"</span>",true))}});a.appendChild(z);a.appendChild(w);var j=i.operatorperson=="2"?"<span style='color:#616161'>多人办理</span>":"<span style='color:#616161'>单人办理</span>";var s=i.operatortype=="1"?"<span style='color:#616161'>任意一人同意</span>":"<span style='color:#616161'>所有人同意</span>";var h=k("<b>经办方式</b>",false);var f=k("<span style='color:#616161'>"+j+"</span>",true);h.appendChild(f);if(i.operatorperson=="2"){var c=k("<b>转下一步条件: </b>",false);var b=k("<span style='color:#616161'>"+s+"</span>",true);c.appendChild(b);h.appendChild(c)}var q=k("<b>允许操作</b>",false);if(parseInt(i.upAttach)==1){var o=k("<span style='color:#616161'>允许上传附件</span>",true);q.appendChild(o)}if(parseInt(i.downAttach)==1){var m=k("<span style='color:#616161'>允许下载附件</span>",true);q.appendChild(m)}r.treeRoot=new Ext.tree.TreeNode({expanded:true});if(i.type=="end"){r.treeRoot.appendChild([x,g])}else{r.treeRoot.appendChild([x,g,p,A,a,h,q])}r.treePanel.setRootNode(r.treeRoot)},getDataById:function(c){var b=this;c=parseInt(c);if((c<0)||(c>b.data.length-1)){return{name:"无",id:"-1"}}var a;Ext.each(b.data,function(d,e,f){if(d.id==c){a=d}});return a},createLine:function(a){var b=this;new Ext.BoxComponent({id:this.ID_DESIGN_LINE+a,renderTo:b.ID_CNOA_flow_flow_setting_design_ct,autoEl:{tag:"div",html:'<img src="./resources/images/cnoa/arrow.gif" />'}})}};var CNOA_flow_flow_user_dealflowClass,CNOA_flow_flow_user_dealflow;CNOA_flow_flow_user_dealflowClass=CNOA.Class.create();CNOA_flow_flow_user_dealflowClass.prototype={init:function(){var a=this;this.edit_id=0;this.sort=0;this.baseUrl="index.php?app=flow&func=flow&action=user";this.ID_btn_edit=Ext.id();this.ID_btn_delete=Ext.id();this.ID_tree_treeRoot=Ext.id();this.ID_find_name=Ext.id();this.ID_find_title=Ext.id();this.ID_find_beginTime=Ext.id();this.ID_find_endTime=Ext.id();this.ID_find_status=Ext.id();this.ID_find_buildUser=Ext.id();this.ID_find_getUser=Ext.id();this.ID_find_flowFrom=Ext.id();this.searchParams={name:"",title:"",beginTime:"",endTime:"",status:0,buildUser:"",flowFrom:""};this.fields=[{name:"ulid"},{name:"lid"},{name:"name"},{name:"flowname"},{name:"title"},{name:"level"},{name:"stepText"},{name:"uname"},{name:"posttime"},{name:"status"},{name:"allowOperate"},{name:"flowtype"}];this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getdealflowJsonData",disableCaching:true}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields})});this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.store.load();this.colModel=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"ulid",dataIndex:"ulid",hidden:true},{header:"流程编号 / 标题",dataIndex:"name",width:240,sortable:true,menuDisabled:true,renderer:this.makeTitle.createDelegate(this)},{header:"所属流程",dataIndex:"flowname",width:120,sortable:true,menuDisabled:true},{header:"重要等级",dataIndex:"level",width:60,sortable:false,menuDisabled:true},{header:"当前步骤",dataIndex:"stepText",width:150,sortable:false,menuDisabled:true},{header:"状态",dataIndex:"status",width:50,sortable:false,menuDisabled:true,renderer:this.makeStatus.createDelegate(this)},{header:"发起人 / 发起日期",dataIndex:"uname",width:150,sortable:false,menuDisabled:true,renderer:this.makeUname.createDelegate(this)},{header:"查看 / 操作",dataIndex:"ulid",width:150,sortable:false,menuDisabled:true,renderer:this.makeOperate.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.pagingBar=new Ext.PagingToolbar({displayInfo:true,store:this.store,pageSize:15,listeners:{beforechange:function(b,c){Ext.apply(c,a.searchParams)}}});this.grid=new Ext.grid.GridPanel({stripeRows:true,store:this.store,loadMask:{msg:lang("waiting")},cm:this.colModel,hideBorders:true,border:false,region:"center",viewConfig:{},listeners:{rowdblclick:function(b,c){},rowclick:function(b,f,c,d){}},tbar:new Ext.Toolbar({items:[{iconCls:"icon-system-refresh",text:lang("refresh"),handler:function(b,c){a.store.reload()}.createDelegate(this)},"->",{xtype:"cnoa_helpBtn",helpid:14}]}),bbar:this.pagingBar});this.flowFrom=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:a.baseUrl+"&task=getFlowFrom",disableCaching:true}),reader:new Ext.data.JsonReader({root:"data",fields:[{name:"sid"},{name:"name"}]}),listeners:{load:function(c,b){}},autoLoad:true});this.gridCt=new Ext.Panel({border:false,layout:"fit",items:[this.grid],region:"center",listeners:{afterrender:function(){new Ext.Toolbar({style:"border-left-width:1px;",items:["发起开始时间：",{xtype:"datefield",width:100,format:"Y-m-d",editable:false,allowBlank:true,id:a.ID_find_beginTime}," 发起最后时间：",{xtype:"datefield",width:100,format:"Y-m-d",editable:false,allowBlank:true,id:a.ID_find_endTime},{xtype:"hidden",id:a.ID_find_buildUser},"发起人",{xtype:"triggerForPeople",dataUrl:a.baseUrl+"&task=getAllUserListsInPermitDeptTree",width:100,id:a.ID_find_getUser,listeners:{selected:function(d,c,b){Ext.getCmp(a.ID_find_buildUser).setValue(c)}}},"所属流程分类",{xtype:"combo",id:a.ID_find_flowFrom,width:130,name:"flowFrom",valueField:"sid",hiddenName:"worktimeId",displayField:"name",triggerAction:"all",mode:"local",editable:false,store:a.flowFrom,listeners:{select:function(d,b,c){}}},"-",{text:lang("search"),handler:function(){a.searchParams={name:Ext.getCmp(a.ID_find_name).getValue(),title:Ext.getCmp(a.ID_find_title).getValue(),beginTime:Ext.getCmp(a.ID_find_beginTime).getRawValue(),endTime:Ext.getCmp(a.ID_find_endTime).getRawValue(),status:Ext.getCmp(a.ID_find_status).getValue(),buildUser:Ext.getCmp(a.ID_find_buildUser).getValue(),flowFrom:Ext.getCmp(a.ID_find_flowFrom).getValue()};a.store.load({params:a.searchParams})}},"-",{text:lang("clear"),handler:function(){Ext.getCmp(a.ID_find_name).setValue("");Ext.getCmp(a.ID_find_title).setValue("");Ext.getCmp(a.ID_find_beginTime).setRawValue("");Ext.getCmp(a.ID_find_endTime).setRawValue("");Ext.getCmp(a.ID_find_status).setValue(-99);Ext.getCmp(a.ID_find_buildUser).setValue("");Ext.getCmp(a.ID_find_getUser).setValue("");Ext.getCmp(a.ID_find_flowFrom).setValue("");a.searchParams={name:"",title:"",beginTime:"",endTime:"",status:0,buildUser:"",flowFrom:""};a.store.load()}}]}).render(this.tbar)}},tbar:new Ext.Toolbar({style:"border-left-width:1px;",items:["标题：",{xtype:"textfield",width:200,id:a.ID_find_title}," 编号名称",{xtype:"textfield",width:150,id:a.ID_find_name},"当前状态：",{xtype:"combo",id:a.ID_find_status,editable:false,mode:"local",triggerAction:"all",valueField:"value",displayField:"display",store:new Ext.data.ArrayStore({fields:["value","display"],data:[[-99,""],[-1,"已删除"],[0,"未发布"],[1,"办理中"],[2,"已办理"],[3,"已退件"],[4,"已撤销"]]}),value:-99}]})});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.gridCt]})},makeTitle:function(f,d,a,g,b,e){var c=a.data;return f+"<br /><span class='cnoa_color_gray'>标题: "+c.title+"</span>"},makeUname:function(f,d,a,g,b,e){var c=a.data;return f+"<br /><span class='cnoa_color_gray'>"+c.posttime+"</span>"},makeStatus:function(a){var b="";if(a==0){b="<span class='cnoa_color_gray'>未发送</span>"}else{if(a==1){b="<span class='cnoa_color_orange'>办理中</span>"}else{if(a==2){b="<span class='cnoa_color_green'>已办理</span>"}else{if(a==3){b="<span class='cnoa_color_red'>已退件</span> "}else{if(a==4){b="<span class='cnoa_color_gray'>已撤销</span>"}}}}}return b},makeOperate:function(j,g,d,i,f,a){var k=d.data;var b=k.status;var e=k.allowOperate;var c="";c+="<a href='javascript:void(0);' onclick='CNOA_flow_flow_user_dealflow.showFlow("+j+", "+k.flowtype+");' ext:qtip='查看详细内容'>查看</a>";c+="&nbsp;&nbsp;";c+="<a href='javascript:void(0);' onclick='CNOA_flow_flow_user_dealflow.viewFlowEvent("+j+', "'+k.name+"\");' ext:qtip='查看流程事件日志'>事件</a>";c+="&nbsp;&nbsp;";c+="<a href='javascript:void(0);' onclick='CNOA_flow_flow_user_dealflow.viewFlowProgress("+j+', "'+k.name+"\");' ext:qtip='查看流程办理进度'>进度</a>";c+="&nbsp;&nbsp;";c+=k.flowtype=="0"?"<a href='javascript:void(0);' onclick='CNOA_flow_flow_user_dealflow.viewFlow2("+k.lid+', "'+k.flowname+"\");' ext:qtip='查看流程图'>[流程图]</a>":"";c+="<br />";c+=e==1?"<a href='javascript:void(0);' onclick='CNOA_flow_flow_user_dealflow.viewFlow("+j+", "+k.flowtype+");' ext:qtip='办理流程'><span class='cnoa_color_red'>办理</span></a>":"<span class='cnoa_color_gray2'>办理</span>";return c},showFlow:function(b,a){mainPanel.closeTab("CNOA_MENU_FLOW_USER_SHOWFLOW");if(a=="0"){mainPanel.loadClass("index.php?app=flow&func=flow&action=user&task=loadPage&from=showflow&ulid="+b,"CNOA_MENU_FLOW_USER_SHOWFLOW","查看工作流程","icon-flow")}else{if(a=="1"){mainPanel.loadClass("index.php?app=flow&func=flow&action=user&module=commonFlow&task=loadPage&from=showflow&ulid="+b,"CNOA_MENU_FLOW_USER_SHOWFLOW","查看工作流程","icon-flow")}}},viewFlow:function(b,a){mainPanel.closeTab("CNOA_MENU_FLOW_USER_VIEWFLOW");if(a==0){mainPanel.loadClass("index.php?app=flow&func=flow&action=user&task=loadPage&from=viewflow&ulid="+b,"CNOA_MENU_FLOW_USER_VIEWFLOW","办理工作流程","icon-flow")}else{if(a==1){mainPanel.loadClass("index.php?app=flow&func=flow&action=user&module=commonFlow&task=loadPage&from=viewflow&ulid="+b,"CNOA_MENU_FLOW_USER_VIEWFLOW","办理工作流程","icon-flow")}}},viewFlow2:function(b,a){CNOA_flow_flow_flowpreview=new CNOA_flow_flow_flowpreviewClass(b,a);CNOA_flow_flow_flowpreview.show()},viewFlowEvent:function(b,d){var c=new CNOA_flow_flow_flowViewEventClass(b,false);var a=new Ext.Window({title:"查看流程详细事件 - "+d,layout:"fit",width:650,height:300,modal:true,maximizable:true,items:[c.grid],buttons:[{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){a.close()}.createDelegate(this)}]}).show()},viewFlowProgress:function(b,d){var c=new CNOA_flow_flow_flowViewProgressClass(b,false);var a=new Ext.Window({title:"查看流程详细进度 - "+d,layout:"fit",width:650,height:300,modal:true,maximizable:true,items:[c.grid],buttons:[{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){a.close()}.createDelegate(this)}]}).show()}};var CNOA_flow_flow_user_entrustflowClass,CNOA_flow_flow_user_entrustflow;CNOA_flow_flow_user_entrustflowClass=CNOA.Class.create();CNOA_flow_flow_user_entrustflowClass.prototype={init:function(){var a=this;this.edit_id=0;this.sort=0;this.baseUrl="index.php?app=flow&func=flow&action=user";this.ID_btn_edit=Ext.id();this.ID_btn_delete=Ext.id();this.ID_tree_treeRoot=Ext.id();this.fields=[{name:"fromuid"},{name:"touid"},{name:"touname"},{name:"stime"},{name:"etime"},{name:"status"},{name:"statusText"},{name:"expiresText"}];this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getEntrustJsonData",disableCaching:true}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields})});this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.store.load();this.colModel=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"fromuid",dataIndex:"fromuid",hidden:true},{header:"被委托人",dataIndex:"touname",width:180,sortable:true,menuDisabled:true},{header:lang("startTime"),dataIndex:"stime",width:120,sortable:true,menuDisabled:true},{header:lang("endTime"),dataIndex:"etime",width:120,sortable:true,menuDisabled:true},{header:"状态",dataIndex:"statusText",width:60,sortable:false,menuDisabled:true,renderer:this.makeStatus.createDelegate(this)},{header:lang("opt"),dataIndex:"fromuid",width:100,sortable:false,menuDisabled:true,renderer:this.makeOperate.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.grid=new Ext.grid.GridPanel({stripeRows:true,store:this.store,loadMask:{msg:lang("waiting")},cm:this.colModel,hideBorders:true,border:false,region:"center",viewConfig:{forceFit:true},listeners:{rowdblclick:function(b,c){},rowclick:function(b,f,c,d){}},tbar:new Ext.Toolbar({items:[{iconCls:"icon-system-refresh",text:lang("refresh"),handler:function(b,c){a.store.reload()}.createDelegate(this)},"->",{xtype:"cnoa_helpBtn",helpid:15}]})});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.grid]})},makeStatus:function(i,f,d,g,e,a){var j=d.data;var b=j.status;var c="";if(b==0){c="<span class='cnoa_color_red'>"+i+"</span>"}else{if(b==1){c="<span class='cnoa_color_green'>"+i+"</span>"}else{if(b==2){c="<span class='cnoa_color_gray'>"+i+"</span>"}}}return c+j.expiresText},makeOperate:function(k,i,e,j,g,b){var f=this;var m=e.data;var d="";var c=Ext.id();var a=l.defer(1,this,[c]);function l(){return new Ext.Button({text:"设置",iconCls:"icon-order-s-con-pour",width:55,handler:function(){f.showSettingPanel()}}).render(document.body,c)}return"<div id="+c+"></div>"},showSettingPanel:function(){var e=this;var a=Ext.id();var c=function(){var h=b.getForm();if(h.isValid()){h.submit({url:e.baseUrl+"&task=setEntrust",waitTitle:lang("notice"),method:"POST",waitMsg:lang("waiting"),success:function(f,i){e.store.reload();d.close()}.createDelegate(this),failure:function(f,i){CNOA.msg.alert(i.result.msg,function(){}.createDelegate(this))}.createDelegate(this)})}else{var g=Ext.getCmp(a).getEl().getBox();g=[g.x+35,g.y+26];CNOA.miniMsg.alert(lang("formValid"),g)}};var b=new Ext.form.FormPanel({border:false,labelWidth:70,waitMsgTarget:true,bodyStyle:"padding:10px;",defaults:{width:160},items:[{xtype:"userselectorfield",fieldLabel:"被委托人",allowBlank:false,name:"touid",multiSelect:false},{name:"stime",fieldLabel:lang("startTime"),xtype:"datetimefield",allowBlank:false,format:"H:i"},{name:"etime",fieldLabel:lang("endTime"),xtype:"datetimefield",allowBlank:false,format:"H:i"},{xtype:"radiogroup",fieldLabel:"是否启用",name:"operatorpersonGroup",items:[{boxLabel:"启用",name:"status",inputValue:"1",checked:true},{boxLabel:"禁用",name:"status",inputValue:"0"}],listeners:{change:function(g,f){}.createDelegate(this),render:function(f){}}},{xtype:"displayfield",hideLabel:true,width:280,value:"<span class='cnoa_color_gray'>设置工作委托人，则所有需要经由你办事的工作也同样可以由被委托人办理。</span>"}]});var d=new Ext.Window({title:"设置流程委托人",layout:"fit",width:317,height:228,modal:true,maximizable:true,resizable:false,items:[b],buttons:[{text:lang("save"),id:a,iconCls:"icon-order-s-accept",handler:function(){c()}},{text:lang("cancel"),iconCls:"icon-dialog-cancel",handler:function(){d.close()}.createDelegate(this)}]}).show();b.getForm().load({url:e.baseUrl+"&task=editEntrustLoadForm",params:{fid:e.edit_id},method:"POST",waitMsg:lang("waiting"),success:function(f,g){}.createDelegate(this),failure:function(f,g){e.close();CNOA.msg.alert(g.result.msg,function(){})}.createDelegate(this)})}};var CNOA_flow_flow_user_flowlistClass,CNOA_flow_flow_user_flowlist;CNOA_flow_flow_user_flowlistClass=CNOA.Class.create();CNOA_flow_flow_user_flowlistClass.prototype={init:function(){var a=this;this.edit_id=0;this.sort=0;this.baseUrl="index.php?app=flow&func=flow&action=user";this.ID_btn_edit=Ext.id();this.ID_btn_delete=Ext.id();this.ID_tree_treeRoot=Ext.id();this.fields=[{name:"lid"},{name:"name"},{name:"sname"},{name:"formid"},{name:"ftype"}];this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getFlowJsonData",disableCaching:true}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields}),listeners:{load:function(b){var c=new Ext.data.Record({lid:"0",name:"通用流程",sname:"",ftype:"1"});b.insert(0,c);a.grid.getView().refresh()}}});this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.store.load();this.colModel=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"lid",dataIndex:"lid",hidden:true},{header:lang("flowName"),dataIndex:"name",width:140,sortable:true,menuDisabled:true,renderer:this.makeName.createDelegate(this)},{header:lang("sort2"),dataIndex:"sname",width:70,sortable:false,menuDisabled:true},{header:"查看",dataIndex:"lid",width:70,sortable:false,menuDisabled:true,renderer:this.makeView.createDelegate(this)},{header:lang("opt"),dataIndex:"lid",width:70,sortable:false,menuDisabled:true,renderer:this.makeOperate.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.pagingBar=new Ext.PagingToolbar({displayInfo:true,store:this.store,style:"border-left-width:1px;",pageSize:15,listeners:{beforechange:function(b,c){c.sort=a.sort}}});this.grid=new Ext.grid.GridPanel({stripeRows:true,store:this.store,bodyStyle:"border-left-width:1px;",loadMask:{msg:lang("waiting")},cm:this.colModel,hideBorders:true,border:false,region:"center",viewConfig:{forceFit:true},listeners:{rowdblclick:function(b,c){},rowclick:function(b,f,c,d){}},tbar:new Ext.Toolbar({style:"border-left-width:1px;",items:[{iconCls:"icon-system-refresh",text:lang("refresh"),handler:function(b,c){a.store.reload()}.createDelegate(this)},"->",{xtype:"cnoa_helpBtn",helpid:16}]}),bbar:this.pagingBar});this.treeRoot=new Ext.tree.AsyncTreeNode({text:"所有分类",sid:"0",iconCls:"icon-tree-root-cnoa",id:this.ID_tree_treeRoot,expanded:true});this.treeLoader=new Ext.tree.TreeLoader({dataUrl:this.baseUrl+"&task=getSortList&type=tree",preloadChildren:true,clearOnLoad:false,listeners:{load:function(b){a.sortTree.selectPath(a.ID_tree_treeRoot)}.createDelegate(this)}});this.sortTree=new Ext.tree.TreePanel({hideBorders:true,border:false,rootVisible:true,lines:true,animCollapse:false,animate:false,loader:this.treeLoader,root:this.treeRoot,autoScroll:true,listeners:{click:function(b){a.sort=b.attributes.sid;a.store.load({params:{sort:a.sort}})}}});this.sortPanel=new Ext.Panel({region:"west",layout:"fit",split:true,width:140,minWidth:80,maxWidth:380,bodyStyle:"border-right-width:1px;",items:[this.sortTree],tbar:new Ext.Toolbar({style:"border-right-width:1px;",items:["流程分类","->",{handler:function(b,c){a.treeRoot.reload()}.createDelegate(this),iconCls:"icon-system-refresh",tooltip:lang("refresh"),text:lang("refresh")}]})});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.grid,this.sortPanel]})},makeName:function(g,e,a,i,c,f){var d=a.data;var b="";if(d.ftype=="1"){b="<span class='cnoa_color_red' ext:qtip='发起通用流程，由发起人定义流程的步骤及各步骤经办人。'>"+g+"</span>"}else{b=g}return b},makeView:function(i,f,d,g,e,b){var j=d.data;if(j.ftype=="1"){c=""}else{var a="./resources/images/icons/";var c="<div style='margin-top:2px;'><a href='javascript:void(0);' onclick='CNOA_flow_flow_user_flowlist.viewFlow("+i+', "'+j.name+"\");'><img src='"+a+"icon-flow.png' style='margin:0 2px 4px 0' align='absmiddle' />流程图</a>";c+="&nbsp;&nbsp;&nbsp;";c+="<a href='javascript:void(0);' onclick='CNOA_flow_flow_user_flowlist.viewForm("+j.formid+");'><img src='"+a+"application_view_list.png' style='margin:0 2px 4px 0' align='absmiddle' />工作表单</a>";c+="</div>"}return c},makeOperate:function(i,f,d,g,e,b){var j=d.data;var a="./resources/images/icons/";if(j.ftype=="1"){var c="<div style='margin-top:2px;'><a href='javascript:void(0);' onclick='CNOA_flow_flow_user_flowlist.newCommonFlow();'><img src='"+a+"page_addedit.png' style='margin:0 2px 4px 0' align='absmiddle' />新建</a>";c+="</div>"}else{var c="<div style='margin-top:2px;'><a href='javascript:void(0);' onclick='CNOA_flow_flow_user_flowlist.newFlow("+i+");'><img src='"+a+"page_addedit.png' style='margin:0 2px 4px 0' align='absmiddle' />新建</a>";c+="</div>"}return c},newFlow:function(a){mainPanel.closeTab("CNOA_MENU_FLOW_USER_NEWFLOW");mainPanel.loadClass("index.php?app=flow&func=flow&action=user&task=loadPage&from=newflow&ac=add&lid="+a,"CNOA_MENU_FLOW_USER_NEWFLOW","新建工作流程","icon-flow-new")},newCommonFlow:function(){mainPanel.closeTab("CNOA_MENU_FLOW_USER_NEWCOMMONFLOW");mainPanel.loadClass("index.php?app=flow&func=flow&action=user&module=commonFlow&task=loadPage&from=newflow","CNOA_MENU_FLOW_USER_NEWCOMMONFLOW","新建工作流程","icon-flow-new")},viewFlow:function(b,a){CNOA_flow_flow_flowpreview=new CNOA_flow_flow_flowpreviewClass(b,a);CNOA_flow_flow_flowpreview.show()},viewForm:function(g){var i=this;var d=Ext.getBody().getBox();var b=d.width-100;var c=d.height-100;var e=function(){Ext.Ajax.request({url:i.baseUrl+"&task=loadFormData",method:"POST",params:{fid:g},success:function(j){var h=Ext.decode(j.responseText);if(h.success===true){a.getEl().update("<center>"+h.data.content+"</center>")}else{CNOA.msg.alert(h.msg,function(){})}f.getEl().unmask()}})};var a=new Ext.Panel({border:false,html:"工作表单载入中...",listeners:{afterrender:function(h){e()}}});var f=new Ext.Window({title:"查看工作表单",width:b,height:c,layout:"fit",bodyStyle:"background-color:#FFFFFF",modal:true,autoScroll:true,maximizable:false,resizable:false,items:[a],buttons:[{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){f.close()}}],listeners:{show:function(h){h.getEl().mask(lang("waiting"))}}}).show()},viewForm2:function(e){var f=this;var a=Ext.id();var d=function(){b.getForm().load({url:f.baseUrl+"&task=loadFormData",params:{fid:e},method:"POST",waitMsg:lang("waiting"),success:function(g,h){var i=Ext.getCmp(a);if(h.result.data.fileInfo==null){i.getEl().update("下载工作表单: (该工作表单尚未上传)")}else{i.getEl().update('下载工作表单: <img src="./resources/images/icons/icon_save.gif"><a href="'+h.result.data.fileInfo.url+'" target="_blank" ext:qtip="请点击右键另存为">下载</a>')}}.createDelegate(this),failure:function(g,h){c.close();CNOA.msg.alert(h.result.msg,function(){})}.createDelegate(this)})};var b=new Ext.form.FormPanel({autoWidth:true,border:false,hideBorders:true,labelWidth:70,labelAlign:"right",waitMsgTarget:true,bodyStyle:"padding:10px;",listeners:{afterrender:function(g){d()}},items:[{xtype:"displayfield",name:"name",fieldLabel:"表单名称"},new Ext.BoxComponent({id:a,autoEl:{tag:"div",style:"padding-left:16px",html:""}})]});var c=new Ext.Window({title:"查看工作表单",width:350,height:200,layout:"fit",modal:true,maximizable:false,resizable:false,items:[b],buttons:[{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){c.close()}}]}).show()}};CNOA_flow_flow_flowpreviewClass=CNOA.Class.create();CNOA_flow_flow_flowpreviewClass.prototype={init:function(b,a){var c=this;this.ID_window_numberTip=Ext.id();this.ID_btn_addedit_save=Ext.id();this.ID_CNOA_flow_flow_setting_design_ct=Ext.id();this.ID_DESIGN_BUTTON="flow_flow_user_flowpreview_button_";this.ID_DESIGN_LINE="flow_flow_user_flowpreview_line_";this.flowId=b;this.flowName=a;this.data=null;this.newStepCount=1;this.baseUrl="index.php?app=flow&func=flow&action=user";this.treeRoot=new Ext.tree.TreeNode({expanded:true});this.treePanel=new Ext.tree.TreePanel({root:this.treeRoot,border:false,id:"flow_flow_preview",rootVisible:false});this.rightPanel=new Ext.Panel({border:false,region:"east",width:180,minWidth:180,maxWidth:180,split:true,autoScroll:true,bodyStyle:"padding-top:4px;",items:[this.treePanel]});this.centerPanel=new Ext.Panel({border:false,region:"center",autoScroll:true,bodyStyle:"background:#FFF url('./resources/images/mxgraph/grid.gif');",html:"<table width='100%' border='0' cellspacing='0' cellpadding='0'><tr><td align='center' valign='top' style='padding-top:20px;'><div id='"+this.ID_CNOA_flow_flow_setting_design_ct+"'></div></td></tr></table>",listeners:{afterrender:function(d){c.readFlowData()}}});this.mainPanel=new Ext.Window({title:"查看流程 - "+this.flowName,width:700,height:makeWindowHeight(600),layout:"border",modal:true,maximizable:true,resizable:true,items:[this.centerPanel,this.rightPanel],buttons:[{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){c.close()}}],listeners:{close:function(){},afterrender:function(d){d.el.on("contextmenu",function(f){f.preventDefault()},this)}}})},show:function(){this.mainPanel.show()},close:function(){this.mainPanel.close()},readFlowData:function(){var a=this;a.mainPanel.getEl().mask(lang("waiting"));Ext.Ajax.request({url:a.baseUrl+"&task=flowpreviewLoadData",method:"POST",params:{lid:a.flowId},success:function(c){var b=Ext.decode(c.responseText);if(b.success===true){if(b.data.length<1){a.data=[{name:"开始",id:"0",type:"start"}]}else{a.data=b.data}}else{CNOA.msg.alert(b.msg)}a.makeFlowViewport();a.mainPanel.getEl().unmask()}})},makeFlowViewport:function(){var f=this;document.getElementById(f.ID_CNOA_flow_flow_setting_design_ct).innerHTML="";var b=0;Ext.each(f.data,function(e,g,h){f.createButton(e.id,e.name,e.type);f.createLine(e.id);b=e.id});try{var d=document.getElementById(f.ID_CNOA_flow_flow_setting_design_ct);var a=document.getElementById(f.ID_DESIGN_LINE+b);d.removeChild(a)}catch(c){}},deleteNode:function(b){var d=this;var a=new Array();var c=0;Ext.each(d.data,function(e,f,g){if(e.id!=b){e.id=c;a.push(e);c++}});d.data=a;d.makeFlowViewport()},addNode:function(c){var e=this;var a=new Array();var b={name:"新步骤"+this.newStepCount++,type:"node"};var d=0;Ext.each(e.data,function(f,g,h){f.id=d;a.push(f);d++;if(f.id==c){b.id=d;a.push(b);d++}});e.data=a;e.makeFlowViewport()},createButton:function(d,a,b){var c=this;new Ext.Button({text:a,scale:"large",btype:b,id:this.ID_DESIGN_BUTTON+d,enableToggle:true,toggleGroup:"flow_flow_setting_design_btn",renderTo:c.ID_CNOA_flow_flow_setting_design_ct,autoWidth:true,handler:function(e){e.toggle(true)},listeners:{render:function(e){},toggle:function(f,e){if(e){c.makeViewTreeData(d)}}}})},makeViewTreeData:function(l){var r=this;var k=function(B,e){return new Ext.tree.TreeNode({iconCls:e?"icon-none":"icon-fileview-column2",text:B,expanded:true})};var i=r.getDataById(l);if((i.operator===null)||(i.operator===undefined)){i.operator={user:[],station:[]}}var x=k("<b>步骤名称</b>",false);var v=k("<span style='color:#616161'>"+i.name+"</span>",true);x.appendChild(v);var g=k("<b>上一步骤名称</b>",false);var d=k("<span style='color:#616161'>"+r.getDataById(parseInt(l)-1).name+"</span>",true);g.appendChild(d);var p=k("<b>下一步骤名称</b>",false);var n=k("<span style='color:#616161'>"+r.getDataById(parseInt(l)+1).name+"</span>",true);p.appendChild(n);var A=k("<b>经办角色</b>",false);var y=k("<b>人员</b>",false);var u=k("<b>岗位</b>",false);try{Ext.each(i.operator.user,function(e,B){var C=k("<span style='color:#616161'>"+e.name+"</span>",true);y.appendChild(C)});if(i.operator.user.length==0){}}catch(t){}try{Ext.each(i.operator.station,function(e,B){var C=k("<span style='color:#616161'>"+e.name+"</span>",true);u.appendChild(C)});if(i.operator.station.length==0){}}catch(t){}A.appendChild(y);A.appendChild(u);if(i.id==0){if((i.operator.station.length==0)&&(i.operator.user.length==0)){A.childNodes=[];A.appendChild(k("<span style='color:#616161'>任意人</span>",true))}}var a=k("<b>表单字段</b>",false);var z=k("<b>可填字段</b>",true);var w=k("<b>必填字段</b>",true);Ext.each(i.formitems,function(e,B){if(e.need){z.appendChild(k("<span style='color:#616161'>"+e.name+"</span>",true))}if(e.must){w.appendChild(k("<span style='color:#616161'>"+e.name+"</span>",true))}});a.appendChild(z);a.appendChild(w);var j=i.operatorperson=="2"?"<span style='color:#616161'>多人办理</span>":"<span style='color:#616161'>单人办理</span>";var s=i.operatortype=="1"?"<span style='color:#616161'>任意一人同意</span>":"<span style='color:#616161'>所有人同意</span>";var h=k("<b>经办方式</b>",false);var f=k("<span style='color:#616161'>"+j+"</span>",true);h.appendChild(f);if(i.operatorperson=="2"){var c=k("<b>转下一步条件: </b>",false);var b=k("<span style='color:#616161'>"+s+"</span>",true);c.appendChild(b);h.appendChild(c)}var q=k("<b>允许操作</b>",false);if(parseInt(i.upAttach)==1){var o=k("<span style='color:#616161'>允许上传附件</span>",true);q.appendChild(o)}if(parseInt(i.downAttach)==1){var m=k("<span style='color:#616161'>允许下载附件</span>",true);q.appendChild(m)}r.treeRoot=new Ext.tree.TreeNode({expanded:true});if(i.type=="end"){r.treeRoot.appendChild([x,g])}else{r.treeRoot.appendChild([x,g,p,A,a,h,q])}r.treePanel.setRootNode(r.treeRoot)},getDataById:function(c){var b=this;c=parseInt(c);if((c<0)||(c>b.data.length-1)){return{name:"无",id:"-1"}}var a;Ext.each(b.data,function(d,e,f){if(d.id==c){a=d}});return a},createLine:function(a){var b=this;new Ext.BoxComponent({id:this.ID_DESIGN_LINE+a,renderTo:b.ID_CNOA_flow_flow_setting_design_ct,autoEl:{tag:"div",html:'<img src="./resources/images/cnoa/arrow.gif" />'}})}};var CNOA_flow_flow_user_myflowClass,CNOA_flow_flow_user_myflow;CNOA_flow_flow_user_myflowClass=CNOA.Class.create();CNOA_flow_flow_user_myflowClass.prototype={init:function(){var a=this;this.edit_id=0;this.sort=0;this.baseUrl="index.php?app=flow&func=flow&action=user";this.ID_btn_edit=Ext.id();this.ID_btn_delete=Ext.id();this.ID_tree_treeRoot=Ext.id();this.ID_find_name=Ext.id();this.ID_find_title=Ext.id();this.ID_find_beginTime=Ext.id();this.ID_find_endTime=Ext.id();this.ID_find_status=Ext.id();this.searchParams={name:"",title:"",beginTime:"",endTime:"",status:0};this.fields=[{name:"lid"},{name:"ulid"},{name:"name"},{name:"flowname"},{name:"title"},{name:"level"},{name:"step"},{name:"posttime"},{name:"status"},{name:"flowtype"}];this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getMyFlowJsonData",disableCaching:true}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields})});this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.store.load();this.colModel=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"ulid",dataIndex:"ulid",hidden:true},{header:"流程编号",dataIndex:"name",width:180,sortable:true,menuDisabled:true},{header:"所属流程",dataIndex:"flowname",width:120,sortable:true,menuDisabled:true},{header:lang("title"),dataIndex:"title",width:120,sortable:true,menuDisabled:true},{header:"重要等级",dataIndex:"level",width:60,sortable:false,menuDisabled:true},{header:"当前步骤",dataIndex:"step",width:70,sortable:false,menuDisabled:true},{header:"状态",dataIndex:"status",width:50,sortable:false,menuDisabled:true,renderer:this.makeStatus.createDelegate(this)},{header:"发起日期",dataIndex:"posttime",width:110,sortable:false,menuDisabled:true},{header:lang("opt"),dataIndex:"ulid",width:160,sortable:false,menuDisabled:true,renderer:this.makeOperate.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.pagingBar=new Ext.PagingToolbar({displayInfo:true,store:this.store,style:"border-left-width:1px;",pageSize:15,listeners:{beforechange:function(b,c){c.sort=a.sort;if(a.searchParams.name!=""){c.name=a.searchParams.name}if(a.searchParams.title!=""){c.title=a.searchParams.title}if(a.searchParams.beginTime!=""){c.beginTime=a.searchParams.beginTime}if(a.searchParams.endTime!=""){c.endTime=a.searchParams.endTime}if(a.searchParams.status!=0){c.status=a.searchParams.status}}}});this.grid=new Ext.grid.GridPanel({stripeRows:true,store:this.store,bodyStyle:"border-left-width:1px;",loadMask:{msg:lang("waiting")},cm:this.colModel,hideBorders:true,border:false,region:"center",viewConfig:{},listeners:{rowdblclick:function(b,c){},rowclick:function(b,f,c,d){}},tbar:new Ext.Toolbar({style:"border-left-width:1px;",items:[{iconCls:"icon-system-refresh",text:lang("refresh"),handler:function(b,c){a.store.reload()}.createDelegate(this)},"-",{handler:function(b,c){a.openExportExcelWindow()}.createDelegate(this),iconCls:"icon-excel",tooltip:"导出流程列表为Excel文件",text:"导出"},"->",{xtype:"cnoa_helpBtn",helpid:18}]}),bbar:this.pagingBar});this.treeRoot=new Ext.tree.AsyncTreeNode({text:"所有分类",sid:"0",iconCls:"icon-tree-root-cnoa",id:this.ID_tree_treeRoot,expanded:true});this.treeLoader=new Ext.tree.TreeLoader({dataUrl:this.baseUrl+"&task=getSortList&type=tree",preloadChildren:true,clearOnLoad:false,listeners:{load:function(b){a.sortTree.selectPath(a.ID_tree_treeRoot)}.createDelegate(this)}});this.sortTree=new Ext.tree.TreePanel({hideBorders:true,border:false,rootVisible:true,lines:true,animCollapse:false,animate:false,loader:this.treeLoader,root:this.treeRoot,autoScroll:true,listeners:{click:function(b){a.sort=b.attributes.sid;a.store.load({params:{sort:a.sort}})}}});this.sortPanel=new Ext.Panel({region:"west",layout:"fit",split:true,width:120,minWidth:80,maxWidth:380,bodyStyle:"border-right-width:1px;",items:[this.sortTree],tbar:new Ext.Toolbar({style:"border-right-width:1px;",items:["流程分类","->",{handler:function(b,c){a.treeRoot.reload()}.createDelegate(this),iconCls:"icon-system-refresh",tooltip:lang("refresh"),text:lang("refresh")}]})});this.gridCt=new Ext.Panel({border:false,layout:"fit",items:[this.grid],region:"center",listeners:{afterrender:function(){new Ext.Toolbar({style:"border-left-width:1px;",items:["发起开始时间：",{xtype:"datefield",width:170,format:"Y-m-d",editable:false,allowBlank:true,id:a.ID_find_beginTime}," 发起最后时间：",{xtype:"datefield",width:170,format:"Y-m-d",editable:false,allowBlank:true,id:a.ID_find_endTime},"-",{xtype:"button",text:lang("search"),handler:function(){a.searchParams={name:Ext.getCmp(a.ID_find_name).getValue(),title:Ext.getCmp(a.ID_find_title).getValue(),beginTime:Ext.getCmp(a.ID_find_beginTime).getRawValue(),endTime:Ext.getCmp(a.ID_find_endTime).getRawValue(),status:Ext.getCmp(a.ID_find_status).getValue()};a.store.load({params:a.searchParams})}},"-",{xtype:"button",text:lang("clear"),handler:function(){Ext.getCmp(a.ID_find_name).setValue("");Ext.getCmp(a.ID_find_title).setValue("");Ext.getCmp(a.ID_find_beginTime).setRawValue("");Ext.getCmp(a.ID_find_endTime).setRawValue("");Ext.getCmp(a.ID_find_status).setValue(-99);a.searchParams={name:"",title:"",beginTime:0,endTime:0,status:0};a.store.load()}}]}).render(this.tbar)}},tbar:new Ext.Toolbar({style:"border-left-width:1px;",items:["标题：",{xtype:"textfield",width:200,id:a.ID_find_title}," 编号名称",{xtype:"textfield",width:150,id:a.ID_find_name},"当前状态：",{xtype:"combo",id:a.ID_find_status,editable:false,mode:"local",triggerAction:"all",valueField:"value",displayField:"display",store:new Ext.data.ArrayStore({fields:["value","display"],data:[[-99,""],[-1,"已删除"],[0,"未发布"],[1,"办理中"],[2,"已办理"],[3,"已退件"],[4,"已撤销"]]}),value:-99}]})});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.gridCt,this.sortPanel]})},openExportExcelWindow:function(){var d=this;var b=function(){if(a.getForm().isValid()){a.getForm().submit({url:d.baseUrl+"&task=exportExcel",waitMsg:lang("waiting"),params:{},method:"POST",success:function(e,f){c.close();d.openDownloadExcelWindow(f.result.msg)},failure:function(e,f){CNOA.msg.alert(f.result.msg,function(){})}})}};var a=new Ext.form.FormPanel({border:false,bodyStyle:"padding:10px;",waitMsgTarget:true,labelWidth:110,items:[{xtype:"datefield",fieldLabel:"流程发起开始时间",width:170,format:"Y-m-d",editable:false,allowBlank:false,name:"stime"},{xtype:"datefield",fieldLabel:"流程发起最后时间",width:170,format:"Y-m-d",editable:false,allowBlank:false,name:"etime"}]});var c=new Ext.Window({width:320,height:140,title:"导出工作流程",resizable:false,modal:true,layout:"fit",items:a,buttons:[{text:"导出",iconCls:"icon-excel",handler:function(){b()}.createDelegate(this)},{text:lang("cancel"),iconCls:"icon-dialog-cancel",handler:function(){c.close()}.createDelegate(this)}]}).show()},openDownloadExcelWindow:function(a){var b=new Ext.Window({width:320,height:150,title:"下载EXCEL表格",resizable:false,modal:true,layout:"fit",bodyStyle:"padding:10px;background-color: #FFF;",html:"请点击下载：<br/>"+a,buttons:[{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){b.close()}.createDelegate(this)}]}).show()},makeStatus:function(a){var b="";if(a==0){b="<span class='cnoa_color_gray'>未发送</span>"}else{if(a==1){b="<span class='cnoa_color_orange'>办理中</span>"}else{if(a==2){b="<span class='cnoa_color_green'>已办理</span>"}else{if(a==3){b="<span class='cnoa_color_red'>已退件</span> "}else{if(a==4){b="<span class='cnoa_color_gray'>已撤销</span>"}}}}}return b},makeOperate:function(i,f,d,g,e,a){var j=d.data;var b=j.status;var c="<a href='javascript:void(0);' onclick='CNOA_flow_flow_user_myflow.showFlow("+i+", "+j.flowtype+");'>查看</a>";c+="&nbsp;&nbsp;";c+=(b=="0"||b=="3"||b=="4")?"<a href='javascript:void(0);' onclick='CNOA_flow_flow_user_myflow.deleteFlow("+i+");'>删除</a>":"<span class='cnoa_color_gray2'>删除</span>";c+="&nbsp;&nbsp;";c+=b=="0"?"<a href='javascript:void(0);' onclick='CNOA_flow_flow_user_myflow.editPanel("+i+", "+j.flowtype+");'>编辑</a>":"<span class='cnoa_color_gray2'>编辑</span>";c+="&nbsp;&nbsp;";c+=b=="1"?"<a href='javascript:void(0);' onclick='CNOA_flow_flow_user_myflow.recall("+i+");'>召回</a>":"<span class='cnoa_color_gray2'>召回</span>";c+="&nbsp;&nbsp;";c+=b=="1"?"<a href='javascript:void(0);' onclick='CNOA_flow_flow_user_myflow.repeal("+i+");'>撤销</a>":"<span class='cnoa_color_gray2'>撤销</span>";c+="<br />";c+="<a href='javascript:void(0);' onclick='CNOA_flow_flow_user_myflow.viewFlowEvent("+i+', "'+j.name+"\");' ext:qtip='查看流程事件日志'>事件</a>";c+="&nbsp;&nbsp;";c+="<a href='javascript:void(0);' onclick='CNOA_flow_flow_user_myflow.viewFlowProgress("+i+', "'+j.name+"\");' ext:qtip='查看流程办理进度'>进度</a>";c+="&nbsp;&nbsp;";c+=j.flowtype=="0"?"<a href='javascript:void(0);' onclick='CNOA_flow_flow_user_myflow.viewFlow2("+j.lid+', "'+j.flowname+"\");' ext:qtip='查看流程图'>[流程图]</a>":"";return c},editPanel:function(b,a){mainPanel.closeTab("CNOA_MENU_FLOW_USER_NEWFLOW");if(a==0){mainPanel.loadClass("index.php?app=flow&func=flow&action=user&task=loadPage&from=newflow&ac=edit&ulid="+b,"CNOA_MENU_FLOW_USER_NEWFLOW","编辑工作流程","icon-flow-new")}else{if(a==1){mainPanel.loadClass("index.php?app=flow&func=flow&action=user&module=commonFlow&task=loadPage&from=newflow&ac=edit&ulid="+b,"CNOA_MENU_FLOW_USER_NEWFLOW","编辑工作流程","icon-flow-new")}}},deleteFlow:function(a){var b=this;CNOA.msg.cf("确认删除吗？",function(c){if(c=="yes"){Ext.Ajax.request({url:b.baseUrl+"&task=deleteflow",method:"POST",params:{ulid:a},success:function(e){var d=Ext.decode(e.responseText);if(d.success===true){CNOA.msg.notice(d.msg,"工作流管理");b.store.reload()}else{CNOA.msg.alert(d.msg)}}})}})},showFlow:function(b,a){mainPanel.closeTab("CNOA_MENU_FLOW_USER_SHOWFLOW");if(a==0){mainPanel.loadClass("index.php?app=flow&func=flow&action=user&task=loadPage&from=showflow&ulid="+b,"CNOA_MENU_FLOW_USER_SHOWFLOW","查看工作流程","icon-flow")}else{if(a==1){mainPanel.loadClass("index.php?app=flow&func=flow&action=user&module=commonFlow&task=loadPage&from=showflow&ulid="+b,"CNOA_MENU_FLOW_USER_SHOWFLOW","查看工作流程","icon-flow")}}},viewFlow2:function(b,a){CNOA_flow_flow_flowpreview=new CNOA_flow_flow_flowpreviewClass(b,a);CNOA_flow_flow_flowpreview.show()},viewFlowEvent:function(b,d){var c=new CNOA_flow_flow_flowViewEventClass(b,false);var a=new Ext.Window({title:"查看流程详细事件 - "+d,layout:"fit",width:650,height:makeWindowHeight(400),modal:true,maximizable:true,items:[c.grid],buttons:[{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){a.close()}.createDelegate(this)}]}).show()},viewFlowProgress:function(b,d){var c=new CNOA_flow_flow_flowViewProgressClass(b,false);var a=new Ext.Window({title:"查看流程详细进度 - "+d,layout:"fit",width:650,height:makeWindowHeight(400),modal:true,maximizable:true,items:[c.grid],buttons:[{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){a.close()}.createDelegate(this)}]}).show()},recall:function(a){var b=this;CNOA.msg.cf("你确定要召回本流程吗？",function(c){if(c=="yes"){Ext.Ajax.request({url:b.baseUrl+"&task=recall",method:"POST",params:{ulid:a},success:function(e){var d=Ext.decode(e.responseText);if(d.success===true){CNOA.msg.notice(d.msg,"工作流管理");b.store.reload()}else{CNOA.msg.alert(d.msg,function(){})}}})}})},repeal:function(a){var b=this;CNOA.msg.cf("你确定要撤销本流程吗？",function(c){if(c=="yes"){Ext.Ajax.request({url:b.baseUrl+"&task=repeal",method:"POST",params:{ulid:a},success:function(e){var d=Ext.decode(e.responseText);if(d.success===true){CNOA.msg.notice(d.msg,"工作流管理");b.store.reload()}else{CNOA.msg.alert(d.msg,function(){})}}})}})}};var CNOA_flow_flow_user_newflowClass,CNOA_flow_flow_user_newflow;var CNOA_flow_flow_user_newflow_goNextStepClass,CNOA_flow_flow_user_newflow_goNextStep;var CNOA_flow_flow_user_newflow_autoSaveTimer;CNOA_flow_flow_user_newflow_goNextStepClass=CNOA.Class.create();CNOA_flow_flow_user_newflow_goNextStepClass.prototype={init:function(a,b){var c=this;this.baseUrl="index.php?app=flow&func=flow&action=user";this.flowid=a;this.stepid=b;this.steptp="node";this.operatorperson=null;this.ID_html=Ext.id();this.ID_multiselects=Ext.id();this.ID_multiselects_tip=Ext.id();this.ID_window=Ext.id();this.ID_nextStepTr1=Ext.id();this.ID_nextStepTr2=Ext.id();this.Tpl=new Ext.Template('<table width="596" border="0" cellspacing="1" cellpadding="0" style="background:#999;margin-bottom:5px;"><tr><td width="147" height="24" align="right" valign="middle" bgcolor="#D9D9D9">下一步骤名称:&nbsp;</td><td width="446" valign="middle" bgcolor="#F2F2F2">&nbsp;{name}</td></tr><tr id="'+this.ID_nextStepTr1+'"><td height="24" align="right" valign="middle" bgcolor="#D9D9D9">经办方式:&nbsp;</td><td valign="middle" bgcolor="#F2F2F2">&nbsp;{operatorperson}</td></tr><tr id="'+this.ID_nextStepTr2+'"><td height="24" align="right" valign="middle" bgcolor="#D9D9D9">转下下一步条件:&nbsp;</td><td valign="middle" bgcolor="#F2F2F2">&nbsp;{operatortype}</td></tr></table>');this.dataStoreFrom=new Ext.data.ArrayStore({data:[],fields:["uid","name"]});this.dataStoreTo=new Ext.data.ArrayStore({data:[],fields:["uid","name"]});this.smsSender=new Ext.form.SMSSender({from:"flow",hideLabel:true,modal:true,boxLabel:"手机短信提醒"});this.formPanel=new Ext.form.FormPanel({autoWidth:true,border:false,hideBorders:true,labelWidth:100,labelAlign:"right",bodyStyle:"padding:10px;",waitMsgTarget:true,items:[{xtype:"panel",border:false,id:this.ID_html,html:""},c.smsSender,{xtype:"itemselector",name:"itemselector",hideLabel:true,id:this.ID_multiselects,imagePath:CNOA_EXTJS_PATH+"/ux/images/",multiselects:[{width:288,height:200,store:this.dataStoreFrom,displayField:"name",valueField:"uid",tbar:["待选人员",{text:"&nbsp;",disabled:true}]},{width:288,height:200,store:this.dataStoreTo,displayField:"name",valueField:"uid",tbar:["经办人","->",{text:"清除",iconCls:"icon-clear",handler:function(){c.formPanel.getForm().findField("itemselector").reset()}}]}]},{xtype:"displayfield",hideLabel:true,id:this.ID_multiselects_tip,value:"注意: 你所选择的经办人如果有多人，则列表第一人将作为主办人，只有主办人有权限决定他的下一步骤经办人。"}]});this.mainPanel=new Ext.Window({id:this.ID_window,title:"转下一步 - 选择经办人",width:630,height:makeWindowHeight(430),layout:"fit",modal:true,maximizable:false,resizable:false,items:[this.formPanel],buttons:[{text:"转下一步",iconCls:"icon-fileview-column3",handler:function(e){var d=c.formPanel.getForm().findField("itemselector").getValue();if(Ext.isEmpty(d)&&(c.steptp!="end")){CNOA.miniMsg.alertShowAt(e,"请选择至少一人作为经办人")}else{var f=d.split(",");if((c.operatorperson=="1")&&(f.length!=1)){CNOA.miniMsg.alertShowAt(e,"该步骤经办方式为:单人办理, 只能选择一人作为经办人")}else{if(c.smsSender.validateValue()){CNOA_flow_flow_user_newflow.sendFormStep2(d,function(){try{c.smsSender.submit()}catch(g){}c.close()})}}}}},{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){c.close()}}],listeners:{close:function(){}}})},show:function(){this.mainPanel.show();this.loadNextStepInfo()},close:function(){this.mainPanel.close()},loadNextStepInfo:function(){var a=this;a.mainPanel.getEl().mask(lang("waiting"));Ext.Ajax.request({url:a.baseUrl+"&task=loadNextStepInfo",method:"POST",params:{flowid:a.flowid,stepid:a.stepid},success:function(g){var b=Ext.decode(g.responseText);if(b.success===true){var f=b.data;var e=f.nextData;a.operatorperson=b.data.operatorperson;b.data.operatorperson=b.data.operatorperson=="1"?"单人办理":"多人办理";b.data.operatortype=b.data.operatortype=="1"?"任意一人同意":"所有人同意";a.Tpl.append(a.ID_html,b.data);if(f.nextStepType=="end"){a.steptp="end";Ext.fly(a.ID_nextStepTr1).dom.style.display="none";Ext.fly(a.ID_nextStepTr2).dom.style.display="none";Ext.getCmp(a.ID_multiselects).hide();Ext.getCmp(a.ID_multiselects_tip).hide();a.mainPanel.setHeight(306)}else{a.dataStoreFrom.removeAll();for(var d=0;d<b.data.operator.length;d++){var c=new Ext.data.Record(b.data.operator[d]);a.dataStoreFrom.add(c)}}}else{CNOA.msg.alert(b.msg,function(){})}a.mainPanel.getEl().unmask()}})}};CNOA_flow_flow_user_newflowClass=CNOA.Class.create();CNOA_flow_flow_user_newflowClass.prototype={init:function(){var a=this;this.lid=CNOA.flow.flow.user_newflow.lid;this.fid=CNOA.flow.flow.user_newflow.fid;this.ulid=CNOA.flow.flow.user_newflow.ulid;this.flowName=CNOA.flow.flow.user_newflow.flowName;this.flowNumber=CNOA.flow.flow.user_newflow.flowNumber;this.action=CNOA.flow.flow.user_newflow.ac;this.allowup=CNOA.flow.flow.user_newflow.allowup;this.title=CNOA.flow.flow.user_newflow.title;this.level=CNOA.flow.flow.user_newflow.level;this.reason=CNOA.flow.flow.user_newflow.reason;this.about=CNOA.flow.flow.user_newflow.about;this.formData=CNOA.flow.flow.user_newflow.formData;this.baseUrl="index.php?app=flow&func=flow&action=user";this.ID_btn_edit=Ext.id();this.ID_btn_save=Ext.id();this.baseField=[{xtype:"fieldset",title:"流程信息",autoHeight:true,defaults:{width:90,xtype:"textfield"},items:[{xtype:"panel",hideBorders:true,border:false,layout:"table",autoWidth:true,layoutConfig:{columns:2},items:[{xtype:"panel",layout:"form",width:350,items:[{xtype:"textfield",readOnly:true,fieldLabel:lang("flowName"),value:this.flowName,width:255}]},{xtype:"panel",layout:"form",width:350,items:[{xtype:"cnoa_textfield",readOnly:true,fieldLabel:"流程编号",width:270,value:this.flowNumber,tooltip:this.makeNumberTip()}]}]},{xtype:"panel",hideBorders:true,border:false,layout:"table",autoWidth:true,layoutConfig:{columns:2},items:[{xtype:"panel",layout:"form",width:350,items:[{xtype:"textfield",fieldLabel:"自定义标题",name:"title",width:255,value:this.action=="edit"?this.title:""}]},{xtype:"panel",layout:"form",width:350,items:[new Ext.form.ComboBox({fieldLabel:"重要程度",name:"level",width:270,store:new Ext.data.SimpleStore({fields:["value","level"],data:[["1","普通"],["2","重要"],["3","非常重要"]]}),hiddenName:"level",valueField:"value",displayField:"level",mode:"local",triggerAction:"all",forceSelection:true,editable:false,value:this.action=="edit"?this.level:1})]}]},{xtype:"panel",hideBorders:true,border:false,layout:"table",autoWidth:true,layoutConfig:{columns:2},items:[{xtype:"panel",layout:"form",width:350,items:[{xtype:"textarea",fieldLabel:"发起理由",name:"reason",width:255,height:120,value:this.action=="edit"?this.reason:""}]},{xtype:"panel",layout:"form",width:350,items:[{xtype:"textarea",fieldLabel:"特殊备注",name:"about",width:270,height:120,value:this.action=="edit"?this.about:""}]}]},{xtype:"flashfile",fieldLabel:lang("attach"),name:"attach",width:620,style:"margin-top:5px;",inputPre:"filesUpload",hideLabel:this.allowup=="0"?true:false,hidden:this.allowup=="0"?true:false,listeners:{render:function(b){b.setValue(CNOA.flow.flow.user_newflow.attach)}}}]}];this.flowForm=new Ext.Panel({title:"工作表单",border:true,frame:true,autoScroll:true,bodyStyle:"background-color:#FFF",html:"工作表单载入中...",listeners:{afterrender:function(b){a.loadFlowForm(b)}}});this.formPanel=new Ext.form.FormPanel({fileUpload:true,autoWidth:true,border:false,labelWidth:70,labelAlign:"right",waitMsgTarget:true,bodyStyle:"padding:10px;",listeners:{afterrender:function(b){}},items:[this.baseField,this.flowForm]});this.centerPanel=new Ext.Panel({hideBorders:true,border:false,region:"center",autoScroll:true,items:[this.formPanel],tbar:new Ext.Toolbar({items:[{text:"转下一步",id:this.ID_btn_send,iconCls:"icon-fileview-column3",handler:function(b){var c=a.formPanel.getForm();if(!c.isValid()||!a.checkForm()){CNOA.miniMsg.alertShowAt(b,"部分表单未完成,请检查(请确认工作表单的必填字段已经填写完毕)",30);return false}a.sendFormStep1()}},"-",{text:"暂存",id:this.ID_btn_save,iconCls:"icon-btn-save",handler:function(){a.saveForm()}},"-",{text:lang("cancel"),iconCls:"icon-dialog-cancel",handler:function(){a.closeTab()}},"-","-",{text:"流程图",iconCls:"icon-flow",handler:function(){a.viewFlow(a.lid,a.flowName)}},"->",{xtype:"cnoa_helpBtn",helpid:69}]})});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.centerPanel]});Ext.getCmp(CNOA.flow.flow.user_newflow.parentID).on("deactivate",function(){clearInterval(CNOA_flow_flow_user_newflow_autoSaveTimer)});Ext.getCmp(CNOA.flow.flow.user_newflow.parentID).on("destroy",function(){clearInterval(CNOA_flow_flow_user_newflow_autoSaveTimer)});setTimeout(function(){a.getAutoSaveFormData()},500)},setAutoSaveFormData:function(){var a=this;CNOA_flow_flow_user_newflow_autoSaveTimer=setInterval(function(){Ext.Ajax.request({url:a.baseUrl+"&task=setAutoSaveFormData",method:"POST",params:{lid:a.lid,data:Ext.encode(a.formPanel.getForm().getValues())},success:function(c){var b=Ext.decode(c.responseText);if(b.success===true){}else{CNOA.msg.alert(b.msg,function(){})}}})},5000)},getAutoSaveFormData:function(){var a=this;Ext.Ajax.request({url:a.baseUrl+"&task=getAutoSaveFormData",method:"POST",params:{lid:a.lid},success:function(d){var b=Ext.decode(d.responseText);if(b.success===true){var c=b.data;c=Ext.decode(c);if(Ext.isEmpty(c)!==true){CNOA.msg.cf("检测到未完成的表单数据是否载入<br>按<b>是</b>载入，按<b>否</b>取消<br>",function(h){if(h=="yes"){a.formPanel.getForm().setValues(c);for(var g in c){var k=g.replace("FLOWDATA[","").replace("]","");var f=a.formPanel.getEl().query("input[flowitemid="+k+"],textarea[flowitemid="+k+"],select[flowitemid="+k+"]");try{f[0].value=c[g]}catch(j){}}}})}else{}}else{CNOA.msg.alert(b.msg,function(){})}a.setAutoSaveFormData()}})},loadFlowForm:function(a){var b=this;Ext.Ajax.request({url:b.baseUrl+"&task=loadFormData2",method:"POST",params:{fid:b.fid,lid:b.lid},success:function(e){var c=Ext.decode(e.responseText);if(c.success===true){var d="<div style='padding-bottom:5px;width:100%' class='x-border-layout-ct'><div class='flow_flow_form'><div>图示：</div><div class='flow_form_must_struct flow_form_must_color'>&nbsp;</div><div>必填字段</div><div class='flow_form_must_struct flow_form_need_color'>&nbsp;</div><div>可填字段</div><div class='flow_form_must_struct flow_form_disabled_color'>&nbsp;</div><div>不可填字段</div></div><div class='clear'></div></div>";a.body.update(d+c.data.content);var f=b.flowForm.getEl().query("input[name^=FLOWDATA],textarea[name^=FLOWDATA],select[name^=FLOWDATA]");Ext.each(f,function(g,h){if(b.action=="edit"){Ext.each(b.formData,function(j,i){if(("FLOWDATA["+j.itemid+"]")==g.name){g.value=j.data}})}if(g.readOnly==true){g.style.border="1px solid #E1E1E1";g.style.backgroundColor="#F6F6F6"}else{g.style.border="1px solid #BCBCBC"}g.title=""})}else{CNOA.msg.alert(c.msg,function(){})}}})},viewFlow:function(b,a){CNOA_flow_flow_flowpreview=new CNOA_flow_flow_flowpreviewClass(b,a);CNOA_flow_flow_flowpreview.show()},closeTab:function(){var a=CNOA.flow.flow.user_newflow.parentID.replace("docs-","");mainPanel.closeTab(a)},goToMyFlow:function(){mainPanel.loadClass("index.php?app=flow&func=flow&action=user&task=loadPage&from=myflow","CNOA_MENU_FLOW_USER_MYFLOW","我的流程","icon-flow-my")},saveForm:function(){var c=this;var a=c.formPanel.getForm();var b=a.findField("reason");b.allowBlank=true;b.validationEvent=false;b.clearInvalid();if(a.isValid()&&this.checkForm()){a.submit({url:c.baseUrl+"&task=saveFlow_"+c.action,waitTitle:lang("notice"),method:"POST",waitMsg:lang("waiting"),params:{lid:c.lid,ulid:c.ulid},success:function(d,f){CNOA.msg.notice(f.result.msg,"工作流管理");c.goToMyFlow();c.closeTab();try{CNOA_flow_flow_user_myflow.store.reload()}catch(g){}}.createDelegate(this),failure:function(d,e){CNOA.msg.alert(e.result.msg,function(){})}.createDelegate(this)})}else{CNOA.miniMsg.alertShowAt(c.ID_btn_save,"部分表单未完成,请检查(请确认工作表单的必填字段已经填写完毕)",30)}},checkForm:function(){var d=this.flowForm.getEl().query("input[name^=FLOWDATA][class*=flow_form_must]");var c=this.flowForm.getEl().query("textarea[name^=FLOWDATA][class*=flow_form_must]");var b=this.flowForm.getEl().query("select[name^=FLOWDATA][class*=flow_form_must]");var a=true;Ext.each(d,function(e,f){if(Ext.isEmpty(e.value)){a=false}});Ext.each(c,function(e,f){if(Ext.isEmpty(e.value)){a=false}});Ext.each(b,function(e,f){if(Ext.isEmpty(e.value)){a=false}});return a},sendFormStep1:function(){var a=this;CNOA_flow_flow_user_newflow_goNextStep=new CNOA_flow_flow_user_newflow_goNextStepClass(a.lid);CNOA_flow_flow_user_newflow_goNextStep.show()},sendFormStep2:function(a,d){var c=this;if(Ext.isArray(a)){a=a.join(",")}var b=c.formPanel.getForm();if(b.isValid()&&this.checkForm()){b.submit({url:c.baseUrl+"&task=sendFlow",waitTitle:lang("notice"),method:"POST",waitMsg:lang("waiting"),params:{lid:c.lid,ulid:c.ulid,nextUids:a},success:function(f,g){try{d.call(this)}catch(h){}CNOA.msg.notice(g.result.msg,"工作流管理");c.goToMyFlow();c.closeTab();try{CNOA_flow_flow_user_myflow.store.reload()}catch(h){}}.createDelegate(this),failure:function(e,f){CNOA.msg.alert(f.result.msg,function(){})}.createDelegate(this)})}else{CNOA.miniMsg.alertShowAt(c.ID_btn_save,lang("formValid"),30)}},makeNumberTip:function(){var b="编号规则";var a="{F}: 此变量表示当前的流程名称。<br>{U}: 此变量表示当前的流程发起者。<br>{Y}: 此变量表示当前时间的四位年份值，如2008。<br>{M}: 此变量表示当前时间的两位月份值，如12。<br>{D}: 此变量表示当前时间的两位日期值，如31。<br>{H}: 此变量表示当前时间的两位小时值，如08。<br>{I}: 此变量表示当前时间的两位分钟值，如59。<br>{S}: 此变量表示当前时间的两位秒钟值，如59。<br>{N}: 此变量表示当天的系统流水号，{N}表示一位流水号，{NNNNN}表示五位流水号，最多五位，如00001。<br><br><b>示例</b>: 如：{F}{Y}{M}{D}-{NNNN}，将会被转化为：流程名称20080808-0008。";return{text:a,title:b}}};CNOA_flow_flow_user_showflowClass=CNOA.Class.create();CNOA_flow_flow_user_showflowClass.prototype={init:function(){var a=this;this.ulid=CNOA.flow.flow.user_showflow.ulid;this.ID_goto_nextstep=Ext.id();this.baseUrl="index.php?app=flow&func=flow&action=user";this.flowPanelLoaded=this.formPanelLoaded=this.progressPanelLoaded=this.eventPanelLoaded=false;this.ID_btn_edit=Ext.id();this.ID_btn_delete=Ext.id();this.ID_tree_treeRoot=Ext.id();this.ID_printArea=Ext.id();this.flowInfo=null;this.topTpl=new Ext.XTemplate('<table width="100%" border="0" cellspacing="1" cellpadding="0" style="background-color:#CDCDCD">',"  <tr>",'    <td width="15%" height="24" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">流程编号:&nbsp;</td>','    <td width="35%" valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{name}</td>','    <td width="15%" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">'+lang("flowName")+":&nbsp;</td>",'    <td width="35%" valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;[{flowname}]{title}</td>',"  </tr>","  <tr>",'    <td height="24" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">发起人:&nbsp;</td>','    <td valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{uname}</td>','    <td align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">发起日期:&nbsp;</td>','    <td valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{posttime}</td>',"  </tr>","  <tr>",'    <td height="24" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">当前步骤:&nbsp;</td>','    <td valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{stepText}</td>','    <td align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">流程状态:&nbsp;</td>','    <td valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{statusText}</td>',"  </tr>","  <tr>",'    <td height="24" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">申请事由:&nbsp;</td>','    <td valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{reason}</td>','    <td align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">特殊备注:&nbsp;</td>','    <td valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{about}</td>',"  </tr>",'  <tpl if="attachCount &gt; 0">',"  <tr>",'    <td height="24" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">流程附件:&nbsp;</td>','    <td colspan="3" valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;',"		{attach}","    </td>","  </tr>","  </tpl>","</table>");this.flowPanel=new Ext.Panel({headerStyle:"border-width:0",border:false,frame:true,animCollapse:false,collapsible:true,titleCollapse:true,style:"margin-bottom:10px;",title:"流程信息",listeners:{afterrender:function(b){a.flowPanelLoaded=true;a.view_loadFlowInfo()}}});this.formPanel=new Ext.form.FormPanel({headerStyle:"border-width:0",style:"margin-bottom:10px;",bodyStyle:"background-color:#FFF",border:false,frame:true,waitMsgTarget:true,animCollapse:false,collapsible:true,titleCollapse:true,autoScroll:true,title:"工作表单",listeners:{afterrender:function(b){a.formPanelLoaded=true;a.view_loadFlowInfo()}}});this.gridProgress=new CNOA_flow_flow_flowViewProgressClass(this.ulid);this.progressPanel=new Ext.Panel({headerStyle:"border-width:0",style:"margin-bottom:10px;",border:false,frame:true,animCollapse:false,collapsible:true,titleCollapse:true,title:"流程进度",layout:"fit",items:[this.gridProgress.grid],listeners:{afterrender:function(c){var b={}}}});this.gridEvent=new CNOA_flow_flow_flowViewEventClass(this.ulid);this.eventPanel=new Ext.Panel({headerStyle:"border-width:0",style:"margin-bottom:10px;",border:false,frame:true,layout:"fit",animCollapse:false,collapsible:true,titleCollapse:true,title:"事件日志",items:[this.gridEvent.grid],listeners:{afterrender:function(b){}}});this.gridReader=new CNOA_flow_flow_flowViewReaderClass(this.ulid);this.readerPanel=new Ext.Panel({headerStyle:"border-width:0",border:false,frame:true,layout:"fit",animCollapse:false,collapsible:true,titleCollapse:true,title:"评阅记录",items:[this.gridReader.grid],listeners:{afterrender:function(b){}}});this.centerPanel=new Ext.Panel({bodyStyle:"padding:10px",border:false,autoScroll:true,region:"center",items:[{xtype:"container",autoEl:"div",id:this.ID_printArea,items:[this.flowPanel,this.formPanel,this.progressPanel,this.eventPanel,this.readerPanel]}]});this.exportArray={i:1,f:1,p:1,e:1,r:1};this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.centerPanel],tbar:new Ext.Toolbar({items:["显示：",{xtype:"checkbox",boxLabel:"流程信息",checked:true,listeners:{check:function(c,b){if(b){a.exportArray.i=1;a.flowPanel.show()}else{a.exportArray.i=0;a.flowPanel.hide()}}}},"-",{xtype:"checkbox",boxLabel:"工作表单",checked:true,listeners:{check:function(c,b){if(b){a.exportArray.f=1;a.formPanel.show()}else{a.exportArray.f=0;a.formPanel.hide()}}}},"-",{xtype:"checkbox",boxLabel:"流程进度",checked:true,listeners:{check:function(c,b){if(b){a.exportArray.p=1;a.progressPanel.show()}else{a.exportArray.p=0;a.progressPanel.hide()}}}},"-",{xtype:"checkbox",boxLabel:"事件日志",checked:true,listeners:{check:function(c,b){if(b){a.exportArray.e=1;a.eventPanel.show()}else{a.exportArray.e=0;a.eventPanel.hide()}}}},"-",{xtype:"checkbox",boxLabel:"评阅记录",checked:true,listeners:{check:function(c,b){if(b){a.exportArray.r=1;a.readerPanel.show()}else{a.exportArray.r=0;a.readerPanel.hide()}}}},"-",{text:"导出",iconCls:"icon-download",tooltip:"导出为HTML文件",menu:{items:[{iconCls:"document-html",text:"导出为网页文件(html)",handler:function(){a.exportFlow("html")}.createDelegate(this)},{iconCls:"document-word",text:"导出为Word文档",handler:function(){a.exportFlow("word")}.createDelegate(this)}]}},"-",{handler:function(b,c){a.dispenseFlow()}.createDelegate(this),iconCls:"icon-flow-entrust",tooltip:"分发",text:"分发"},"-",{handler:function(b,c){a.gridReader.showSay()}.createDelegate(this),hidden:Ext.isAir?true:false,iconCls:"icon-view-form-png",text:"我要评阅"},"-",{handler:function(b,c){a.printFlow()}.createDelegate(this),hidden:Ext.isAir?true:false,iconCls:"icon-print",tooltip:"打印",text:"打印"},"-",{iconCls:"icon-dialog-cancel",text:lang("close"),handler:function(b,c){a.closeTab()}.createDelegate(this)},"->",{xtype:"cnoa_helpBtn",helpid:19}]})})},view_loadFlowInfo:function(){var a=this;if(!this.flowPanelLoaded||!this.formPanelLoaded){return false}Ext.Ajax.request({url:a.baseUrl+"&task=show_loadFlowInfo",method:"POST",params:{ulid:a.ulid},success:function(c){var b=Ext.decode(c.responseText);if(b.success===true){a.topTpl.overwrite(a.flowPanel.body,b.data.flowInfo);a.flowInfo=b.data.flowInfo;a.formPanel.body.update(b.data.formInfo)}else{CNOA.msg.alert(b.msg,function(){})}}})},closeTab:function(){mainPanel.closeTab("CNOA_MENU_FLOW_USER_SHOWFLOW")},exportFlow:function(f){var g=this;var b=Ext.id();var a=Ext.encode(this.exportArray);var e=function(){c.getForm().submit({url:g.baseUrl+"&task=exportFlow&target="+f,params:{ulid:g.ulid,exportArray:a},method:"POST",waitMsg:lang("waiting"),success:function(h,i){var j=Ext.getCmp(b);j.getEl().update("请点击下载：<br/>"+i.result.msg)}.createDelegate(this),failure:function(h,i){d.close();CNOA.msg.alert(i.result.msg,function(){})}.createDelegate(this)})};var c=new Ext.form.FormPanel({autoWidth:true,border:false,hideBorders:true,labelWidth:70,labelAlign:"right",waitMsgTarget:true,bodyStyle:"padding:10px;",listeners:{afterrender:function(h){e()}},items:[{xtype:"displayfield",name:"name",fieldLabel:lang("flowName"),value:g.flowInfo.name},new Ext.BoxComponent({id:b,autoEl:{tag:"div",style:"padding-left:16px",html:""}})]});var d=new Ext.Window({title:"导出工作流程",width:320,height:150,layout:"fit",modal:true,maximizable:false,resizable:false,items:[c],buttons:[{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){d.close()}}]}).show()},printFlow:function(){var a=Ext.encode(this.exportArray);window.open(this.baseUrl+"&task=exportFlow&target=printer&ulid="+this.ulid+"&exportArray="+a,"_blank","width=740,height="+(screen.availHeight-120)+",left="+((screen.availWidth-740)/2)+",top=60,scrollbars=yes,resizable=yes,status=no")},readedFlow:function(){CNOA_flow_flow_view_reader=new CNOA_flow_flow_view_readerClass(this.ulid);CNOA_flow_flow_view_reader.show()},dispenseFlow:function(){var e=this;var c=Ext.id();var b=function(g){var h=a.getForm();if(h.isValid()){h.submit({url:e.baseUrl+"&task=dispenseFlow",waitTitle:lang("notice"),method:"POST",waitMsg:lang("waiting"),params:{ulid:e.ulid},success:function(f,i){CNOA.msg.alert(i.result.msg,function(){d.close()})}.createDelegate(this),failure:function(f,i){CNOA.msg.alert(i.result.msg)}.createDelegate(this)})}else{CNOA.miniMsg.alertShowAt(g,"未选择要分发的人员",30)}};var a=new Ext.form.FormPanel({autoWidth:true,border:false,hideBorders:true,labelWidth:70,labelAlign:"right",waitMsgTarget:true,bodyStyle:"padding:10px;",items:[{xtype:"textarea",style:"margin: 0; padding: 0;",height:65,width:325,readOnly:true,allowBlank:false,fieldLabel:"分发给谁",name:"allUserNames"},{xtype:"hidden",name:"allUids"},{xtype:"btnForPoepleSelector",style:"margin: 0; padding: 0",autoWidth:true,dataUrl:e.baseUrl+"&task=getAllUserListsInPermitDeptTree",style:"margin-left:75px;",text:lang("selectPeople"),listeners:{selected:function(h,j){var k=new Array();var g=new Array();if(j.length>0){for(var f=0;f<j.length;f++){k.push(j[f].uname);g.push(j[f].uid)}}a.getForm().findField("allUserNames").setValue(k.join(","));a.getForm().findField("allUids").setValue(g.join(","))},onrender:function(f){f.setSelectedUids(a.getForm().findField("allUids").getValue().split(","))}}}]});var d=new Ext.Window({title:"分发工作流",width:475,height:180,layout:"fit",modal:true,maximizable:false,resizable:false,items:[a],buttons:[{text:"分发",id:c,handler:function(f){b(f)}},{text:lang("close"),handler:function(){d.close()}}]}).show()}};var CNOA_flow_flow_user_viewflowClass,CNOA_flow_flow_user_viewflow;var CNOA_flow_flow_user_dealflow_goNextStepClass,CNOA_flow_flow_user_dealflow_goNextStep;CNOA_flow_flow_user_dealflow_goNextStepClass=CNOA.Class.create();CNOA_flow_flow_user_dealflow_goNextStepClass.prototype={init:function(a){var b=this;this.baseUrl="index.php?app=flow&func=flow&action=user";this.ulid=a;this.operatorperson=null;this.sponsor=false;this.stepText="";this.ID_html=Ext.id();this.ID_multiselects=Ext.id();this.ID_multiselects_tip=Ext.id();this.ID_nextStepTr1=Ext.id();this.ID_nextStepTr2=Ext.id();this.ID_window=Ext.id();this.smsSender=new Ext.form.SMSSender({from:"flow",hideLabel:true,boxLabel:"手机短信提醒"});this.Tpl=new Ext.Template('<table width="596" border="0" cellspacing="1" cellpadding="0" style="background:#999;margin-bottom:5px;"><tr><td height="24" colspan="2" align="left" valign="middle" bgcolor="#C9C9C9">&nbsp;<b>下一步骤信息</b></td></tr><tr><td width="147" height="24" align="right" valign="middle" bgcolor="#D9D9D9">下一步骤名称:&nbsp;</td><td width="446" valign="middle" bgcolor="#F2F2F2">&nbsp;{name}</td></tr><tr id="'+this.ID_nextStepTr1+'"><td height="24" align="right" valign="middle" bgcolor="#D9D9D9">经办方式:&nbsp;</td><td valign="middle" bgcolor="#F2F2F2">&nbsp;{operatorperson}</td></tr><tr id="'+this.ID_nextStepTr2+'"><td height="24" align="right" valign="middle" bgcolor="#D9D9D9">转下下一步条件:&nbsp;</td><td valign="middle" bgcolor="#F2F2F2">&nbsp;{operatortype}</td></tr></table>');this.dataStoreFrom=new Ext.data.ArrayStore({data:[],fields:["uid","name"]});this.dataStoreTo=new Ext.data.ArrayStore({data:[],fields:["uid","name"]});this.formPanel=new Ext.form.FormPanel({autoWidth:true,border:false,hideBorders:true,labelWidth:100,labelAlign:"top",bodyStyle:"padding:10px;",waitMsgTarget:true,items:[{xtype:"panel",border:false,header:false,id:this.ID_html,html:""},this.smsSender,{xtype:"textarea",fieldLabel:"办理意见",name:"say",width:597,height:110,value:"同意"},{xtype:"radiogroup",hideLabel:true,name:"sayTgroup",height:50,width:250,items:[{boxLabel:"同意",name:"sayT",inputValue:"1",checked:true},{boxLabel:"不同意",name:"sayT",inputValue:"2"}],listeners:{change:function(d,c){if(c.inputValue=="1"){b.formPanel.getForm().findField("say").setValue("同意")}else{if(c.inputValue=="2"){b.formPanel.getForm().findField("say").setValue("不同意")}}}}},{xtype:"itemselector",name:"itemselector",hideLabel:true,id:this.ID_multiselects,imagePath:CNOA_EXTJS_PATH+"/ux/images/",multiselects:[{width:288,height:200,store:this.dataStoreFrom,displayField:"name",valueField:"uid",tbar:["待选人员",{text:"&nbsp;",disabled:true}]},{width:288,height:200,store:this.dataStoreTo,displayField:"name",valueField:"uid",tbar:["经办人","->",{text:"清除",iconCls:"icon-clear",handler:function(){b.formPanel.getForm().findField("itemselector").reset()}}]}]},{xtype:"displayfield",hideLabel:true,id:this.ID_multiselects_tip,value:"注意: 你所选择的经办人如果有多人，则列表第一人将作为主办人，只有主办人有权限决定他的下一步骤经办人。"}]});this.mainPanel=new Ext.Window({title:"转下一步 - 选择经办人",id:this.ID_window,width:630,height:makeWindowHeight(610),layout:"fit",modal:true,maximizable:false,resizable:false,items:[this.formPanel],buttons:[{text:"转下一步",iconCls:"icon-fileview-column3",handler:function(d){var h=b.formPanel.getForm();if(h.isValid()){var c=h.findField("itemselector").getValue();var e=h.findField("say").getValue();if(b.sponsor){if(Ext.isEmpty(c)){CNOA.miniMsg.alertShowAt(d,"请选择至少一人作为经办人");return false}else{var g=c.split(",");if((b.operatorperson=="1")&&(g.length!=1)){CNOA.miniMsg.alertShowAt(d,"该步骤经办方式为:单人办理, 只能选择一人作为经办人");return false}}}if(b.smsSender.validateValue()){CNOA_flow_flow_user_viewflow.sendFormStep2(e,c,function(){try{b.smsSender.submit()}catch(f){}b.close()})}}else{CNOA.miniMsg.alertShowAt(d,"请检查未填写的地方")}}},{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){b.close()}}],listeners:{close:function(){}}})},show:function(){this.mainPanel.show();this.loadNextStepInfo()},close:function(){this.mainPanel.close()},loadNextStepInfo:function(){var a=this;a.mainPanel.getEl().mask(lang("waiting"));Ext.Ajax.request({url:a.baseUrl+"&task=deal_loadNextStepInfo",method:"POST",params:{ulid:a.ulid},success:function(g){var b=Ext.decode(g.responseText);if(b.success===true){var f=b.data;var e=f.nextData;a.operatorperson=e.operatorperson;e.operatorperson=e.operatorperson=="1"?"单人办理":"多人办理";e.operatortype=e.operatortype=="1"?"任意一人同意":"所有人同意";a.Tpl.append(a.ID_html,e);if(f.nextStepType=="end"){Ext.fly(a.ID_nextStepTr1).dom.style.display="none";Ext.fly(a.ID_nextStepTr2).dom.style.display="none";Ext.getCmp(a.ID_multiselects).hide();Ext.getCmp(a.ID_multiselects_tip).hide();a.mainPanel.setHeight(360)}else{if(f.sponsor=="1"){a.sponsor=true;a.dataStoreFrom.removeAll();for(var d=0;d<e.operator.length;d++){var c=new Ext.data.Record(e.operator[d]);a.dataStoreFrom.add(c)}}else{a.sponsor=false;Ext.getCmp(a.ID_multiselects).hide();Ext.getCmp(a.ID_multiselects_tip).hide();a.mainPanel.setHeight(360)}}}else{CNOA.msg.alert(b.msg,function(){a.close()})}a.mainPanel.getEl().unmask()}})}};CNOA_flow_flow_user_viewflowClass=CNOA.Class.create();CNOA_flow_flow_user_viewflowClass.prototype={init:function(){var a=this;this.ulid=CNOA.flow.flow.user_viewflow.ulid;this.ID_goto_nextstep=Ext.id();this.ID_disagree=Ext.id();this.ID_goto_prestep=Ext.id();this.ID_huiqian=Ext.id();this.ID_zhuangban=Ext.id();this.ID_huiqian_say=Ext.id();this.baseUrl="index.php?app=flow&func=flow&action=user";this.flowPanelLoaded=this.formPanelLoaded=this.progressPanelLoaded=this.eventPanelLoaded=false;this.ID_btn_edit=Ext.id();this.ID_btn_delete=Ext.id();this.ID_tree_treeRoot=Ext.id();this.ID_printArea=Ext.id();this.topTpl=new Ext.XTemplate('<table width="100%" border="0" cellspacing="1" cellpadding="0" style="background-color:#CDCDCD">',"  <tr>",'    <td width="15%" height="24" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">流程编号:&nbsp;</td>','    <td width="35%" valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{name}</td>','    <td width="15%" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">'+lang("flowName")+":&nbsp;</td>",'    <td width="35%" valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;[{flowname}]{title}</td>',"  </tr>","  <tr>",'    <td height="24" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">发起人:&nbsp;</td>','    <td valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{uname}</td>','    <td align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">发起日期:&nbsp;</td>','    <td valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{posttime}</td>',"  </tr>","  <tr>",'    <td height="24" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">当前步骤:&nbsp;</td>','    <td valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{stepText}</td>','    <td align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">流程状态:&nbsp;</td>','    <td valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{statusText}</td>',"  </tr>","  <tr>",'    <td height="24" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">申请事由:&nbsp;</td>','    <td valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{reason}</td>','    <td align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">特殊备注:&nbsp;</td>','    <td valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{about}</td>',"  </tr>",'  <tpl if="attachCount &gt; 0">',"  <tr>",'    <td height="24" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">流程附件:&nbsp;</td>','    <td colspan="3" valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;',"		{attach}","    </td>","  </tr>","  </tpl>","</table>");this.flowPanel=new Ext.Panel({headerStyle:"border-width:0",border:false,frame:true,animCollapse:false,collapsible:true,titleCollapse:true,style:"margin-bottom:10px;",title:"流程信息",listeners:{afterrender:function(b){a.flowPanelLoaded=true;a.view_loadFlowInfo()}}});this.formPanel=new Ext.form.FormPanel({headerStyle:"border-width:0",style:"margin-bottom:10px;",bodyStyle:"background-color:#FFF",border:false,frame:true,waitMsgTarget:true,animCollapse:false,collapsible:true,titleCollapse:true,autoScroll:true,title:"工作表单",listeners:{afterrender:function(b){a.formPanelLoaded=true;a.view_loadFlowInfo()}}});this.gridProgress=new CNOA_flow_flow_flowViewProgressClass(this.ulid);this.progressPanel=new Ext.Panel({headerStyle:"border-width:0",style:"margin-bottom:10px;",border:false,frame:true,animCollapse:false,collapsible:true,titleCollapse:true,title:"流程进度",items:[this.gridProgress.grid],listeners:{afterrender:function(c){var b={}}}});this.gridEvent=new CNOA_flow_flow_flowViewEventClass(this.ulid);this.eventPanel=new Ext.Panel({headerStyle:"border-width:0",border:false,frame:true,animCollapse:false,collapsible:true,titleCollapse:true,title:"事件日志",items:[this.gridEvent.grid],listeners:{afterrender:function(c){var b={}}}});this.exportArray={i:1,f:1,p:1,e:1};this.centerPanel=new Ext.Panel({bodyStyle:"padding:10px",border:false,autoScroll:true,region:"center",items:[{xtype:"container",autoEl:"div",id:this.ID_printArea,items:[this.flowPanel,this.formPanel,this.progressPanel,this.eventPanel]}],tbar:new Ext.Toolbar({items:["显示：",{xtype:"checkbox",boxLabel:"流程信息",checked:true,listeners:{check:function(c,b){if(b){a.exportArray.i=1;a.flowPanel.show()}else{a.exportArray.i=0;a.flowPanel.hide()}}}},"-",{xtype:"checkbox",boxLabel:"工作表单",checked:true,listeners:{check:function(c,b){if(b){a.exportArray.f=1;a.formPanel.show()}else{a.exportArray.f=0;a.formPanel.hide()}}}},"-",{xtype:"checkbox",boxLabel:"流程进度",checked:true,listeners:{check:function(c,b){if(b){a.exportArray.p=1;a.progressPanel.show()}else{a.exportArray.p=0;a.progressPanel.hide()}}}},"-",{xtype:"checkbox",boxLabel:"事件日志",checked:true,listeners:{check:function(c,b){if(b){a.exportArray.e=1;a.eventPanel.show()}else{a.exportArray.e=0;a.eventPanel.hide()}}}},"-",{text:"导出",iconCls:"icon-download",tooltip:"导出为HTML文件",menu:{items:[{iconCls:"document-html",text:"导出为网页文件(html)",handler:function(){a.exportFlow("html")}.createDelegate(this)},{iconCls:"document-word",text:"导出为Word文档",handler:function(){a.exportFlow("word")}.createDelegate(this)}]}},"-",{handler:function(b,c){a.printFlow()}.createDelegate(this),iconCls:"icon-print",hidden:Ext.isAir?true:false,tooltip:"打印",text:"打印"}]})});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.centerPanel],tbar:new Ext.Toolbar({items:[{iconCls:"icon-flow-goto-nextstep",text:"同意(转下一步)",id:this.ID_goto_nextstep,handler:function(b,c){var d=a.formPanel.getForm();if(!d.isValid()||!a.checkForm()){CNOA.miniMsg.alertShowAt(b,"部分表单未完成,请检查(请确认工作表单的必填字段已经填写完毕)",30);return false}a.sendFormStep1()}.createDelegate(this)},"-",{iconCls:"icon-flow-entrust",text:"会签",id:this.ID_huiqian,handler:function(b,c){a.huiqian()}.createDelegate(this)},"-",{iconCls:"icon-flow-entrust",text:"转办",id:this.ID_zhuangban,handler:function(b,c){a.zhuangban()}.createDelegate(this)},"-",{iconCls:"icon-flow-entrust",text:"会签意见",hidden:true,id:this.ID_huiqian_say,handler:function(b,c){a.showHuiqianWindow()}.createDelegate(this)},"-",{iconCls:"icon-flow-goto-firststep",text:"不同意(退件)",id:this.ID_disagree,handler:function(b,c){a.disagree()}.createDelegate(this)},"-",{iconCls:"icon-flow-goto-prevstep",text:"退回上一步",id:this.ID_goto_prestep,handler:function(b,c){a.goto_prevstep()}.createDelegate(this)},"-",{iconCls:"icon-dialog-cancel",text:lang("close"),handler:function(b,c){a.closeTab()}.createDelegate(this)},"->",{xtype:"cnoa_helpBtn",helpid:20}]})})},makeStatus:function(a){var b="";if(a==0){b="<span class='cnoa_color_gray'>未发送</span>"}else{if(a==1){b="<span class='cnoa_color_orange'>办理中</span>"}else{if(a==2){b="<span class='cnoa_color_green'>已办理</span>"}else{if(a==3){b="<span class='cnoa_color_red'>已退件</span> "}else{if(a==4){b="<span class='cnoa_color_graye'>已撤销</span>"}}}}}return b},makeOperate:function(i,f,d,g,e,a){var j=d.data;var b=j.status;var c="<a href='javascript:void(0);' onclick='("+i+");'>查看</a>";c+="&nbsp;&nbsp;";c+=(b=="0"||b=="3"||b=="4")?"<a href='javascript:void(0);' onclick='CNOA_flow_flow_user_viewflow.deleteFlow("+i+");'>删除</a>":"　　";c+="&nbsp;&nbsp;";c+=b=="0"?"<a href='javascript:void(0);' onclick='CNOA_flow_flow_user_viewflow.editPanel("+i+");'>编辑</a>":"　　";c+="&nbsp;&nbsp;";c+=(b!="0"&&b!="3"&&b!="4")?"<a href='javascript:void(0);' onclick='("+i+");'>召回</a>":"　　";c+="&nbsp;&nbsp;";c+=(b!="0"&&b!="3"&&b!="4")?"<a href='javascript:void(0);' onclick='("+i+");'>撤销</a>":"　　";return c},view_loadFlowInfo:function(){var a=this;if(!this.flowPanelLoaded||!this.formPanelLoaded){return false}Ext.Ajax.request({url:a.baseUrl+"&task=view_loadFlowInfo",method:"POST",params:{ulid:a.ulid},success:function(e){var b=Ext.decode(e.responseText);if(b.success===true){a.topTpl.overwrite(a.flowPanel.body,b.data.flowInfo);a.stepText=b.data.flowInfo.stepText;if(b.data.flowInfo.status=="2"){a.hideOperatBtn()}if(b.data.isEntrust=="1"){a.showEntrustBtn()}else{if(b.data.isHuiQian=="1"){a.showHuiqianBtn()}}var d=Ext.id();var c="<div style='padding-bottom:5px;' class='x-border-layout-ct'><div class='flow_flow_form'><div>图示：</div><div class='flow_form_must_struct flow_form_must_color'>&nbsp;</div><div>必填字段</div><div class='flow_form_must_struct flow_form_need_color'>&nbsp;</div><div>可填字段</div><div class='flow_form_must_struct flow_form_disabled_color'>&nbsp;</div><div>不可填字段</div></div><div class='clear'></div><div id='"+d+"'></div></div>";a.formPanel.body.update(c+b.data.formInfo,false,function(){if(b.data.flowInfo.allowup=="1"){new Ext.form.FlashFile({xtype:"flashfile",fieldLabel:lang("attach"),name:"attach",style:"margin-top:5px;",inputPre:"filesUpload",renderTo:d})}});if(b.data.flowInfo.status=="1"&&b.data.flowInfo.step=="0"){var f=a.formPanel.getEl().query("input[name^=FLOWDATA],textarea[name^=FLOWDATA],select[name^=FLOWDATA]");Ext.each(f,function(g,h){Ext.each(b.data.formData,function(j,i){if(("FLOWDATA["+j.itemid+"]")==g.name){g.value=j.data}});if(g.readOnly==true){g.style.border="1px solid #E1E1E1";g.style.backgroundColor="#F6F6F6"}else{g.style.border="1px solid #BCBCBC"}g.title=""})}}else{CNOA.msg.alert(b.msg,function(){})}}})},hideOperatBtn:function(){Ext.getCmp(this.ID_goto_nextstep).hide();Ext.getCmp(this.ID_disagree).hide();Ext.getCmp(this.ID_goto_prestep).hide()},showEntrustBtn:function(){Ext.getCmp(this.ID_huiqian).hide()},showHuiqianBtn:function(){Ext.getCmp(this.ID_goto_nextstep).hide();Ext.getCmp(this.ID_disagree).hide();Ext.getCmp(this.ID_goto_prestep).hide();Ext.getCmp(this.ID_huiqian).hide();Ext.getCmp(this.ID_zhuangban).hide();Ext.getCmp(this.ID_huiqian_say).show()},showHuiqianWindow:function(){var e=this;var c=function(){var g=b.getForm();g.load({url:e.baseUrl+"&task=loadHuiQianInfo",params:{ulid:e.ulid},method:"POST",waitTitle:lang("notice"),success:function(f,h){},failure:function(f,h){CNOA.msg.alert(h.result.msg,function(){})}})};var b=new Ext.form.FormPanel({border:false,hideBorders:true,labelWidth:90,labelAlign:"top",waitMsgTarget:true,bodyStyle:"padding-top:20px;padding:10px;",items:[{xtype:"textarea",height:147,width:360,name:"say",hideLabel:true,value:"已阅"},{xtype:"radiogroup",hideLabel:true,width:200,allowBlank:false,name:"sayTGroup",items:[{boxLabel:"已阅",name:"sayT",inputValue:"1",checked:true},{boxLabel:"同意",name:"sayT",inputValue:"2"},{boxLabel:"不同意",name:"sayT",inputValue:"3"}],listeners:{change:function(g,f){if(f.inputValue=="1"){b.getForm().findField("say").setValue("已阅")}else{if(f.inputValue=="2"){b.getForm().findField("say").setValue("同意")}else{if(f.inputValue=="3"){b.getForm().findField("say").setValue("不同意")}}}}}}]});var d=new Ext.Window({width:400,height:300,title:"会签意见",resizable:false,modal:true,layout:"fit",items:b,buttons:[{text:lang("ok"),id:e.ID_btn_report_window_report,iconCls:"icon-btn-save",handler:function(){a()}.createDelegate(this)},{text:lang("cancel"),iconCls:"icon-dialog-cancel",handler:function(){d.close()}.createDelegate(this)}]}).show();var a=function(){if(b.getForm().isValid()){b.getForm().submit({url:e.baseUrl+"&task=submitHuiQianInfo",waitTitle:lang("notice"),method:"POST",waitMsg:lang("waiting"),params:{ulid:e.ulid},success:function(f,g){CNOA.msg.notice(g.result.msg,"流程管理");try{CNOA_flow_flow_user_dealflow.store.reload()}catch(h){}e.view_loadFlowInfo();e.gridEvent.store.reload();d.close()}.createDelegate(this),failure:function(f,g){CNOA.msg.alert(g.result.msg)}.createDelegate(this)})}};c()},goToDealFlowList:function(){mainPanel.loadClass("index.php?app=flow&func=flow&action=user&task=loadPage&from=dealflow","CNOA_MENU_FLOW_DEALFLOW","审批流程","icon-flow-deal")},closeTab:function(){mainPanel.closeTab("CNOA_MENU_FLOW_USER_VIEWFLOW")},huiqian:function(){var f=this;var a=Ext.id();var c=function(){var g=b.getForm();if(g.isValid()){g.submit({url:f.baseUrl+"&task=setHuiQianInfo",waitTitle:lang("notice"),method:"POST",waitMsg:lang("waiting"),params:{ulid:f.ulid},success:function(h,i){CNOA.msg.notice(i.result.msg,"流程管理");d.close()}.createDelegate(this),failure:function(h,i){CNOA.msg.alert(i.result.msg,function(){})}.createDelegate(this)})}};var e=function(){var g=b.getForm();g.load({url:f.baseUrl+"&task=getHuiQianInfo",params:{ulid:f.ulid},method:"POST",waitTitle:lang("notice"),success:function(h,i){},failure:function(h,i){CNOA.msg.alert(i.result.msg,function(){})}})};var b=new Ext.form.FormPanel({border:false,waitMsgTarget:true,bodyStyle:"padding:10px;",labelAlign:"top",items:[{xtype:"displayfield",hideLabel:true,value:"步骤名称: "+f.stepText,name:"stepText"},{xtype:"textarea",width:483,height:188,readOnly:true,fieldLabel:"会签人员",name:"allUserNames"},{xtype:"hidden",name:"allUids"},{xtype:"btnForPoepleSelector",autoWidth:true,dataUrl:this.baseUrl+"&task=getAllUserListsInPermitDeptTree",text:lang("selectPeople"),listeners:{selected:function(j,k){var l=new Array();var h=new Array();if(k.length>0){for(var g=0;g<k.length;g++){l.push(k[g].uname);h.push(k[g].uid)}}b.getForm().findField("allUserNames").setValue(l.join(","));b.getForm().findField("allUids").setValue(h.join(","))},onrender:function(g){g.setSelectedUids(b.getForm().findField("allUids").getValue().split(","))},afterrender:function(){e()}}}]});var d=new Ext.Window({title:"设置本步骤会签人员",modal:true,maximizable:false,resizable:false,width:520,height:360,layout:"fit",items:[b],buttons:[{iconCls:"icon-btn-save",text:lang("ok"),handler:function(g,h){c()}.createDelegate(this)},{iconCls:"icon-dialog-cancel",text:lang("cancel"),handler:function(g,h){d.close()}.createDelegate(this)}]}).show()},zhuangban:function(){var d=this;var b=function(){var e=a.getForm();if(e.isValid()){e.submit({url:d.baseUrl+"&task=setZhuangbanInfo",waitTitle:lang("notice"),method:"POST",waitMsg:lang("waiting"),params:{ulid:d.ulid},success:function(f,g){CNOA.msg.notice(g.result.msg,"流程管理");c.close();d.closeTab();try{CNOA_flow_flow_user_dealflow.store.reload()}catch(h){}}.createDelegate(this),failure:function(f,g){CNOA.msg.alert(g.result.msg,function(){})}.createDelegate(this)})}};var a=new Ext.form.FormPanel({border:false,waitMsgTarget:true,bodyStyle:"padding:10px;",labelAlign:"top",items:[{xtype:"hidden",name:"uid"},{xtype:"triggerForPeople",fieldLabel:"选择转办人",allowBlank:false,name:"uname",dataUrl:d.baseUrl+"&task=getAllUserListsInPermitDeptTree",width:340,listeners:{selected:function(g,f,e){a.getForm().findField("uid").setValue(f)}}},{xtype:"textarea",width:340,height:200,fieldLabel:"转办意见",name:"say"}]});var c=new Ext.Window({title:"转办工作流",modal:true,maximizable:false,resizable:false,width:375,height:360,layout:"fit",items:[a],buttons:[{iconCls:"icon-btn-save",text:lang("ok"),handler:function(e,f){b()}.createDelegate(this)},{iconCls:"icon-dialog-cancel",text:lang("cancel"),handler:function(e,f){c.close()}.createDelegate(this)}]}).show()},disagree:function(){var f=this;var a=Ext.id();var e=new Ext.form.SMSSender({from:"flow",hideLabel:true,boxLabel:"手机短信提醒"});var c=function(){var g=b.getForm();if(g.isValid()){g.submit({url:f.baseUrl+"&task=disagree",waitTitle:lang("notice"),method:"POST",waitMsg:lang("waiting"),params:{ulid:f.ulid},success:function(h,i){try{e.submit()}catch(j){}CNOA.msg.notice(i.result.msg,"流程管理");d.close();f.closeTab();try{CNOA_flow_flow_user_dealflow.store.reload()}catch(j){}}.createDelegate(this),failure:function(h,i){CNOA.msg.alert(i.result.msg,function(){})}.createDelegate(this)})}};var b=new Ext.form.FormPanel({border:false,waitMsgTarget:true,bodyStyle:"padding:10px;",labelAlign:"top",items:[{xtype:"textarea",width:483,height:100,value:"不同意",name:"reason",fieldLabel:"不同意理由"},{xtype:"radiogroup",hideLabel:true,width:200,allowBlank:false,name:"sayTgroup",items:[{boxLabel:"同意",name:"sayT",inputValue:"1"},{boxLabel:"不同意",name:"sayT",inputValue:"2",checked:true}],listeners:{change:function(h,g){if(g.inputValue=="1"){b.getForm().findField("reason").setValue("同意")}else{if(g.inputValue=="2"){b.getForm().findField("reason").setValue("不同意")}}}}},e]});var d=new Ext.Window({title:"不同意(退件)",maximizable:false,resizable:false,width:520,height:300,layout:"fit",items:[b],buttons:[{iconCls:"icon-btn-save",text:lang("ok"),handler:function(g,h){c()}.createDelegate(this)},{iconCls:"icon-dialog-cancel",text:lang("cancel"),handler:function(g,h){d.close()}.createDelegate(this)}]}).show()},goto_prevstep:function(){var f=this;var a=Ext.id();var e=new Ext.form.SMSSender({from:"flow",hideLabel:true,boxLabel:"手机短信提醒"});var c=function(){var g=b.getForm();if(g.isValid()){g.submit({url:f.baseUrl+"&task=gotoPrevstep",waitTitle:lang("notice"),method:"POST",waitMsg:lang("waiting"),params:{ulid:f.ulid},success:function(h,i){try{e.submit()}catch(j){}CNOA.msg.notice(i.result.msg,"流程管理");d.close();f.closeTab();try{CNOA_flow_flow_user_dealflow.store.reload()}catch(j){}}.createDelegate(this),failure:function(h,i){CNOA.msg.alert(i.result.msg,function(){})}.createDelegate(this)})}};var b=new Ext.form.FormPanel({border:false,bodyStyle:"padding:10px;",labelAlign:"top",waitMsgTarget:true,items:[{xtype:"textarea",width:483,height:220,name:"reason",fieldLabel:"退回理由"},e]});var d=new Ext.Window({title:"退回上一步",maximizable:false,resizable:false,width:520,height:360,layout:"fit",items:[b],buttons:[{iconCls:"icon-btn-save",text:lang("ok"),handler:function(g,h){c()}.createDelegate(this)},{iconCls:"icon-dialog-cancel",text:lang("cancel"),handler:function(g,h){d.close()}.createDelegate(this)}]}).show()},sendFormStep1:function(){var a=this;CNOA_flow_flow_user_dealflow_goNextStep=new CNOA_flow_flow_user_dealflow_goNextStepClass(a.ulid);CNOA_flow_flow_user_dealflow_goNextStep.show()},checkForm:function(){var b=this.formPanel.getEl().query("input[name^=FLOWDATA][class*=flow_form_must],textarea[name^=FLOWDATA][class*=flow_form_must],select[name^=FLOWDATA][class*=flow_form_must]");var a=true;Ext.each(b,function(c,d){if(Ext.isEmpty(c.value)){a=false}});return a},sendFormStep2:function(c,a,e){var d=this;if(Ext.isArray(a)){a=a.join(",")}var b=d.formPanel.getForm();if(b.isValid()&&this.checkForm()){b.submit({url:d.baseUrl+"&task=deal_sendFlow",waitTitle:lang("notice"),method:"POST",waitMsg:lang("waiting"),params:{ulid:d.ulid,nextUids:a,say:c},success:function(f,g){try{e.call(this)}catch(h){}CNOA.msg.notice(g.result.msg,"流程管理");d.goToDealFlowList();d.closeTab();try{CNOA_flow_flow_user_dealflow.store.reload()}catch(h){}}.createDelegate(this),failure:function(f,g){CNOA.msg.alert(g.result.msg,function(){})}.createDelegate(this)})}else{CNOA.miniMsg.alertShowAt(d.ID_goto_nextstep,lang("formValid"),30)}},exportFlow:function(f){var g=this;var b=Ext.id();var a=Ext.encode(this.exportArray);var e=function(){c.getForm().submit({url:g.baseUrl+"&task=exportFlow&target="+f,params:{ulid:g.ulid,exportArray:a},method:"POST",waitMsg:lang("waiting"),success:function(h,i){var j=Ext.getCmp(b);j.getEl().update("请点击下载：<br/>"+i.result.msg)}.createDelegate(this),failure:function(h,i){d.close();CNOA.msg.alert(i.result.msg,function(){})}.createDelegate(this)})};var c=new Ext.form.FormPanel({autoWidth:true,border:false,hideBorders:true,labelWidth:70,labelAlign:"right",waitMsgTarget:true,bodyStyle:"padding:10px;",listeners:{afterrender:function(h){e()}},items:[{xtype:"displayfield",name:"name",fieldLabel:lang("flowName")},new Ext.BoxComponent({id:b,autoEl:{tag:"div",style:"padding-left:16px",html:""}})]});var d=new Ext.Window({title:"导出工作流程",width:320,height:150,layout:"fit",modal:true,maximizable:false,resizable:false,items:[c],buttons:[{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){d.close()}}]}).show()},printFlow:function(){var a=Ext.encode(this.exportArray);window.open(this.baseUrl+"&task=exportFlow&target=printer&ulid="+this.ulid+"&exportArray="+a,"_blank","width=740,height="+(screen.availHeight-120)+",left="+((screen.availWidth-740)/2)+",top=60,scrollbars=yes,resizable=yes,status=no")}};var CNOA_flow_flow_user_flowlistOutClass,CNOA_flow_flow_user_flowlistOut;CNOA_flow_flow_user_flowlistOutClass=CNOA.Class.create();CNOA_flow_flow_user_flowlistOutClass.prototype={init:function(){var a=this;this.sort=CNOA.flow.flow.user_flowlistOut.sort;this.baseUrl="index.php?app=flow&func=flow&action=user";this.ID_btn_edit=Ext.id();this.ID_btn_delete=Ext.id();this.ID_tree_treeRoot=Ext.id();this.fields=[{name:"lid"},{name:"name"},{name:"formid"}];this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getFlowJsonDataForout&sort="+this.sort,disableCaching:true}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields})});this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.store.load();this.colModel=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"lid",dataIndex:"lid",hidden:true},{header:lang("flowName"),dataIndex:"name",width:140,sortable:true,menuDisabled:true},{header:"查看",dataIndex:"lid",width:70,sortable:false,menuDisabled:true,renderer:this.makeView.createDelegate(this)},{header:lang("opt"),dataIndex:"lid",width:70,sortable:false,menuDisabled:true,renderer:this.makeOperate.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.grid=new Ext.grid.GridPanel({stripeRows:true,store:this.store,loadMask:{msg:lang("waiting")},cm:this.colModel,hideBorders:true,border:false,region:"center",viewConfig:{forceFit:true},listeners:{rowdblclick:function(b,c){},rowclick:function(b,f,c,d){}},tbar:new Ext.Toolbar({items:[{iconCls:"icon-system-refresh",text:lang("refresh"),handler:function(b,c){a.store.reload()}.createDelegate(this)},"->",{xtype:"cnoa_helpBtn",helpid:17}]}),bbar:this.pagingBar});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.grid]})},makeView:function(i,f,d,g,e,b){var j=d.data;var a="./resources/images/icons/";var c="<div style='margin-top:2px;'><a href='javascript:void(0);' onclick='CNOA_flow_flow_user_flowlistOut.viewFlow("+i+', "'+j.name+"\");'><img src='"+a+"icon-flow.png' style='margin:0 2px 4px 0' align='absmiddle' />流程图</a>";c+="&nbsp;&nbsp;&nbsp;";c+="<a href='javascript:void(0);' onclick='CNOA_flow_flow_user_flowlistOut.viewForm("+j.formid+");'><img src='"+a+"application_view_list.png' style='margin:0 2px 4px 0' align='absmiddle' />工作表单</a>";c+="</div>";return c},makeOperate:function(i,f,d,g,e,b){var j=d.data;var a="./resources/images/icons/";var c="<div style='margin-top:2px;'><a href='javascript:void(0);' onclick='CNOA_flow_flow_user_flowlistOut.newFlow("+i+");'><img src='"+a+"page_addedit.png' style='margin:0 2px 4px 0' align='absmiddle' />新建</a>";c+="</div>";return c},newFlow:function(a){mainPanel.closeTab("CNOA_MENU_FLOW_USER_NEWFLOW");mainPanel.loadClass("index.php?app=flow&func=flow&action=user&task=loadPage&from=newflow&ac=add&lid="+a,"CNOA_MENU_FLOW_USER_NEWFLOW","新建工作流程","icon-flow-new")},viewFlow:function(b,a){CNOA_flow_flow_flowpreview=new CNOA_flow_flow_flowpreviewClass(b,a);CNOA_flow_flow_flowpreview.show()},viewForm:function(g){var i=this;var d=Ext.getBody().getBox();var b=d.width-100;var c=d.height-100;var e=function(){Ext.Ajax.request({url:i.baseUrl+"&task=loadFormData",method:"POST",params:{fid:g},success:function(j){var h=Ext.decode(j.responseText);if(h.success===true){a.getEl().update("<center>"+h.data.content+"</center>")}else{CNOA.msg.alert(h.msg,function(){})}f.getEl().unmask()}})};var a=new Ext.Panel({border:false,html:"工作表单载入中...",listeners:{afterrender:function(h){e()}}});var f=new Ext.Window({title:"查看工作表单",width:b,height:c,layout:"fit",bodyStyle:"background-color:#FFFFFF",modal:true,autoScroll:true,maximizable:false,resizable:false,items:[a],buttons:[{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){f.close()}}],listeners:{show:function(h){h.getEl().mask(lang("waiting"))}}}).show()},viewForm2:function(e){var f=this;var a=Ext.id();var d=function(){b.getForm().load({url:f.baseUrl+"&task=loadFormData",params:{fid:e},method:"POST",waitMsg:lang("waiting"),success:function(g,h){var i=Ext.getCmp(a);if(h.result.data.fileInfo==null){i.getEl().update("下载工作表单: (该工作表单尚未上传)")}else{i.getEl().update('下载工作表单: <img src="./resources/images/icons/icon_save.gif"><a href="'+h.result.data.fileInfo.url+'" target="_blank" ext:qtip="请点击右键另存为">下载</a>')}}.createDelegate(this),failure:function(g,h){c.close();CNOA.msg.alert(h.result.msg,function(){})}.createDelegate(this)})};var b=new Ext.form.FormPanel({autoWidth:true,border:false,hideBorders:true,labelWidth:70,labelAlign:"right",waitMsgTarget:true,bodyStyle:"padding:10px;",listeners:{afterrender:function(g){d()}},items:[{xtype:"displayfield",name:"name",fieldLabel:"表单名称"},new Ext.BoxComponent({id:a,autoEl:{tag:"div",style:"padding-left:16px",html:""}})]});var c=new Ext.Window({title:"查看工作表单",width:350,height:200,layout:"fit",modal:true,maximizable:false,resizable:false,items:[b],buttons:[{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){c.close()}}]}).show()}};var CNOA_flow_flow_user_newcommonflow_Card1Class=CNOA.Class.create();CNOA_flow_flow_user_newcommonflow_Card1Class.prototype={init:function(){var a=this;this.ac=CNOA.flow.flow.user_newcommonflow.ac;this.ulid=CNOA.flow.flow.user_newcommonflow.ulid;this.baseUrl="index.php?app=flow&func=flow&action=user&module=commonFlow";this.baseField=[{xtype:"fieldset",title:"流程信息",autoHeight:true,defaults:{width:90,xtype:"textfield"},items:[{xtype:"panel",hideBorders:true,border:false,layout:"table",autoWidth:true,layoutConfig:{columns:2},items:[{xtype:"panel",layout:"form",width:350,items:[{xtype:"textfield",readOnly:true,fieldLabel:lang("flowName"),value:"通用流程",name:"flowname",width:255}]},{xtype:"panel",layout:"form",width:350,items:[{xtype:"cnoa_textfield",readOnly:true,fieldLabel:"流程编号",width:270,name:"name",value:"通用流程{NNNNNN}",tooltip:this.makeNumberTip()}]}]},{xtype:"panel",hideBorders:true,border:false,layout:"table",autoWidth:true,layoutConfig:{columns:2},items:[{xtype:"panel",layout:"form",width:350,items:[{xtype:"textfield",fieldLabel:"自定义标题",name:"title",width:255,value:this.action=="edit"?this.title:""}]},{xtype:"panel",layout:"form",width:350,items:[new Ext.form.ComboBox({fieldLabel:"重要程度",name:"level",width:270,store:new Ext.data.SimpleStore({fields:["value","level"],data:[["1","普通"],["2","重要"],["3","非常重要"]]}),hiddenName:"level",valueField:"value",displayField:"level",mode:"local",triggerAction:"all",forceSelection:true,editable:false,value:this.action=="edit"?this.level:1})]}]},{xtype:"htmleditor",width:620,height:460,fieldLabel:"发起理由",name:"reason"},{xtype:"flashfile",fieldLabel:lang("attach"),name:"attach",width:620,style:"margin-top:5px;",inputPre:"filesUpload",listeners:{render:function(b){}}}]}];this.formPanel=new Ext.form.FormPanel({fileUpload:true,autoWidth:true,border:false,labelWidth:70,labelAlign:"right",waitMsgTarget:true,bodyStyle:"padding:10px;",listeners:{afterrender:function(b){if(a.ac=="edit"){a.loadForm()}}},items:[this.baseField]});this.mainPanel=new Ext.Panel({hideBorders:true,border:false,autoScroll:true,items:[this.formPanel],tbar:new Ext.Toolbar({items:["第一步：填写流程信息&nbsp;&nbsp;",{text:"下一步",iconCls:"icon-fileview-column3",handler:function(){CNOA_flow_flow_user_newcommonflow.mainPanel.getLayout().setActiveItem(1)}},"-",{text:lang("cancel"),iconCls:"icon-dialog-cancel",handler:function(){CNOA_flow_flow_user_newcommonflow.closeTab()}}]})})},makeNumberTip:function(){var b="编号规则";var a="{F}: 此变量表示当前的流程名称。<br>{U}: 此变量表示当前的流程发起者。<br>{Y}: 此变量表示当前时间的四位年份值，如2008。<br>{M}: 此变量表示当前时间的两位月份值，如12。<br>{D}: 此变量表示当前时间的两位日期值，如31。<br>{H}: 此变量表示当前时间的两位小时值，如08。<br>{I}: 此变量表示当前时间的两位分钟值，如59。<br>{S}: 此变量表示当前时间的两位秒钟值，如59。<br>{N}: 此变量表示当天的系统流水号，{N}表示一位流水号，{NNNNN}表示五位流水号，最多五位，如00001。<br><br><b>示例</b>: 如：{F}{Y}{M}{D}-{NNNN}，将会被转化为：流程名称20080808-0008。";return{text:a,title:b}},loadForm:function(){var a=this;this.formPanel.getForm().load({url:a.baseUrl+"&task=editLoadFormDataInfo",method:"POST",waitMsg:lang("waiting"),params:{ulid:this.ulid},success:function(b,c){CNOA_flow_flow_user_newcommonflow.stepInfo=c.result.step;CNOA_flow_flow_user_newcommonflow.cardPanel2.insertData(c.result.step)}.createDelegate(this),failure:function(b,c){CNOA.msg.alert(c.result.msg,function(){})}.createDelegate(this)})}};var CNOA_flow_flow_user_newcommonflow_Card2Class=CNOA.Class.create();CNOA_flow_flow_user_newcommonflow_Card2Class.prototype={init:function(){var a=this;this.ac=CNOA.flow.flow.user_newcommonflow.ac;this.ulid=CNOA.flow.flow.user_newcommonflow.ulid;this.baseUrl="index.php?app=flow&func=flow&action=user&module=commonFlow";this.ID_btn_add=Ext.id();this.ID_btn_edit=Ext.id();this.selectedRow=0;this.store=new Ext.data.Store({reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:[{name:"id"},{name:"stepName"},{name:"uid"},{name:"uname"}]})});this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:true});this.colum=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),this.sm,{header:"id",dataIndex:"id",sortable:true,hidden:true},{header:"步骤名称",width:400,sortable:true,dataIndex:"stepName"},{header:"经办人",width:200,sortable:true,dataIndex:"uname"},{header:lang("del"),dataIndex:"id",width:100,sortable:true,renderer:this.makeOperate.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.grid=new Ext.grid.GridPanel({stripeRows:true,store:this.store,sm:this.sm,loadMask:{msg:lang("waiting")},region:"center",hideBorders:true,border:false,colModel:this.colum,bodyStyle:"border-top-width:1px;",listeners:{cellclick:function(c,g,d,f){if(d<5){a.selectedRow=g;Ext.getCmp(a.ID_btn_edit).show();var b=c.getStore().getAt(g);a.addPanel.getForm().loadRecord(b)}}}});this.addPanel=new Ext.form.FormPanel({hideBorders:true,border:false,waitMsgTarget:true,autoScroll:true,header:false,height:100,labelWidth:90,region:"north",bodyStyle:"background-color:#EEEEEE;",labelAlign:"right",items:[{xtype:"panel",border:false,autoHeight:true,hideBorders:true,bodyStyle:"background:none;",items:[{xtype:"panel",hideBorders:true,border:false,layout:"table",autoHeight:true,bodyStyle:"background:none;padding:10px;",autoWidth:true,layoutConfig:{columns:6},defaults:{style:"margin-right:5px"},items:[{xtype:"label",text:"步骤名称："},{xtype:"textfield",width:220,emptyText:"请填写步骤名称",blankText:"请填写步骤名称",allowBlank:false,name:"stepName"},{xtype:"label",text:"经办人："},{xtype:"userselectorfield",width:100,allowBlank:false,emptyText:"请选择经办人",emptyText:"请选择经办人",name:"uid",multiSelect:false}]}]},{xtype:"panel",border:false,width:900,hideBorders:true,bodyStyle:"background:none;",items:[{xtype:"panel",hideBorders:true,border:false,layout:"table",bodyStyle:"background:none;",autoWidth:true,layoutConfig:{columns:2},items:[{xtype:"button",text:"添加新步骤",id:this.ID_btn_add,style:"margin-left:376px;",iconCls:"icon-utils-s-add",handler:function(b){a.addData(b)}},{xtype:"button",text:lang("modify"),hidden:true,id:this.ID_btn_edit,style:"margin-left:5px",iconCls:"icon-utils-s-add",handler:function(b){a.editData(b)}}]}]}],tbar:new Ext.Toolbar({items:["第二步：设置流程流转步骤&nbsp;&nbsp;",{text:"上一步",iconCls:"icon-btn-arrow-left",handler:function(){CNOA_flow_flow_user_newcommonflow.mainPanel.getLayout().setActiveItem(0)}},"-",{text:"提交",iconCls:"icon-dialog-apply2",handler:function(b){a.getData(b)}},"-",{text:lang("cancel"),iconCls:"icon-dialog-cancel",handler:function(){CNOA_flow_flow_user_newcommonflow.closeTab()}}]})});this.mainPanel=new Ext.Panel({layout:"border",items:[this.addPanel,this.grid]})},makeOperate:function(e,c,a,f,b,d){return"<a href='javascript:void(0);' onclick='CNOA_flow_flow_user_newcommonflow.cardPanel2.delData("+f+");'>删除</a>"},insertData:function(a){var b=this;Ext.each(a,function(c,d){var e=new Ext.data.Record({stepName:c.stepName,uname:c.uname,uid:c.uid});b.grid.getStore().add(e)});b.grid.getView().refresh()},addData:function(a){if(this.addPanel.getForm().isValid()){Ext.getCmp(this.ID_btn_edit).hide();var b=new Ext.data.Record({stepName:this.addPanel.getForm().findField("stepName").getValue(),uname:this.addPanel.getForm().findField("uid").getRawValue(),uid:this.addPanel.getForm().findField("uid").getValue()});this.addPanel.getForm().reset();this.grid.getStore().add(b);this.grid.getView().refresh()}else{CNOA.miniMsg.alertShowAt(a,"请填写步骤名称及选择经办人")}},editData:function(a){if(this.addPanel.getForm().isValid()){Ext.getCmp(this.ID_btn_edit).hide();var b=new Ext.data.Record({stepName:this.addPanel.getForm().findField("stepName").getValue(),uname:this.addPanel.getForm().findField("uname").getValue(),uid:this.addPanel.getForm().findField("uid").getValue()});this.addPanel.getForm().reset();this.grid.getStore().removeAt(this.selectedRow);this.grid.getStore().insert(this.selectedRow,b);this.grid.getView().refresh()}else{CNOA.miniMsg.alertShowAt(a,"请填写步骤名称及选择经办人")}},delData:function(a){this.grid.getStore().removeAt(a);this.grid.getView().refresh()},getData:function(b){var c=[];var a=this.grid.getStore();if(a.getCount()>=1){a.each(function(d,e){c.push(d.data)});CNOA_flow_flow_user_newcommonflow.submit(c)}else{CNOA.miniMsg.alertShowAt(b,"请设置流程流转步骤，流程流转过程中至少需要有一个步骤")}}};CNOA_flow_flow_user_newcommonflowClass=CNOA.Class.create();CNOA_flow_flow_user_newcommonflowClass.prototype={init:function(){var a=this;this.ac=CNOA.flow.flow.user_newcommonflow.ac;this.ulid=CNOA.flow.flow.user_newcommonflow.ulid;this.stepInfo={};this.baseUrl="index.php?app=flow&func=flow&action=user&module=commonFlow";this.cardPanel1=new CNOA_flow_flow_user_newcommonflow_Card1Class();this.cardPanel2=new CNOA_flow_flow_user_newcommonflow_Card2Class();this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"card",activeItem:0,autoScroll:false,items:[this.cardPanel1.mainPanel,this.cardPanel2.mainPanel]})},closeTab:function(){var a=CNOA.flow.flow.user_newcommonflow.parentID.replace("docs-","");mainPanel.closeTab(a)},goToMyFlow:function(){mainPanel.closeTab("CNOA_MENU_FLOW_USER_MYFLOW");mainPanel.loadClass("index.php?app=flow&func=flow&action=user&task=loadPage&from=myflow","CNOA_MENU_FLOW_USER_MYFLOW","我的流程","icon-flow-my")},submit:function(b){var c=this;var a=this.cardPanel1.formPanel.getForm();CNOA.msg.cf("确认要提交吗？",function(d){if(d=="yes"){if(a.isValid()){a.submit({url:c.baseUrl+"&task=sendFlow",waitMsg:lang("waiting"),params:{step:Ext.encode(b),ac:c.ac,ulid:c.ulid},method:"POST",success:function(e,f){c.closeTab();c.goToMyFlow()}.createDelegate(this),failure:function(e,f){CNOA.msg.alert(f.result.msg)}.createDelegate(this)})}}})}};var CNOA_flow_flow_user_showcommonflowClass,CNOA_flow_flow_user_showcommonflow;CNOA_flow_flow_user_showcommonflowClass=CNOA.Class.create();CNOA_flow_flow_user_showcommonflowClass.prototype={init:function(){var a=this;this.ulid=CNOA.flow.flow.user_showcommonflow.ulid;this.ID_goto_nextstep=Ext.id();this.baseUrl="index.php?app=flow&func=flow&action=user";this.flowPanelLoaded=this.progressPanelLoaded=this.eventPanelLoaded=false;this.ID_btn_edit=Ext.id();this.ID_btn_delete=Ext.id();this.ID_tree_treeRoot=Ext.id();this.ID_printArea=Ext.id();this.flowInfo=null;this.topTpl=new Ext.XTemplate('<table width="100%" border="0" cellspacing="1" cellpadding="0" style="background-color:#CDCDCD">',"  <tr>",'    <td width="15%" height="24" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">流程编号:&nbsp;</td>','    <td width="35%" valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{name}</td>','    <td width="15%" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">'+lang("flowName")+":&nbsp;</td>",'    <td width="35%" valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;[{flowname}]{title}</td>',"  </tr>","  <tr>",'    <td height="24" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">发起人:&nbsp;</td>','    <td valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{uname}</td>','    <td align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">发起日期:&nbsp;</td>','    <td valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{posttime}</td>',"  </tr>","  <tr>",'    <td height="24" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">当前步骤:&nbsp;</td>','    <td valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{stepText}</td>','    <td align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">流程状态:&nbsp;</td>','    <td valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{statusText}</td>',"  </tr>","  <tr>",'    <td height="24" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">流程步骤:&nbsp;</td>','    <td colspan="3" valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{stepInfo}</td>',"  </tr>",'  <tpl if="attachCount &gt; 0">',"  <tr>",'    <td height="24" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">流程附件:&nbsp;</td>','    <td colspan="3" valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;',"		{attach}","    </td>","  </tr>","  </tpl>","</table>");this.flowPanel=new Ext.Panel({headerStyle:"border-width:0",border:false,frame:true,animCollapse:false,collapsible:true,titleCollapse:true,style:"margin-bottom:10px;",title:"流程信息",listeners:{afterrender:function(b){a.flowPanelLoaded=true;a.view_loadFlowInfo()}}});this.gridProgress=new CNOA_flow_flow_flowViewProgressClass(this.ulid,true,false);this.progressPanel=new Ext.Panel({headerStyle:"border-width:0",style:"margin-bottom:10px;",border:false,frame:true,animCollapse:false,collapsible:true,titleCollapse:true,title:"流程进度",layout:"fit",items:[this.gridProgress.grid],listeners:{afterrender:function(c){var b={}}}});this.gridEvent=new CNOA_flow_flow_flowViewEventClass(this.ulid);this.eventPanel=new Ext.Panel({headerStyle:"border-width:0",style:"margin-bottom:10px;",border:false,frame:true,layout:"fit",animCollapse:false,collapsible:true,titleCollapse:true,title:"事件日志",items:[this.gridEvent.grid],listeners:{afterrender:function(b){}}});this.gridReader=new CNOA_flow_flow_flowViewReaderClass(this.ulid);this.readerPanel=new Ext.Panel({headerStyle:"border-width:0",border:false,frame:true,layout:"fit",animCollapse:false,collapsible:true,titleCollapse:true,title:"评阅记录",items:[this.gridReader.grid],listeners:{afterrender:function(b){}}});this.centerPanel=new Ext.Panel({bodyStyle:"padding:10px",border:false,autoScroll:true,region:"center",items:[{xtype:"container",autoEl:"div",id:this.ID_printArea,items:[this.flowPanel,this.progressPanel,this.eventPanel,this.readerPanel]}]});this.exportArray={i:1,p:1,e:1,r:1};this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.centerPanel],tbar:new Ext.Toolbar({items:["显示：",{xtype:"checkbox",boxLabel:"流程信息",checked:true,listeners:{check:function(c,b){if(b){a.exportArray.i=1;a.flowPanel.show()}else{a.exportArray.i=0;a.flowPanel.hide()}}}},"-",{xtype:"checkbox",boxLabel:"流程进度",checked:true,listeners:{check:function(c,b){if(b){a.exportArray.p=1;a.progressPanel.show()}else{a.exportArray.p=0;a.progressPanel.hide()}}}},"-",{xtype:"checkbox",boxLabel:"事件日志",checked:true,listeners:{check:function(c,b){if(b){a.exportArray.e=1;a.eventPanel.show()}else{a.exportArray.e=0;a.eventPanel.hide()}}}},"-",{xtype:"checkbox",boxLabel:"评阅记录",checked:true,listeners:{check:function(c,b){if(b){a.exportArray.r=1;a.readerPanel.show()}else{a.exportArray.r=0;a.readerPanel.hide()}}}},"-",{text:"导出",iconCls:"icon-download",tooltip:"导出为HTML文件",menu:{items:[{iconCls:"document-html",text:"导出为网页文件(html)",handler:function(){a.exportFlow("html")}.createDelegate(this)},{iconCls:"document-word",text:"导出为Word文档",handler:function(){a.exportFlow("word")}.createDelegate(this)}]}},"-",{handler:function(b,c){a.dispenseFlow()}.createDelegate(this),iconCls:"icon-flow-entrust",tooltip:"分发",text:"分发"},"-",{handler:function(b,c){a.gridReader.showSay()}.createDelegate(this),hidden:Ext.isAir?true:false,iconCls:"icon-view-form-png",text:"我要评阅"},"-",{handler:function(b,c){a.printFlow()}.createDelegate(this),hidden:Ext.isAir?true:false,iconCls:"icon-print",tooltip:"打印",text:"打印"},"-",{iconCls:"icon-dialog-cancel",text:lang("close"),handler:function(b,c){a.closeTab()}.createDelegate(this)},"->",{xtype:"cnoa_helpBtn",helpid:19}]})})},view_loadFlowInfo:function(){var a=this;if(!this.flowPanelLoaded){return false}Ext.Ajax.request({url:a.baseUrl+"&task=show_loadFlowInfo",method:"POST",params:{ulid:a.ulid},success:function(c){var b=Ext.decode(c.responseText);if(b.success===true){a.topTpl.overwrite(a.flowPanel.body,b.data.flowInfo);a.flowInfo=b.data.flowInfo}else{CNOA.msg.alert(b.msg,function(){})}}})},closeTab:function(){mainPanel.closeTab("CNOA_MENU_FLOW_USER_SHOWFLOW")},exportFlow:function(f){var g=this;var b=Ext.id();var a=Ext.encode(this.exportArray);var e=function(){c.getForm().submit({url:g.baseUrl+"&task=exportFlow&target="+f,params:{ulid:g.ulid,exportArray:a},method:"POST",waitMsg:lang("waiting"),success:function(h,i){var j=Ext.getCmp(b);j.getEl().update("请点击下载：<br/>"+i.result.msg)}.createDelegate(this),failure:function(h,i){d.close();CNOA.msg.alert(i.result.msg,function(){})}.createDelegate(this)})};var c=new Ext.form.FormPanel({autoWidth:true,border:false,hideBorders:true,labelWidth:70,labelAlign:"right",waitMsgTarget:true,bodyStyle:"padding:10px;",listeners:{afterrender:function(h){e()}},items:[{xtype:"displayfield",name:"flowname",fieldLabel:lang("flowName"),value:g.flowInfo.name},new Ext.BoxComponent({id:b,autoEl:{tag:"div",style:"padding-left:16px",html:""}})]});var d=new Ext.Window({title:"导出工作流程",width:320,height:150,layout:"fit",modal:true,maximizable:false,resizable:false,items:[c],buttons:[{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){d.close()}}]}).show()},printFlow:function(){var a=Ext.encode(this.exportArray);window.open(this.baseUrl+"&task=exportFlow&target=printer&ulid="+this.ulid+"&exportArray="+a,"_blank","width=740,height="+(screen.availHeight-120)+",left="+((screen.availWidth-740)/2)+",top=60,scrollbars=yes,resizable=yes,status=no")},readedFlow:function(){CNOA_flow_flow_view_reader=new CNOA_flow_flow_view_readerClass(this.ulid);CNOA_flow_flow_view_reader.show()},dispenseFlow:function(){var e=this;var c=Ext.id();var b=function(g){var h=a.getForm();if(h.isValid()){h.submit({url:e.baseUrl+"&task=dispenseFlow",waitTitle:lang("notice"),method:"POST",waitMsg:lang("waiting"),params:{ulid:e.ulid},success:function(f,i){CNOA.msg.notice(i.result.msg,"工作流管理");d.close()}.createDelegate(this),failure:function(f,i){CNOA.msg.alert(i.result.msg)}.createDelegate(this)})}else{CNOA.miniMsg.alertShowAt(g,"未选择要分发的人员",30)}};var a=new Ext.form.FormPanel({autoWidth:true,border:false,hideBorders:true,labelWidth:70,labelAlign:"right",waitMsgTarget:true,bodyStyle:"padding:10px;",items:[{xtype:"textarea",style:"margin: 0; padding: 0;",height:65,width:365,readOnly:true,allowBlank:false,fieldLabel:"分发给谁",name:"allUserNames"},{xtype:"hidden",name:"allUids"},{xtype:"btnForPoepleSelector",style:"margin: 0; padding: 0",autoWidth:true,dataUrl:e.baseUrl+"&task=getAllUserListsInPermitDeptTree",style:"margin-left:75px;",text:lang("selectPeople"),listeners:{selected:function(h,j){var k=new Array();var g=new Array();if(j.length>0){for(var f=0;f<j.length;f++){k.push(j[f].uname);g.push(j[f].uid)}}a.getForm().findField("allUserNames").setValue(k.join(","));a.getForm().findField("allUids").setValue(g.join(","))},onrender:function(f){f.setSelectedUids(a.getForm().findField("allUids").getValue().split(","))}}}]});var d=new Ext.Window({title:"分发工作流",width:475,height:180,layout:"fit",modal:true,maximizable:false,resizable:false,items:[a],buttons:[{text:"分发",id:c,handler:function(f){b(f)}},{text:lang("close"),handler:function(){d.close()}}]}).show()}};var CNOA_flow_flow_user_viewcommonflowClass,CNOA_flow_flow_user_viewcommonflow;var CNOA_flow_flow_user_dealcommonflow_goNextStepClass,CNOA_flow_flow_user_dealcommonflow_goNextStep;CNOA_flow_flow_user_dealcommonflow_goNextStepClass=CNOA.Class.create();CNOA_flow_flow_user_dealcommonflow_goNextStepClass.prototype={init:function(a){var b=this;this.baseUrl="index.php?app=flow&func=flow&action=user";this.ulid=a;this.operatorperson=null;this.sponsor=false;this.stepText="";this.ID_html=Ext.id();this.ID_multiselects=Ext.id();this.ID_multiselects_tip=Ext.id();this.ID_nextStepTr1=Ext.id();this.ID_nextStepTr2=Ext.id();this.ID_window=Ext.id();this.smsSender=new Ext.form.SMSSender({from:"flow",hideLabel:true,modal:true,boxLabel:"手机短信提醒"});this.Tpl=new Ext.Template('<table width="596" border="0" cellspacing="1" cellpadding="0" style="background:#999;margin-bottom:5px;"><tr><td height="24" colspan="2" align="left" valign="middle" bgcolor="#C9C9C9">&nbsp;<b>下一步骤信息</b></td></tr><tr><td width="147" height="24" align="right" valign="middle" bgcolor="#D9D9D9">下一步骤名称:&nbsp;</td><td width="446" valign="middle" bgcolor="#F2F2F2">&nbsp;{name}</td></tr><tr id="'+this.ID_nextStepTr1+'"><td height="24" align="right" valign="middle" bgcolor="#D9D9D9">经办方式:&nbsp;</td><td valign="middle" bgcolor="#F2F2F2">&nbsp;{operatorperson}</td></tr><tr id="'+this.ID_nextStepTr2+'"><td height="24" align="right" valign="middle" bgcolor="#D9D9D9">转下下一步条件:&nbsp;</td><td valign="middle" bgcolor="#F2F2F2">&nbsp;{operatortype}</td></tr></table>');this.dataStoreFrom=new Ext.data.ArrayStore({data:[],fields:["uid","name"]});this.dataStoreTo=new Ext.data.ArrayStore({data:[],fields:["uid","name"]});this.formPanel=new Ext.form.FormPanel({autoWidth:true,border:false,hideBorders:true,labelWidth:100,labelAlign:"top",bodyStyle:"padding:10px;",waitMsgTarget:true,items:[{xtype:"panel",border:false,header:false,id:this.ID_html,html:""},this.smsSender,{xtype:"textarea",fieldLabel:"办理意见",name:"say",width:597,height:110,value:"同意"},{xtype:"radiogroup",hideLabel:true,width:200,allowBlank:false,name:"sayTgroup",items:[{boxLabel:"同意",name:"sayT",inputValue:"1",checked:true},{boxLabel:"不同意",name:"sayT",inputValue:"2"}],listeners:{change:function(d,c){if(c.inputValue=="1"){b.formPanel.getForm().findField("say").setValue("同意")}else{if(c.inputValue=="2"){b.formPanel.getForm().findField("say").setValue("不同意")}}}}},{xtype:"itemselector",name:"itemselector",hideLabel:false,id:this.ID_multiselects,imagePath:CNOA_EXTJS_PATH+"/ux/images/",multiselects:[{width:288,height:200,store:this.dataStoreFrom,fromLegend:"已选资金来源",displayField:"name",valueField:"uid",tbar:["待选人员",{text:"&nbsp;",disabled:true}]},{width:288,height:200,store:this.dataStoreTo,toLegend:"已选资金来源",displayField:"name",valueField:"uid",tbar:["经办人","->",{text:"清除",iconCls:"icon-clear",handler:function(){b.formPanel.getForm().findField("itemselector").reset()}}]}]},{xtype:"displayfield",hideLabel:true,id:this.ID_multiselects_tip,value:"注意: 你所选择的经办人如果有多人，则列表第一人将作为主办人，只有主办人有权限决定他的下一步骤经办人。"}]});this.mainPanel=new Ext.Window({title:"转下一步 - 选择经办人",id:this.ID_window,width:630,height:makeWindowHeight(610),layout:"fit",modal:true,maximizable:false,resizable:false,items:[this.formPanel],buttons:[{text:"转下一步",iconCls:"icon-fileview-column3",handler:function(d){var h=b.formPanel.getForm();if(h.isValid()){var c=h.findField("itemselector").getValue();var e=h.findField("say").getValue();if(b.sponsor){if(Ext.isEmpty(c)){CNOA.miniMsg.alertShowAt(d,"请选择至少一人作为经办人");return false}else{var g=c.split(",");if((b.operatorperson=="1")&&(g.length!=1)){CNOA.miniMsg.alertShowAt(d,"该步骤经办方式为:单人办理, 只能选择一人作为经办人");return false}}}if(b.smsSender.validateValue()){CNOA_flow_flow_user_viewcommonflow.sendFormStep2(e,c,function(){try{b.smsSender.submit()}catch(f){}b.close()})}}else{CNOA.miniMsg.alertShowAt(d,"请检查未填写的地方")}}},{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){b.close()}}],listeners:{close:function(){}}})},show:function(){this.mainPanel.show();this.loadNextStepInfo()},close:function(){this.mainPanel.close()},loadNextStepInfo:function(){var a=this;a.mainPanel.getEl().mask(lang("waiting"));Ext.Ajax.request({url:a.baseUrl+"&task=deal_loadNextStepInfo",method:"POST",params:{ulid:a.ulid},success:function(g){var b=Ext.decode(g.responseText);if(b.success===true){var f=b.data;var e=f.nextData;a.operatorperson=e.operatorperson;e.operatorperson=e.operatorperson=="1"?"单人办理":"多人办理";e.operatortype=e.operatortype=="1"?"任意一人同意":"所有人同意";a.Tpl.append(a.ID_html,e);if(f.nextStepType=="end"){Ext.fly(a.ID_nextStepTr1).dom.style.display="none";Ext.fly(a.ID_nextStepTr2).dom.style.display="none";Ext.getCmp(a.ID_multiselects).hide();Ext.getCmp(a.ID_multiselects_tip).hide();a.mainPanel.setHeight(306)}else{if(f.sponsor=="1"){a.sponsor=true;a.dataStoreFrom.removeAll();for(var d=0;d<e.operator.length;d++){var c=new Ext.data.Record(e.operator[d]);a.dataStoreFrom.add(c)}Ext.getCmp(a.ID_multiselects).fromMultiselect.view.select([0]);Ext.getCmp(a.ID_multiselects).fromTo()}else{a.sponsor=false;Ext.getCmp(a.ID_multiselects).hide();Ext.getCmp(a.ID_multiselects_tip).hide();a.mainPanel.setHeight(360)}}}else{CNOA.msg.alert(b.msg,function(){a.close()})}a.mainPanel.getEl().unmask()}})}};CNOA_flow_flow_user_viewcommonflowClass=CNOA.Class.create();CNOA_flow_flow_user_viewcommonflowClass.prototype={init:function(){var a=this;this.ulid=CNOA.flow.flow.user_viewcommonflow.ulid;this.ID_goto_nextstep=Ext.id();this.ID_disagree=Ext.id();this.ID_goto_prestep=Ext.id();this.ID_huiqian=Ext.id();this.ID_zhuangban=Ext.id();this.ID_huiqian_say=Ext.id();this.baseUrl="index.php?app=flow&func=flow&action=user";this.flowPanelLoaded=this.progressPanelLoaded=this.eventPanelLoaded=false;this.ID_btn_edit=Ext.id();this.ID_btn_delete=Ext.id();this.ID_tree_treeRoot=Ext.id();this.ID_printArea=Ext.id();this.topTpl=new Ext.XTemplate('<table width="100%" border="0" cellspacing="1" cellpadding="0" style="background-color:#CDCDCD">',"  <tr>",'    <td width="15%" height="24" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">流程编号:&nbsp;</td>','    <td width="35%" valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{name}</td>','    <td width="15%" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">'+lang("flowName")+":&nbsp;</td>",'    <td width="35%" valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;[{flowname}]{title}</td>',"  </tr>","  <tr>",'    <td height="24" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">发起人:&nbsp;</td>','    <td valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{uname}</td>','    <td align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">发起日期:&nbsp;</td>','    <td valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{posttime}</td>',"  </tr>","  <tr>",'    <td height="24" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">当前步骤:&nbsp;</td>','    <td valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{stepText}</td>','    <td align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">流程状态:&nbsp;</td>','    <td valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{statusText}</td>',"  </tr>","  <tr>",'    <td height="24" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">申请事由:&nbsp;</td>','    <td colspan="3" valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{reason}</td>',"  </tr>",'  <tpl if="attachCount &gt; 0">',"  <tr>",'    <td height="24" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">流程附件:&nbsp;</td>','    <td colspan="3" valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;',"		{attach}","    </td>","  </tr>","  </tpl>","</table>");this.flowPanel=new Ext.Panel({headerStyle:"border-width:0",border:false,frame:true,animCollapse:false,collapsible:true,titleCollapse:true,style:"margin-bottom:10px;",title:"流程信息",listeners:{afterrender:function(b){a.flowPanelLoaded=true;a.view_loadFlowInfo()}}});this.gridProgress=new CNOA_flow_flow_flowViewProgressClass(this.ulid,true,false);this.progressPanel=new Ext.Panel({headerStyle:"border-width:0",style:"margin-bottom:10px;",border:false,frame:true,animCollapse:false,collapsible:true,titleCollapse:true,title:"流程进度",items:[this.gridProgress.grid],listeners:{afterrender:function(b){}}});this.gridEvent=new CNOA_flow_flow_flowViewEventClass(this.ulid);this.eventPanel=new Ext.Panel({headerStyle:"border-width:0",border:false,frame:true,animCollapse:false,collapsible:true,titleCollapse:true,title:"事件日志",items:[this.gridEvent.grid],listeners:{afterrender:function(c){var b={}}}});this.exportArray={i:1,p:1,e:1};this.centerPanel=new Ext.Panel({bodyStyle:"padding:10px",border:false,autoScroll:true,region:"center",items:[{xtype:"container",autoEl:"div",id:this.ID_printArea,items:[this.flowPanel,this.progressPanel,this.eventPanel]}],tbar:new Ext.Toolbar({items:["显示：",{xtype:"checkbox",boxLabel:"流程信息",checked:true,listeners:{check:function(c,b){if(b){a.exportArray.i=1;a.flowPanel.show()}else{a.exportArray.i=0;a.flowPanel.hide()}}}},"-",{xtype:"checkbox",boxLabel:"流程进度",checked:true,listeners:{check:function(c,b){if(b){a.exportArray.p=1;a.progressPanel.show()}else{a.exportArray.p=0;a.progressPanel.hide()}}}},"-",{xtype:"checkbox",boxLabel:"事件日志",checked:true,listeners:{check:function(c,b){if(b){a.exportArray.e=1;a.eventPanel.show()}else{a.exportArray.e=0;a.eventPanel.hide()}}}},"-",{text:"导出",iconCls:"icon-download",tooltip:"导出为HTML文件",menu:{items:[{iconCls:"document-html",text:"导出为网页文件(html)",handler:function(){a.exportFlow("html")}.createDelegate(this)},{iconCls:"document-word",text:"导出为Word文档",handler:function(){a.exportFlow("word")}.createDelegate(this)}]}},"-",{handler:function(b,c){a.printFlow()}.createDelegate(this),iconCls:"icon-print",hidden:Ext.isAir?true:false,tooltip:"打印",text:"打印"}]})});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.centerPanel],tbar:new Ext.Toolbar({items:[{iconCls:"icon-flow-goto-nextstep",text:"同意(转下一步)",id:this.ID_goto_nextstep,handler:function(b,c){a.sendFormStep1()}.createDelegate(this)},"-",{iconCls:"icon-flow-entrust",text:"会签",id:this.ID_huiqian,handler:function(b,c){a.huiqian()}.createDelegate(this)},"-",{iconCls:"icon-flow-entrust",text:"转办",id:this.ID_zhuangban,handler:function(b,c){a.zhuangban()}.createDelegate(this)},"-",{iconCls:"icon-flow-entrust",text:"会签意见",hidden:true,id:this.ID_huiqian_say,handler:function(b,c){a.showHuiqianWindow()}.createDelegate(this)},"-",{iconCls:"icon-flow-goto-firststep",text:"不同意(退件)",id:this.ID_disagree,handler:function(b,c){a.disagree()}.createDelegate(this)},"-",{iconCls:"icon-flow-goto-prevstep",text:"退回上一步",id:this.ID_goto_prestep,handler:function(b,c){a.goto_prevstep()}.createDelegate(this)},"-",{iconCls:"icon-dialog-cancel",text:lang("close"),handler:function(b,c){a.closeTab()}.createDelegate(this)},"->",{xtype:"cnoa_helpBtn",helpid:20}]})})},makeStatus:function(a){var b="";if(a==0){b="<span class='cnoa_color_gray'>未发送</span>"}else{if(a==1){b="<span class='cnoa_color_orange'>办理中</span>"}else{if(a==2){b="<span class='cnoa_color_green'>已办理</span>"}else{if(a==3){b="<span class='cnoa_color_red'>已退件</span> "}else{if(a==4){b="<span class='cnoa_color_graye'>已撤销</span>"}}}}}return b},makeOperate:function(i,f,d,g,e,a){var j=d.data;var b=j.status;var c="<a href='javascript:void(0);' onclick='("+i+");'>查看</a>";c+="&nbsp;&nbsp;";c+=(b=="0"||b=="3"||b=="4")?"<a href='javascript:void(0);' onclick='CNOA_flow_flow_user_viewcommonflow.deleteFlow("+i+");'>删除</a>":"　　";c+="&nbsp;&nbsp;";c+=b=="0"?"<a href='javascript:void(0);' onclick='CNOA_flow_flow_user_viewcommonflow.editPanel("+i+");'>编辑</a>":"　　";c+="&nbsp;&nbsp;";c+=(b!="0"&&b!="3"&&b!="4")?"<a href='javascript:void(0);' onclick='("+i+");'>召回</a>":"　　";c+="&nbsp;&nbsp;";c+=(b!="0"&&b!="3"&&b!="4")?"<a href='javascript:void(0);' onclick='("+i+");'>撤销</a>":"　　";return c},view_loadFlowInfo:function(){var a=this;if(!this.flowPanelLoaded){return false}Ext.Ajax.request({url:a.baseUrl+"&task=view_loadFlowInfo",method:"POST",params:{ulid:a.ulid},success:function(e){var b=Ext.decode(e.responseText);if(b.success===true){a.topTpl.overwrite(a.flowPanel.body,b.data.flowInfo);a.stepText=b.data.flowInfo.stepText;if(b.data.flowInfo.status=="2"){a.hideOperatBtn()}if(b.data.isHuiQian=="1"){a.showHuiqianBtn()}var d=Ext.id();var c="<div style='padding-bottom:5px;' class='x-border-layout-ct'><div class='flow_flow_form'><div>图示：</div><div class='flow_form_must_struct flow_form_must_color'>&nbsp;</div><div>必填字段</div><div class='flow_form_must_struct flow_form_need_color'>&nbsp;</div><div>可填字段</div><div class='flow_form_must_struct flow_form_disabled_color'>&nbsp;</div><div>不可填字段</div></div><div class='clear'></div><div id='"+d+"'></div></div>";if(b.data.flowInfo.status=="1"&&b.data.flowInfo.step=="0"){var f=a.formPanel.getEl().query("input[name^=FLOWDATA],textarea[name^=FLOWDATA],select[name^=FLOWDATA]");Ext.each(f,function(g,h){Ext.each(b.data.formData,function(j,i){if(("FLOWDATA["+j.itemid+"]")==g.name){g.value=j.data}});if(g.readOnly==true){g.style.border="1px solid #E1E1E1";g.style.backgroundColor="#F6F6F6"}else{g.style.border="1px solid #BCBCBC"}g.title=""})}}else{CNOA.msg.alert(b.msg,function(){})}}})},hideOperatBtn:function(){Ext.getCmp(this.ID_goto_nextstep).hide();Ext.getCmp(this.ID_disagree).hide();Ext.getCmp(this.ID_goto_prestep).hide()},showHuiqianBtn:function(){Ext.getCmp(this.ID_goto_nextstep).hide();Ext.getCmp(this.ID_disagree).hide();Ext.getCmp(this.ID_goto_prestep).hide();Ext.getCmp(this.ID_huiqian).hide();Ext.getCmp(this.ID_zhuangban).hide();Ext.getCmp(this.ID_huiqian_say).show()},showHuiqianWindow:function(){var e=this;var c=function(){var g=b.getForm();g.load({url:e.baseUrl+"&task=loadHuiQianInfo",params:{ulid:e.ulid},method:"POST",waitTitle:lang("notice"),success:function(f,h){},failure:function(f,h){}})};var b=new Ext.form.FormPanel({border:false,hideBorders:true,labelWidth:90,labelAlign:"top",waitMsgTarget:true,bodyStyle:"padding-top:20px;padding:10px;",items:[{xtype:"textarea",height:147,width:360,name:"say",hideLabel:true,value:"已阅"},{xtype:"radiogroup",hideLabel:true,width:200,allowBlank:false,name:"sayTGroup",items:[{boxLabel:"已阅",name:"sayT",inputValue:"1",checked:true},{boxLabel:"同意",name:"sayT",inputValue:"2"},{boxLabel:"不同意",name:"sayT",inputValue:"3"}],listeners:{change:function(g,f){if(f.inputValue=="1"){b.getForm().findField("say").setValue("已阅")}else{if(f.inputValue=="2"){b.getForm().findField("say").setValue("同意")}else{if(f.inputValue=="3"){b.getForm().findField("say").setValue("不同意")}}}}}}]});var d=new Ext.Window({width:400,height:300,title:"会签意见",resizable:false,modal:true,layout:"fit",items:b,buttons:[{text:lang("ok"),id:e.ID_btn_report_window_report,iconCls:"icon-btn-save",handler:function(){a()}.createDelegate(this)},{text:lang("cancel"),iconCls:"icon-dialog-cancel",handler:function(){d.close()}.createDelegate(this)}]}).show();var a=function(){if(b.getForm().isValid()){b.getForm().submit({url:e.baseUrl+"&task=submitHuiQianInfo",waitTitle:lang("notice"),method:"POST",waitMsg:lang("waiting"),params:{ulid:e.ulid},success:function(f,g){CNOA.msg.notice(g.result.msg,"流程管理");try{CNOA_flow_flow_user_dealflow.store.reload()}catch(h){}e.view_loadFlowInfo();e.gridEvent.store.reload();d.close()}.createDelegate(this),failure:function(f,g){CNOA.msg.alert(g.result.msg)}.createDelegate(this)})}};c()},goToDealFlowList:function(){mainPanel.loadClass("index.php?app=flow&func=flow&action=user&task=loadPage&from=dealflow","CNOA_MENU_FLOW_DEALFLOW","审批流程","icon-flow-deal")},closeTab:function(){mainPanel.closeTab("CNOA_MENU_FLOW_USER_VIEWFLOW")},huiqian:function(){var f=this;var a=Ext.id();var c=function(){var g=b.getForm();if(g.isValid()){g.submit({url:f.baseUrl+"&task=setHuiQianInfo",waitTitle:lang("notice"),method:"POST",waitMsg:lang("waiting"),params:{ulid:f.ulid},success:function(h,i){CNOA.msg.notice(i.result.msg,"工作流管理");d.close()}.createDelegate(this),failure:function(h,i){CNOA.msg.alert(i.result.msg,function(){})}.createDelegate(this)})}};var e=function(){var g=b.getForm();g.load({url:f.baseUrl+"&task=getHuiQianInfo",params:{ulid:f.ulid},method:"POST",waitTitle:lang("notice"),success:function(h,i){},failure:function(h,i){CNOA.msg.alert(i.result.msg,function(){})}})};var b=new Ext.form.FormPanel({border:false,waitMsgTarget:true,bodyStyle:"padding:10px;",labelAlign:"top",items:[{xtype:"displayfield",hideLabel:true,value:"步骤名称: "+f.stepText,name:"stepText"},{xtype:"textarea",width:483,height:188,readOnly:true,fieldLabel:"会签人员",name:"allUserNames"},{xtype:"hidden",name:"allUids"},{xtype:"btnForPoepleSelector",autoWidth:true,dataUrl:this.baseUrl+"&task=getAllUserListsInPermitDeptTree",text:lang("selectPeople"),listeners:{selected:function(j,k){var l=new Array();var h=new Array();if(k.length>0){for(var g=0;g<k.length;g++){l.push(k[g].uname);h.push(k[g].uid)}}b.getForm().findField("allUserNames").setValue(l.join(","));b.getForm().findField("allUids").setValue(h.join(","))},onrender:function(g){g.setSelectedUids(b.getForm().findField("allUids").getValue().split(","))},afterrender:function(){e()}}}]});var d=new Ext.Window({title:"设置本步骤会签人员",modal:true,maximizable:false,resizable:false,width:520,height:360,layout:"fit",items:[b],buttons:[{iconCls:"icon-btn-save",text:lang("ok"),handler:function(g,h){c()}.createDelegate(this)},{iconCls:"icon-dialog-cancel",text:lang("cancel"),handler:function(g,h){d.close()}.createDelegate(this)}]}).show()},zhuangban:function(){var d=this;var b=function(){var e=a.getForm();if(e.isValid()){e.submit({url:d.baseUrl+"&task=setZhuangbanInfo",waitTitle:lang("notice"),method:"POST",waitMsg:lang("waiting"),params:{ulid:d.ulid},success:function(f,g){CNOA.msg.notice(g.result.msg,"工作流管理");c.close();d.closeTab();try{CNOA_flow_flow_user_dealflow.store.reload()}catch(h){}}.createDelegate(this),failure:function(f,g){CNOA.msg.alert(g.result.msg,function(){})}.createDelegate(this)})}};var a=new Ext.form.FormPanel({border:false,waitMsgTarget:true,bodyStyle:"padding:10px;",labelAlign:"top",items:[{xtype:"hidden",name:"uid"},{xtype:"triggerForPeople",fieldLabel:"选择转办人",allowBlank:false,name:"uname",dataUrl:d.baseUrl+"&task=getAllUserListsInPermitDeptTree",width:340,listeners:{selected:function(g,f,e){a.getForm().findField("uid").setValue(f)}}},{xtype:"textarea",width:340,height:200,fieldLabel:"转办意见",name:"say"}]});var c=new Ext.Window({title:"转办工作流",modal:true,maximizable:false,resizable:false,width:375,height:360,layout:"fit",items:[a],buttons:[{iconCls:"icon-btn-save",text:lang("ok"),handler:function(e,f){b()}.createDelegate(this)},{iconCls:"icon-dialog-cancel",text:lang("cancel"),handler:function(e,f){c.close()}.createDelegate(this)}]}).show()},disagree:function(){var f=this;var a=Ext.id();var e=new Ext.form.SMSSender({from:"flow",hideLabel:true,boxLabel:"手机短信提醒"});var c=function(){var g=b.getForm();if(g.isValid()){g.submit({url:f.baseUrl+"&task=disagree",waitTitle:lang("notice"),method:"POST",waitMsg:lang("waiting"),params:{ulid:f.ulid},success:function(h,i){try{e.submit()}catch(j){}CNOA.msg.notice(i.result.msg,"工作流管理");d.close();f.closeTab();try{CNOA_flow_flow_user_dealflow.store.reload()}catch(j){}}.createDelegate(this),failure:function(h,i){CNOA.msg.alert(i.result.msg,function(){})}.createDelegate(this)})}};var b=new Ext.form.FormPanel({border:false,waitMsgTarget:true,bodyStyle:"padding:10px;",labelAlign:"top",items:[{xtype:"textarea",width:483,height:220,name:"reason",fieldLabel:"不同意理由"},e]});var d=new Ext.Window({title:"不同意(退件)",maximizable:false,resizable:false,width:520,height:360,layout:"fit",items:[b],buttons:[{iconCls:"icon-btn-save",text:lang("ok"),handler:function(g,h){c()}.createDelegate(this)},{iconCls:"icon-dialog-cancel",text:lang("cancel"),handler:function(g,h){d.close()}.createDelegate(this)}]}).show()},goto_prevstep:function(){var f=this;var a=Ext.id();var e=new Ext.form.SMSSender({from:"flow",hideLabel:true,boxLabel:"手机短信提醒"});var c=function(){var g=b.getForm();if(g.isValid()){g.submit({url:f.baseUrl+"&task=gotoPrevstep",waitTitle:lang("notice"),method:"POST",waitMsg:lang("waiting"),params:{ulid:f.ulid},success:function(h,i){try{e.submit()}catch(j){}CNOA.msg.alert(i.result.msg,function(){d.close();f.closeTab();try{CNOA_flow_flow_user_dealflow.store.reload()}catch(k){}}.createDelegate(this))}.createDelegate(this),failure:function(h,i){CNOA.msg.alert(i.result.msg,function(){})}.createDelegate(this)})}};var b=new Ext.form.FormPanel({border:false,bodyStyle:"padding:10px;",labelAlign:"top",waitMsgTarget:true,items:[{xtype:"textarea",width:483,height:220,name:"reason",fieldLabel:"退回理由"},e]});var d=new Ext.Window({title:"退回上一步",maximizable:false,resizable:false,width:520,height:360,layout:"fit",items:[b],buttons:[{iconCls:"icon-btn-save",text:lang("ok"),handler:function(g,h){c()}.createDelegate(this)},{iconCls:"icon-dialog-cancel",text:lang("cancel"),handler:function(g,h){d.close()}.createDelegate(this)}]}).show()},sendFormStep1:function(){var a=this;CNOA_flow_flow_user_dealcommonflow_goNextStep=new CNOA_flow_flow_user_dealcommonflow_goNextStepClass(a.ulid);CNOA_flow_flow_user_dealcommonflow_goNextStep.show()},checkForm:function(){var b=this.formPanel.getEl().query("input[name^=FLOWDATA][class*=flow_form_must],textarea[name^=FLOWDATA][class*=flow_form_must],select[name^=FLOWDATA][class*=flow_form_must]");var a=true;Ext.each(b,function(c,d){if(Ext.isEmpty(c.value)){a=false}});return a},sendFormStep2:function(b,a,d){var c=this;if(Ext.isArray(a)){a=a.join(",")}Ext.Ajax.request({url:c.baseUrl+"&task=deal_sendFlow",method:"POST",params:{ulid:c.ulid,nextUids:a,say:b},success:function(g){var f=Ext.decode(g.responseText);if(f.success===true){try{d.call(this)}catch(h){}CNOA.msg.alert(f.msg,function(){c.goToDealFlowList();c.closeTab();try{CNOA_flow_flow_user_dealflow.store.reload()}catch(i){}}.createDelegate(this))}else{CNOA.msg.alert(f.msg,function(){})}}})},exportFlow:function(f){var g=this;var b=Ext.id();var a=Ext.encode(this.exportArray);var e=function(){c.getForm().submit({url:g.baseUrl+"&task=exportFlow&target="+f,params:{ulid:g.ulid,exportArray:a},method:"POST",waitMsg:lang("waiting"),success:function(h,i){var j=Ext.getCmp(b);j.getEl().update("请点击下载：<br/>"+i.result.msg)}.createDelegate(this),failure:function(h,i){d.close();CNOA.msg.alert(i.result.msg,function(){})}.createDelegate(this)})};var c=new Ext.form.FormPanel({autoWidth:true,border:false,hideBorders:true,labelWidth:70,labelAlign:"right",waitMsgTarget:true,bodyStyle:"padding:10px;",listeners:{afterrender:function(h){e()}},items:[{xtype:"displayfield",name:"name",fieldLabel:lang("flowName")},new Ext.BoxComponent({id:b,autoEl:{tag:"div",style:"padding-left:16px",html:""}})]});var d=new Ext.Window({title:"导出工作流程",width:320,height:150,layout:"fit",modal:true,maximizable:false,resizable:false,items:[c],buttons:[{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){d.close()}}]}).show()},printFlow:function(){var a=Ext.encode(this.exportArray);window.open(this.baseUrl+"&task=exportFlow&target=printer&ulid="+this.ulid+"&exportArray="+a,"_blank","width=740,height="+(screen.availHeight-120)+",left="+((screen.availWidth-740)/2)+",top=60,scrollbars=yes,resizable=yes,status=no")}};var CNOA_flow_flow_dispense_listClass,CNOA_flow_flow_dispense_list;CNOA_flow_flow_dispense_listClass=CNOA.Class.create();CNOA_flow_flow_dispense_listClass.prototype={init:function(){var a=this;this.edit_id=0;this.sort=0;this.isread=CNOA.flow.flow.dispense_list.isread;this.baseUrl="index.php?app=flow&func=flow&action=user";this.ID_btn_edit=Ext.id();this.ID_btn_delete=Ext.id();this.ID_tree_treeRoot=Ext.id();this.ID_find_name=Ext.id();this.ID_find_title=Ext.id();this.ID_find_beginTime=Ext.id();this.ID_find_endTime=Ext.id();this.ID_find_status=Ext.id();this.searchParams={name:"",title:"",beginTime:"",endTime:"",status:0};this.fields=[{name:"lid"},{name:"ulid"},{name:"name"},{name:"flowname"},{name:"title"},{name:"level"},{name:"step"},{name:"posttime"},{name:"status"},{name:"flowtype"}];this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getDispenseJsonData&isread="+this.isread,disableCaching:true}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields})});this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.store.load();this.colModel=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),{header:"ulid",dataIndex:"ulid",hidden:true},{header:"流程编号",dataIndex:"name",width:180,sortable:true,menuDisabled:true},{header:"所属流程",dataIndex:"flowname",width:120,sortable:true,menuDisabled:true},{header:lang("title"),dataIndex:"title",width:120,sortable:true,menuDisabled:true},{header:"重要等级",dataIndex:"level",width:60,sortable:false,menuDisabled:true},{header:"当前步骤",dataIndex:"step",width:70,sortable:false,menuDisabled:true},{header:"状态",dataIndex:"status",width:50,sortable:false,menuDisabled:true,renderer:this.makeStatus.createDelegate(this)},{header:"发起日期",dataIndex:"posttime",width:110,sortable:false,menuDisabled:true},{header:lang("opt"),dataIndex:"ulid",width:160,sortable:false,menuDisabled:true,renderer:this.makeOperate.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.pagingBar=new Ext.PagingToolbar({displayInfo:true,store:this.store,pageSize:15,listeners:{beforechange:function(b,c){c.sort=a.sort;if(a.searchParams.name!=""){c.name=a.searchParams.name}if(a.searchParams.title!=""){c.title=a.searchParams.title}if(a.searchParams.beginTime!=""){c.beginTime=a.searchParams.beginTime}if(a.searchParams.endTime!=""){c.endTime=a.searchParams.endTime}if(a.searchParams.status!=0){c.status=a.searchParams.status}}}});this.grid=new Ext.grid.GridPanel({stripeRows:true,store:this.store,loadMask:{msg:lang("waiting")},cm:this.colModel,hideBorders:true,border:false,region:"center",viewConfig:{},listeners:{rowdblclick:function(b,c){},rowclick:function(b,f,c,d){}},tbar:new Ext.Toolbar({items:[{iconCls:"icon-system-refresh",text:lang("refresh"),handler:function(b,c){a.store.reload()}.createDelegate(this)},"->",{xtype:"cnoa_helpBtn",helpid:161}]}),bbar:this.pagingBar});this.gridCt=new Ext.Panel({border:false,layout:"fit",items:[this.grid],region:"center",listeners:{afterrender:function(){new Ext.Toolbar({items:["发起开始时间：",{xtype:"datefield",width:170,format:"Y-m-d",editable:false,allowBlank:true,id:a.ID_find_beginTime}," 发起最后时间：",{xtype:"datefield",width:170,format:"Y-m-d",editable:false,allowBlank:true,id:a.ID_find_endTime},{xtype:"button",text:lang("search"),handler:function(){a.searchParams={name:Ext.getCmp(a.ID_find_name).getValue(),title:Ext.getCmp(a.ID_find_title).getValue(),beginTime:Ext.getCmp(a.ID_find_beginTime).getRawValue(),endTime:Ext.getCmp(a.ID_find_endTime).getRawValue(),status:Ext.getCmp(a.ID_find_status).getValue()};a.store.load({params:a.searchParams})}},{xtype:"button",text:lang("clear"),handler:function(){Ext.getCmp(a.ID_find_name).setValue("");Ext.getCmp(a.ID_find_title).setValue("");Ext.getCmp(a.ID_find_beginTime).setRawValue("");Ext.getCmp(a.ID_find_endTime).setRawValue("");Ext.getCmp(a.ID_find_status).setValue(-99);a.searchParams={name:"",title:"",beginTime:0,endTime:0,status:0};a.store.load()}}]}).render(this.tbar)}},tbar:new Ext.Toolbar({items:["标题：",{xtype:"textfield",width:200,id:a.ID_find_title}," 编号名称",{xtype:"textfield",width:150,id:a.ID_find_name},"当前状态：",{xtype:"combo",id:a.ID_find_status,editable:false,mode:"local",triggerAction:"all",valueField:"value",displayField:"display",store:new Ext.data.ArrayStore({fields:["value","display"],data:[[-99,""],[-1,"已删除"],[0,"未发布"],[1,"办理中"],[2,"已办理"],[3,"已退件"],[4,"已撤销"]]}),value:-99}]})});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.gridCt]})},makeStatus:function(a){var b="";if(a==0){b="<span class='cnoa_color_gray'>未发送</span>"}else{if(a==1){b="<span class='cnoa_color_orange'>办理中</span>"}else{if(a==2){b="<span class='cnoa_color_green'>已办理</span>"}else{if(a==3){b="<span class='cnoa_color_red'>已退件</span> "}else{if(a==4){b="<span class='cnoa_color_gray'>已撤销</span>"}}}}}return b},makeOperate:function(i,f,d,g,e,a){var j=d.data;var b=j.status;var c="<a href='javascript:void(0);' onclick='CNOA_flow_flow_dispense_list.showFlow("+i+", "+j.flowtype+");'>查看</a>";return c},showFlow:function(b,a){mainPanel.closeTab("CNOA_MENU_FLOW_USER_VIEWFLOW");if(a==0){mainPanel.loadClass("index.php?app=flow&func=flow&action=user&task=loadPage&from=showdispenseflow&ulid="+b,"CNOA_MENU_FLOW_USER_VIEWFLOW","查看工作流程","icon-flow")}else{if(a==1){mainPanel.loadClass("index.php?app=flow&func=flow&action=user&module=commonFlow&task=loadPage&from=showdispenseflow&ulid="+b,"CNOA_MENU_FLOW_USER_VIEWFLOW","查看工作流程","icon-flow")}}}};var CNOA_flow_flow_dispense_viewClass,CNOA_flow_flow_dispense_view;CNOA_flow_flow_dispense_viewClass=CNOA.Class.create();CNOA_flow_flow_dispense_viewClass.prototype={init:function(){var a=this;this.ulid=CNOA.flow.flow.dispense_view.ulid;this.ID_goto_nextstep=Ext.id();this.baseUrl="index.php?app=flow&func=flow&action=user";this.flowPanelLoaded=this.formPanelLoaded=this.progressPanelLoaded=this.eventPanelLoaded=false;this.ID_btn_edit=Ext.id();this.ID_btn_delete=Ext.id();this.ID_tree_treeRoot=Ext.id();this.ID_printArea=Ext.id();this.topTpl=new Ext.XTemplate('<table width="100%" border="0" cellspacing="1" cellpadding="0" style="background-color:#CDCDCD">',"  <tr>",'    <td width="15%" height="24" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">流程编号:&nbsp;</td>','    <td width="35%" valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{name}</td>','    <td width="15%" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">'+lang("flowName")+":&nbsp;</td>",'    <td width="35%" valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;[{flowname}]{title}</td>',"  </tr>","  <tr>",'    <td height="24" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">发起人:&nbsp;</td>','    <td valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{uname}</td>','    <td align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">发起日期:&nbsp;</td>','    <td valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{posttime}</td>',"  </tr>","  <tr>",'    <td height="24" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">当前步骤:&nbsp;</td>','    <td valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{stepText}</td>','    <td align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">流程状态:&nbsp;</td>','    <td valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{statusText}</td>',"  </tr>","  <tr>",'    <td height="24" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">申请事由:&nbsp;</td>','    <td valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{reason}</td>','    <td align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">特殊备注:&nbsp;</td>','    <td valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{about}</td>',"  </tr>",'  <tpl if="attachCount &gt; 0">',"  <tr>",'    <td height="24" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">流程附件:&nbsp;</td>','    <td colspan="3" valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;',"		{attach}","    </td>","  </tr>","  </tpl>","</table>");this.flowPanel=new Ext.Panel({headerStyle:"border-width:0",border:false,frame:true,animCollapse:false,collapsible:true,titleCollapse:true,style:"margin-bottom:10px;",title:"流程信息",listeners:{afterrender:function(b){a.flowPanelLoaded=true;a.view_loadFlowInfo()}}});this.formPanel=new Ext.form.FormPanel({headerStyle:"border-width:0",style:"margin-bottom:10px;",bodyStyle:"background-color:#FFF",border:false,frame:true,waitMsgTarget:true,animCollapse:false,collapsible:true,titleCollapse:true,autoScroll:true,title:"工作表单",listeners:{afterrender:function(b){a.formPanelLoaded=true;a.view_loadFlowInfo()}}});this.gridProgress=new CNOA_flow_flow_flowViewProgressClass(this.ulid);this.progressPanel=new Ext.Panel({headerStyle:"border-width:0",style:"margin-bottom:10px;",border:false,frame:true,animCollapse:false,collapsible:true,titleCollapse:true,title:"流程进度",layout:"fit",items:[this.gridProgress.grid],listeners:{afterrender:function(c){var b={}}}});this.gridEvent=new CNOA_flow_flow_flowViewEventClass(this.ulid);this.eventPanel=new Ext.Panel({headerStyle:"border-width:0",style:"margin-bottom:10px;",border:false,frame:true,layout:"fit",animCollapse:false,collapsible:true,titleCollapse:true,title:"事件日志",items:[this.gridEvent.grid],listeners:{afterrender:function(b){}}});this.gridReader=new CNOA_flow_flow_flowViewReaderClass(this.ulid);this.readerPanel=new Ext.Panel({headerStyle:"border-width:0",border:false,frame:true,layout:"fit",animCollapse:false,collapsible:true,titleCollapse:true,title:"评阅记录",items:[this.gridReader.grid],listeners:{afterrender:function(b){}}});this.centerPanel=new Ext.Panel({bodyStyle:"padding:10px",border:false,autoScroll:true,region:"center",items:[{xtype:"container",autoEl:"div",id:this.ID_printArea,items:[this.flowPanel,this.formPanel,this.progressPanel,this.eventPanel,this.readerPanel]}]});this.exportArray={i:1,f:1,p:1,e:1,r:1};this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.centerPanel],tbar:new Ext.Toolbar({items:["显示：",{xtype:"checkbox",boxLabel:"流程信息",checked:true,listeners:{check:function(c,b){if(b){a.exportArray.i=1;a.flowPanel.show()}else{a.exportArray.i=0;a.flowPanel.hide()}}}},{xtype:"checkbox",boxLabel:"工作表单",checked:true,listeners:{check:function(c,b){if(b){a.exportArray.f=1;a.formPanel.show()}else{a.exportArray.f=0;a.formPanel.hide()}}}},{xtype:"checkbox",boxLabel:"流程进度",checked:true,listeners:{check:function(c,b){if(b){a.exportArray.p=1;a.progressPanel.show()}else{a.exportArray.p=0;a.progressPanel.hide()}}}},{xtype:"checkbox",boxLabel:"事件日志",checked:true,listeners:{check:function(c,b){if(b){a.exportArray.e=1;a.eventPanel.show()}else{a.exportArray.e=0;a.eventPanel.hide()}}}},{xtype:"checkbox",boxLabel:"评阅记录",checked:true,listeners:{check:function(c,b){if(b){a.exportArray.r=1;a.readerPanel.show()}else{a.exportArray.r=0;a.readerPanel.hide()}}}},{handler:function(b,c){a.printFlow()}.createDelegate(this),hidden:Ext.isAir?true:false,iconCls:"icon-print",tooltip:"打印",text:"打印"},{handler:function(b,c){a.gridReader.showSay()}.createDelegate(this),hidden:Ext.isAir?true:false,iconCls:"icon-view-form-png",text:"我要评阅"},{iconCls:"icon-dialog-cancel",text:lang("close"),handler:function(b,c){a.closeTab()}.createDelegate(this)},"->",{xtype:"cnoa_helpBtn",helpid:162}]})})},view_loadFlowInfo:function(){var a=this;if(!this.flowPanelLoaded||!this.formPanelLoaded){return false}Ext.Ajax.request({url:a.baseUrl+"&task=show_loadDispenseFlowInfo",method:"POST",params:{ulid:a.ulid},success:function(c){var b=Ext.decode(c.responseText);if(b.success===true){a.topTpl.overwrite(a.flowPanel.body,b.data.flowInfo);a.formPanel.body.update(b.data.formInfo)}else{CNOA.msg.alert(b.msg,function(){})}}})},closeTab:function(){mainPanel.closeTab("CNOA_MENU_FLOW_USER_VIEWFLOW")},printFlow:function(){var a=Ext.encode(this.exportArray);window.open(this.baseUrl+"&task=exportFlow&target=printer&ulid="+this.ulid+"&exportArray="+a,"_blank","width=740,height="+(screen.availHeight-120)+",left="+((screen.availWidth-740)/2)+",top=60,scrollbars=yes,resizable=yes,status=no")}};var CNOA_flow_flow_dispense_view_commonflowClass,CNOA_flow_flow_dispense_view_commonflow;CNOA_flow_flow_dispense_view_commonflowClass=CNOA.Class.create();CNOA_flow_flow_dispense_view_commonflowClass.prototype={init:function(){var a=this;this.ulid=CNOA.flow.flow.dispense_view_commonflow.ulid;this.ID_goto_nextstep=Ext.id();this.baseUrl="index.php?app=flow&func=flow&action=user";this.flowPanelLoaded=this.progressPanelLoaded=this.eventPanelLoaded=false;this.ID_btn_edit=Ext.id();this.ID_btn_delete=Ext.id();this.ID_tree_treeRoot=Ext.id();this.ID_printArea=Ext.id();this.topTpl=new Ext.XTemplate('<table width="100%" border="0" cellspacing="1" cellpadding="0" style="background-color:#CDCDCD">',"  <tr>",'    <td width="15%" height="24" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">流程编号:&nbsp;</td>','    <td width="35%" valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{name}</td>','    <td width="15%" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">'+lang("flowName")+":&nbsp;</td>",'    <td width="35%" valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;[{flowname}]{title}</td>',"  </tr>","  <tr>",'    <td height="24" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">发起人:&nbsp;</td>','    <td valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{uname}</td>','    <td align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">发起日期:&nbsp;</td>','    <td valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{posttime}</td>',"  </tr>","  <tr>",'    <td height="24" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">当前步骤:&nbsp;</td>','    <td valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{stepText}</td>','    <td align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">流程状态:&nbsp;</td>','    <td valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{statusText}</td>',"  </tr>","  <tr>",'    <td height="24" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">申请事由:&nbsp;</td>','    <td colspan="3" valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;{reason}</td>',"  </tr>",'  <tpl if="attachCount &gt; 0">',"  <tr>",'    <td height="24" align="right" valign="middle" class="cnoa_bgc_F6F6F6 cnoa_font_bold">流程附件:&nbsp;</td>','    <td colspan="3" valign="middle" class="cnoa_bgc_FFFFFF">&nbsp;',"		{attach}","    </td>","  </tr>","  </tpl>","</table>");this.flowPanel=new Ext.Panel({headerStyle:"border-width:0",border:false,frame:true,animCollapse:false,collapsible:true,titleCollapse:true,style:"margin-bottom:10px;",title:"流程信息",listeners:{afterrender:function(b){a.flowPanelLoaded=true;a.view_loadFlowInfo()}}});this.gridProgress=new CNOA_flow_flow_flowViewProgressClass(this.ulid,true,false);this.progressPanel=new Ext.Panel({headerStyle:"border-width:0",style:"margin-bottom:10px;",border:false,frame:true,animCollapse:false,collapsible:true,titleCollapse:true,title:"流程进度",layout:"fit",items:[this.gridProgress.grid],listeners:{afterrender:function(c){var b={}}}});this.gridEvent=new CNOA_flow_flow_flowViewEventClass(this.ulid);this.eventPanel=new Ext.Panel({headerStyle:"border-width:0",style:"margin-bottom:10px;",border:false,frame:true,layout:"fit",animCollapse:false,collapsible:true,titleCollapse:true,title:"事件日志",items:[this.gridEvent.grid],listeners:{afterrender:function(b){}}});this.gridReader=new CNOA_flow_flow_flowViewReaderClass(this.ulid);this.readerPanel=new Ext.Panel({headerStyle:"border-width:0",border:false,frame:true,layout:"fit",animCollapse:false,collapsible:true,titleCollapse:true,title:"评阅记录",items:[this.gridReader.grid],listeners:{afterrender:function(b){}}});this.centerPanel=new Ext.Panel({bodyStyle:"padding:10px",border:false,autoScroll:true,region:"center",items:[{xtype:"container",autoEl:"div",id:this.ID_printArea,items:[this.flowPanel,this.progressPanel,this.eventPanel,this.readerPanel]}]});this.exportArray={i:1,p:1,e:1,r:1};this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.centerPanel],tbar:new Ext.Toolbar({items:["显示：",{xtype:"checkbox",boxLabel:"流程信息",checked:true,listeners:{check:function(c,b){if(b){a.exportArray.i=1;a.flowPanel.show()}else{a.exportArray.i=0;a.flowPanel.hide()}}}},{xtype:"checkbox",boxLabel:"流程进度",checked:true,listeners:{check:function(c,b){if(b){a.exportArray.p=1;a.progressPanel.show()}else{a.exportArray.p=0;a.progressPanel.hide()}}}},{xtype:"checkbox",boxLabel:"事件日志",checked:true,listeners:{check:function(c,b){if(b){a.exportArray.e=1;a.eventPanel.show()}else{a.exportArray.e=0;a.eventPanel.hide()}}}},{xtype:"checkbox",boxLabel:"评阅记录",checked:true,listeners:{check:function(c,b){if(b){a.exportArray.r=1;a.readerPanel.show()}else{a.exportArray.r=0;a.readerPanel.hide()}}}},{text:"导出",iconCls:"icon-download",tooltip:"导出为HTML文件",menu:{items:[{iconCls:"document-html",text:"导出为网页文件(html)",handler:function(){a.exportFlow("html")}.createDelegate(this)},{iconCls:"document-word",text:"导出为Word文档",handler:function(){a.exportFlow("word")}.createDelegate(this)}]}},{handler:function(b,c){a.gridReader.showSay()}.createDelegate(this),hidden:Ext.isAir?true:false,iconCls:"icon-view-form-png",text:"我要评阅"},{handler:function(b,c){a.printFlow()}.createDelegate(this),hidden:Ext.isAir?true:false,iconCls:"icon-print",tooltip:"打印",text:"打印"},{iconCls:"icon-dialog-cancel",text:lang("close"),handler:function(b,c){a.closeTab()}.createDelegate(this)},"->",{xtype:"cnoa_helpBtn",helpid:19}]})})},view_loadFlowInfo:function(){var a=this;if(!this.flowPanelLoaded){return false}Ext.Ajax.request({url:a.baseUrl+"&task=show_loadFlowInfo",method:"POST",params:{ulid:a.ulid},success:function(c){var b=Ext.decode(c.responseText);if(b.success===true){a.topTpl.overwrite(a.flowPanel.body,b.data.flowInfo)}else{CNOA.msg.alert(b.msg,function(){})}}})},closeTab:function(){mainPanel.closeTab("CNOA_MENU_FLOW_USER_VIEWFLOW")},exportFlow:function(f){var g=this;var b=Ext.id();var a=Ext.encode(this.exportArray);var e=function(){c.getForm().submit({url:g.baseUrl+"&task=exportFlow&target="+f,params:{ulid:g.ulid,exportArray:a},method:"POST",waitMsg:lang("waiting"),success:function(h,i){var j=Ext.getCmp(b);j.getEl().update("请点击下载：<br/>"+i.result.msg)}.createDelegate(this),failure:function(h,i){d.close();CNOA.msg.alert(i.result.msg,function(){})}.createDelegate(this)})};var c=new Ext.form.FormPanel({autoWidth:true,border:false,hideBorders:true,labelWidth:70,labelAlign:"right",waitMsgTarget:true,bodyStyle:"padding:10px;",listeners:{afterrender:function(h){e()}},items:[{xtype:"displayfield",name:"name",fieldLabel:lang("flowName")},new Ext.BoxComponent({id:b,autoEl:{tag:"div",style:"padding-left:16px",html:""}})]});var d=new Ext.Window({title:"导出工作流程",width:320,height:150,layout:"fit",modal:true,maximizable:false,resizable:false,items:[c],buttons:[{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){d.close()}}]}).show()},printFlow:function(){var a=Ext.encode(this.exportArray);window.open(this.baseUrl+"&task=exportFlow&target=printer&ulid="+this.ulid+"&exportArray="+a,"_blank","width=740,height="+(screen.availHeight-120)+",left="+((screen.availWidth-740)/2)+",top=60,scrollbars=yes,resizable=yes,status=no")},readedFlow:function(){CNOA_flow_flow_view_reader=new CNOA_flow_flow_view_readerClass(this.ulid);CNOA_flow_flow_view_reader.show()}};var sm_flow_flow=1;