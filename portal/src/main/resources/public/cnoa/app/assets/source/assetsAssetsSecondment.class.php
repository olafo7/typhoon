<?php//decode by qq2859470class assetsAssetsSecondment extends assetsAssets{    public function run( )    {        $task = getpar( $_GET, "task" );        switch ( $task )        {        case "loadPage" :            $this->_loadpage( );            exit( );        case "getList" :            $this->_getList( );            exit( );        case "cnumstore" :            $this->_cnumstore( );            exit( );        case "cnumnews" :            $this->_cnumnews( );            exit( );        case "addSecondment" :            $this->_addSecondment( );            exit( );        case "editSecondment" :            $this->_editSecondment( );            exit( );        case "exportExcel" :            $this->_exportExcel( );            exit( );        case "delSecondment" :            $this->_delSecondment( );            exit( );        case "getStatusStore" :            $this->_getStatusStore( );            exit( );        case "changeStatus" :            $this->_changeStatus( );        }        exit( );    }    private function _loadpage( )    {        global $CNOA_CONTROLLER;        $tplPath = $CNOA_CONTROLLER->appPath."/tpl/default/assets/secondment.htm";        $CNOA_CONTROLLER->loadExtraTpl( $tplPath );    }    private function _getList( $id = 0, $exportExcel = FALSE )    {        global $CNOA_DB;        $searchNumber = getpar( $_POST, "searchNumber" );        $searchName = getpar( $_POST, "searchName" );        $searchAssetsName = getpar( $_POST, "searchAssetsName" );        $searchBorrowDate = getpar( $_POST, "searchBorrowDate" );        $searchEndBorrowDate = getpar( $_POST, "searchEndBorrowDate" );        $searchReturnDate = getpar( $_POST, "searchReturnDate" );        $searchEndReturnDate = getpar( $_POST, "searchEndReturnDate" );        $searchDept = getpar( $_POST, "searchDept" );        $searchReceiver = getpar( $_POST, "searchReceiver" );        $searchReturnStatus = getpar( $_POST, "searchReturnStatus" );        $sbtime = strtotime( $searchBorrowDate." 00:00:00" );        $ebtime = strtotime( $searchEndBorrowDate." 23:59:59" );        $srtime = strtotime( $searchReturnDate." 00:00:00" );        $ertime = strtotime( $searchEndReturnDate." 23:59:59" );        $start = getpar( $_POST, "start", 0 );        $row = getpagesize( "assets_assets_secondment" );        $WHERE[] = "WHERE 1";        if ( !empty( $searchBorrowDate ) || empty( $searchEndBorrowDate ) )        {            msg::callback( FALSE, "借出结束日期未设置" );        }        else if ( !empty( $searchBorrowDate ) || !empty( $searchEndBorrowDate ) || !empty( $searchReturnDate ) || !empty( $searchEndReturnDate ) )        {        }        else if ( !empty( $searchReturnDate ) || empty( $searchEndReturnDate ) )        {            msg::callback( FALSE, "归还结束日期未设置" );        }        else if ( !empty( $searchBorrowDate ) || !empty( $searchEndBorrowDate ) )        {            if ( else if$ebtime < $sbtime )            {                msg::callback( FALSE, "借出结束日期不能大于借出开始日期" );            }        }        else if ( empty( $searchBorrowDate ) && !empty( $searchEndBorrowDate ) )        {            msg::callback( FALSE, "借出开始日期未设置" );        }        else if ( empty( $searchReturnDate ) && !empty( $searchEndReturnDate ) )        {            msg::callback( FALSE, "归还开始日期未设置" );        }        else if ( !empty( $searchReturnDate ) || !empty( $searchEndReturnDate ) )        {            if ( else if$ertime < $srtime )            {                msg::callback( FALSE, "归还结束日期不能大于归还开始日期" );            }        }        if ( !empty( $searchNumber ) )        {        }        if ( !empty( $searchName ) )        {        }        if ( !empty( $searchAssetsName ) )        {        }        if ( !empty( $searchReceiver ) )        {        }        if ( !empty( $searchDept ) )        {        }        if ( !empty( $searchReturnStatus ) )        {        }        $WHERE[$WHERE = implode( " AND ", $WHERE );        $result = $CNOA_DB->db_select( "*", $this->table_secondment_list, "{$WHERE} ORDER BY `id` DESC LIMIT {$start},{$row}" );        if ( $exportExcel )        {            $result = $CNOA_DB->db_select( "*", $this->table_secondment_list, $where." ORDER BY `id` DESC " );        }        if ( !is_array( $result ) )        {            $result = array( );        }        $data = array( );        foreach ( $result as $value )        {            $cnum = $CNOA_DB->db_getone( array( "cnum", "assetsName" ), $this->table_manage, "WHERE id=".$value['mid'] );            $value['receiverUids'] = $value['receiver'];            $value['receiver'] = !empty( $value['receiver'] ) ? $this->__takeUserName( $value['receiver'] ) : " ";            $value['acceptdpt'] = !empty( $value['acceptdpt'] ) ? app::loadapp( "main", "struct" )->api_getNameById( $value['acceptdpt'] ) : " ";            $value['borrowdate'] = !empty( $value['borrowdate'] ) ? date( "Y-m-d H:i:s", $value['borrowdate'] ) : " ";            $value['assetsName'] = !empty( $cnum['assetsName'] ) ? $cnum['assetsName'] : " ";            $value['returndate'] = !empty( $value['returndate'] ) ? date( "Y-m-d H:i:s", $value['returndate'] ) : " ";            $value['status'] = !empty( $value['status'] ) ? $value['status'] : " ";            $value['jiediaonumber'] = !empty( $value['jiediaonumber'] ) ? $cnum['cnum']."-".$value['jiediaonumber'] : " ";            $data[] = $value;        }        if ( !empty( $id ) )        {            return $data;        }        if ( $exportExcel )        {            return $data;        }        ( );        $ds = new dataStore( );        $ds->data = $data;        $ds->total = $CNOA_DB->db_getcount( $this->table_secondment_list, $WHERE );        echo $ds->makeJsonData( );        exit( );    }    private function _cnumstore( )    {        global $CNOA_DB;        $data = $CNOA_DB->db_select( array( "id", "cnum", "assetsName" ), $this->table_manage, "WHERE `type`='1' ORDER BY `id` DESC" );        if ( !is_array( $data ) )        {            $data = array( );        }        ( );        $ds = new dataStore( );        $ds->data = $data;        echo $ds->makeJsonData( );        exit( );    }    private function _cnumnews( )    {        global $CNOA_DB;        $id = getpar( $_POST, "id" );        $tempData = array( "id", "cnum", "standard", "deptId", "assetsName", "purchase", "assetsNum", "custody" );        $getCount = $CNOA_DB->db_getcount( $this->table_secondment_list, "WHERE mid=".$id );        $data = $CNOA_DB->db_getone( $tempData, $this->table_manage, "WHERE `id`='".$id."'" );        if ( !is_array( $data ) )        {            $data = array( );        }        if ( 0 < $data['assetsNum'] )        {            $data['residueNum'] = $data['assetsNum'] - $getCount;            if ( $data['residueNum'] < 0 )            {                $data['residueNum'] = "已超出".abs( $data['residueNum'] );            }        }        $data['residueNum'] = !empty( $data['residueNum'] ) ? $data['residueNum'] : "0";        $data['standard'] = !empty( $data['standard'] ) ? $data['standard'] : " ";        $data['custody'] = !empty( $data['custody'] ) ? $this->__takeUserName( $data['custody'] ) : " ";        $data['cid'] = $data['id'];        unset( $data['id'] );        $data['purchase'] = !empty( $data['purchase'] ) ? date( "Y-m-d", $data['purchase'] ) : " ";        $data['deptId'] = !empty( $data['deptId'] ) ? app::loadapp( "main", "struct" )->api_getNameById( $data['deptId'] ) : " ";        ( );        $ds = new dataStore( );        $ds->data = $data;        echo $ds->makeJsonData( );        exit( );    }    private function _addSecondment( )    {        global $CNOA_DB;        global $CNOA_SESSION;        $sid = getpar( $_POST, "sid" );        $cid = getpar( $_POST, "cid" );        $data['jiediaonumber'] = getpar( $_POST, "jiediaonumber" );        $data['borrowdate'] = strtotime( getpar( $_POST, "borrowdate" ) );        $data['returndate'] = strtotime( getpar( $_POST, "returndate" ) );        $data['status'] = getpar( $_POST, "statusId" );        $data['acceptdpt'] = getpar( $_POST, "acceptdpt" );        $data['receiver'] = getpar( $_POST, "receiverUids" );        $data['remark'] = getpar( $_POST, "remark" );        if ( !empty( $data['returndate'] ) || $data['returndate'] < $data['borrowdate'] )        {            msg::callback( FALSE, "借出日期不能大于归还日期!" );        }        if ( empty( $sid ) )        {            $result = $CNOA_DB->db_select( "*", $this->table_secondment_list, "WHERE jiediaonumber='".$data['jiediaonumber']."' AND mid={$cid}" );            if ( 0 < $result )            {                msg::callback( FALSE, "该借调编号已存在!" );            }            $data['mid'] = $cid;            $getCount = $CNOA_DB->db_getcount( $this->table_secondment_list, "WHERE mid=".$data['mid'] );            $getNum = $CNOA_DB->db_getone( array( "cnum", "assetsName", "assetsNum" ), $this->table_manage, "WHERE id=".$data['mid'] );            if ( $getNum['assetsNum'] <= $getCount )            {                msg::callback( FALSE, "没有可借调的资产!" );            }            $CNOA_DB->db_insert( $data, $this->table_secondment_list );            app::loadapp( "main", "systemLogs" )->api_addLogs( "add", 6005, $data['jiediaonumber'], "借调列表" );            $data['operator'] = $CNOA_SESSION->get( "UID" );            $data['operation'] = "1";            $data['turnover'] = time( );            $data['shid'] = $data['mid'];            $data['cnum'] = $getNum['cnum'];            $data['assetsName'] = $getNum['assetsName'];            unset( $data['mid'] );            $CNOA_DB->db_insert( $data, $this->table_historical );        }        else        {            $CNOA_DB->db_update( $data, $this->table_secondment_list, "WHERE id=".$sid );            $mid = $CNOA_DB->db_getfield( "mid", $this->table_secondment_list, "WHERE id=".$sid );            $temp = $CNOA_DB->db_getone( array( "cnum", "assetsName" ), $this->table_manage, "WHERE `id` = ".$mid );            $data['operator'] = $CNOA_SESSION->get( "UID" );            $data['operation'] = "2";            $data['turnover'] = time( );            $data['shid'] = $cid;            $data['cnum'] = $temp['cnum'];            $data['assetsName'] = $temp['assetsName'];            unset( $data['mid'] );            $CNOA_DB->db_insert( $data, $this->table_historical );            app::loadapp( "main", "systemLogs" )->api_addLogs( "update", 6005, $data['jiediaonumber'], "借调列表" );        }    }    private function _editSecondment( )    {        global $CNOA_DB;        $sid = getpar( $_POST, "sid" );        $data = $CNOA_DB->db_getone( "*", $this->table_secondment_list, "WHERE id=".$sid );        $tempData = array( "id", "cnum", "deptId", "assetsName", "purchase", "assetsNum", "custody", "standard" );        $result = $CNOA_DB->db_getone( $tempData, $this->table_manage, "WHERE id=".$data['mid'] );        $getCount = $CNOA_DB->db_getcount( $this->table_secondment_list, "WHERE mid=".$data['mid'] );        $temp = array( );        if ( 0 < $result['assetsNum'] )        {            $data['residueNum'] = $result['assetsNum'] - $getCount;            if ( $data['residueNum'] < 0 )            {                $data['residueNum'] = "已超出".abs( $data['residueNum'] );            }        }        $temp['residueNum'] = !empty( $data['residueNum'] ) ? $data['residueNum'] : "0";        $temp['receiver'] = $this->__takeUserName( $data['receiver'] );        $temp['receiver'] = !empty( $temp['receiver'] ) ? $temp['receiver'] : "";        $temp['custody'] = $this->__takeUserName( $result['custody'] );        $temp['custody'] = !empty( $temp['custody'] ) ? $temp['custody'] : " ";        $temp['statusId'] = !empty( $data['status'] ) ? $data['status'] : " ";        $temp['jiediaonumber'] = $data['jiediaonumber'];        $temp['cnum'] = $result['cnum'];        $temp['standard'] = $result['standard'];        $temp['assetsNum'] = !empty( $result['assetsNum'] ) ? $result['assetsNum'] : " ";        $temp['assetsName'] = $result['assetsName'];        $temp['deptId'] = app::loadapp( "main", "struct" )->api_getNameById( $result['deptId'] );        $temp['purchase'] = date( "Y-m-d", $result['purchase'] );        $temp['borrowdate'] = date( "Y-m-d H:i:s", $data['borrowdate'] );        if ( !empty( $data['returndate'] ) )        {            $temp['returndate'] = date( "Y-m-d H:i:s", $data['returndate'] );        }        $temp['receiverUids'] = $data['receiver'];        $temp['mid'] = $data['mid'];        $temp['remark'] = $data['remark'];        $temp['acceptdpt'] = $data['acceptdpt'];        $temp['acceptdptName'] = app::loadapp( "main", "struct" )->api_getNameById( $data['acceptdpt'] );        ( );        $ds = new dataStore( );        $ds->data = $temp;        echo $ds->makeJsonData( );    }    private function _exportExcel( )    {        global $CNOA_SESSION;        global $CNOA_DB;        $step = getpar( $_POST, "step", getpar( $_GET, "step", 0 ) );        if ( $step == 1 )        {            $info = array( );            $fileName = "CNOA.HR-".date( "Ymd", $GLOBALS['CNOA_TIMESTAMP'] )."-".string::rands( 10, 2 ).".xlsx";            $info[0] = $this->_getList( "", TRUE );            $assetsSecondment = include( CNOA_PATH."/resources/export/assets_assetsSecondment.php" );            ( );            $excel = new exportExcel( );            $info = $excel->formatExcelDate( $assetsSecondment, $info );            $sheetName = array( "借调信息" );            $excel->init( $info, $sheetName );            $excel->save( CNOA_PATH_FILE."/common/temp/".$fileName, "excel2007" );            msg::callback( TRUE, $fileName );        }        else        {            $fileName = getpar( $_GET, "file", "" );            $file = CNOA_PATH_FILE."/common/temp/".$fileName;            if ( !file_exists( $file ) )            {                echo "文件不存在!";                exit( );            }            if ( $CNOA_DB )            {                $CNOA_DB->close( );            }            @ini_set( "zlib.output_compression", "Off" );            header( "Content-Type: application/octet-stream" );            header( "Content-Disposition: attachment;filename=".cn_urlencode( "借调信息.xlsx" ) );            header( "Content-Length: ".filesize( $file ) );            ob_clean( );            flush( );            readfile( $file );            @unlink( $file );        }        exit( );    }    private function _delSecondment( )    {        global $CNOA_DB;        global $CNOA_SESSION;        $ids = getpar( $_POST, "ids" );        $data = array( );        $data['operator'] = $CNOA_SESSION->get( "UID" );        $data['operation'] = "3";        $data['turnover'] = time( );        if ( isinformat( $ids ) )        {            $result = $CNOA_DB->db_select( "*", $this->table_secondment_list, "WHERE `id` IN (".$ids.")" );            if ( !is_array( $result ) )            {                $result = array( );            }            foreach ( $result as $value )            {                $data['jiediaonumber'] = $value['jiediaonumber'];                $data['borrowdate'] = $value['borrowdate'];                $data['acceptdpt'] = $value['acceptdpt'];                $data['receiver'] = $value['receiver'];                $data['returndate'] = $value['returndate'];                $data['status'] = $value['status'];                $data['remark'] = $value['remark'];                $temp = $CNOA_DB->db_getone( array( "cnum", "assetsName" ), $this->table_manage, "WHERE `id`=".$value['mid'] );                $data['cnum'] = $temp['cnum'];                $data['assetsName'] = $temp['assetsName'];                $CNOA_DB->db_insert( $data, $this->table_historical );                unset( $data['cnum'] );                unset( $data['assetsName'] );            }            if ( $CNOA_DB->db_delete( $this->table_secondment_list, "WHERE `id` IN (".$ids.")" ) )            {                app::loadapp( "main", "systemLogs" )->api_addLogs( "del", 6005, "", "借调列表" );                msg::callback( TRUE, lang( "delSuccess" ) );            }        }        msg::callback( FALSE, lang( "delFail" ) );    }    private function _getStatusStore( )    {        global $CNOA_DB;        $data = $CNOA_DB->db_select( array( "id", "value" ), $this->table_dropdown, "WHERE type='1'" );        ( );        $ds = new dataStore( );        $ds->data = $data;        echo $ds->makeJsonData( );        exit( );    }    private function _changeStatus( )    {        global $CNOA_DB;        global $CNOA_SESSION;        $id = getpar( $_POST, "id" );        $data['returndate'] = time( );        $data['status'] = "1";        $result = $CNOA_DB->db_update( $data, $this->table_secondment_list, "WHERE id=".$id );        if ( 0 < $result )        {            $temp = $CNOA_DB->db_select( "*", $this->table_secondment_list, "WHERE id=".$id );            $tempData = array( );            foreach ( $temp as $value )            {                $tempData['jiediaonumber'] = $value['jiediaonumber'];                $tempData['acceptdpt'] = $value['acceptdpt'];                $tempData['receiver'] = $value['receiver'];                $tempData['returndate'] = $value['returndate'];                $tempData['status'] = $value['status'];                $tempData['mid'] = $value['mid'];            }            $temporary = $CNOA_DB->db_getone( array( "cnum", "assetsName" ), $this->table_manage, "WHERE id=".$tempData['mid'] );            $tempData['operator'] = $CNOA_SESSION->get( "UID" );            $tempData['cnum'] = $temporary['cnum'];            $tempData['assetsName'] = $temporary['assetsName'];            $tempData['operation'] = "4";            $tempData['turnover'] = $data['returndate'];            $tempData['borrowdate'] = $data['returndate'];            unset( $tempData['mid'] );            $CNOA_DB->db_insert( $tempData, $this->table_historical );            msg::callback( TRUE, lang( "editSuccess" ) );        }        msg::callback( FALSE, lang( "editFail" ) );    }}?>