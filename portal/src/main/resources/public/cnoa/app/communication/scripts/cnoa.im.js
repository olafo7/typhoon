var CNOA_communication_im_historyClass,CNOA_communication_im_history;CNOA_communication_im_historyClass=CNOA.Class.create();CNOA_communication_im_historyClass.prototype={init:function(){var a=this;this.ID_btn_refreshList=Ext.id();this.ID_tree_treeRoot="CNOA_communication_im_history_tree_root";this.ID_btn_collapseExpand=Ext.id();this.ID_chattingWith=Ext.id();this.ID_exportBtn=Ext.id();this.newSelectUid=0;this.newSelectGid=0;this.type="person";this.baseUrl="index.php?app=communication&func=im";this.fields=[{name:"id",mapping:"id"},{name:"date",mapping:"date"},{name:"content",mapping:"content"}];this.store=new Ext.data.GroupingStore({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&action=index&task=getHistoryList"}),groupField:"date",sortInfo:{field:"id",direction:"ASC"},applySort:function(){},reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields}),listeners:{load:function(d,b,e){var c=$("div[id=CHAT_HISTORYPANEL] div.x-grid3-scroller").get(0);c.scrollTop=999999999;setTimeout(function(){c.scrollTop=999999999},500)}}});this.colModel=new Ext.grid.ColumnModel([{header:"id",dataIndex:"id",width:20,sortable:true,hidden:true},{header:lang("date"),dataIndex:"date",width:20,sortable:true},{header:lang("content"),dataIndex:"content",width:60,sortable:false,resizable:false,menuDisabled:true,renderer:a.renderContent}]);this.pagingBar=new Ext.PagingToolbar({displayInfo:true,emptyMsg:lang("pagingToolbarEmptyMsg"),displayMsg:lang("pagingToolbarDisplayMsg"),style:"border-left-width:1px;",store:this.store,pageSize:30,listeners:{beforechange:function(b,c){c.type=a.type;c.uid=a.newSelectUid;c.gid=a.newSelectGid}}});this.grid=new Ext.grid.GridPanel({stripeRows:true,ds:this.store,hideHeaders:true,loadMask:{msg:lang("waiting")},cm:this.colModel,hideBorders:true,border:false,id:"CHAT_HISTORYPANEL",viewConfig:{forceFit:true},view:new Ext.grid.GroupingView({forceFit:true,showGroupName:true,enableNoGroups:false,enableGroupingMenu:false,hideGroupedColumn:true})});this.centerPanel=new Ext.Panel({region:"center",layout:"fit",bodyStyle:"border-left-width:1px;",autoScroll:true,items:[this.grid],tbar:new Ext.Toolbar({style:"border-left-width:1px;",items:[new Ext.BoxComponent({id:this.ID_chattingWith,autoEl:{tag:"div",style:"font-weight:bold;color:#535353;",html:lang("clickToViewRecord")}}),"->",{xtype:"button",text:lang("delSelected"),hidden:true,handler:function(b){var c=a.grid.getSelectionModel().getSelections();if(c.length==0){CNOA.miniMsg.alertShowAt(b,lang("mustSelectOneRow"))}else{CNOA.msg.cf(lang("confirmToDelete"),function(e){if(e=="yes"){if(c){var f="";for(var d=0;d<c.length;d++){f+=c[d].get("id")+",";var g=c[d];a.store.remove(g)}Ext.Ajax.request({url:a.baseUrl+"&action=index&task=deleteRecord",method:"POST",params:{ids:f},success:function(i){var h=Ext.decode(i.responseText);if(h.success===true){}else{CNOA.msg.alert(h.msg,function(){})}}})}}})}}},{xtype:"button",text:lang("export2"),hidden:true,id:this.ID_exportBtn,cls:"btn-blue3",iconCls:"icon-excel",handler:function(){a.exportHistory()}},{xtype:"cnoa_helpBtn",helpid:2}]}),bbar:this.pagingBar});this.treeRoot=new Ext.tree.AsyncTreeNode({id:this.ID_tree_treeRoot,expanded:true});this.treeLoader=new Ext.tree.TreeLoader({dataUrl:this.baseUrl+"&action=index&task=getAllUserListsInDeptTree",preloadChildren:true,clearOnLoad:false,listeners:{load:function(b){this.treeRoot.firstChild.collapse(true);if(Ext.getCmp(this.ID_btn_collapseExpand).pressed){this.treeRoot.expand(true)}else{this.treeRoot.firstChild.expand()}this.deptTree.getEl().unmask();try{var b=a.deptTree.getNodeById("CNOA_main_im_index_userlist_tree_node_"+CNOA_USER_UID);a.treeRoot.removeChild(b)}catch(c){}}.createDelegate(this)}});this.deptTree=new Ext.tree.TreePanel({hideBorders:true,border:false,rootVisible:false,lines:true,animCollapse:false,animate:false,loader:this.treeLoader,root:this.treeRoot,autoScroll:true,listeners:{click:function(b){a.openHistory(b)}.createDelegate(this),render:function(){}}});this.deptPanel=new Ext.Panel({region:"west",layout:"fit",split:true,hideBorders:true,border:false,width:180,minWidth:80,maxWidth:380,items:[this.deptTree],tbar:new Ext.Toolbar({items:[{handler:function(b,c){this.reloadDeptData()}.createDelegate(this),iconCls:"icon-system-refresh",tooltip:lang("refresh"),text:lang("refresh")},"->",{text:lang("expand"),id:this.ID_btn_collapseExpand,tooltip:lang("expandMenuTip"),enableToggle:true,toggleHandler:function(b,c){if(c){b.setText(lang("collapse"));b.setTooltip(lang("collapseMenuTip"));a.treeRoot.expand(true)}else{b.setText(lang("expand"));b.setTooltip(lang("expandMenuTip"));a.treeRoot.collapse(true);a.treeRoot.firstChild.expand()}}}]})});this.groupFields=[{name:"gid"},{name:"uid"},{name:"name"}];this.groupStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&action=index&task=getGroupList",disableCaching:true}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.groupFields})});this.groupStore.load();this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.groupColModel=new Ext.grid.ColumnModel([{header:"gid",dataIndex:"gid",hidden:true},{header:lang("group"),dataIndex:"name",width:210,sortable:true,menuDisabled:true,renderer:this.makeOper.createDelegate(this)}]);this.groupPanel=new Ext.grid.GridPanel({border:false,hideBorders:false,autoScroll:true,region:"center",layout:"fit",store:this.groupStore,cm:this.groupColModel,stripeRows:true,viewConfig:{forceFit:true},tbar:["->",{text:lang("refresh"),iconCls:"icon-system-refresh",handler:function(b,c){a.groupStore.reload()}}],listeners:{rowclick:function(c,f,d){var b=a.groupPanel.getStore().getAt(f);a.newSelectGid=b.data.gid;a.store.load({params:{type:"group",gid:b.data.gid}});Ext.getCmp(a.ID_chattingWith).getEl().update(lang("groupsRecord",b.data.name))}}});this.ddPanel=new Ext.Panel({width:380,minWidth:400,maxWidth:450,region:"west",layout:"card",activeItem:0,hideBorders:true,items:[this.deptPanel,this.groupPanel],tbar:[{enableToggle:true,allowDepress:false,pressed:true,toggleGroup:"CHAT_RECORD_VIEW",iconCls:"icon-communication-share",text:lang("linkMan"),cls:"btn-blue4",handler:function(){a.type="person";a.ddPanel.getLayout().setActiveItem(0);a.store.removeAll();a.store.load({params:{type:"person",uid:0}});var b=lang("clickToViewRecord");Ext.getCmp(a.ID_chattingWith).getEl().update(b);a.groupPanel.getSelectionModel().clearSelections()}},{enableToggle:true,allowDepress:false,toggleGroup:"CHAT_RECORD_VIEW",iconCls:"icon-group",text:lang("group"),cls:"btn-red1",handler:function(){a.type="group";a.ddPanel.getLayout().setActiveItem(1);var b=lang("clickGroupToViewRecord");a.store.removeAll();a.store.load({params:{type:"group",gid:0}});Ext.getCmp(a.ID_chattingWith).getEl().update(b)}}]});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:true,listeners:{afterlayout:function(){}},items:[this.centerPanel,this.ddPanel]})},exportHistory:function(){var a=this;Ext.Ajax.request({url:a.baseUrl+"&action=index&task=exportHistory",method:"POST",params:{uid:a.newSelectUid,step:1},success:function(b){ajaxDownload(a.baseUrl+"&action=index&task=exportHistory&uid="+a.newSelectUid+"&file="+b.responseText)}})},renderContent:function(c,b,a){b.attr='style="white-space:normal;"';return c},reloadDeptData:function(){this.treeRoot.reload()},openHistory:function(a){var c=this;if((a==undefined)||a.disabled||(a.attributes.uid==undefined)||(a.attributes.uid==CNOA_USER_UID)){return}var b=lang("recordWith",a.text);Ext.getCmp(this.ID_chattingWith).getEl().update(b);this.newSelectUid=a.attributes.uid;Ext.getCmp(this.ID_exportBtn).show();this.store.load({params:{type:"person",uid:a.attributes.uid}})},makeOper:function(e,c,b){var f=this;var d=b.data;var a="";if(d.isdelete==1){a+=e+'<span style="color: red">('+lang("dismissed")+")</span>"}else{a+=e}return a}};var sm_communication_im=1;