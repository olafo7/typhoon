var CNOA_communication_email_newEmailClass,CNOA_communication_email_newEmail;CNOA_communication_email_newEmailClass=CNOA.Class.create();CNOA_communication_email_newEmailClass.prototype={init:function(){var b=this;this.job=CNOA.communication.email.newEmail.job;this.edit_id=CNOA.communication.email.newEmail.id;this.emailFolder=CNOA.communication.email.newEmail.emailFolder;this.baseUrl="index.php?app=communication&func=email&action=index";this.ID_saveStatusBar=Ext.id();this.ID_flash_upload=Ext.id();this.ID_content=Ext.id();this.ID_bccuids=Ext.id();this.accountComboBoxDataStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getAccountList"}),reader:new Ext.data.JsonReader({root:"data",fields:[{name:"accountid"},{name:"account"}]}),listeners:{load:function(e,c,d){if(c.length<1){CNOA.msg.alert(lang("setEmailNotice"),function(){b.closeTab()})}else{b.accountComboBox.setValue(c[0].get("accountid"))}}}});this.accountComboBoxDataStore.load();this.accountComboBox=new Ext.form.ComboBox({fieldLabel:lang("sender2"),name:"accountid",store:this.accountComboBoxDataStore,hiddenName:"accountid",valueField:"accountid",displayField:"account",mode:"local",width:300,allowBlank:false,triggerAction:"all",forceSelection:true,editable:false,listeners:{select:function(e,c,d){}.createDelegate(this),change:function(){}.createDelegate(this)}});this.saveStatusBar=new Ext.BoxComponent({id:this.ID_saveStatusBar,autoEl:{tag:"div",style:"margin-left:20px;color:#676767;",html:""}});var a;this.centerPanel=new Ext.form.FormPanel({plain:false,region:"center",border:false,autoScroll:true,bodyStyle:"padding: 10px;background-color:#F8F8F8;",labelWidth:50,labelAlign:"right",waitMsgTarget:true,defaults:{},items:[this.accountComboBox,{xtype:"textarea",height:35,anchor:"-20",id:"emailContent",allowBlank:false,fieldLabel:lang("receiver"),emptyText:lang("wbyxdgts"),name:"emails",enableKeyEvents:true,listeners:{render:function(c){c.to=b.ID_bccuids},keyup:function(c,d){c.setValue(c.getValue().replace("；",";"))}}},{xtype:"hidden",id:this.ID_bccuids,name:"bccuids"},{xtype:"compositefield",items:[{xtype:"button",text:lang("emailAccount"),handler:function(){var c=Ext.getCmp("emailContent");if(!a){a=email_selector("addressBook",c,true)}a.show()}},{xtype:"displayfield",value:lang("wbyxdgts")}]},{xtype:"flashfile",fieldLabel:lang("attach"),name:"files",inputPre:"filesUpload"},{xtype:"textfield",fieldLabel:lang("title"),anchor:"-20",allowBlank:false,name:"title"},{items:[{xtype:"ueditor",toolType:"mini",name:"content",id:b.ID_content,zIndex:200,height:300}],fieldLabel:lang("articleContent"),border:false,height:360}],tbar:new Ext.Toolbar({style:"border-top-width:0;",items:[{handler:function(c,d){this.sendMessage()}.createDelegate(this),iconCls:"icon-send-sms",cls:"btn-green1",text:lang("send")},{handler:function(c,d){b.saveMessage()},iconCls:"icon-win-save",cls:"btn-blue4",text:lang("save")},{text:lang("close"),iconCls:"icon-noPass",cls:"btn-gray1",handler:function(){b.closeTab()}.createDelegate(this)},{xtype:"signatureBtn",iconCls:"icon-person-sign",cls:"btn-red1",url:this.baseUrl,autoToTargetEl:this.job=="loadDrafts"?false:true,targetEl:b.ID_content},this.saveStatusBar,"->",{xtype:"cnoa_helpBtn",helpid:123}]})});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.centerPanel],listeners:{beforedestroy:function(){if(a){a.destroy()}}}});if(this.job=="loadDrafts"){setTimeout(function(){b.draftsLoad()},100)}if(this.job=="replayLoad"){setTimeout(function(){b.replayLoad()},100)}if(this.job=="transmit"){setTimeout(function(){b.transmitLoad()},100)}if(this.job=="replayAll"){setTimeout(function(){b.replayAll()},100)}this.stv=setInterval(function(){try{b.saveMessage()}catch(c){}},60*1*1000)},replayLoad:function(){var b=this;var a=this.edit_id;b.centerPanel.getForm().load({url:this.baseUrl+"&task=replayLoad",params:{edit_id:a},method:"POST",waitTitle:lang("notice"),success:function(c,d){b.edit_id=0;b.centerPanel.getForm().findField("content").focus()},failure:function(c,d){CNOA.msg.alert(d.result.msg,function(){})}})},replayAll:function(){var a=this;var b=this.edit_id;a.centerPanel.getForm().load({url:this.baseUrl+"&task=replayAll",params:{id:b},method:"POST",waitTitle:lang("notice"),success:function(c,d){a.edit_id=0;a.centerPanel.getForm().findField("content").focus()},failure:function(c,d){CNOA.msg.alert(d.result.msg)}})},transmitLoad:function(){var b=this;var c=this.edit_id;var a=this.emailFolder;b.centerPanel.getForm().load({url:this.baseUrl+"&task=transmitLoad",params:{edit_id:c,emailFolder:a},method:"POST",waitTitle:lang("notice"),success:function(d,e){b.edit_id=0;b.centerPanel.getForm().findField("content").focus()},failure:function(d,e){CNOA.msg.alert(e.result.msg)}})},draftsLoad:function(){var a=this;a.centerPanel.getForm().load({url:this.baseUrl+"&task=draftsLoad",params:{edit_id:this.edit_id},method:"POST",waitTitle:lang("notice"),success:function(b,c){a.edit_id=c.result.data.id;a.centerPanel.getForm().findField("content").focus();a.centerPanel.getForm().findField("files").setValue("");a.centerPanel.getForm().findField("files").setValue(c.result.data.files)},failure:function(b,c){CNOA.msg.alert(c.result.msg,function(){})}})},sendMessage:function(){var d=this;var a=d.centerPanel.getForm();var c=a.findField("emails");var b=a.findField("title");if(a.findField("files").isUploading()){CNOA.msg.notice2("正在上传中，请稍等...");return}c.allowBlank=false;c.validationEvent=true;b.allowBlank=false;b.validationEvent=true;if(a.isValid()){a.submit({url:d.baseUrl+"&task=send",method:"POST",waitMsg:lang("waiting"),timeout:9999999,params:{task:"send",edit_id:d.edit_id},success:function(f,g){CNOA.msg.notice2(lang("emailSent"));try{CNOA_communication_email_index_drafts.store.reload()}catch(h){}try{CNOA_communication_email_index_inbox.store.reload()}catch(h){}try{CNOA_communication_email_index_outbox.store.reload()}catch(h){}d.closeTab()}.createDelegate(this),failure:function(e,f){CNOA.msg.alert(f.result.msg,function(){}.createDelegate(this))}.createDelegate(this)})}},saveMessage:function(){var d=this;var a=d.centerPanel.getForm();if(a.findField("files").isUploading()){return}var c=a.findField("emails");var b=a.findField("title");c.allowBlank=true;c.validationEvent=false;c.clearInvalid();b.allowBlank=true;b.validationEvent=false;b.clearInvalid();if(a.isValid()){a.submit({url:d.baseUrl+"&task=save",method:"POST",waitMsg:lang("waiting"),params:{task:"save",edit_id:d.edit_id},success:function(f,g){d.edit_id=parseInt(g.result.data.edit_id);Ext.getCmp(d.ID_saveStatusBar).getEl().update(lang("savedToDrafts")+"("+g.result.data.updateTime+")");f.findField("files").setValue("");f.findField("files").setValue(g.result.data.filesList);try{CNOA_communication_email_index_drafts.store.reload()}catch(h){}}.createDelegate(this),failure:function(e,f){CNOA.msg.alert(f.result.msg,function(){}.createDelegate(this))}.createDelegate(this)})}else{}},closeTab:function(){mainPanel.closeTab(CNOA.communication.email.newEmail.parentID.replace("docs-",""))},gotoLinkman:function(){mainPanel.closeTab("CNOA_MENU_COMMUNICATION_EMAIL_LINKMAN");mainPanel.loadClass(this.baseUrl+"&task=loadPage&from=linkman","CNOA_MENU_COMMUNICATION_EMAIL_LINKMAN",lang("linkMan"),"icon-kontact-contacts")}};var CNOA_communication_email_index_inboxClass,CNOA_communication_email_index_inbox;CNOA_communication_email_index_inboxClass=CNOA.Class.create();CNOA_communication_email_index_inboxClass.prototype={init:function(){var a=this;this.actionFolder="inbox";this.baseUrl="index.php?app=communication&func=email&action=index";this.ID_grid_inbox=Ext.id();this.ID_btn_delete_inbox=Ext.id();this.ID_tree_treeRoot=Ext.id();this.ID_text_title=Ext.id();this.ID_COMBOX_LIST=Ext.id();this.ID_COMBOX_FOLDERLIST=Ext.id();this.storeBar={srcmail:0,title:"",folder:0};this.fieldsInbox=[{name:"id"},{name:"from"},{name:"subject"},{name:"content"},{name:"date"},{name:"isread"},{name:"attachs"}];this.storeInbox=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=listInBox",disableCaching:true}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fieldsInbox})});this.storeInbox.load();this.smInbox=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.colModelInbox=new Ext.grid.ColumnModel([this.smInbox,{header:"id",dataIndex:"id",hidden:true},{header:'<img src="./resources/images/icons/sms-readed.gif" width="16" height="16" /><img src="./resources/images/icons/attach2.gif" width="16" height="16" />',dataIndex:"isread",width:45,sortable:true,menuDisabled:true,renderer:this.statusCheck.createDelegate(this)},{header:lang("sender"),dataIndex:"from",width:230,sortable:false,menuDisabled:true,renderer:this.makeFrom.createDelegate(this)},{header:lang("title"),dataIndex:"subject",width:180,id:"subject",sortable:false,menuDisabled:true,renderer:this.contentCheck.createDelegate(this)},{header:lang("receiveTime"),dataIndex:"date",width:120,sortable:false,menuDisabled:true},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.pagingBarInbox=new Ext.PagingToolbar({style:"border-left-width:1px;",displayInfo:true,plugins:[new Ext.grid.plugins.ComboPageSize()],store:this.storeInbox,pageSize:15,listeners:{beforechange:function(b,c){Ext.apply(c,a.storeBar)}}});this.sortStore=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getAllEmailList",disableCaching:true}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:[{name:"text"},{name:"srcmail"}]}),listeners:{load:function(d,b,c){Ext.getCmp(a.ID_COMBOX_LIST).setValue(0)}}});this.folderStore=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getFolderList&from=combo",disableCaching:true}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:[{name:"fid"},{name:"name"}]}),listeners:{load:function(d,b,c){}}});this.gridInbox=new Ext.grid.GridPanel({region:"center",layout:"fit",bodyStyle:"border-left-width:1px;",stripeRows:true,id:this.ID_grid_inbox,store:this.storeInbox,loadMask:{msg:lang("waiting")},cm:this.colModelInbox,sm:this.smInbox,hideBorders:true,border:false,autoExpandColumn:"subject",listeners:{cellclick:function(c,g,d,f){var b=c.getStore().getAt(g);if(d==4){a.rowClick(c,b);a.view(b.data.id)}}},tbar:new Ext.Toolbar({style:"border-left-width:1px;",items:[{id:this.ID_btn_refreshList,handler:function(b,c){a.storeInbox.load();a.treeRoot.reload()}.createDelegate(this),iconCls:"icon-system-refresh",text:lang("refresh")},{id:a.ID_btn_delete_inbox,text:lang("del"),iconCls:"icon-utils-s-delete",handler:function(b,c){a.deleteEmail()}.createDelegate(this)},{text:lang("fetchEmail"),iconCls:"icon-utils-s-add",cls:"btn-blue4",handler:function(){a.refreshEmail()}.createDelegate(this)},{text:lang("unreadEmail"),cls:"btn-red1",iconCls:"icon-email-unread",handler:function(){a.storeInbox.load({params:{notRead:1}})}},new Ext.form.ComboBox({id:this.ID_COMBOX_LIST,store:this.sortStore,valueField:"srcmail",displayField:"text",hiddenName:"srcmail",mode:"local",width:180,triggerAction:"all",forceSelection:true,editable:false,listeners:{select:function(d,b,c){a.storeBar.srcmail=b.data.srcmail;a.storeInbox.load({params:a.storeBar})}}}),new Ext.form.ComboBox({style:"margin-left:3px;",id:this.ID_COMBOX_FOLDERLIST,store:this.folderStore,emptyText:lang("moveTO"),valueField:"fid",displayField:"name",hiddenName:"folder",mode:"local",width:180,triggerAction:"all",forceSelection:true,editable:false,listeners:{select:function(g,b,c){var f=a.gridInbox.getSelectionModel().getSelections();if(f.length==0){CNOA.miniMsg.alertShowAt(g,lang("mustSelectOneRow"))}else{var e=new Array();for(var d=0;d<f.length;d++){e.push(f[d].get("id"))}a.moveListTo(b.data.fid,e)}g.clearValue()}}}),"->",{xtype:"cnoa_helpBtn",helpid:122}]}),bbar:this.pagingBarInbox});this.ID_text_stime=Ext.id();this.ID_text_etime=Ext.id();this.gridCt=new Ext.Panel({border:false,layout:"fit",region:"center",items:[this.gridInbox],tbar:new Ext.Toolbar({style:"border-left-width:1px;",items:[lang("title")+":",{xtype:"textfield",width:123,name:"title",id:a.ID_text_title},lang("receiveTimeFrom")+":",{xtype:"datefield",format:"Y-m-d",id:a.ID_text_stime},lang("to")+":",{xtype:"datefield",format:"Y-m-d",id:a.ID_text_etime},{text:lang("search"),handler:function(){a.storeBar.title=Ext.getCmp(a.ID_text_title).getValue();a.storeInbox.load({params:a.storeBar})}},{text:lang("clear"),handler:function(){Ext.getCmp(a.ID_text_title).setValue("");a.storeBar.title="";a.storeInbox.load()}}]})});this.centerPanel=new Ext.Panel({border:false,region:"center",layout:"fit",items:[this.gridCt]});this.treeRoot=new Ext.tree.AsyncTreeNode({text:lang("folder"),expanded:true});this.treeLoader=new Ext.tree.TreeLoader({dataUrl:this.baseUrl+"&task=getFolderTree",preloadChildren:true,clearOnLoad:false,listeners:{load:function(b){}.createDelegate(this)}});this.folderTree=new Ext.tree.TreePanel({rootVisible:false,split:true,region:"west",width:120,hideBorders:true,border:false,lines:true,animCollapse:false,animate:false,loader:this.treeLoader,root:this.treeRoot,autoScroll:true,bodyStyle:"border-right-width:1px;",listeners:{click:function(b){a.storeBar.folder=b.attributes.fid;a.storeInbox.load({params:a.storeBar})}},tbar:new Ext.Toolbar({style:"border-right-width:1px;",items:[{handler:function(b,c){this.treeRoot.reload()}.createDelegate(this),tooltip:lang("refresh"),text:lang("refresh")},"->",lang("folder")]})});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.folderTree,this.centerPanel]})},moveListTo:function(b,a){var c=this;Ext.Ajax.request({url:c.baseUrl,method:"POST",params:{ids:a.join(","),task:"moveToFolder",folder:b},success:function(e){var d=Ext.decode(e.responseText);if(d.success===true){CNOA.msg.notice2(d.msg);c.storeInbox.reload();c.treeRoot.reload()}else{CNOA.msg.alert(d.msg)}}})},rowClick:function(d,b){var a=d.getEl().query("span[comm_mail_gridid="+this.actionFolder+"_"+b.data.id+"]");for(var c=0;c<a.length;c++){a[c].style.fontWeight="normal"}try{var g=d.getEl().query("img[comm_mail_gridid="+this.actionFolder+"_"+b.data.id+"]");g[0].src="./resources/images/icons/sms-readed.gif"}catch(f){}},makeFrom:function(f,g,b){var e=b.data;var d="";var c="";if(f[0].name!=null){d=f[0].name;c=""}else{d='<a href="javascript:void(0)" onclick="CNOA_communication_email_index_inbox.addNewAddress(\''+f[0].address+"')\">"+f[0].address+"</a>"}if(b.data.isread==0){var a="font-weight: bold;"}return String.format('<span style="{1}" comm_mail_gridid="{3}_{2}">{0}</span>{4}',d,a,b.data.id,this.actionFolder,c)},contentCheck:function(e,f,c){var d=c.data;var b="";if(c.data.isread==0){b="font-weight: bold;"}var a=String.format('<span style="{1}" comm_mail_gridid="{3}_{2}">{0}</span>',e,b,c.data.id,this.actionFolder);return a+"&nbsp;<span class='cnoa_color_gray'> - "+d.content+"&nbsp;</span>"},statusCheck:function(d,e,a){var c=a.data;var b="";if(d==1){b+='<img src="./resources/images/icons/sms-readed.gif" width="16" height="16" />'}else{b+='<img src="./resources/images/icons/sms-unread.gif" width="16" height="16" comm_mail_gridid="'+this.actionFolder+"_"+a.data.id+'" />'}if(c.attachs>0){b+='<img src="./resources/images/icons/attach2.gif" width="16" height="16" />'}return b},deleteEmail:function(){var h=this;var e="inbox";var g,c;var g=h.ID_btn_delete_inbox;var c=h.gridInbox;var a=Ext.getCmp(g).getEl().getBox();a=[a.x+12,a.y+26];var f=c.getSelectionModel().getSelections();if(f.length==0){CNOA.miniMsg.alert(lang("mustSelectOneRow"),a)}else{var d=new Array();for(var b=0;b<f.length;b++){d.push(f[b].get("id"))}CNOA.miniMsg.show({msg:lang("confirmToDelete"),xy:a,modal:false,fn:function(i){if(i=="confirm"){Ext.Ajax.request({url:h.baseUrl,method:"POST",params:{ids:d.join(","),task:"delete",folder:e},success:function(k){var j=Ext.decode(k.responseText);if(j.success===true){c.store.reload();h.treeRoot.reload()}else{CNOA.msg.alert(j.msg)}}})}}})}},refreshEmail:function(){var a=this;Ext.Ajax.request({url:this.baseUrl+"&task=checkNewEmail",method:"GET",timeout:3000});CNOA.msg.notice2(lang("emailReceiving"))},view:function(a){mainPanel.closeTab("CNOA_MENU_COMMUNICATION_EMAIL_VIEW");mainPanel.loadClass("index.php?app=communication&func=email&action=index&task=loadPage&from=view&folder=inbox&id="+a,"CNOA_MENU_COMMUNICATION_EMAIL_VIEW",lang("viewMail"),"icon-cnoa-mail")},goSetting:function(){mainPanel.closeTab("CNOA_MENU_COMMUNICATION_EMAIL_SETTING");mainPanel.loadClass("index.php?app=communication&func=email&action=index&task=loadPage&from=setting","CNOA_MENU_COMMUNICATION_EMAIL_SETTING",lang("emailSet"),"icon-role-s-operation")},addNewAddress:function(a){var b=this;new Ext.AddContact({email:a,listeners:{uploadSuccess:function(){b.storeInbox.reload()}}})}};var CNOA_communication_email_index_outboxClass,CNOA_communication_email_index_outbox;CNOA_communication_email_index_outboxClass=CNOA.Class.create();CNOA_communication_email_index_outboxClass.prototype={init:function(){var a=this;this.actionFolder="outbox";this.baseUrl="index.php?app=communication&func=email&action=index";this.ID_grid_outbox=Ext.id();this.ID_btn_delete_outbox=Ext.id();this.ID_text_title=Ext.id();this.ID_text_toName=Ext.id();this.storeBar={title:"",toName:""};this.fields=[{name:"id"},{name:"to"},{name:"from"},{name:"subject"},{name:"content"},{name:"date"},{name:"attachs"}];this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=listOutBox",disableCaching:true}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields})});this.store.load();this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.colModel=new Ext.grid.ColumnModel([this.sm,{header:"id",dataIndex:"id",hidden:true},{header:'<img src="./resources/images/icons/attach.gif" width="13" height="13" />',dataIndex:"attachs",width:34,sortable:true,menuDisabled:true,resizable:false,renderer:this.attachCheck,tooltip:lang("attach")},{header:lang("receiver"),dataIndex:"to",width:135,sortable:false,menuDisabled:true,renderer:this.makeFrom.createDelegate(this)},{header:lang("sentFromEmail"),dataIndex:"from",width:135,sortable:false,menuDisabled:true},{header:lang("title"),dataIndex:"subject",width:180,id:"subject",sortable:false,menuDisabled:true,renderer:this.contentCheck.createDelegate(this)},{header:lang("posttime"),dataIndex:"date",width:120,sortable:false,menuDisabled:true},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.pagingBar=new Ext.PagingToolbar({displayInfo:true,plugins:[new Ext.grid.plugins.ComboPageSize()],store:this.store,pageSize:15,listeners:{beforechange:function(b,c){c.task="list";c.folder="outbox"}}});this.grid=new Ext.grid.GridPanel({stripeRows:true,id:this.ID_grid_outbox,store:this.store,loadMask:{msg:lang("waiting")},cm:this.colModel,sm:this.sm,hideBorders:true,border:false,autoExpandColumn:"subject",listeners:{rowdblclick:function(b,c){},cellclick:function(c,g,d,f){var b=c.getStore().getAt(g);a.rowClick(c,b);if(d!=0){a.view(b.data.id)}}},tbar:new Ext.Toolbar({items:[{id:this.ID_btn_refreshList,handler:function(b,c){a.store.reload()}.createDelegate(this),iconCls:"icon-system-refresh",text:lang("refresh")},{id:a.ID_btn_delete_outbox,text:lang("del"),iconCls:"icon-utils-s-delete",handler:function(b,c){a.deleteEmail()}.createDelegate(this)},"->",{xtype:"cnoa_helpBtn",helpid:102}]}),bbar:this.pagingBar});this.gridCt=new Ext.Panel({border:false,layout:"fit",region:"center",items:[this.grid],tbar:new Ext.Toolbar({style:"border-left-width:1px;",items:[lang("title")+":",{xtype:"textfield",width:123,name:"title",id:a.ID_text_title},lang("receiver")+":",{xtype:"textfield",width:123,name:"toName",id:a.ID_text_toName},{text:lang("search"),handler:function(){a.storeBar.title=Ext.getCmp(a.ID_text_title).getValue();a.storeBar.toName=Ext.getCmp(a.ID_text_toName).getValue();a.store.load({params:a.storeBar})}},{text:lang("clear"),handler:function(){Ext.getCmp(a.ID_text_title).setValue("");Ext.getCmp(a.ID_text_toName).setValue("");a.storeBar.title="";a.storeBar.toName="";a.store.load()}}]})});this.centerPanel=new Ext.Panel({border:false,region:"center",layout:"fit",items:[this.gridCt]});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.centerPanel]})},attachCheck:function(a){if(a==1){return'<img src="./resources/images/icons/attach2.gif" width="16" height="16" />'}else{return""}},rowClick:function(b,a){},makeFrom:function(c,d,a){var b=a.data;return b.to},contentCheck:function(f,h,c){var d=c.data;var b="";try{f=f.replace(new RegExp("<br />","g"),"\n");f=f.replace(/<\/div>(.*)$/gi,"")}catch(g){f=lang("userNotExists")}var a=String.format("<span>{0}</span>",f);return a+"<br><span class='cnoa_color_gray'>"+d.content+"</span>"},deleteEmail:function(){var h=this;var e="outbox";var g,c;var g=h.ID_btn_delete_outbox;var c=h.grid;var a=Ext.getCmp(g).getEl().getBox();a=[a.x+12,a.y+26];var f=c.getSelectionModel().getSelections();if(f.length==0){CNOA.miniMsg.alert(lang("mustSelectOneRow"),a)}else{var d=new Array();for(var b=0;b<f.length;b++){d.push(f[b].get("id"))}CNOA.miniMsg.show({msg:lang("confirmToDelete"),xy:a,modal:false,fn:function(i){if(i=="confirm"){Ext.Ajax.request({url:h.baseUrl,method:"POST",params:{ids:d.join(","),task:"delete",folder:e},success:function(k){var j=Ext.decode(k.responseText);if(j.success===true){CNOA.msg.notice2(j.msg);c.store.reload()}else{CNOA.msg.alert(j.msg)}}})}}})}},view:function(a){mainPanel.closeTab("CNOA_MENU_COMMUNICATION_EMAIL_VIEW");mainPanel.loadClass("index.php?app=communication&func=email&action=index&task=loadPage&from=view&folder=outbox&id="+a,"CNOA_MENU_COMMUNICATION_EMAIL_VIEW",lang("viewMail"),"icon-cnoa-mail")}};var CNOA_communication_email_index_draftsClass,CNOA_communication_email_index_drafts;CNOA_communication_email_index_draftsClass=CNOA.Class.create();CNOA_communication_email_index_draftsClass.prototype={init:function(){var a=this;this.actionFolder="inbox";this.baseUrl="index.php?app=communication&func=email&action=index";this.ID_grid=Ext.id();this.ID_btn_delete=Ext.id();this.fields=[{name:"id"},{name:"attach"},{name:"to"},{name:"subject"},{name:"content"},{name:"posttime"}];this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=listDrafts"}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields})});this.store.load();this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.colModel=new Ext.grid.ColumnModel([this.sm,{header:"id",dataIndex:"id",width:20,sortable:true,hidden:true},{header:'<img src="./resources/images/icons/attach.gif" width="13" height="13" />',dataIndex:"attach",width:34,sortable:true,menuDisabled:true,resizable:false,renderer:this.attachCheck,tooltip:lang("attach")},{header:lang("receiver"),dataIndex:"to",width:160,sortable:false,menuDisabled:true},{header:lang("titleContent"),dataIndex:"subject",id:"subject",width:180,sortable:false,menuDisabled:true,renderer:this.contentCheck.createDelegate(this)},{header:lang("saveTime"),dataIndex:"posttime",width:120,sortable:false,menuDisabled:true},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.pagingBar=new Ext.PagingToolbar({displayInfo:true,plugins:[new Ext.grid.plugins.ComboPageSize()],store:this.store,pageSize:15,listeners:{beforechange:function(b,c){}}});this.grid=new Ext.grid.GridPanel({stripeRows:true,id:this.ID_grid_,store:this.store,loadMask:{msg:lang("waiting")},cm:this.colModel,sm:this.sm,hideBorders:true,border:false,autoExpandColumn:"subject",listeners:{rowdblclick:function(b,c){},rowclick:function(b,d,c){},cellclick:function(c,g,d,f){var b=c.getStore().getAt(g);if(d!=0){a.draftsLoad()}}},tbar:new Ext.Toolbar({items:[{id:this.ID_btn_refreshList,handler:function(b,c){a.store.reload()}.createDelegate(this),iconCls:"icon-system-refresh",text:lang("refresh")},{id:a.ID_btn_delete,text:lang("del"),iconCls:"icon-utils-s-delete",handler:function(b,c){a.deleteEmail()}.createDelegate(this)},"->",{xtype:"cnoa_helpBtn",helpid:121}]}),bbar:this.pagingBar});this.centerPanel=new Ext.Panel({border:false,region:"center",layout:"fit",items:[this.grid]});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.centerPanel]})},contentCheck:function(c,d,a){var b=a.data;return c+"<br><span class='cnoa_color_gray'>"+b.content+"</span>"},attachCheck:function(a){a=Ext.decode(a);if(a.length>0){return'<img src="./resources/images/icons/attach2.gif" width="16" height="16" />'}else{return""}},deleteEmail:function(){var h=this;var e="drafts";var g,c;var g=h.ID_btn_delete;var c=h.grid;var a=Ext.getCmp(g).getEl().getBox();a=[a.x+12,a.y+26];var f=c.getSelectionModel().getSelections();if(f.length==0){CNOA.miniMsg.alert(lang("mustSelectOneRow"),a)}else{var d=new Array();for(var b=0;b<f.length;b++){d.push(f[b].get("id"))}CNOA.miniMsg.show({msg:lang("confirmToDelete"),xy:a,modal:false,fn:function(i){if(i=="confirm"){Ext.Ajax.request({url:h.baseUrl,method:"POST",params:{ids:d.join(","),task:"delete",folder:e},success:function(k){var j=Ext.decode(k.responseText);if(j.success===true){c.store.reload()}else{CNOA.msg.alert(j.msg)}}})}}})}},draftsLoad:function(){var c=this;var a=c.grid.getSelectionModel().getSelections();var b=a[0].get("id");mainPanel.closeTab("CNOA_MENU_COMMUNICATION_EMAIL_NEW");mainPanel.loadClass("index.php?app=communication&func=email&action=index&task=loadPage&from=newEmail&job=loadDrafts&id="+b,"CNOA_MENU_COMMUNICATION_EMAIL_NEW",lang("newEmail"),"icon-new-sms")}};var CNOA_communication_email_settingClass,CNOA_communication_email_setting;CNOA_communication_email_settingClass=CNOA.Class.create();CNOA_communication_email_settingClass.prototype={init:function(){var a=this;this.baseUrl="index.php?app=communication&func=email&action=index";this.fields=[{name:"id"},{name:"pop3_type"},{name:"pop3_host"},{name:"pop3_port"},{name:"pop3_user"},{name:"pop3_pass"},{name:"pop3_ssl"},{name:"smtp_host"},{name:"smtp_port"},{name:"smtp_user"},{name:"smtp_pass"},{name:"smtp_auth"},{name:"smtp_ssl"},{name:"smtp_from"},{name:"smtp_from_name"},{name:"status"},{name:"default"},{name:"delremote"}];this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getSettingList",disableCaching:true}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields})});this.store.load();this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.colModel=new Ext.grid.ColumnModel([this.sm,{header:"id",dataIndex:"id",hidden:true},{header:lang("ifDefault"),dataIndex:"default",width:60,sortable:true,menuDisabled:true},{header:lang("status"),dataIndex:"status",width:50,sortable:false,menuDisabled:true},{header:lang("emailAddr"),dataIndex:"smtp_from",width:134,sortable:false,menuDisabled:true},{header:lang("sendName"),dataIndex:"smtp_from_name",width:100,sortable:false,menuDisabled:true},{header:lang("inProtocol"),dataIndex:"pop3_type",width:65,sortable:true,menuDisabled:true},{header:lang("mailServer"),dataIndex:"pop3_host",width:134,sortable:true,menuDisabled:true},{header:lang("thePort"),dataIndex:"pop3_port",width:65,sortable:true,menuDisabled:true},{header:lang("receiverUser"),dataIndex:"pop3_user",width:134,sortable:false,menuDisabled:true},{header:lang("receivingPassword"),dataIndex:"pop3_pass",width:70,sortable:false,menuDisabled:true},{header:lang("encryption"),dataIndex:"pop3_ssl",width:85,sortable:false,menuDisabled:true},{header:lang("smtpHost"),dataIndex:"smtp_host",width:134,sortable:false,menuDisabled:true},{header:lang("smtpPort"),dataIndex:"smtp_port",width:65,sortable:false,menuDisabled:true},{header:lang("smtpUser"),dataIndex:"smtp_user",width:134,sortable:false,menuDisabled:true},{header:lang("smtpPwd"),dataIndex:"smtp_pass",width:70,sortable:false,menuDisabled:true},{header:lang("needEmailAuth"),dataIndex:"smtp_auth",width:65,sortable:false,menuDisabled:true},{header:lang("smptSSL"),dataIndex:"smtp_ssl",width:85,sortable:false,menuDisabled:true},{header:lang("delAfterReceive2"),dataIndex:"delremote",width:85,sortable:false,menuDisabled:true},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.grid=new Ext.grid.GridPanel({stripeRows:true,store:this.store,loadMask:{msg:lang("waiting")},cm:this.colModel,sm:this.sm,hideBorders:true,border:false,listeners:{rowdblclick:function(b,c){a.showAddEditWindow("edit")},cellclick:function(b,f,c,d){}},tbar:new Ext.Toolbar({items:[{handler:function(b,c){this.store.reload()}.createDelegate(this),iconCls:"icon-system-refresh",tooltip:lang("refresh"),text:lang("refresh")},{handler:function(b,c){a.showAddEditWindow("add")}.createDelegate(this),iconCls:"icon-utils-s-add",text:lang("add")},{handler:function(b,c){a.showAddEditWindow("edit",b)}.createDelegate(this),iconCls:"icon-utils-s-edit",text:lang("modify")},{text:lang("del"),iconCls:"icon-utils-s-delete",handler:function(b,c){a.deleteList(b)}.createDelegate(this)},"->",{xtype:"cnoa_helpBtn",helpid:125}]})});this.centerPanel=new Ext.Panel({border:false,region:"center",layout:"fit",items:[this.grid]});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.centerPanel]})},deleteList:function(a){var c=this;var b=this.grid.getSelectionModel().getSelections();if(b.length==0){CNOA.miniMsg.alertShowAt(a,lang("mustSelectOneRow"))}else{Ext.MessageBox.show({title:lang("notice"),msg:lang("delEmailNotice"),buttons:Ext.MessageBox.YESNOCANCEL,fn:function(e){if(e!="cancel"){if(b){var f="";for(var d=0;d<b.length;d++){f+=b[d].get("id")+","}Ext.Ajax.request({url:c.baseUrl+"&task=deleteSettingData",method:"POST",params:{ids:f,btn:e},success:function(h){var g=Ext.decode(h.responseText);if(g.success===true){CNOA.msg.notice2(g.msg);c.store.reload()}else{CNOA.msg.alert(g.msg)}}})}}},icon:Ext.MessageBox.QUESTION})}},showAddEditWindow:function(c,b){var g=this;var f=0;var d=Ext.id();if(c=="edit"){var e=this.grid.getSelectionModel().getSelections();if(e.length==0){CNOA.miniMsg.alertShowAt(b,lang("mustSelectOneRow"));return}f=e[0].get("id")}this.baseField=[{xtype:"fieldset",title:lang("receiverSet"),layout:"table",layoutConfig:{columns:2},defaults:{border:false,width:320},items:[{layout:"form",fieldLabel:lang("inProtocol"),items:(function(){var h={};if(c!="edit"){h=[{xtype:"radiogroup",fieldLabel:lang("inProtocol"),items:[{boxLabel:"POP3",checked:true,inputValue:"1",name:"pop3_type"},{boxLabel:"IMAP",inputValue:"2",name:"pop3_type"}]}]}else{h=[{xtype:"displayfield",fieldLabel:lang("inProtocol"),name:"pop3_typeName"},{xtype:"hidden",name:"pop3_type"}]}return h})()},{xtype:"box"},{layout:"form",items:[{xtype:"textfield",width:190,name:"pop3_host",allowBlank:false,fieldLabel:lang("serverAddress")}]},{layout:"form",items:[{xtype:"textfield",width:190,name:"pop3_port",value:110,allowBlank:false,fieldLabel:lang("serverPort")}]},{layout:"form",items:[{xtype:"textfield",width:190,allowBlank:false,name:"pop3_user",fieldLabel:lang("username2"),enableKeyEvents:true,listeners:{keyup:function(h,i){g.formPanel.getForm().findField("smtp_user").setValue(h.getValue())}}}]},{layout:"form",items:[{xtype:"textfield",width:190,allowBlank:false,name:"pop3_pass",fieldLabel:lang("password"),inputType:"password",enableKeyEvents:true,listeners:{keyup:function(h,i){g.formPanel.getForm().findField("smtp_pass").setValue(h.getValue())}}}]},{layout:"form",items:[{xtype:"checkbox",width:190,name:"pop3_ssl",boxLabel:lang("sslLogin"),listeners:{check:function(i,h){}}}]},{layout:"form",items:[{xtype:"checkbox",width:190,name:"delremote",boxLabel:lang("delAfterReceive")}]}]},{xtype:"fieldset",title:lang("smtpSet"),layout:"table",layoutConfig:{columns:2},defaults:{border:false,width:320},items:[{layout:"form",items:[{xtype:"textfield",width:190,name:"smtp_from",vtype:"email",allowBlank:false,fieldLabel:lang("emailAddr")}]},{layout:"form",items:[{xtype:"textfield",width:190,allowBlank:false,name:"smtp_from_name",fieldLabel:lang("sendWithName")}]},{layout:"form",items:[{xtype:"textfield",width:190,allowBlank:false,name:"smtp_host",fieldLabel:lang("smtpHost")}]},{layout:"form",items:[{xtype:"textfield",width:190,allowBlank:false,name:"smtp_port",value:25,fieldLabel:lang("smtpPort")}]},{layout:"form",items:[{xtype:"textfield",width:190,allowBlank:false,name:"smtp_user",fieldLabel:lang("smtpUser")}]},{layout:"form",items:[{xtype:"textfield",width:190,allowBlank:false,name:"smtp_pass",fieldLabel:lang("smtpPwd"),inputType:"password"}]},{layout:"form",items:[{xtype:"checkbox",width:190,checked:true,name:"smtp_auth",boxLabel:lang("needEmailAuth")}]},{xtype:"hidden"},{layout:"form",items:[{xtype:"checkbox",width:190,name:"smtp_ssl_enable",boxLabel:"是否使用加密传输",listeners:{check:function(i,h){Ext.getCmp(d).setDisabled(!h);Ext.getCmp(d).setValue(Ext.getCmp(d).getValue())}}}]},{layout:"form",items:[{xtype:"radiogroup",id:d,disabled:true,fieldLabel:"加密方式",width:87,items:[{boxLabel:"SSL",name:"smtp_ssl",inputValue:1,checked:true},{boxLabel:"TLS",name:"smtp_ssl",inputValue:2}]}]}]},{xtype:"fieldset",title:lang("otherOpt"),layout:"table",layoutConfig:{columns:2},defaults:{border:false,width:320},items:[{layout:"form",items:[{xtype:"checkbox",name:"default",fieldLabel:lang("setToDefault")}]},{layout:"form",items:[{xtype:"checkbox",name:"status",checked:true,fieldLabel:lang("isEnable")}]}]}];this.formPanel=new Ext.form.FormPanel({border:false,monitorResize:true,labelWidth:105,labelAlign:"right",waitMsgTarget:true,items:[{xtype:"panel",border:false,bodyStyle:"padding:10px;",items:this.baseField}]});var a=function(){if(g.formPanel.getForm().isValid()){g.formPanel.getForm().submit({url:g.baseUrl+"&task=setSettingData",waitTitle:lang("notice"),method:"POST",waitMsg:lang("waiting"),params:{id:f,type:c},success:function(h,i){g.store.reload();g.addEditWindow.close()},failure:function(h,i){CNOA.msg.alert(i.result.msg,function(){})}})}else{}};this.addEditWindow=new Ext.Window({title:lang("addEditEmail"),width:700,height:makeWindowHeight(550),resizable:false,autoDistory:true,modal:true,maskDisabled:true,items:[this.formPanel],plain:true,layout:"fit",buttonAlign:"right",buttons:[{xtype:"cnoa_helpBtn",helpid:125,openType:"window",text:lang("howSet")},{text:lang("testCorrect"),handler:function(){g.testEmailConfig()}.createDelegate(this)},{text:lang("save"),iconCls:"icon-btn-save",handler:function(){a()}.createDelegate(this)},{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){g.addEditWindow.close()}}]});this.addEditWindow.show();if(c=="edit"){this.formPanel.getForm().load({url:this.baseUrl+"&task=getSettingData",params:{id:e[0].get("id")},method:"POST",waitMsg:lang("waiting"),success:function(h,i){}.createDelegate(this),failure:function(h,i){CNOA.msg.alert(i.result.msg,function(){g.addEditWindow.close()})}.createDelegate(this)})}},testEmailConfig:function(){var a=this;if(a.formPanel.getForm().isValid()){a.formPanel.getForm().submit({url:a.baseUrl+"&task=testEmailConfig",waitTitle:lang("notice"),method:"POST",waitMsg:lang("waiting"),timeout:60000,success:function(b,c){Ext.MessageBox.show({title:lang("setTestResult"),value:c.result.msg,width:560,height:350,buttons:Ext.MessageBox.OK,multiline:260})},failure:function(b,c){CNOA.msg.alert(c.result.msg)}})}}};var CNOA_communication_email_viewClass,CNOA_communication_email_view;CNOA_communication_email_viewClass=CNOA.Class.create();CNOA_communication_email_viewClass.prototype={init:function(){var a=this;this.actionFolder=CNOA.communication.email.view.folder;this.id=CNOA.communication.email.view.id;this.isMonitor=CNOA.communication.email.view.isMonitor;this.uid=CNOA.communication.email.view.uid;this.baseUrl="index.php?app=communication&func=email&action=index&folder="+this.actionFolder+"&isMonitor="+this.isMonitor+"&uid="+this.uid;this.previewPanel=new Ext.Panel({border:false,autoHeight:true,region:"north",listeners:{render:function(){a.preview()}}});this.contentPanel=new Ext.Panel({border:false,html:'<div style="width:100%;height:100%;"><iframe scrolling=auto frameborder=0 width=100% height=100% src="'+this.baseUrl+"&task=getContent&id="+this.id+'"></iframe></div>',region:"center",listeners:{render:function(){}}});this.centerPanel=new Ext.Panel({layout:"border",region:"center",border:false,autoScroll:false,items:[this.previewPanel,this.contentPanel],tbar:new Ext.Toolbar({items:[{text:lang("del"),hidden:this.smstype=="sys"?true:false,iconCls:"icon-utils-s-delete",handler:function(b){CNOA.miniMsg.cfShowAt(b,lang("confirmToDelete"),function(){a.deleteMsg()})}.createDelegate(this)},{text:lang("reply"),iconCls:"icon-btn-sms-reply",hidden:(this.actionFolder=="outbox"||this.isMonitor==1)?true:false,handler:function(){a.replayLoad()}.createDelegate(this)},{text:lang("replyAll"),hidden:(this.actionFolder=="outbox"||this.isMonitor==1)?true:false,iconCls:"icon-btn-sms-reply",handler:function(){a.replayAll()}},{text:lang("transmit"),iconCls:"icon-tab-inbox",handler:function(){a.transmitLoad()}},{text:lang("saveAs"),iconCls:"icon-tab-drafts",handler:function(){a.downloadEmail()}.createDelegate(this)},{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(b){a.closeTab()}.createDelegate(this)},"<span class='cnoa_color_gray'>"+lang("emailCantViewNotice")+"</span>","->",{xtype:"cnoa_helpBtn",helpid:126}]})});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.centerPanel]})},preview:function(){var b=this;var a=new Ext.XTemplate("<div>",'	<div style="background-color:#F5F5F5;padding:3px 10px;border-bottom:1px solid #D9D9D9;">','		<div style="font-size:14px;font-weight:bold;line-height:22px;">{subject}</div>','		<div style="font-size:12px;line-height:18px;color:#919191;">'+lang("sender2")+":{from}</div>",'		<div style="font-size:12px;line-height:18px;color:#919191;">'+lang("time")+":{date}</div>",'		<div style="font-size:12px;line-height:18px;color:#919191;">'+lang("receiver")+":{to}</div>","	</div>",'	<tpl if="attachCount &gt; 0">','	<div style="border:2px solid #E6E6E6;height:160px;overflow-y:auto;">','		<div style="height:32px;background-color:#E6E6E6;line-height:32px;">','			<img src="./resources/images/icons/attach.gif">','			<span style="font-size:14px;font-weight:bold;">'+lang("attach")+"</span>","		</div>","		{attach}","	</div>","	</tpl>","</div>");b.previewPanel.getEl().mask(lang("waiting"));b.previewPanel.body.update("");Ext.Ajax.request({url:b.baseUrl+"&task=view",method:"POST",params:{id:b.id,folder:b.actionFolder,smstype:b.smstype},success:function(d){var c=Ext.decode(d.responseText);a.overwrite(b.previewPanel.body,c.data);b.previewPanel.getEl().unmask()}})},doLayout:function(){this.centerPanel.doLayout()},closeTab:function(){mainPanel.closeTab(CNOA.communication.email.view.parentID.replace("docs-",""))},replayLoad:function(){mainPanel.closeTab("CNOA_MENU_COMMUNICATION_EMAIL_NEW");mainPanel.loadClass("index.php?app=communication&func=email&action=index&task=loadPage&from=newEmail&job=replayLoad&id="+this.id,"CNOA_MENU_COMMUNICATION_EMAIL_NEW",lang("replyMsg"),"icon-new-sms")},replayAll:function(){mainPanel.closeTab("CNOA_MENU_COMMUNICATION_EMAIL_NEW");mainPanel.loadClass("index.php?app=communication&func=email&action=index&task=loadPage&from=newEmail&job=replayAll&id="+this.id,"CNOA_MENU_COMMUNICATION_EMAIL_NEW","回复全部","icon-new-sms")},transmitLoad:function(){mainPanel.closeTab("CNOA_MENU_COMMUNICATION_EMAIL_NEW");mainPanel.loadClass("index.php?app=communication&func=email&action=index&task=loadPage&from=newEmail&job=transmit&id="+this.id+"&emailFolder="+this.actionFolder,"CNOA_MENU_COMMUNICATION_EMAIL_NEW",lang("transmitMessage"),"icon-new-sms")},downloadEmail:function(){ajaxDownload(this.baseUrl+"&task=downloadEmail&id="+this.id)},deleteMsg:function(){var a=this;Ext.Ajax.request({url:a.baseUrl,method:"POST",params:{ids:this.id,task:"delete",folder:this.actionFolder},success:function(c){var b=Ext.decode(c.responseText);if(b.success===true){CNOA.msg.notice2(b.msg);try{CNOA_communication_email_index_inbox.storeInbox.reload()}catch(d){}try{CNOA_communication_email_index_outbox.storeOutbox.reload()}catch(d){}a.closeTab()}else{CNOA.msg.alert(b.msg)}}})}};CNOA_communication_email_linkmanSortClass=CNOA.Class.create();CNOA_communication_email_linkmanSortClass.prototype={init:function(a){var b=this;this.baseUrl="index.php?app=communication&func=email&action=index";this.tp=a;this.title=lang("sortSet");this.action=a=="edit"?"edit":"add";this.edit_id=0;this.ID_btn_delete=Ext.id();this.ID_btn_edit=Ext.id();this.ID_groupComboBox=Ext.id();this.fields=[{name:"id",mapping:"id"},{name:"name",mapping:"name"}];this.store=new Ext.data.Store({autoLoad:true,proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getGroupList"}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields})});this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:true});this.colum=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),this.sm,{header:"id",dataIndex:"id",sortable:true,hidden:true},{header:lang("sortName"),width:440,editor:new Ext.form.TextField({allowBlank:false}),sortable:true,dataIndex:"name"}]);this.grid=new Ext.grid.EditorGridPanel({store:this.store,sm:this.sm,hideBorders:true,border:false,height:258,collapsible:true,animCollapse:true,allowDomMove:true,colModel:this.colum,viewConfig:{forceFit:true},clicksToEdit:1,listeners:{afteredit:function(e){var f=e.record;var c=e.field;var g=f.get("id");var d=f.get("name");Ext.Ajax.request({url:this.baseUrl+"&task=updateGroup",params:"id="+g+"&name="+encodeURIComponent(d),success:function(i){var h=Ext.decode(i.responseText);if(h.success===true){}else{CNOA.msg.alert(h.msg,function(){b.store.reload()})}}})}.createDelegate(this)}});this.mainPanel=new Ext.Window({width:500,height:360,resizable:false,autoDistory:true,modal:true,maskDisabled:true,items:[this.grid],plain:true,title:this.title,buttonAlign:"right",autoScroll:true,tbar:[{text:lang("addSort"),iconCls:"icon-utils-s-add",cls:"btn-blue4",handler:function(){var c=this.grid.getStore().recordType;var d=new c({name:""});this.grid.stopEditing();this.store.insert(0,d);this.grid.startEditing(0,3)}.createDelegate(this)},{text:lang("del"),iconCls:"icon-utils-s-delete",id:this.ID_btn_delete,handler:function(c,d){var e=this.grid.getSelectionModel().getSelections();if(e.length==0){CNOA.miniMsg.alertShowAt(c,lang("mustSelectOneRow"))}else{CNOA.msg.cf(lang("delLinkSortSure"),function(f){if(f=="yes"){if(e){var g="";g+=e[0].get("id");b.deleteList(g)}}})}}.createDelegate(this)}],buttons:[{text:lang("close"),iconCls:"icon-dialog-cancel",cls:"btn-red1",handler:function(){b.close();b.store.reload();CNOA_communication_email_linkman.sortStore.reload();CNOA_communication_email_linkman.store.reload()}}]})},show:function(b){var a=this;a.mainPanel.show()},close:function(){this.mainPanel.close()},deleteList:function(a){var b=this;Ext.Ajax.request({url:this.baseUrl+"&task=deleteGroup",method:"POST",params:{ids:a},success:function(d){var c=Ext.decode(d.responseText);if(c.success===true){b.store.reload()}else{CNOA.msg.alert(c.msg)}}})}};CNOA_communication_email_linkmanClass=CNOA.Class.create();CNOA_communication_email_linkmanClass.prototype={init:function(){var a=this;this.baseUrl="index.php?app=communication&func=email&action=index";this.sortStore=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getSortList",method:"POST"}),reader:new Ext.data.JsonReader({root:"data",fields:[{name:"id",mapping:"id"},{name:"name",mapping:"name"}]})});this.sortStore.load();this.sortCombo=new Ext.form.ComboBox({autoLoad:true,triggerAction:"all",selectOnFocus:true,editable:false,store:this.sortStore,valueField:"id",displayField:"name",allowBlank:false,mode:"local",forceSelection:true});this.dsc=Ext.data.Record.create([{name:"email",type:"string"},{name:"name",type:"string"},{name:"sid",type:"string"}]);this.fields=[{name:"id",mapping:"id"},{name:"sid",mapping:"sid"},{name:"email",mapping:"email"},{name:"name",mapping:"name"}];this.store=new Ext.data.GroupingStore({autoLoad:true,proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getLinkmanList"}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields}),listeners:{update:function(e,b,d){var c=b.data;if(d==Ext.data.Record.EDIT){a.submit(c)}}},sortInfo:{field:"sid",direction:"DESC"}});this.editor=new Ext.ux.grid.RowEditor({cancelText:lang("cancel"),saveText:lang("update"),errorSummary:false});this.sm=new Ext.grid.CheckboxSelectionModel({});this.cm=[new Ext.grid.RowNumberer(),this.sm,{header:"",dataIndex:"id",hidden:true},{header:"",dataIndex:"sid",hidden:true},{id:"email",header:lang("emailAddr"),dataIndex:"email",width:280,sortable:true,editor:{xtype:"textfield",vtype:"email",allowBlank:false}},{header:lang("truename"),dataIndex:"name",width:200,sortable:true,editor:{xtype:"textfield",allowBlank:false}},{id:"sid",header:lang("sort2"),dataIndex:"sid",width:200,sortable:true,editor:this.sortCombo,renderer:function(b){var c;a.sortStore.each(function(d){if(d.get("id")==b){c=d;return}});return c==null?b:c.get("name")}}];this.grid=new Ext.grid.GridPanel({stripeRows:true,store:this.store,width:600,plain:false,loadMask:{msg:lang("waiting")},region:"center",border:false,autoScroll:true,autoExpandColumn:"sid",plugins:[this.editor],columns:this.cm,view:new Ext.grid.GroupingView({markDirty:false}),tbar:[{handler:function(b,c){a.store.reload()}.createDelegate(this),iconCls:"icon-system-refresh",text:lang("refresh")},{iconCls:"icon-utils-s-add",text:lang("add"),handler:function(){var b=new a.dsc({email:"",sid:"",name:""});a.editor.stopEditing();a.store.insert(0,b);a.grid.getView().refresh();a.grid.getSelectionModel().selectRow(0);a.editor.startEditing(0)}},{iconCls:"icon-utils-s-delete",text:lang("del"),handler:function(b){a.editor.stopEditing();var c=a.grid.getSelectionModel().getSelections();if(c.length==0){CNOA.miniMsg.alertShowAt(b,lang("mustSelectOneRow"))}else{CNOA.msg.cf(lang("confirmToDelete"),function(e){if(e=="yes"){if(c){var f="";for(var d=0;d<c.length;d++){f+=c[d].get("id")+",";var g=c[d];a.store.remove(g)}a.deleteList(f)}}})}}},{handler:function(b,c){a.showImportWindow()}.createDelegate(this),iconCls:"document-excel-import",cls:"btn-red1",text:lang("importLinkman")},"<span style='color:#676767'>"+lang("typeSet")+":</span>",{text:lang("typeSet"),iconCls:"icon-type-set",cls:"btn-yellow1",handler:function(b,c){CNOA_communication_email_linkmanSort=new CNOA_communication_email_linkmanSortClass();CNOA_communication_email_linkmanSort.show()}.createDelegate(this)},"<span class='cnoa_color_gray'>"+lang("dblclickToEdit")+"</span>","->",{xtype:"cnoa_helpBtn",helpid:99}]});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.grid]})},submit:function(a){var b=this;Ext.Ajax.request({url:this.baseUrl+"&task=submitLinkman",params:a,method:"POST",success:function(e,d){var c=Ext.decode(e.responseText);if(c.success===true){}else{CNOA.msg.alert(c.msg,function(){b.store.reload()})}},failure:function(c,d){CNOA.msg.alert(result.msg,function(){b.store.reload()})}})},deleteList:function(a){var b=this;Ext.Ajax.request({url:this.baseUrl+"&task=deleteLinkman",method:"POST",params:{ids:a},success:function(d){var c=Ext.decode(d.responseText);if(c.success===true){b.store.reload()}else{CNOA.msg.alert(c.msg)}}})},showImportWindow:function(){var a=this;this.UPLOAD_WINDOW_FORMPANEL=new Ext.FormPanel({fileUpload:true,autoHeight:true,autoScroll:false,waitMsgTarget:true,hideBorders:true,border:false,bodyStyle:"padding: 5px;",buttonAlign:"right",items:[{xtype:"fileuploadfield",name:"face",allowBlank:false,buttonCfg:{text:lang("browserLinkmanExcel")},hideLabel:true,width:370,listeners:{fileselected:function(c,b){}}},{xtype:"displayfield",hideLabel:true,value:lang("must0307Excel")}],buttons:[{text:lang("import2"),iconCls:"document-excel-import",handler:function(){if(this.UPLOAD_WINDOW_FORMPANEL.getForm().isValid()){this.UPLOAD_WINDOW_FORMPANEL.getForm().submit({url:a.baseUrl+"&task=import_linkman_upload",waitMsg:lang("waiting"),params:{},success:function(b,c){a.showImportToDbWindow(c.result.msg);a.UPLOAD_WINDOW.close()},failure:function(b,c){CNOA.msg.alert(c.result.msg,function(){})}})}}.createDelegate(this)},{text:lang("close"),handler:function(){a.UPLOAD_WINDOW.close()}}]});this.UPLOAD_WINDOW=new Ext.Window({width:398,height:163,autoScroll:false,modal:true,resizable:false,title:lang("importLinkManList"),items:[this.UPLOAD_WINDOW_FORMPANEL]}).show()},showImportToDbWindow:function(e){var f=this;var d=Ext.getBody().getBox();var b=d.width-100;var c=d.height-100;var a=Ext.id();f.ImportToDbWindow=new Ext.Window({title:lang("setLinkImportAttr"),width:b,height:c,layout:"fit",modal:true,maximizable:true,resizable:true,html:'<iframe scrolling="auto" frameborder="0" id="'+a+'" width="100%" height="100%" src="'+f.baseUrl+"&task=import_linkman_todb&from="+e+'"></iframe>',buttons:[{text:lang("save"),iconCls:"icon-order-s-accept",handler:function(){Ext.getDom(a).contentWindow.submit()}},{text:lang("cancel"),iconCls:"icon-dialog-cancel",handler:function(){f.ImportToDbWindow.close()}}],listeners:{close:function(){try{Ext.getDom(a).src=""}catch(g){}}}}).show()},closeImportToDbWindow:function(){this.ImportToDbWindow.close()}};var sm_communication_email=1;