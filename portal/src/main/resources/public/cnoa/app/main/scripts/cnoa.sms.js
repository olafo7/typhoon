var CNOA_main_sms_inboxListClass,CNOA_main_sms_inboxList;CNOA_main_sms_inboxListClass=CNOA.Class.create();CNOA_main_sms_inboxListClass.prototype={init:function(){var a=this;this.baseUrl="index.php?app=main&func=sms&action=smsmgr";this.search={mobile:"",fromuid:0,stime:0,etime:0};this.ID_Search_mobile=Ext.id();this.ID_Search_fromuid=Ext.id();this.ID_Search_stime=Ext.id();this.ID_Search_etime=Ext.id();this.searchBar=new Ext.Toolbar({items:[(lang("phoneAddBook")+":"),{xtype:"textfield",id:this.ID_Search_mobile,width:100},"&nbsp;"+lang("sender")+":",{xtype:"hidden",id:this.ID_Search_fromuid},{xtype:"triggerForPeople",dataUrl:this.baseUrl+"&task=getAllUserListsInPermitDeptTree",width:100,id:this.ID_Search_fromuid+"Tr",listeners:{selected:function(d,c,b){Ext.getCmp(a.ID_Search_fromuid).setValue(c)}}},"&nbsp;"+lang("receiveTime")+":",{xtype:"datefield",format:"Y-m-d",id:this.ID_Search_stime,width:100},lang("to"),{xtype:"datefield",id:this.ID_Search_etime,format:"Y-m-d",width:100},{xtype:"button",text:lang("search"),style:"margin-left:5px",handler:function(){a.doSearch()}},{xtype:"button",text:lang("clear"),style:"margin-left:5px",handler:function(){a.resetSearch()}}]});this.fields=[{name:"id"},{name:"fid"},{name:"mobile"},{name:"fromname"},{name:"posttime"},{name:"text"}];this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getJsonDataInbox"}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields}),listeners:{exception:function(g,f,i,e,d,c){var b=Ext.decode(d.responseText);if(b.failure){CNOA.msg.alert(b.msg)}}}});this.store.load({params:{start:0}});this.sm=new Ext.grid.CheckboxSelectionModel();this.colModel=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),this.sm,{header:"id",dataIndex:"id",width:20,sortable:true,hidden:true},{header:lang("sourceNum")+" / "+lang("truename"),dataIndex:"id",width:120,renderer:this.makeName.createDelegate(this),sortable:true},{header:lang("SMStype"),dataIndex:"id",width:80,renderer:this.makeType.createDelegate(this),sortable:true},{header:lang("belongSMS"),dataIndex:"id",width:80,renderer:this.makeFather.createDelegate(this),sortable:true},{header:lang("receiveTime"),dataIndex:"posttime",width:80,sortable:true},{header:lang("smsContent"),dataIndex:"text",width:300,menuDisabled:true,resizable:false},{header:lang("opt"),dataIndex:"id",width:40,renderer:this.makeOperate.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.grid=new Ext.grid.GridPanel({stripeRows:true,store:this.store,loadMask:{msg:lang("waiting")},cm:this.colModel,sm:this.sm,autoWidth:true,hideBorders:true,border:false,viewConfig:{forceFit:true}});this.pagingBar=new Ext.PagingToolbar({displayInfo:true,store:this.store,pageSize:15,listeners:{beforechange:function(b,c){if(a.search.mobile!=""){c.mobile=a.search.mobile}if(a.search.fromuid!=0&&a.search.fromuid!=""){c.fromuid=a.search.fromuid}if(a.search.stime!=""){c.stime=a.search.stime}if(a.search.etime!=""){c.etime=a.search.etime}}}});this.centerPanel=new Ext.Panel({region:"center",layout:"fit",border:false,autoScroll:true,items:[this.grid],tbar:new Ext.Toolbar({items:[{id:this.ID_btn_refreshList,handler:function(b,c){a.store.reload()}.createDelegate(this),iconCls:"icon-system-refresh",text:lang("refresh")},{id:this.ID_btn_delete,text:lang("del"),iconCls:"icon-utils-s-delete",handler:function(b,c){var d=this.grid.getSelectionModel().getSelections();if(d.length==0){CNOA.miniMsg.alertShowAt(b,lang("mustSelectOneRow"))}else{CNOA.miniMsg.cfShowAt(b,lang("confirmToDelete"),function(){if(d){var f="";for(var e=0;e<d.length;e++){f+=d[e].get("id")+","}a.deleteList(f)}})}}.createDelegate(this)},"->",{xtype:"cnoa_helpBtn",helpid:29}]}),bbar:this.pagingBar});this.mainPanel=new Ext.Panel({collapsible:false,border:false,layout:"border",autoScroll:true,items:[this.centerPanel],tbar:this.searchBar})},makeName:function(f,d,a,g,b,e){var c=a.data;h=c.mobile;if(c.fromname!=""){h+="<br />"+c.fromname+""}return h},makeType:function(f,d,a,g,b,e){var c=a.data;if(c.fid==0){h=lang("sendDirectly")}else{h=lang("reply")}return h},makeFather:function(f,d,a,g,b,e){var c=a.data;if(c.fid==0){h="--"}else{h="<a href='javascript:void(0);' onclick='CNOA_main_sms_inboxList.view("+c.fid+', "out");\'>'+lang("view")+"</a>"}return h},makeOperate:function(f,d,a,g,b,e){var c=a.data;h="<a href='javascript:void(0);' onclick='CNOA_main_sms_inboxList.view("+c.id+', "in");\'>'+lang("view")+"</a>";return h},doSearch:function(){this.search.mobile=Ext.getCmp(this.ID_Search_mobile).getValue();this.search.fromuid=Ext.getCmp(this.ID_Search_fromuid).getValue();this.search.stime=Ext.getCmp(this.ID_Search_stime).getRawValue();this.search.etime=Ext.getCmp(this.ID_Search_etime).getRawValue();this.store.load({params:{mobile:this.search.mobile,fromuid:this.search.fromuid,stime:this.search.stime,etime:this.search.etime}})},resetSearch:function(){Ext.getCmp(this.ID_Search_mobile).setValue("");Ext.getCmp(this.ID_Search_fromuid).setValue("");Ext.getCmp(this.ID_Search_stime).setValue("");Ext.getCmp(this.ID_Search_etime).setValue("");Ext.getCmp(this.ID_Search_fromuid+"Tr").setValue("");this.search={mobile:"",fromuid:0,stime:0,etime:0};this.store.load()},deleteList:function(a){var b=this;Ext.Ajax.request({url:this.baseUrl+"&task=deleteInbox",method:"POST",params:{ids:a},success:function(d){var c=Ext.decode(d.responseText);if(c.success===true){CNOA.msg.alert(c.msg,function(){b.store.reload()})}else{CNOA.msg.alert(c.msg)}}})},view:function(b,a){mainPanel.closeTab("CNOA_MENU_MAIN_SMS_VIEW");mainPanel.loadClass(this.baseUrl+"&task=loadPage&from=smsview&id="+b+"&inout="+a,"CNOA_MENU_MAIN_SMS_VIEW","查看短信","icon-page-view")}};var CNOA_main_sms_outboxListClass,CNOA_main_sms_outboxList;CNOA_main_sms_outboxListClass=CNOA.Class.create();CNOA_main_sms_outboxListClass.prototype={init:function(){var a=this;this.baseUrl="index.php?app=main&func=sms&action=smsmgr";this.search={mobile:"",fromuid:0,touid:0,stime:0,etime:0};this.ID_Search_mobile=Ext.id();this.ID_Search_fromuid=Ext.id();this.ID_Search_touid=Ext.id();this.ID_Search_stime=Ext.id();this.ID_Search_etime=Ext.id();this.searchBar=new Ext.Toolbar({items:["&nbsp;"+lang("sender")+":",{xtype:"hidden",id:this.ID_Search_fromuid},{xtype:"triggerForPeople",dataUrl:this.baseUrl+"&task=getAllUserListsInPermitDeptTree",width:100,id:this.ID_Search_fromuid+"Tr",listeners:{selected:function(d,c,b){Ext.getCmp(a.ID_Search_fromuid).setValue(c)}}},"&nbsp;"+lang("receiveMan")+":",{xtype:"hidden",id:this.ID_Search_touid},{xtype:"triggerForPeople",dataUrl:this.baseUrl+"&task=getAllUserListsInPermitDeptTree",width:100,id:this.ID_Search_touid+"Tr",listeners:{selected:function(d,c,b){Ext.getCmp(a.ID_Search_touid).setValue(c)}}},lang("receivingPhone")+":",{xtype:"textfield",id:this.ID_Search_mobile,width:100},"&nbsp;"+lang("posttime")+":",{xtype:"datefield",format:"Y-m-d",id:this.ID_Search_stime,width:100},lang("to"),{xtype:"datefield",id:this.ID_Search_etime,format:"Y-m-d",width:100},{xtype:"button",text:lang("search"),style:"margin-left:5px",handler:function(){a.doSearch()}},{xtype:"button",text:lang("clear"),style:"margin-left:5px",handler:function(){a.resetSearch()}}]});this.fields=[{name:"cid"},{name:"id"},{name:"mobile"},{name:"fromname"},{name:"toname"},{name:"sendtime"},{name:"text"},{name:"from"},{name:"replies"}];this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getJsonDataOutbox"}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields}),listeners:{exception:function(g,f,i,e,d,c){var b=Ext.decode(d.responseText);if(b.failure){CNOA.msg.alert(b.msg)}}}});this.store.load({params:{start:0}});this.sm=new Ext.grid.CheckboxSelectionModel();this.colModel=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),this.sm,{header:"id",dataIndex:"id",width:20,sortable:true,hidden:true},{header:lang("sender"),dataIndex:"fromname",width:80,sortable:true},{header:lang("receivingPhone")+" / "+lang("truename"),dataIndex:"id",width:120,sortable:true,renderer:this.makeName.createDelegate(this)},{header:lang("posttime"),dataIndex:"sendtime",width:80,sortable:true},{header:lang("sourceType"),dataIndex:"from",width:80,sortable:true},{header:lang("smsContent"),dataIndex:"text",width:200,menuDisabled:true},{header:lang("replyContent"),dataIndex:"replies",width:130,menuDisabled:true},{header:lang("opt"),dataIndex:"",width:40,renderer:this.makeOperate.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.grid=new Ext.grid.GridPanel({stripeRows:true,store:this.store,loadMask:{msg:lang("waiting")},cm:this.colModel,sm:this.sm,hideBorders:true,autoWidth:true,hideBorders:true,border:false,viewConfig:{forceFit:true}});this.pagingBar=new Ext.PagingToolbar({displayInfo:true,store:this.store,pageSize:15,listeners:{beforechange:function(b,c){if(a.search.mobile!=""){c.mobile=a.search.mobile}if(a.search.fromuid!=0&&a.search.fromuid!=""){c.fromuid=a.search.fromuid}if(a.search.touid!=0&&a.search.touid!=""){c.touid=a.search.touid}if(a.search.stime!=""){c.stime=a.search.stime}if(a.search.etime!=""){c.etime=a.search.etime}}}});this.centerPanel=new Ext.Panel({region:"center",layout:"fit",border:false,autoScroll:true,items:[this.grid],tbar:new Ext.Toolbar({items:[{id:this.ID_btn_refreshList,handler:function(b,c){a.store.reload()}.createDelegate(this),iconCls:"icon-system-refresh",text:lang("refresh")},{id:this.ID_btn_delete,text:lang("del"),iconCls:"icon-utils-s-delete",handler:function(b,c){var d=this.grid.getSelectionModel().getSelections();if(d.length==0){CNOA.miniMsg.alertShowAt(b,lang("mustSelectOneRow"))}else{CNOA.miniMsg.cfShowAt(b,lang("delSMSReplies"),function(){if(d){var f="";for(var e=0;e<d.length;e++){f+=d[e].get("id")+","}a.deleteList(f)}})}}.createDelegate(this)},"->",{xtype:"cnoa_helpBtn",helpid:30}]}),bbar:this.pagingBar});this.mainPanel=new Ext.Panel({collapsible:false,border:false,layout:"border",autoScroll:true,items:[this.centerPanel],tbar:this.searchBar})},makeName:function(f,d,a,g,b,e){var c=a.data;h=c.mobile;if(c.toname!=""){h+="<br />"+c.toname+""}return h},makeOperate:function(f,d,a,g,b,e){var c=a.data;h="<a href='javascript:void(0);' class='gridview' onclick='CNOA_main_sms_outboxList.view("+c.id+', "out");\'>'+lang("view")+"</a>";return h},doSearch:function(){this.search.mobile=Ext.getCmp(this.ID_Search_mobile).getValue();this.search.fromuid=Ext.getCmp(this.ID_Search_fromuid).getValue();this.search.touid=Ext.getCmp(this.ID_Search_touid).getValue();this.search.stime=Ext.getCmp(this.ID_Search_stime).getRawValue();this.search.etime=Ext.getCmp(this.ID_Search_etime).getRawValue();this.store.load({params:{mobile:this.search.mobile,fromuid:this.search.fromuid,touid:this.search.touid,stime:this.search.stime,etime:this.search.etime}})},resetSearch:function(){Ext.getCmp(this.ID_Search_mobile).setValue("");Ext.getCmp(this.ID_Search_fromuid).setValue("");Ext.getCmp(this.ID_Search_touid).setValue("");Ext.getCmp(this.ID_Search_stime).setValue("");Ext.getCmp(this.ID_Search_etime).setValue("");Ext.getCmp(this.ID_Search_fromuid+"Tr").setValue("");Ext.getCmp(this.ID_Search_touid+"Tr").setValue("");this.search={mobile:"",fromuid:0,touid:0,stime:0,etime:0};this.store.load()},deleteList:function(a){var b=this;Ext.Ajax.request({url:this.baseUrl+"&task=deleteOutbox",method:"POST",params:{ids:a},success:function(d){var c=Ext.decode(d.responseText);if(c.success===true){CNOA.msg.alert(c.msg,function(){b.store.reload()})}else{CNOA.msg.alert(c.msg)}}})},view:function(b,a){mainPanel.closeTab("CNOA_MENU_MAIN_SMS_VIEW");mainPanel.loadClass(this.baseUrl+"&task=loadPage&from=smsview&id="+b+"&inout="+a,"CNOA_MENU_MAIN_SMS_VIEW","查看短信","icon-page-view")}};var CNOA_main_sms_sendClass,CNOA_main_sms_send;CNOA_main_sms_sendClass=CNOA.Class.create();CNOA_main_sms_sendClass.prototype={init:function(){var c=this;this.baseUrl="index.php?app=main&func=sms&action=send";ID_sms_length_status=Ext.id();this.centerPanel=new Ext.form.FormPanel({plain:false,region:"center",border:false,autoScroll:true,bodyStyle:"padding: 10px;background-color:#F8F8F8;",labelWidth:70,labelAlign:"right",waitMsgTarget:true,items:[{xtype:"hidden",name:"from",value:"hand"},{xtype:"textarea",height:35,anchor:"-20",readOnly:true,fieldLabel:lang("interRecipient"),blankText:lang("pleaseSelectRecipient"),name:"receiverNames"},{xtype:"hidden",name:"receiverUids"},{xtype:"btnForPoepleSelector",autoWidth:true,anchor:"-20",dataUrl:this.baseUrl+"&task=getAllUserListsInPermitDeptTree",style:"margin-left:75px;margin-bottom:4px;",text:lang("selectReceiveMan"),listeners:{selected:function(f,g){var j=new Array();var e=new Array();if(g.length>0){for(var d=0;d<g.length;d++){j.push(g[d].uname);e.push(g[d].uid)}}c.centerPanel.getForm().findField("receiverNames").setValue(j.join(","));c.centerPanel.getForm().findField("receiverUids").setValue(e.join(","))},onrender:function(d){d.setSelectedUids(c.centerPanel.getForm().findField("receiverUids").getValue().split(","))}}},{xtype:"textarea",height:35,anchor:"-20",fieldLabel:lang("receivingPhone"),vtype:"mobiles",vtypeText:lang("wrongMobile"),name:"customRecvUser"},{xtype:"hidden",name:"customRecvMobile"},{xtype:"displayfield",value:lang("ifMorePhoneNum"),style:"color:#666"},{xtype:"datetimefield",width:177,minValue:new Date(),fieldLabel:lang("posttime"),name:"time"},{xtype:"displayfield",value:lang("emptyTimeIsSend")},{xtype:"textarea",anchor:"-20",height:160,allowBlank:false,enableKeyEvents:true,fieldLabel:lang("smsContent"),name:"text",listeners:{keyup:function(d,f){c.makeCount(d)},change:function(d,f){c.makeCount(d)}}},{xtype:"displayfield",id:ID_sms_length_status,value:lang("current0Word")}],tbar:new Ext.Toolbar({style:"border-bottom-width:0;",items:[{handler:function(d,e){this.submit();this.treeRoot.reload()}.createDelegate(this),iconCls:"icon-send-sms",cls:"btn-green1",text:lang("send")},{handler:function(d,e){this.centerPanel.getForm().reset()}.createDelegate(this),iconCls:"icon-system-reset",cls:"btn-red1",text:lang("reset")},{text:lang("close"),iconCls:"icon-bulk-delete",cls:"btn-gray1",handler:function(){c.closeTab()}.createDelegate(this)},"->",{xtype:"cnoa_helpBtn",helpid:97}]})});this.fields=[{name:"id"},{name:"content"},{name:"name"}];this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getTemplateList",disableCaching:true}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields}),listeners:{exception:function(j,i,k,g,f,e){var d=Ext.decode(f.responseText);if(d.failure){CNOA.msg.alert(d.msg)}},load:function(e,d,f){}}});c.store.load();this.sm=new Ext.grid.CheckboxSelectionModel({singleSelect:false});this.pagingBar=new Ext.PagingToolbar({style:"border:0px",displayInfo:true,store:this.store,pageSize:15});function a(k,e,d,l,i,f){var j="";var g=d.data.name;j='<div ext:qtip="'+lang("doubleClickTemp")+'"><b>'+g+"</b>";j+='<div style="color:#666">'+k+"</div></div>";return j}this.colModel=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),this.sm,{header:"id",dataIndex:"id",hidden:true},{header:lang("templateContent"),dataIndex:"content",width:180,sortable:true,menuDisabled:true,renderer:a.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);function b(){var d=c.grid.getSelectionModel().getSelections();if(d.length==0){CNOA.msg.alert(lang("firstOperateData"))}else{var e=d[0].get("id");c.editTempate(2,e)}}this.grid=new Ext.grid.GridPanel({stripeRows:true,region:"center",store:this.store,loadMask:{msg:lang("waiting")},cm:this.colModel,sm:this.sm,bodyStyle:"border-right:0px;  ",bbar:c.pagingBar,listeners:{rowdblclick:function(i,k,j){var d=c.store.reader.jsonData.data;var g=d[k];var f=g.content;f=f.replace(/<br \/>/g,"");c.centerPanel.getForm().findField("text").setValue(f)}},tbar:new Ext.Toolbar({border:true,items:[{text:lang("refresh"),iconCls:"icon-system-refresh",handler:function(d,e){c.store.reload()}},{text:lang("new"),iconCls:"icon-utils-s-add",cls:"btn-blue4",handler:function(d){c.editTempate(1)}},{text:lang("modify"),iconCls:"icon-utils-s-edit",handler:function(d){b()}},{text:lang("del"),iconCls:"icon-utils-s-delete",handler:function(d){c.doDeleteList()}}]})});this.treeRoot=new Ext.tree.AsyncTreeNode({text:"",expanded:true});this.treeLoader=new Ext.tree.TreeLoader({dataUrl:"index.php?app=communication&func=sms&action=smsmgr&task=getLinkmanTree",preloadChildren:true,clearOnLoad:false,baseAttrs:{uiProvider:Ext.ux.TreeCheckNodeUI},listeners:{load:function(d){this.linkManTree.expandAll();this.linkManTree.getEl().unmask()}.createDelegate(this)}});this.linkManTree=new Ext.tree.TreePanel({hideBorders:true,border:false,rootVisible:false,lines:true,animCollapse:false,animate:false,loader:this.treeLoader,root:this.treeRoot,autoScroll:true,listeners:{check:function(d){c.makeLinkmanList()}}});this.linkManPanel=new Ext.Panel({region:"west",width:320,bodyStyle:"border-right-width:0px; border-bottom-width:0px;",items:[this.linkManTree],tbar:new Ext.Toolbar({items:[{iconCls:"icon-system-refresh",tooltip:lang("refresh"),text:lang("refresh"),handler:function(d,e){c.treeRoot.reload();d.nextSibling().setText(lang("collapse"));d.nextSibling().setTooltip(lang("collapseMenuTip"));d.nextSibling().setIconClass("icon-collapse-all");d.nextSibling().pressed=false}.createDelegate(this)},{text:lang("collapse"),tooltip:lang("collapseMenuTip"),enableToggle:true,id:this.ID_btn_collapseExpand,toggleHandler:function(d,e){if(e){d.setText(lang("expand"));d.setTooltip(lang("expandMenuTip"));c.treeRoot.collapse(true)}else{d.setText(lang("collapse"));d.setTooltip(lang("collapseMenuTip"));c.treeRoot.expand(true)}}},"->",{xtype:"checkbox",boxLabel:lang("selectAll"),listeners:{check:function(e,d){c.treeRoot.eachChild(function(f){f.checked=d;f.getUI().checkbox.checked=d;f.eachChild(function(g){g.checked=d;g.getUI().checkbox.checked=d;g.eachChild(function(i){i.checked=d;i.getUI().checkbox.checked=d})})});c.makeLinkmanList()}.createDelegate(this)}},{text:lang("mgrPhoneBook"),cls:"btn-blue2",handler:function(){c.gotoLinkman()}}]})});this.eastPanel=new Ext.form.FormPanel({plain:false,region:"east",border:false,layout:"border",width:560,autoScroll:true,labelWidth:70,labelAlign:"right",waitMsgTarget:true,items:[this.grid,this.linkManPanel]});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"border",autoScroll:false,items:[this.centerPanel,this.eastPanel]})},editTempate:function(g,b){var f=this;var i=lang("addSMStemp");if(g==2){i=lang("editSMStemp")}var j=[{xtype:"textfield",width:200,name:"name",allowBlank:false,fieldLabel:lang("tempName")},{xtype:"label",fieldLabel:lang("Instructions"),text:"1. "+lang("receiveMan")+": @@recvMan@@",style:"color:#555",width:300},{xtype:"textarea",allowBlank:false,fieldLabel:lang("templateContent"),name:"content",width:360,height:210}];var a=new Ext.form.FormPanel({hideBorders:true,border:false,waitMsgTarget:true,layout:"border",labelWidth:80,items:[{xtype:"panel",border:false,bodyStyle:"padding:15px",layout:"form",region:"center",autoScroll:true,items:[j]}]});function d(){var l=f.baseUrl+"&task=editTempate&edit=0";if(g==2){l=f.baseUrl+"&task=editTempate&edit=1"}var k=a.getForm();if(k.isValid()){k.submit({url:l,waitTitle:lang("notice"),method:"POST",waitMsg:lang("waiting"),params:{tid:b},success:function(m,n){CNOA.msg.alert(n.result.msg,function(){e.close();f.store.reload()})},failure:function(m,n){CNOA.msg.alert(n.result.msg)}})}else{CNOA.miniMsg.alertShowAt(ID_btn_save,lang("formValid"))}}function c(){a.getForm().load({url:f.baseUrl+"&task=loadTemplate",params:{tid:b},method:"POST",success:function(k,l){},failure:function(k,l){CNOA.msg.alert(l.result.msg,function(){})}})}if(g==2){c()}var e=new Ext.Window({title:i,width:500,height:400,modal:true,layout:"fit",resizable:false,border:false,items:[a],buttons:[{text:lang("save"),iconCls:"icon-btn-save",cls:"btn-blue4",handler:function(){d()}},{cls:"btn-red1",text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){e.close()}}]}).show();return e},doDelete:function(a){var b=this;Ext.Ajax.request({url:b.baseUrl+"&task=deleteTemplate",params:{ids:a},method:"POST",success:function(d){var c=d.responseText;jsData=Ext.decode(c);arrData=jsData.data;CNOA.msg.alert(jsData.msg,function(){b.store.reload()})}})},doDeleteList:function(a){var c=this;var b=c.grid.getSelectionModel().getSelections();if(b.length==0){CNOA.msg.alert(lang("firstSelectData"))}else{CNOA.msg.cf(lang("deleteToInformation"),function(f){if(f=="yes"){if(b){var g="";var j="";var d=0;for(var e=0;e<b.length;e++){j=b[e];id=parseInt(j.get("id"));g+=id+((e!=b.length-1)?",":"")}c.doDelete(g)}}})}},makeCount:function(b){var a=b.getValue().length;var c=b.getValue().Tlength();var e=Math.ceil(c/140);Ext.getCmp(ID_sms_length_status).setValue(lang("nowInput")+"<span class='cnoa_color_red'>"+a+"</span>"+lang("wordTotal")+"<span class='cnoa_color_red'>"+e+"</span>"+lang("SMSinstructions")+": @@recvMan@@")},submit:function(){var c=this;var b=c.centerPanel.getForm().findField("receiverNames").getValue();var a=c.centerPanel.getForm().findField("customRecvUser").getValue();if(b==""&&a==""){CNOA.msg.alert(lang("fillInRecipient"));return}if(this.centerPanel.getForm().isValid()){this.centerPanel.getForm().submit({url:this.baseUrl+"&task=submit",waitTitle:lang("notice"),method:"POST",waitMsg:lang("waiting"),params:{},success:function(d,e){CNOA.msg.alert(e.result.msg,function(){c.centerPanel.getForm().reset();try{CNOA_main_sms_outboxList.store.reload()}catch(f){}try{CNOA_main_sms_sendboxList.store.reload()}catch(f){}})}.createDelegate(this),failure:function(d,e){CNOA.msg.alert(e.result.msg)}.createDelegate(this)})}},closeTab:function(){mainPanel.closeTab(CNOA.main.sms.send.parentID.replace("docs-",""))},gotoLinkman:function(){mainPanel.closeTab("CNOA_MENU_COMMUNICATION_TEXTSMS_LINKMAN");mainPanel.loadClass("index.php?app=communication&func=sms&action=smsmgr&task=loadPage&from=linkman","CNOA_MENU_COMMUNICATION_TEXTSMS_LINKMAN",lang("phoneAddBook"),"icon-kontact-contacts")},makeLinkmanList:function(){var d=this;var c="";var a="";var b=[];d.treeRoot.eachChild(function(e){e.eachChild(function(f){f.eachChild(function(g){if(g.getUI().checkbox.checked){var i=g.text.replace(/^\(([0-9]{1,15})\).*/g,"$1");var j=g.text.replace(/^\([0-9]{1,15}\)(.*)/g,"$1");b.push({m:i,n:j});a+=i+";"}})})});d.centerPanel.getForm().findField("customRecvUser").setValue(a);d.centerPanel.getForm().findField("customRecvMobile").setValue(Ext.encode(b))}};var CNOA_main_sms_sendboxListClass,CNOA_main_sms_sendboxList;CNOA_main_sms_sendboxListClass=CNOA.Class.create();CNOA_main_sms_sendboxListClass.prototype={init:function(){var a=this;this.baseUrl="index.php?app=main&func=sms&action=smsmgr";this.search={mobile:"",fromuid:0,touid:0,stime:0,etime:0};this.ID_Search_mobile=Ext.id();this.ID_Search_fromuid=Ext.id();this.ID_Search_touid=Ext.id();this.ID_Search_stime=Ext.id();this.ID_Search_etime=Ext.id();this.searchBar=new Ext.Toolbar({items:["&nbsp;"+lang("sender")+":",{xtype:"hidden",id:this.ID_Search_fromuid},{xtype:"triggerForPeople",dataUrl:this.baseUrl+"&task=getAllUserListsInPermitDeptTree",width:100,id:this.ID_Search_fromuid+"Tr",listeners:{selected:function(d,c,b){Ext.getCmp(a.ID_Search_fromuid).setValue(c)}}},"&nbsp;"+lang("receiveMan")+":",{xtype:"hidden",id:this.ID_Search_touid},{xtype:"triggerForPeople",dataUrl:this.baseUrl+"&task=getAllUserListsInPermitDeptTree",width:100,id:this.ID_Search_touid+"Tr",listeners:{selected:function(d,c,b){Ext.getCmp(a.ID_Search_touid).setValue(c)}}},lang("receivingPhone")+":",{xtype:"textfield",id:this.ID_Search_mobile,width:100},"&nbsp;"+lang("posttime")+":",{xtype:"datefield",format:"Y-m-d",id:this.ID_Search_stime,width:100},lang("to"),{xtype:"datefield",id:this.ID_Search_etime,format:"Y-m-d",width:100},{xtype:"button",text:lang("search"),style:"margin-left:5px",handler:function(){a.doSearch()}},{xtype:"button",text:lang("clear"),style:"margin-left:5px",handler:function(){a.resetSearch()}}]});this.fields=[{name:"cid"},{name:"id"},{name:"mobile"},{name:"fromname"},{name:"toname"},{name:"sendtime"},{name:"text"},{name:"from"},{name:"status"}];this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:this.baseUrl+"&task=getJsonDataSendbox"}),reader:new Ext.data.JsonReader({totalProperty:"total",root:"data",fields:this.fields}),listeners:{exception:function(g,f,i,e,d,c){var b=Ext.decode(d.responseText);if(b.failure){CNOA.msg.alert(b.msg)}}}});this.store.load({params:{start:0}});this.sm=new Ext.grid.CheckboxSelectionModel();this.colModel=new Ext.grid.ColumnModel([new Ext.grid.RowNumberer(),this.sm,{header:"id",dataIndex:"id",width:20,sortable:true,hidden:true},{header:lang("sender"),dataIndex:"fromname",width:80,sortable:true},{header:lang("receivingPhone")+" / "+lang("truename"),dataIndex:"id",width:120,sortable:true,renderer:this.makeName.createDelegate(this)},{header:lang("posttime"),dataIndex:"sendtime",width:80,sortable:true},{header:lang("sourceType"),dataIndex:"from",width:80,sortable:true},{header:lang("SMSstatus"),dataIndex:"status",width:80,menuDisabled:true},{header:lang("smsContent"),dataIndex:"text",width:200,menuDisabled:true},{header:lang("opt"),dataIndex:"",width:40,renderer:this.makeOperate.createDelegate(this)},{header:"",dataIndex:"noIndex",width:1,menuDisabled:true,resizable:false}]);this.grid=new Ext.grid.GridPanel({stripeRows:true,store:this.store,loadMask:{msg:lang("waiting")},cm:this.colModel,sm:this.sm,hideBorders:true,autoWidth:true,hideBorders:true,border:false,viewConfig:{forceFit:true}});this.pagingBar=new Ext.PagingToolbar({displayInfo:true,store:this.store,pageSize:15,listeners:{beforechange:function(b,c){if(a.search.mobile!=""){c.mobile=a.search.mobile}if(a.search.fromuid!=0&&a.search.fromuid!=""){c.fromuid=a.search.fromuid}if(a.search.touid!=0&&a.search.touid!=""){c.touid=a.search.touid}if(a.search.stime!=""){c.stime=a.search.stime}if(a.search.etime!=""){c.etime=a.search.etime}}}});this.centerPanel=new Ext.Panel({region:"center",layout:"fit",border:false,autoScroll:true,items:[this.grid],tbar:new Ext.Toolbar({items:[{id:this.ID_btn_refreshList,handler:function(b,c){a.store.reload()}.createDelegate(this),iconCls:"icon-system-refresh",text:lang("refresh")},{id:this.ID_btn_delete,text:lang("del"),iconCls:"icon-utils-s-delete",handler:function(b,c){var d=this.grid.getSelectionModel().getSelections();if(d.length==0){CNOA.miniMsg.alertShowAt(b,lang("mustSelectOneRow"))}else{CNOA.miniMsg.cfShowAt(b,lang("confirmToDelete"),function(){if(d){var f="";for(var e=0;e<d.length;e++){f+=d[e].get("id")+","}a.deleteList(f)}})}}.createDelegate(this)},"->",{xtype:"cnoa_helpBtn",helpid:31}]}),bbar:this.pagingBar});this.mainPanel=new Ext.Panel({collapsible:false,border:false,layout:"border",autoScroll:true,items:[this.centerPanel],tbar:this.searchBar})},makeName:function(f,d,a,g,b,e){var c=a.data;h=c.mobile;if(c.toname!=""){h+="<br />"+c.toname+""}return h},makeOperate:function(f,d,a,g,b,e){var c=a.data;h="<a href='javascript:void(0);' class='gridview' onclick='CNOA_main_sms_sendboxList.view("+c.id+', "send");\'>'+lang("view")+"</a>";return h},doSearch:function(){this.search.mobile=Ext.getCmp(this.ID_Search_mobile).getValue();this.search.fromuid=Ext.getCmp(this.ID_Search_fromuid).getValue();this.search.touid=Ext.getCmp(this.ID_Search_touid).getValue();this.search.stime=Ext.getCmp(this.ID_Search_stime).getRawValue();this.search.etime=Ext.getCmp(this.ID_Search_etime).getRawValue();this.store.load({params:{mobile:this.search.mobile,fromuid:this.search.fromuid,touid:this.search.touid,stime:this.search.stime,etime:this.search.etime}})},resetSearch:function(){Ext.getCmp(this.ID_Search_mobile).setValue("");Ext.getCmp(this.ID_Search_fromuid).setValue("");Ext.getCmp(this.ID_Search_touid).setValue("");Ext.getCmp(this.ID_Search_stime).setValue("");Ext.getCmp(this.ID_Search_etime).setValue("");Ext.getCmp(this.ID_Search_fromuid+"Tr").setValue("");Ext.getCmp(this.ID_Search_touid+"Tr").setValue("");this.search={mobile:"",fromuid:0,touid:0,stime:0,etime:0};this.store.load()},deleteList:function(a){var b=this;Ext.Ajax.request({url:this.baseUrl+"&task=deleteSendbox",method:"POST",params:{ids:a},success:function(d){var c=Ext.decode(d.responseText);if(c.success===true){CNOA.msg.alert(c.msg,function(){b.store.reload()})}else{CNOA.msg.alert(c.msg)}}})},view:function(b,a){mainPanel.closeTab("CNOA_MENU_MAIN_SMS_VIEW");mainPanel.loadClass(this.baseUrl+"&task=loadPage&from=smsview&id="+b+"&inout="+a,"CNOA_MENU_MAIN_SMS_VIEW","查看短信","icon-page-view")}};var CNOA_main_sms_settingClass,CNOA_main_sms_setting;CNOA_main_sms_settingClass=CNOA.Class.create();CNOA_main_sms_settingClass.prototype={init:function(){var a=this;this.baseUrl="index.php?app=main&func=sms&action=setting";this.formPanel=new Ext.form.FormPanel({border:false,waitMsgTarget:true,labelWidth:180,labelAlign:"right",items:[{xtype:"panel",border:false,layout:"form",bodyStyle:"padding:10px",items:[{xtype:"fieldset",items:[{xtype:"displayfield",name:"msgoutcount",fieldLabel:lang("beenTextingNum")},{xtype:"displayfield",name:"msgincount",fieldLabel:lang("SMSreceived")},{xtype:"checkbox",name:"enable",fieldLabel:lang("sendReceiveFunction")},{xtype:"radiogroup",name:"enable",fieldLabel:lang("SMSsendType"),width:280,items:[{boxLabel:lang("useSMScat"),name:"sms_useapi",checked:true,inputValue:0},{boxLabel:lang("uerMarkePlatform"),name:"sms_useapi",inputValue:1}],listeners:{change:function(j,i){var k=a.formPanel.getForm();var g=k.findField("api_type");var e=k.findField("api_out");var m=k.findField("api_sms_sender_code");var l=k.findField("api_in");if(i.inputValue=="0"){g.enable();e.enable();l.enable()}else{if(i.inputValue=="1"){g.disable();e.disable();l.disable()}}}}},{xtype:"textfield",name:"api_type",fieldLabel:lang("interfaceName"),width:"100"}]},{xtype:"fieldset",title:lang("sendSMSset"),items:[{xtype:"textarea",name:"api_out",fieldLabel:lang("SMSinterface"),anchor:"-20"},{xtype:"displayfield",value:lang("SMSleftBlank")},{xtype:"textfield",name:"api_sms_sender_code",fieldLabel:lang("SMSverficationCode"),anchor:"-20"},{xtype:"displayfield",value:lang("taskSMSserver")}]},{xtype:"fieldset",title:lang("receiveSMS"),items:[{xtype:"textarea",name:"api_in",fieldLabel:lang("SMSreceiveInterface"),anchor:"-20"},{xtype:"displayfield",value:lang("optionAgreement")}]}]}],listeners:{render:function(){a.getSettingInfo()}}});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"fit",autoScroll:false,items:[this.formPanel],tbar:new Ext.Toolbar({items:[{iconCls:"icon-btn-save",cls:"btn-blue4",text:lang("save"),handler:function(b,c){a.submit()}.createDelegate(this)},lang("doNotModifyInterface"),"->",{xtype:"cnoa_helpBtn",helpid:32}]})})},getSettingInfo:function(){var a=this;this.formPanel.getForm().load({url:a.baseUrl+"&task=getSetting",params:{},method:"POST",waitMsg:lang("waiting"),success:function(b,c){}.createDelegate(this),failure:function(b,c){CNOA.msg.alert(c.result.msg,function(){})}.createDelegate(this)})},submit:function(){var a=this;if(this.formPanel.getForm().isValid()){this.formPanel.getForm().submit({url:this.baseUrl+"&task=submit",waitTitle:lang("notice"),method:"POST",waitMsg:lang("waiting"),params:{},success:function(b,c){CNOA.msg.alert(c.result.msg,function(){})}.createDelegate(this),failure:function(b,c){CNOA.msg.alert(c.result.msg)}.createDelegate(this)})}}};var CNOA_main_sms_viewClass,CNOA_main_sms_view;CNOA_main_sms_viewClass=CNOA.Class.create();CNOA_main_sms_viewClass.prototype={init:function(){var a=this;this.type=CNOA.main.sms.view.type;this.id=CNOA.main.sms.view.id;this.baseUrl="index.php?app=main&func=sms&action=smsmgr";this.Panel=new Ext.Panel({border:false,bodyStyle:"padding:10px",labelAlign:"right",labelWidth:"100",autoScroll:true,listeners:{render:function(){a.getviewInfo()}}});this.mainPanel=new Ext.Panel({collapsible:false,hideBorders:true,border:false,layout:"fit",autoScroll:false,items:[this.Panel],tbar:new Ext.Toolbar({items:[{id:this.ID_btn_refreshList,handler:function(b,c){a.getviewInfo()}.createDelegate(this),iconCls:"icon-system-refresh",text:lang("refresh")},{text:lang("close"),iconCls:"icon-dialog-cancel",handler:function(){a.closeTab()}.createDelegate(this)},"->",{xtype:"cnoa_helpBtn",helpid:33}]})})},closeTab:function(){mainPanel.closeTab(CNOA.main.sms.view.parentID.replace("docs-",""))},getviewInfo:function(){var a=this;a.mainPanel.getEl().mask(lang("waiting"));Ext.Ajax.request({url:this.baseUrl+"&task=view",method:"POST",disableCaching:true,params:{type:this.type,id:this.id},success:function(c){a.mainPanel.getEl().unmask();var b=Ext.decode(c.responseText);if(b.success===true){a.makeContents(b.data)}else{CNOA.msg.alert(b.msg)}}})},makeContents:function(c){var d=this;var a=new Array();if(this.type=="in"){a.push(d.makeInView(c))}else{if(this.type=="out"){a.push(d.makeOutView(c));if(c.list.length>0){for(var b=0;b<c.list.length;b++){a.push(d.makeInView(c.list[b]))}}}else{if(this.type=="send"){a.push(d.makeOutView(c))}}}this.Panel.removeAll();this.Panel.add(a);this.Panel.doLayout()},makeOutView:function(a){var c=this;var b=new Ext.Panel({title:lang("msgType"),style:"margin-bottom:10px",bodyStyle:"padding:10px",frame:true,layout:"form",items:[{xtype:"displayfield",fieldLabel:lang("sender"),value:a.fromname},{xtype:"displayfield",fieldLabel:lang("receiveMan"),value:a.toname},{xtype:"displayfield",fieldLabel:lang("receivingPhone"),value:a.mobile},{xtype:"displayfield",fieldLabel:lang("posttime"),value:a.sendtime},{xtype:"displayfield",fieldLabel:lang("smsContent"),value:a.text},{xtype:"displayfield",fieldLabel:lang("msgType1"),value:a.from}]});return b},makeInView:function(a){var d=this;var c;if(this.type=="in"){c=lang("msgType2")}else{c=lang("reply")}var b=new Ext.Panel({title:c,style:"margin-bottom:10px",bodyStyle:"padding:10px",frame:true,layout:"form",items:[{xtype:"displayfield",fieldLabel:lang("sender"),value:a.fromname},{xtype:"displayfield",fieldLabel:lang("sourceNum"),value:a.mobile},{xtype:"displayfield",fieldLabel:lang("receiveTime"),value:a.posttime},{xtype:"displayfield",fieldLabel:lang("smsContent"),value:a.text}]});return b}};var sm_main_sms=1;